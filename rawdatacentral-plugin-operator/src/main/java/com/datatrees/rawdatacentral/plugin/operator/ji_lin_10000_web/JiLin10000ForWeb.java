package com.datatrees.rawdatacentral.plugin.operator.ji_lin_10000_web;

import javax.script.Invocable;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.datatrees.common.util.PatternUtils;
import com.datatrees.crawler.core.processor.common.ProcessorContextUtil;
import com.datatrees.crawler.core.processor.plugin.PluginFactory;
import com.datatrees.crawler.core.util.xpath.XPathUtil;
import com.datatrees.rawdatacentral.common.http.TaskHttpClient;
import com.datatrees.rawdatacentral.common.http.TaskUtils;
import com.datatrees.rawdatacentral.common.utils.CheckUtils;
import com.datatrees.rawdatacentral.common.utils.RedisUtils;
import com.datatrees.rawdatacentral.common.utils.ScriptEngineUtil;
import com.datatrees.rawdatacentral.domain.constant.FormType;
import com.datatrees.rawdatacentral.domain.enums.ErrorCode;
import com.datatrees.rawdatacentral.domain.enums.RequestType;
import com.datatrees.rawdatacentral.domain.operator.OperatorParam;
import com.datatrees.rawdatacentral.domain.result.HttpResult;
import com.datatrees.rawdatacentral.domain.vo.Response;
import com.datatrees.rawdatacentral.service.OperatorPluginService;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.util.CollectionUtils;

/**
 * 吉林电信web端
 * 登录 wap端手机号，服务密码，图片验证码
 * 详单查询 短信验证码和两次图片验证码
 * User: yand
 * Date: 2017/10/10
 */
public class JiLin10000ForWeb implements OperatorPluginService {

    private static       Logger logger     = LoggerFactory.getLogger(JiLin10000ForWeb.class);
    private              String preUrl     = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
    private              String pscToken   = "nqnfydcxen";
    private              String queryType  = "4";
    private              String areaCode   = "";
    private              String pwdType    = "2";
    private              String firstInput = "y";
    private              String url        = StringUtils.EMPTY;
    private static final String javaScript = "Ly93YXAgZW5jcnlwdA0KZnVuY3Rpb24gZW5jcnlwdChzdHIsa2V5KXsJCQ0KCXZhciBjb2RlID0nJzsNCgl2YXIgYyA9IHN0ci5zcGxpdCgnJyk7DQoJdmFyIGsgPSBrZXkuc3BsaXQoJycpOwkNCgkNCglmb3IodmFyIGk9MDsgaTxjLmxlbmd0aDsgaSsrKXsNCgkJDQoJCXZhciBoYyA9IGNbaV0uY2hhckNvZGVBdCgpOw0KCQl2YXIga2kgPSBpOw0KCQkNCgkJaWYoaSA+PSBrLmxlbmd0aCl7DQoJCQlraSA9IGkgJSBrLmxlbmd0aDsNCgkJfQ0KCQkNCgkJdmFyIGt0ID0ga1traV0uY2hhckNvZGVBdCgpIC0gOTc7DQoJCWlmKGhjID49IDk3ICYmIGhjIDw9IDEyMil7DQoJCQloYyA9IDk3ICsgKCgoaGMgLTk3KSArIGt0KSAlIDI2KTsNCgkJfQ0KCQlpZihoYyA+PSA2NSAmJiBoYyA8PSA5MCl7DQoJCQloYyA9IDY1ICsgKCgoaGMgLSA2NSkgKyBrdCkgJSAyNik7DQoJCX0NCgkJaWYoaGMgPj00OCAmJiBoYzw9NTcpew0KCQkJaWYoa3QgPj0gMTApew0KCQkJCWt0ID0gMTA7DQoJCQl9DQoJCQloYyA9IDQ4ICsgKCgoaGMgLSA0OCkgKyBrdCkgJSAxMCk7DQoJCX0NCgkJdmFyIHRlbXAgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGhjKTsNCgkJY29kZSArPSB0ZW1wOw0KCQkNCgl9DQoJcmV0dXJuIGNvZGU7DQp9DQoNCg0KDQp2YXIgQ3J5cHRvSlMgPSBDcnlwdG9KUyB8fA0KZnVuY3Rpb24obiwgdCkgew0KICAgIHZhciB1ID0ge30sDQogICAgZiA9IHUubGliID0ge30sDQogICAgbyA9IGZ1bmN0aW9uKCkge30sDQogICAgaSA9IGYuQmFzZSA9IHsNCiAgICAgICAgZXh0ZW5kOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICBvLnByb3RvdHlwZSA9IHRoaXM7DQogICAgICAgICAgICB2YXIgdCA9IG5ldyBvOw0KICAgICAgICAgICAgcmV0dXJuIG4gJiYgdC5taXhJbihuKSwNCiAgICAgICAgICAgIHQuaGFzT3duUHJvcGVydHkoImluaXQiKSB8fCAodC5pbml0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdC4kc3VwZXIuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpDQogICAgICAgICAgICB9KSwNCiAgICAgICAgICAgIHQuaW5pdC5wcm90b3R5cGUgPSB0LA0KICAgICAgICAgICAgdC4kc3VwZXIgPSB0aGlzLA0KICAgICAgICAgICAgdA0KICAgICAgICB9LA0KICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIG4gPSB0aGlzLmV4dGVuZCgpOw0KICAgICAgICAgICAgcmV0dXJuIG4uaW5pdC5hcHBseShuLCBhcmd1bWVudHMpLA0KICAgICAgICAgICAgbg0KICAgICAgICB9LA0KICAgICAgICBpbml0OiBmdW5jdGlvbigpIHt9LA0KICAgICAgICBtaXhJbjogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgZm9yICh2YXIgdCBpbiBuKSBuLmhhc093blByb3BlcnR5KHQpICYmICh0aGlzW3RdID0gblt0XSk7DQogICAgICAgICAgICBuLmhhc093blByb3BlcnR5KCJ0b1N0cmluZyIpICYmICh0aGlzLnRvU3RyaW5nID0gbi50b1N0cmluZykNCiAgICAgICAgfSwNCiAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdC5wcm90b3R5cGUuZXh0ZW5kKHRoaXMpDQogICAgICAgIH0NCiAgICB9LA0KICAgIHIgPSBmLldvcmRBcnJheSA9IGkuZXh0ZW5kKHsNCiAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgaSkgew0KICAgICAgICAgICAgbiA9IHRoaXMud29yZHMgPSBuIHx8IFtdOw0KICAgICAgICAgICAgdGhpcy5zaWdCeXRlcyA9IGkgIT0gdCA/IGk6IDQgKiBuLmxlbmd0aA0KICAgICAgICB9LA0KICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIChuIHx8IGwpLnN0cmluZ2lmeSh0aGlzKQ0KICAgICAgICB9LA0KICAgICAgICBjb25jYXQ6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHZhciBpID0gdGhpcy53b3JkcywNCiAgICAgICAgICAgIHIgPSBuLndvcmRzLA0KICAgICAgICAgICAgdSA9IHRoaXMuc2lnQnl0ZXMsDQogICAgICAgICAgICB0Ow0KICAgICAgICAgICAgaWYgKG4gPSBuLnNpZ0J5dGVzLCB0aGlzLmNsYW1wKCksIHUgJSA0KSBmb3IgKHQgPSAwOyB0IDwgbjsgdCsrKSBpW3UgKyB0ID4+PiAyXSB8PSAoclt0ID4+PiAyXSA+Pj4gMjQgLSA4ICogKHQgJSA0KSAmIDI1NSkgPDwgMjQgLSA4ICogKCh1ICsgdCkgJSA0KTsNCiAgICAgICAgICAgIGVsc2UgaWYgKDY1NTM1IDwgci5sZW5ndGgpIGZvciAodCA9IDA7IHQgPCBuOyB0ICs9IDQpIGlbdSArIHQgPj4+IDJdID0gclt0ID4+PiAyXTsNCiAgICAgICAgICAgIGVsc2UgaS5wdXNoLmFwcGx5KGksIHIpOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2lnQnl0ZXMgKz0gbiwNCiAgICAgICAgICAgIHRoaXMNCiAgICAgICAgfSwNCiAgICAgICAgY2xhbXA6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIGkgPSB0aGlzLndvcmRzLA0KICAgICAgICAgICAgdCA9IHRoaXMuc2lnQnl0ZXM7DQogICAgICAgICAgICBpW3QgPj4+IDJdICY9IDQyOTQ5NjcyOTUgPDwgMzIgLSA4ICogKHQgJSA0KTsNCiAgICAgICAgICAgIGkubGVuZ3RoID0gbi5jZWlsKHQgLyA0KQ0KICAgICAgICB9LA0KICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB2YXIgbiA9IGkuY2xvbmUuY2FsbCh0aGlzKTsNCiAgICAgICAgICAgIHJldHVybiBuLndvcmRzID0gdGhpcy53b3Jkcy5zbGljZSgwKSwNCiAgICAgICAgICAgIG4NCiAgICAgICAgfSwNCiAgICAgICAgcmFuZG9tOiBmdW5jdGlvbih0KSB7DQogICAgICAgICAgICBmb3IgKHZhciBpID0gW10sIHUgPSAwOyB1IDwgdDsgdSArPSA0KSBpLnB1c2goNDI5NDk2NzI5NiAqIG4ucmFuZG9tKCkgfCAwKTsNCiAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KGksIHQpDQogICAgICAgIH0NCiAgICB9KSwNCiAgICBlID0gdS5lbmMgPSB7fSwNCiAgICBsID0gZS5IZXggPSB7DQogICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdmFyIHUgPSBuLndvcmRzLA0KICAgICAgICAgICAgaSwgdCwgcjsNCiAgICAgICAgICAgIGZvciAobiA9IG4uc2lnQnl0ZXMsIGkgPSBbXSwgdCA9IDA7IHQgPCBuOyB0KyspIHIgPSB1W3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1LA0KICAgICAgICAgICAgaS5wdXNoKChyID4+PiA0KS50b1N0cmluZygxNikpLA0KICAgICAgICAgICAgaS5wdXNoKChyICYgMTUpLnRvU3RyaW5nKDE2KSk7DQogICAgICAgICAgICByZXR1cm4gaS5qb2luKCIiKQ0KICAgICAgICB9LA0KICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IG4ubGVuZ3RoLA0KICAgICAgICAgICAgdSA9IFtdLCB0ID0gMDsgdCA8IGk7IHQgKz0gMikgdVt0ID4+PiAzXSB8PSBwYXJzZUludChuLnN1YnN0cih0LCAyKSwgMTYpIDw8IDI0IC0gNCAqICh0ICUgOCk7DQogICAgICAgICAgICByZXR1cm4gbmV3IHIuaW5pdCh1LCBpIC8gMikNCiAgICAgICAgfQ0KICAgIH0sDQogICAgcyA9IGUuTGF0aW4xID0gew0KICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHZhciByID0gbi53b3JkcywNCiAgICAgICAgICAgIGksIHQ7DQogICAgICAgICAgICBmb3IgKG4gPSBuLnNpZ0J5dGVzLCBpID0gW10sIHQgPSAwOyB0IDwgbjsgdCsrKSBpLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZShyW3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1KSk7DQogICAgICAgICAgICByZXR1cm4gaS5qb2luKCIiKQ0KICAgICAgICB9LA0KICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IG4ubGVuZ3RoLA0KICAgICAgICAgICAgdSA9IFtdLCB0ID0gMDsgdCA8IGk7IHQrKykgdVt0ID4+PiAyXSB8PSAobi5jaGFyQ29kZUF0KHQpICYgMjU1KSA8PCAyNCAtIDggKiAodCAlIDQpOw0KICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQodSwgaSkNCiAgICAgICAgfQ0KICAgIH0sDQogICAgYSA9IGUuVXRmOCA9IHsNCiAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoZXNjYXBlKHMuc3RyaW5naWZ5KG4pKSkNCiAgICAgICAgICAgIH0gY2F0Y2godCkgew0KICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJNYWxmb3JtZWQgVVRGLTggZGF0YSIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIHMucGFyc2UodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KG4pKSkNCiAgICAgICAgfQ0KICAgIH0sDQogICAgaCA9IGYuQnVmZmVyZWRCbG9ja0FsZ29yaXRobSA9IGkuZXh0ZW5kKHsNCiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdGhpcy5fZGF0YSA9IG5ldyByLmluaXQ7DQogICAgICAgICAgICB0aGlzLl9uRGF0YUJ5dGVzID0gMA0KICAgICAgICB9LA0KICAgICAgICBfYXBwZW5kOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAic3RyaW5nIiA9PSB0eXBlb2YgbiAmJiAobiA9IGEucGFyc2UobikpOw0KICAgICAgICAgICAgdGhpcy5fZGF0YS5jb25jYXQobik7DQogICAgICAgICAgICB0aGlzLl9uRGF0YUJ5dGVzICs9IG4uc2lnQnl0ZXMNCiAgICAgICAgfSwNCiAgICAgICAgX3Byb2Nlc3M6IGZ1bmN0aW9uKHQpIHsNCiAgICAgICAgICAgIHZhciBmID0gdGhpcy5fZGF0YSwNCiAgICAgICAgICAgIHMgPSBmLndvcmRzLA0KICAgICAgICAgICAgdSA9IGYuc2lnQnl0ZXMsDQogICAgICAgICAgICBlID0gdGhpcy5ibG9ja1NpemUsDQogICAgICAgICAgICBvID0gdSAvICg0ICogZSksDQogICAgICAgICAgICBvID0gdCA/IG4uY2VpbChvKSA6IG4ubWF4KChvIHwgMCkgLSB0aGlzLl9taW5CdWZmZXJTaXplLCAwKSwNCiAgICAgICAgICAgIGk7DQogICAgICAgICAgICBpZiAodCA9IG8gKiBlLCB1ID0gbi5taW4oNCAqIHQsIHUpLCB0KSB7DQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHQ7IGkgKz0gZSkgdGhpcy5fZG9Qcm9jZXNzQmxvY2socywgaSk7DQogICAgICAgICAgICAgICAgaSA9IHMuc3BsaWNlKDAsIHQpOw0KICAgICAgICAgICAgICAgIGYuc2lnQnl0ZXMgLT0gdQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQoaSwgdSkNCiAgICAgICAgfSwNCiAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIG4gPSBpLmNsb25lLmNhbGwodGhpcyk7DQogICAgICAgICAgICByZXR1cm4gbi5fZGF0YSA9IHRoaXMuX2RhdGEuY2xvbmUoKSwNCiAgICAgICAgICAgIG4NCiAgICAgICAgfSwNCiAgICAgICAgX21pbkJ1ZmZlclNpemU6IDANCiAgICB9KSwNCiAgICBjOw0KICAgIHJldHVybiBmLkhhc2hlciA9IGguZXh0ZW5kKHsNCiAgICAgICAgY2ZnOiBpLmV4dGVuZCgpLA0KICAgICAgICBpbml0OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB0aGlzLmNmZyA9IHRoaXMuY2ZnLmV4dGVuZChuKTsNCiAgICAgICAgICAgIHRoaXMucmVzZXQoKQ0KICAgICAgICB9LA0KICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBoLnJlc2V0LmNhbGwodGhpcyk7DQogICAgICAgICAgICB0aGlzLl9kb1Jlc2V0KCkNCiAgICAgICAgfSwNCiAgICAgICAgdXBkYXRlOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXBwZW5kKG4pLA0KICAgICAgICAgICAgdGhpcy5fcHJvY2VzcygpLA0KICAgICAgICAgICAgdGhpcw0KICAgICAgICB9LA0KICAgICAgICBmaW5hbGl6ZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIG4gJiYgdGhpcy5fYXBwZW5kKG4pLA0KICAgICAgICAgICAgdGhpcy5fZG9GaW5hbGl6ZSgpDQogICAgICAgIH0sDQogICAgICAgIGJsb2NrU2l6ZTogMTYsDQogICAgICAgIF9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0LCBpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBuLmluaXQoaSkuZmluYWxpemUodCkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgX2NyZWF0ZUhtYWNIZWxwZXI6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0LCBpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjLkhNQUMuaW5pdChuLCBpKS5maW5hbGl6ZSh0KQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfSksDQogICAgYyA9IHUuYWxnbyA9IHt9LA0KICAgIHUNCn0gKE1hdGgpOyAoZnVuY3Rpb24oKSB7DQogICAgdmFyIG4gPSBDcnlwdG9KUywNCiAgICB0ID0gbi5saWIuV29yZEFycmF5Ow0KICAgIG4uZW5jLkJhc2U2NCA9IHsNCiAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB2YXIgaSA9IG4ud29yZHMsDQogICAgICAgICAgICB1ID0gbi5zaWdCeXRlcywNCiAgICAgICAgICAgIGYgPSB0aGlzLl9tYXAsDQogICAgICAgICAgICB0LCBlLCByOw0KICAgICAgICAgICAgZm9yIChuLmNsYW1wKCksIG4gPSBbXSwgdCA9IDA7IHQgPCB1OyB0ICs9IDMpIGZvciAoZSA9IChpW3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1KSA8PCAxNiB8IChpW3QgKyAxID4+PiAyXSA+Pj4gMjQgLSA4ICogKCh0ICsgMSkgJSA0KSAmIDI1NSkgPDwgOCB8IGlbdCArIDIgPj4+IDJdID4+PiAyNCAtIDggKiAoKHQgKyAyKSAlIDQpICYgMjU1LCByID0gMDsgNCA+IHIgJiYgdCArIC43NSAqIHIgPCB1OyByKyspIG4ucHVzaChmLmNoYXJBdChlID4+PiA2ICogKDMgLSByKSAmIDYzKSk7DQogICAgICAgICAgICBpZiAoaSA9IGYuY2hhckF0KDY0KSkgZm9yICg7IG4ubGVuZ3RoICUgNDspIG4ucHVzaChpKTsNCiAgICAgICAgICAgIHJldHVybiBuLmpvaW4oIiIpDQogICAgICAgIH0sDQogICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB2YXIgZSA9IG4ubGVuZ3RoLA0KICAgICAgICAgICAgZiA9IHRoaXMuX21hcCwNCiAgICAgICAgICAgIGkgPSBmLmNoYXJBdCg2NCksDQogICAgICAgICAgICBvLA0KICAgICAgICAgICAgczsNCiAgICAgICAgICAgIGkgJiYgKGkgPSBuLmluZGV4T2YoaSksIC0xICE9IGkgJiYgKGUgPSBpKSk7DQogICAgICAgICAgICBmb3IgKHZhciBpID0gW10sIHUgPSAwLCByID0gMDsgciA8IGU7IHIrKykgciAlIDQgJiYgKG8gPSBmLmluZGV4T2Yobi5jaGFyQXQociAtIDEpKSA8PCAyICogKHIgJSA0KSwgcyA9IGYuaW5kZXhPZihuLmNoYXJBdChyKSkgPj4+IDYgLSAyICogKHIgJSA0KSwgaVt1ID4+PiAyXSB8PSAobyB8IHMpIDw8IDI0IC0gOCAqICh1ICUgNCksIHUrKyk7DQogICAgICAgICAgICByZXR1cm4gdC5jcmVhdGUoaSwgdSkNCiAgICAgICAgfSwNCiAgICAgICAgX21hcDogIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky89Ig0KICAgIH0NCn0pKCksDQpmdW5jdGlvbihuKSB7DQogICAgZnVuY3Rpb24gaShuLCB0LCBpLCByLCB1LCBmLCBlKSB7DQogICAgICAgIHJldHVybiBuID0gbiArICh0ICYgaSB8IH50ICYgcikgKyB1ICsgZSwNCiAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0DQogICAgfQ0KICAgIGZ1bmN0aW9uIHIobiwgdCwgaSwgciwgdSwgZiwgZSkgew0KICAgICAgICByZXR1cm4gbiA9IG4gKyAodCAmIHIgfCBpICYgfnIpICsgdSArIGUsDQogICAgICAgIChuIDw8IGYgfCBuID4+PiAzMiAtIGYpICsgdA0KICAgIH0NCiAgICBmdW5jdGlvbiB1KG4sIHQsIGksIHIsIHUsIGYsIGUpIHsNCiAgICAgICAgcmV0dXJuIG4gPSBuICsgKHQgXiBpIF4gcikgKyB1ICsgZSwNCiAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0DQogICAgfQ0KICAgIGZ1bmN0aW9uIGYobiwgdCwgaSwgciwgdSwgZiwgZSkgew0KICAgICAgICByZXR1cm4gbiA9IG4gKyAoaSBeICh0IHwgfnIpKSArIHUgKyBlLA0KICAgICAgICAobiA8PCBmIHwgbiA+Pj4gMzIgLSBmKSArIHQNCiAgICB9DQogICAgZm9yICh2YXIgbyA9IENyeXB0b0pTLA0KICAgIGUgPSBvLmxpYiwNCiAgICBjID0gZS5Xb3JkQXJyYXksDQogICAgcyA9IGUuSGFzaGVyLA0KICAgIGUgPSBvLmFsZ28sDQogICAgdCA9IFtdLCBoID0gMDsgNjQgPiBoOyBoKyspIHRbaF0gPSA0Mjk0OTY3Mjk2ICogbi5hYnMobi5zaW4oaCArIDEpKSB8IDA7DQogICAgZSA9IGUuTUQ1ID0gcy5leHRlbmQoew0KICAgICAgICBfZG9SZXNldDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB0aGlzLl9oYXNoID0gbmV3IGMuaW5pdChbMTczMjU4NDE5MywgNDAyMzIzMzQxNywgMjU2MjM4MzEwMiwgMjcxNzMzODc4XSkNCiAgICAgICAgfSwNCiAgICAgICAgX2RvUHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCBlKSB7DQogICAgICAgICAgICBmb3IgKHZhciB2LCBhLCBsID0gMDsgMTYgPiBsOyBsKyspIHYgPSBlICsgbCwNCiAgICAgICAgICAgIGEgPSBuW3ZdLA0KICAgICAgICAgICAgblt2XSA9IChhIDw8IDggfCBhID4+PiAyNCkgJiAxNjcxMTkzNSB8IChhIDw8IDI0IHwgYSA+Pj4gOCkgJiA0Mjc4MjU1MzYwOw0KICAgICAgICAgICAgdmFyIGwgPSB0aGlzLl9oYXNoLndvcmRzLA0KICAgICAgICAgICAgdiA9IG5bZSArIDBdLA0KICAgICAgICAgICAgYSA9IG5bZSArIDFdLA0KICAgICAgICAgICAgeSA9IG5bZSArIDJdLA0KICAgICAgICAgICAgcCA9IG5bZSArIDNdLA0KICAgICAgICAgICAgdyA9IG5bZSArIDRdLA0KICAgICAgICAgICAgYiA9IG5bZSArIDVdLA0KICAgICAgICAgICAgayA9IG5bZSArIDZdLA0KICAgICAgICAgICAgZCA9IG5bZSArIDddLA0KICAgICAgICAgICAgZyA9IG5bZSArIDhdLA0KICAgICAgICAgICAgbnQgPSBuW2UgKyA5XSwNCiAgICAgICAgICAgIHR0ID0gbltlICsgMTBdLA0KICAgICAgICAgICAgaXQgPSBuW2UgKyAxMV0sDQogICAgICAgICAgICBydCA9IG5bZSArIDEyXSwNCiAgICAgICAgICAgIHV0ID0gbltlICsgMTNdLA0KICAgICAgICAgICAgZnQgPSBuW2UgKyAxNF0sDQogICAgICAgICAgICBldCA9IG5bZSArIDE1XSwNCiAgICAgICAgICAgIG8gPSBsWzBdLA0KICAgICAgICAgICAgcyA9IGxbMV0sDQogICAgICAgICAgICBoID0gbFsyXSwNCiAgICAgICAgICAgIGMgPSBsWzNdLA0KICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgdiwgNywgdFswXSksDQogICAgICAgICAgICBjID0gaShjLCBvLCBzLCBoLCBhLCAxMiwgdFsxXSksDQogICAgICAgICAgICBoID0gaShoLCBjLCBvLCBzLCB5LCAxNywgdFsyXSksDQogICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBwLCAyMiwgdFszXSksDQogICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCB3LCA3LCB0WzRdKSwNCiAgICAgICAgICAgIGMgPSBpKGMsIG8sIHMsIGgsIGIsIDEyLCB0WzVdKSwNCiAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIGssIDE3LCB0WzZdKSwNCiAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGQsIDIyLCB0WzddKSwNCiAgICAgICAgICAgIG8gPSBpKG8sIHMsIGgsIGMsIGcsIDcsIHRbOF0pLA0KICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgbnQsIDEyLCB0WzldKSwNCiAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIHR0LCAxNywgdFsxMF0pLA0KICAgICAgICAgICAgcyA9IGkocywgaCwgYywgbywgaXQsIDIyLCB0WzExXSksDQogICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCBydCwgNywgdFsxMl0pLA0KICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgdXQsIDEyLCB0WzEzXSksDQogICAgICAgICAgICBoID0gaShoLCBjLCBvLCBzLCBmdCwgMTcsIHRbMTRdKSwNCiAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGV0LCAyMiwgdFsxNV0pLA0KICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgYSwgNSwgdFsxNl0pLA0KICAgICAgICAgICAgYyA9IHIoYywgbywgcywgaCwgaywgOSwgdFsxN10pLA0KICAgICAgICAgICAgaCA9IHIoaCwgYywgbywgcywgaXQsIDE0LCB0WzE4XSksDQogICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCB2LCAyMCwgdFsxOV0pLA0KICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgYiwgNSwgdFsyMF0pLA0KICAgICAgICAgICAgYyA9IHIoYywgbywgcywgaCwgdHQsIDksIHRbMjFdKSwNCiAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGV0LCAxNCwgdFsyMl0pLA0KICAgICAgICAgICAgcyA9IHIocywgaCwgYywgbywgdywgMjAsIHRbMjNdKSwNCiAgICAgICAgICAgIG8gPSByKG8sIHMsIGgsIGMsIG50LCA1LCB0WzI0XSksDQogICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCBmdCwgOSwgdFsyNV0pLA0KICAgICAgICAgICAgaCA9IHIoaCwgYywgbywgcywgcCwgMTQsIHRbMjZdKSwNCiAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIGcsIDIwLCB0WzI3XSksDQogICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCB1dCwgNSwgdFsyOF0pLA0KICAgICAgICAgICAgYyA9IHIoYywgbywgcywgaCwgeSwgOSwgdFsyOV0pLA0KICAgICAgICAgICAgaCA9IHIoaCwgYywgbywgcywgZCwgMTQsIHRbMzBdKSwNCiAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIHJ0LCAyMCwgdFszMV0pLA0KICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgYiwgNCwgdFszMl0pLA0KICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgZywgMTEsIHRbMzNdKSwNCiAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGl0LCAxNiwgdFszNF0pLA0KICAgICAgICAgICAgcyA9IHUocywgaCwgYywgbywgZnQsIDIzLCB0WzM1XSksDQogICAgICAgICAgICBvID0gdShvLCBzLCBoLCBjLCBhLCA0LCB0WzM2XSksDQogICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCB3LCAxMSwgdFszN10pLA0KICAgICAgICAgICAgaCA9IHUoaCwgYywgbywgcywgZCwgMTYsIHRbMzhdKSwNCiAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIHR0LCAyMywgdFszOV0pLA0KICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgdXQsIDQsIHRbNDBdKSwNCiAgICAgICAgICAgIGMgPSB1KGMsIG8sIHMsIGgsIHYsIDExLCB0WzQxXSksDQogICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBwLCAxNiwgdFs0Ml0pLA0KICAgICAgICAgICAgcyA9IHUocywgaCwgYywgbywgaywgMjMsIHRbNDNdKSwNCiAgICAgICAgICAgIG8gPSB1KG8sIHMsIGgsIGMsIG50LCA0LCB0WzQ0XSksDQogICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCBydCwgMTEsIHRbNDVdKSwNCiAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGV0LCAxNiwgdFs0Nl0pLA0KICAgICAgICAgICAgcyA9IHUocywgaCwgYywgbywgeSwgMjMsIHRbNDddKSwNCiAgICAgICAgICAgIG8gPSBmKG8sIHMsIGgsIGMsIHYsIDYsIHRbNDhdKSwNCiAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGQsIDEwLCB0WzQ5XSksDQogICAgICAgICAgICBoID0gZihoLCBjLCBvLCBzLCBmdCwgMTUsIHRbNTBdKSwNCiAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIGIsIDIxLCB0WzUxXSksDQogICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCBydCwgNiwgdFs1Ml0pLA0KICAgICAgICAgICAgYyA9IGYoYywgbywgcywgaCwgcCwgMTAsIHRbNTNdKSwNCiAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIHR0LCAxNSwgdFs1NF0pLA0KICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgYSwgMjEsIHRbNTVdKSwNCiAgICAgICAgICAgIG8gPSBmKG8sIHMsIGgsIGMsIGcsIDYsIHRbNTZdKSwNCiAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGV0LCAxMCwgdFs1N10pLA0KICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgaywgMTUsIHRbNThdKSwNCiAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIHV0LCAyMSwgdFs1OV0pLA0KICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgdywgNiwgdFs2MF0pLA0KICAgICAgICAgICAgYyA9IGYoYywgbywgcywgaCwgaXQsIDEwLCB0WzYxXSksDQogICAgICAgICAgICBoID0gZihoLCBjLCBvLCBzLCB5LCAxNSwgdFs2Ml0pLA0KICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgbnQsIDIxLCB0WzYzXSk7DQogICAgICAgICAgICBsWzBdID0gbFswXSArIG8gfCAwOw0KICAgICAgICAgICAgbFsxXSA9IGxbMV0gKyBzIHwgMDsNCiAgICAgICAgICAgIGxbMl0gPSBsWzJdICsgaCB8IDA7DQogICAgICAgICAgICBsWzNdID0gbFszXSArIGMgfCAwDQogICAgICAgIH0sDQogICAgICAgIF9kb0ZpbmFsaXplOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciB1ID0gdGhpcy5fZGF0YSwNCiAgICAgICAgICAgIHIgPSB1LndvcmRzLA0KICAgICAgICAgICAgdCA9IDggKiB0aGlzLl9uRGF0YUJ5dGVzLA0KICAgICAgICAgICAgaSA9IDggKiB1LnNpZ0J5dGVzLA0KICAgICAgICAgICAgZjsNCiAgICAgICAgICAgIGZvciAocltpID4+PiA1XSB8PSAxMjggPDwgMjQgLSBpICUgMzIsIGYgPSBuLmZsb29yKHQgLyA0Mjk0OTY3Mjk2KSwgclsoaSArIDY0ID4+PiA5IDw8IDQpICsgMTVdID0gKGYgPDwgOCB8IGYgPj4+IDI0KSAmIDE2NzExOTM1IHwgKGYgPDwgMjQgfCBmID4+PiA4KSAmIDQyNzgyNTUzNjAsIHJbKGkgKyA2NCA+Pj4gOSA8PCA0KSArIDE0XSA9ICh0IDw8IDggfCB0ID4+PiAyNCkgJiAxNjcxMTkzNSB8ICh0IDw8IDI0IHwgdCA+Pj4gOCkgJiA0Mjc4MjU1MzYwLCB1LnNpZ0J5dGVzID0gNCAqIChyLmxlbmd0aCArIDEpLCB0aGlzLl9wcm9jZXNzKCksIHUgPSB0aGlzLl9oYXNoLCByID0gdS53b3JkcywgdCA9IDA7IDQgPiB0OyB0KyspIGkgPSByW3RdLA0KICAgICAgICAgICAgclt0XSA9IChpIDw8IDggfCBpID4+PiAyNCkgJiAxNjcxMTkzNSB8IChpIDw8IDI0IHwgaSA+Pj4gOCkgJiA0Mjc4MjU1MzYwOw0KICAgICAgICAgICAgcmV0dXJuIHUNCiAgICAgICAgfSwNCiAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIG4gPSBzLmNsb25lLmNhbGwodGhpcyk7DQogICAgICAgICAgICByZXR1cm4gbi5faGFzaCA9IHRoaXMuX2hhc2guY2xvbmUoKSwNCiAgICAgICAgICAgIG4NCiAgICAgICAgfQ0KICAgIH0pOw0KICAgIG8uTUQ1ID0gcy5fY3JlYXRlSGVscGVyKGUpOw0KICAgIG8uSG1hY01ENSA9IHMuX2NyZWF0ZUhtYWNIZWxwZXIoZSkNCn0gKE1hdGgpLA0KZnVuY3Rpb24oKSB7DQogICAgdmFyIHQgPSBDcnlwdG9KUywNCiAgICBuID0gdC5saWIsDQogICAgaSA9IG4uQmFzZSwNCiAgICByID0gbi5Xb3JkQXJyYXksDQogICAgbiA9IHQuYWxnbywNCiAgICB1ID0gbi5FdnBLREYgPSBpLmV4dGVuZCh7DQogICAgICAgIGNmZzogaS5leHRlbmQoew0KICAgICAgICAgICAga2V5U2l6ZTogNCwNCiAgICAgICAgICAgIGhhc2hlcjogbi5NRDUsDQogICAgICAgICAgICBpdGVyYXRpb25zOiAxDQogICAgICAgIH0pLA0KICAgICAgICBpbml0OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB0aGlzLmNmZyA9IHRoaXMuY2ZnLmV4dGVuZChuKQ0KICAgICAgICB9LA0KICAgICAgICBjb21wdXRlOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICBmb3IgKHZhciBpLCBvLCBmID0gdGhpcy5jZmcsDQogICAgICAgICAgICB1ID0gZi5oYXNoZXIuY3JlYXRlKCksIGUgPSByLmNyZWF0ZSgpLCBoID0gZS53b3JkcywgcyA9IGYua2V5U2l6ZSwgZiA9IGYuaXRlcmF0aW9uczsgaC5sZW5ndGggPCBzOykgew0KICAgICAgICAgICAgICAgIGZvciAoaSAmJiB1LnVwZGF0ZShpKSwgaSA9IHUudXBkYXRlKG4pLmZpbmFsaXplKHQpLCB1LnJlc2V0KCksIG8gPSAxOyBvIDwgZjsgbysrKSBpID0gdS5maW5hbGl6ZShpKSwNCiAgICAgICAgICAgICAgICB1LnJlc2V0KCk7DQogICAgICAgICAgICAgICAgZS5jb25jYXQoaSkNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBlLnNpZ0J5dGVzID0gNCAqIHMsDQogICAgICAgICAgICBlDQogICAgICAgIH0NCiAgICB9KTsNCiAgICB0LkV2cEtERiA9IGZ1bmN0aW9uKG4sIHQsIGkpIHsNCiAgICAgICAgcmV0dXJuIHUuY3JlYXRlKGkpLmNvbXB1dGUobiwgdCkNCiAgICB9DQp9ICgpOw0KQ3J5cHRvSlMubGliLkNpcGhlciB8fA0KZnVuY3Rpb24obikgew0KICAgIHZhciBpID0gQ3J5cHRvSlMsDQogICAgdCA9IGkubGliLA0KICAgIGYgPSB0LkJhc2UsDQogICAgZSA9IHQuV29yZEFycmF5LA0KICAgIGMgPSB0LkJ1ZmZlcmVkQmxvY2tBbGdvcml0aG0sDQogICAgbCA9IGkuZW5jLkJhc2U2NCwNCiAgICB5ID0gaS5hbGdvLkV2cEtERiwNCiAgICBvID0gdC5DaXBoZXIgPSBjLmV4dGVuZCh7DQogICAgICAgIGNmZzogZi5leHRlbmQoKSwNCiAgICAgICAgY3JlYXRlRW5jcnlwdG9yOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGUodGhpcy5fRU5DX1hGT1JNX01PREUsIG4sIHQpDQogICAgICAgIH0sDQogICAgICAgIGNyZWF0ZURlY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHRoaXMuX0RFQ19YRk9STV9NT0RFLCBuLCB0KQ0KICAgICAgICB9LA0KICAgICAgICBpbml0OiBmdW5jdGlvbihuLCB0LCBpKSB7DQogICAgICAgICAgICB0aGlzLmNmZyA9IHRoaXMuY2ZnLmV4dGVuZChpKTsNCiAgICAgICAgICAgIHRoaXMuX3hmb3JtTW9kZSA9IG47DQogICAgICAgICAgICB0aGlzLl9rZXkgPSB0Ow0KICAgICAgICAgICAgdGhpcy5yZXNldCgpDQogICAgICAgIH0sDQogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIGMucmVzZXQuY2FsbCh0aGlzKTsNCiAgICAgICAgICAgIHRoaXMuX2RvUmVzZXQoKQ0KICAgICAgICB9LA0KICAgICAgICBwcm9jZXNzOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXBwZW5kKG4pLA0KICAgICAgICAgICAgdGhpcy5fcHJvY2VzcygpDQogICAgICAgIH0sDQogICAgICAgIGZpbmFsaXplOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICByZXR1cm4gbiAmJiB0aGlzLl9hcHBlbmQobiksDQogICAgICAgICAgICB0aGlzLl9kb0ZpbmFsaXplKCkNCiAgICAgICAgfSwNCiAgICAgICAga2V5U2l6ZTogNCwNCiAgICAgICAgaXZTaXplOiA0LA0KICAgICAgICBfRU5DX1hGT1JNX01PREU6IDEsDQogICAgICAgIF9ERUNfWEZPUk1fTU9ERTogMiwNCiAgICAgICAgX2NyZWF0ZUhlbHBlcjogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICAgICBlbmNyeXB0OiBmdW5jdGlvbih0LCBpLCByKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAoInN0cmluZyIgPT0gdHlwZW9mIGkgPyB2OiB1KS5lbmNyeXB0KG4sIHQsIGksIHIpDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbih0LCBpLCByKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAoInN0cmluZyIgPT0gdHlwZW9mIGkgPyB2OiB1KS5kZWNyeXB0KG4sIHQsIGksIHIpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfSk7DQogICAgdC5TdHJlYW1DaXBoZXIgPSBvLmV4dGVuZCh7DQogICAgICAgIF9kb0ZpbmFsaXplOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzKCEwKQ0KICAgICAgICB9LA0KICAgICAgICBibG9ja1NpemU6IDENCiAgICB9KTsNCiAgICB2YXIgcyA9IGkubW9kZSA9IHt9LA0KICAgIGEgPSBmdW5jdGlvbih0LCBpLCByKSB7DQogICAgICAgIHZhciBmID0gdGhpcy5faXYsDQogICAgICAgIHU7DQogICAgICAgIGZvciAoZiA/IHRoaXMuX2l2ID0gbjogZiA9IHRoaXMuX3ByZXZCbG9jaywgdSA9IDA7IHUgPCByOyB1KyspIHRbaSArIHVdIF49IGZbdV0NCiAgICB9LA0KICAgIHIgPSAodC5CbG9ja0NpcGhlck1vZGUgPSBmLmV4dGVuZCh7DQogICAgICAgIGNyZWF0ZUVuY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuRW5jcnlwdG9yLmNyZWF0ZShuLCB0KQ0KICAgICAgICB9LA0KICAgICAgICBjcmVhdGVEZWNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLkRlY3J5cHRvci5jcmVhdGUobiwgdCkNCiAgICAgICAgfSwNCiAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgdGhpcy5fY2lwaGVyID0gbjsNCiAgICAgICAgICAgIHRoaXMuX2l2ID0gdA0KICAgICAgICB9DQogICAgfSkpLmV4dGVuZCgpOw0KICAgIHIuRW5jcnlwdG9yID0gci5leHRlbmQoew0KICAgICAgICBwcm9jZXNzQmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHZhciBpID0gdGhpcy5fY2lwaGVyLA0KICAgICAgICAgICAgciA9IGkuYmxvY2tTaXplOw0KICAgICAgICAgICAgYS5jYWxsKHRoaXMsIG4sIHQsIHIpOw0KICAgICAgICAgICAgaS5lbmNyeXB0QmxvY2sobiwgdCk7DQogICAgICAgICAgICB0aGlzLl9wcmV2QmxvY2sgPSBuLnNsaWNlKHQsIHQgKyByKQ0KICAgICAgICB9DQogICAgfSk7DQogICAgci5EZWNyeXB0b3IgPSByLmV4dGVuZCh7DQogICAgICAgIHByb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgdmFyIGkgPSB0aGlzLl9jaXBoZXIsDQogICAgICAgICAgICByID0gaS5ibG9ja1NpemUsDQogICAgICAgICAgICB1ID0gbi5zbGljZSh0LCB0ICsgcik7DQogICAgICAgICAgICBpLmRlY3J5cHRCbG9jayhuLCB0KTsNCiAgICAgICAgICAgIGEuY2FsbCh0aGlzLCBuLCB0LCByKTsNCiAgICAgICAgICAgIHRoaXMuX3ByZXZCbG9jayA9IHUNCiAgICAgICAgfQ0KICAgIH0pOw0KICAgIHMgPSBzLkNCQyA9IHI7DQogICAgciA9IChpLnBhZCA9IHt9KS5Qa2NzNyA9IHsNCiAgICAgICAgcGFkOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICBmb3IgKHZhciBpID0gNCAqIHQsDQogICAgICAgICAgICBpID0gaSAtIG4uc2lnQnl0ZXMgJSBpLA0KICAgICAgICAgICAgZiA9IGkgPDwgMjQgfCBpIDw8IDE2IHwgaSA8PCA4IHwgaSwNCiAgICAgICAgICAgIHIgPSBbXSwgdSA9IDA7IHUgPCBpOyB1ICs9IDQpIHIucHVzaChmKTsNCiAgICAgICAgICAgIGkgPSBlLmNyZWF0ZShyLCBpKTsNCiAgICAgICAgICAgIG4uY29uY2F0KGkpDQogICAgICAgIH0sDQogICAgICAgIHVucGFkOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICBuLnNpZ0J5dGVzIC09IG4ud29yZHNbbi5zaWdCeXRlcyAtIDEgPj4+IDJdICYgMjU1DQogICAgICAgIH0NCiAgICB9Ow0KICAgIHQuQmxvY2tDaXBoZXIgPSBvLmV4dGVuZCh7DQogICAgICAgIGNmZzogby5jZmcuZXh0ZW5kKHsNCiAgICAgICAgICAgIG1vZGU6IHMsDQogICAgICAgICAgICBwYWRkaW5nOiByDQogICAgICAgIH0pLA0KICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB2YXIgdDsNCiAgICAgICAgICAgIG8ucmVzZXQuY2FsbCh0aGlzKTsNCiAgICAgICAgICAgIHZhciBuID0gdGhpcy5jZmcsDQogICAgICAgICAgICBpID0gbi5pdiwNCiAgICAgICAgICAgIG4gPSBuLm1vZGU7DQogICAgICAgICAgICB0aGlzLl94Zm9ybU1vZGUgPT0gdGhpcy5fRU5DX1hGT1JNX01PREUgPyB0ID0gbi5jcmVhdGVFbmNyeXB0b3I6ICh0ID0gbi5jcmVhdGVEZWNyeXB0b3IsIHRoaXMuX21pbkJ1ZmZlclNpemUgPSAxKTsNCiAgICAgICAgICAgIHRoaXMuX21vZGUgPSB0LmNhbGwobiwgdGhpcywgaSAmJiBpLndvcmRzKQ0KICAgICAgICB9LA0KICAgICAgICBfZG9Qcm9jZXNzQmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHRoaXMuX21vZGUucHJvY2Vzc0Jsb2NrKG4sIHQpDQogICAgICAgIH0sDQogICAgICAgIF9kb0ZpbmFsaXplOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciB0ID0gdGhpcy5jZmcucGFkZGluZywNCiAgICAgICAgICAgIG47DQogICAgICAgICAgICByZXR1cm4gdGhpcy5feGZvcm1Nb2RlID09IHRoaXMuX0VOQ19YRk9STV9NT0RFID8gKHQucGFkKHRoaXMuX2RhdGEsIHRoaXMuYmxvY2tTaXplKSwgbiA9IHRoaXMuX3Byb2Nlc3MoITApKSA6IChuID0gdGhpcy5fcHJvY2VzcyghMCksIHQudW5wYWQobikpLA0KICAgICAgICAgICAgbg0KICAgICAgICB9LA0KICAgICAgICBibG9ja1NpemU6IDQNCiAgICB9KTsNCiAgICB2YXIgaCA9IHQuQ2lwaGVyUGFyYW1zID0gZi5leHRlbmQoew0KICAgICAgICBpbml0OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB0aGlzLm1peEluKG4pDQogICAgICAgIH0sDQogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICByZXR1cm4gKG4gfHwgdGhpcy5mb3JtYXR0ZXIpLnN0cmluZ2lmeSh0aGlzKQ0KICAgICAgICB9DQogICAgfSksDQogICAgcyA9IChpLmZvcm1hdCA9IHt9KS5PcGVuU1NMID0gew0KICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHZhciB0ID0gbi5jaXBoZXJ0ZXh0Ow0KICAgICAgICAgICAgcmV0dXJuIG4gPSBuLnNhbHQsDQogICAgICAgICAgICAobiA/IGUuY3JlYXRlKFsxMzk4ODkzNjg0LCAxNzAxMDc2ODMxXSkuY29uY2F0KG4pLmNvbmNhdCh0KSA6IHQpLnRvU3RyaW5nKGwpDQogICAgICAgIH0sDQogICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB2YXIgdCwgaTsNCiAgICAgICAgICAgIHJldHVybiBuID0gbC5wYXJzZShuKSwNCiAgICAgICAgICAgIHQgPSBuLndvcmRzLA0KICAgICAgICAgICAgMTM5ODg5MzY4NCA9PSB0WzBdICYmIDE3MDEwNzY4MzEgPT0gdFsxXSAmJiAoaSA9IGUuY3JlYXRlKHQuc2xpY2UoMiwgNCkpLCB0LnNwbGljZSgwLCA0KSwgbi5zaWdCeXRlcyAtPSAxNiksDQogICAgICAgICAgICBoLmNyZWF0ZSh7DQogICAgICAgICAgICAgICAgY2lwaGVydGV4dDogbiwNCiAgICAgICAgICAgICAgICBzYWx0OiBpDQogICAgICAgICAgICB9KQ0KICAgICAgICB9DQogICAgfSwNCiAgICB1ID0gdC5TZXJpYWxpemFibGVDaXBoZXIgPSBmLmV4dGVuZCh7DQogICAgICAgIGNmZzogZi5leHRlbmQoew0KICAgICAgICAgICAgZm9ybWF0OiBzDQogICAgICAgIH0pLA0KICAgICAgICBlbmNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICByID0gdGhpcy5jZmcuZXh0ZW5kKHIpOw0KICAgICAgICAgICAgdmFyIHUgPSBuLmNyZWF0ZUVuY3J5cHRvcihpLCByKTsNCiAgICAgICAgICAgIHJldHVybiB0ID0gdS5maW5hbGl6ZSh0KSwNCiAgICAgICAgICAgIHUgPSB1LmNmZywNCiAgICAgICAgICAgIGguY3JlYXRlKHsNCiAgICAgICAgICAgICAgICBjaXBoZXJ0ZXh0OiB0LA0KICAgICAgICAgICAgICAgIGtleTogaSwNCiAgICAgICAgICAgICAgICBpdjogdS5pdiwNCiAgICAgICAgICAgICAgICBhbGdvcml0aG06IG4sDQogICAgICAgICAgICAgICAgbW9kZTogdS5tb2RlLA0KICAgICAgICAgICAgICAgIHBhZGRpbmc6IHUucGFkZGluZywNCiAgICAgICAgICAgICAgICBibG9ja1NpemU6IG4uYmxvY2tTaXplLA0KICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogci5mb3JtYXQNCiAgICAgICAgICAgIH0pDQogICAgICAgIH0sDQogICAgICAgIGRlY3J5cHQ6IGZ1bmN0aW9uKG4sIHQsIGksIHIpIHsNCiAgICAgICAgICAgIHJldHVybiByID0gdGhpcy5jZmcuZXh0ZW5kKHIpLA0KICAgICAgICAgICAgdCA9IHRoaXMuX3BhcnNlKHQsIHIuZm9ybWF0KSwNCiAgICAgICAgICAgIG4uY3JlYXRlRGVjcnlwdG9yKGksIHIpLmZpbmFsaXplKHQuY2lwaGVydGV4dCkNCiAgICAgICAgfSwNCiAgICAgICAgX3BhcnNlOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICByZXR1cm4gInN0cmluZyIgPT0gdHlwZW9mIG4gPyB0LnBhcnNlKG4sIHRoaXMpIDogbg0KICAgICAgICB9DQogICAgfSksDQogICAgaSA9IChpLmtkZiA9IHt9KS5PcGVuU1NMID0gew0KICAgICAgICBleGVjdXRlOiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICByZXR1cm4gciB8fCAociA9IGUucmFuZG9tKDgpKSwNCiAgICAgICAgICAgIG4gPSB5LmNyZWF0ZSh7DQogICAgICAgICAgICAgICAga2V5U2l6ZTogdCArIGkNCiAgICAgICAgICAgIH0pLmNvbXB1dGUobiwgciksDQogICAgICAgICAgICBpID0gZS5jcmVhdGUobi53b3Jkcy5zbGljZSh0KSwgNCAqIGkpLA0KICAgICAgICAgICAgbi5zaWdCeXRlcyA9IDQgKiB0LA0KICAgICAgICAgICAgaC5jcmVhdGUoew0KICAgICAgICAgICAgICAgIGtleTogbiwNCiAgICAgICAgICAgICAgICBpdjogaSwNCiAgICAgICAgICAgICAgICBzYWx0OiByDQogICAgICAgICAgICB9KQ0KICAgICAgICB9DQogICAgfSwNCiAgICB2ID0gdC5QYXNzd29yZEJhc2VkQ2lwaGVyID0gdS5leHRlbmQoew0KICAgICAgICBjZmc6IHUuY2ZnLmV4dGVuZCh7DQogICAgICAgICAgICBrZGY6IGkNCiAgICAgICAgfSksDQogICAgICAgIGVuY3J5cHQ6IGZ1bmN0aW9uKG4sIHQsIGksIHIpIHsNCiAgICAgICAgICAgIHJldHVybiByID0gdGhpcy5jZmcuZXh0ZW5kKHIpLA0KICAgICAgICAgICAgaSA9IHIua2RmLmV4ZWN1dGUoaSwgbi5rZXlTaXplLCBuLml2U2l6ZSksDQogICAgICAgICAgICByLml2ID0gaS5pdiwNCiAgICAgICAgICAgIG4gPSB1LmVuY3J5cHQuY2FsbCh0aGlzLCBuLCB0LCBpLmtleSwgciksDQogICAgICAgICAgICBuLm1peEluKGkpLA0KICAgICAgICAgICAgbg0KICAgICAgICB9LA0KICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICByZXR1cm4gciA9IHRoaXMuY2ZnLmV4dGVuZChyKSwNCiAgICAgICAgICAgIHQgPSB0aGlzLl9wYXJzZSh0LCByLmZvcm1hdCksDQogICAgICAgICAgICBpID0gci5rZGYuZXhlY3V0ZShpLCBuLmtleVNpemUsIG4uaXZTaXplLCB0LnNhbHQpLA0KICAgICAgICAgICAgci5pdiA9IGkuaXYsDQogICAgICAgICAgICB1LmRlY3J5cHQuY2FsbCh0aGlzLCBuLCB0LCBpLmtleSwgcikNCiAgICAgICAgfQ0KICAgIH0pDQp9ICgpLA0KZnVuY3Rpb24oKSB7DQogICAgZm9yICh2YXIgaSwgdHQsIHMgPSBDcnlwdG9KUywNCiAgICB5ID0gcy5saWIuQmxvY2tDaXBoZXIsDQogICAgaCA9IHMuYWxnbywNCiAgICB0ID0gW10sIHAgPSBbXSwgdyA9IFtdLCBiID0gW10sIGsgPSBbXSwgZCA9IFtdLCBjID0gW10sIGwgPSBbXSwgYSA9IFtdLCB2ID0gW10sIHUgPSBbXSwgZiA9IDA7IDI1NiA+IGY7IGYrKykgdVtmXSA9IDEyOCA+IGYgPyBmIDw8IDEgOiBmIDw8IDEgXiAyODM7DQogICAgZm9yICh2YXIgciA9IDAsDQogICAgZSA9IDAsDQogICAgZiA9IDA7IDI1NiA+IGY7IGYrKykgew0KICAgICAgICBpID0gZSBeIGUgPDwgMSBeIGUgPDwgMiBeIGUgPDwgMyBeIGUgPDwgNDsNCiAgICAgICAgaSA9IGkgPj4+IDggXiBpICYgMjU1IF4gOTk7DQogICAgICAgIHRbcl0gPSBpOw0KICAgICAgICBwW2ldID0gcjsNCiAgICAgICAgdmFyIG8gPSB1W3JdLA0KICAgICAgICBnID0gdVtvXSwNCiAgICAgICAgbnQgPSB1W2ddLA0KICAgICAgICBuID0gMjU3ICogdVtpXSBeIDE2ODQzMDA4ICogaTsNCiAgICAgICAgd1tyXSA9IG4gPDwgMjQgfCBuID4+PiA4Ow0KICAgICAgICBiW3JdID0gbiA8PCAxNiB8IG4gPj4+IDE2Ow0KICAgICAgICBrW3JdID0gbiA8PCA4IHwgbiA+Pj4gMjQ7DQogICAgICAgIGRbcl0gPSBuOw0KICAgICAgICBuID0gMTY4NDMwMDkgKiBudCBeIDY1NTM3ICogZyBeIDI1NyAqIG8gXiAxNjg0MzAwOCAqIHI7DQogICAgICAgIGNbaV0gPSBuIDw8IDI0IHwgbiA+Pj4gODsNCiAgICAgICAgbFtpXSA9IG4gPDwgMTYgfCBuID4+PiAxNjsNCiAgICAgICAgYVtpXSA9IG4gPDwgOCB8IG4gPj4+IDI0Ow0KICAgICAgICB2W2ldID0gbjsNCiAgICAgICAgciA/IChyID0gbyBeIHVbdVt1W250IF4gb11dXSwgZSBePSB1W3VbZV1dKSA6IHIgPSBlID0gMQ0KICAgIH0NCiAgICB0dCA9IFswLCAxLCAyLCA0LCA4LCAxNiwgMzIsIDY0LCAxMjgsIDI3LCA1NF07DQogICAgaCA9IGguQUVTID0geS5leHRlbmQoew0KICAgICAgICBfZG9SZXNldDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBmb3IgKHZhciBuLCBmID0gdGhpcy5fa2V5LA0KICAgICAgICAgICAgZSA9IGYud29yZHMsDQogICAgICAgICAgICByID0gZi5zaWdCeXRlcyAvIDQsDQogICAgICAgICAgICBmID0gNCAqICgodGhpcy5fblJvdW5kcyA9IHIgKyA2KSArIDEpLCB1ID0gdGhpcy5fa2V5U2NoZWR1bGUgPSBbXSwgaSA9IDA7IGkgPCBmOyBpKyspIGkgPCByID8gdVtpXSA9IGVbaV0gOiAobiA9IHVbaSAtIDFdLCBpICUgciA/IDYgPCByICYmIDQgPT0gaSAlIHIgJiYgKG4gPSB0W24gPj4+IDI0XSA8PCAyNCB8IHRbbiA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgdFtuID4+PiA4ICYgMjU1XSA8PCA4IHwgdFtuICYgMjU1XSkgOiAobiA9IG4gPDwgOCB8IG4gPj4+IDI0LCBuID0gdFtuID4+PiAyNF0gPDwgMjQgfCB0W24gPj4+IDE2ICYgMjU1XSA8PCAxNiB8IHRbbiA+Pj4gOCAmIDI1NV0gPDwgOCB8IHRbbiAmIDI1NV0sIG4gXj0gdHRbaSAvIHIgfCAwXSA8PCAyNCksIHVbaV0gPSB1W2kgLSByXSBeIG4pOw0KICAgICAgICAgICAgZm9yIChlID0gdGhpcy5faW52S2V5U2NoZWR1bGUgPSBbXSwgciA9IDA7IHIgPCBmOyByKyspIGkgPSBmIC0gciwNCiAgICAgICAgICAgIG4gPSByICUgNCA/IHVbaV0gOiB1W2kgLSA0XSwNCiAgICAgICAgICAgIGVbcl0gPSA0ID4gciB8fCA0ID49IGkgPyBuOiBjW3RbbiA+Pj4gMjRdXSBeIGxbdFtuID4+PiAxNiAmIDI1NV1dIF4gYVt0W24gPj4+IDggJiAyNTVdXSBeIHZbdFtuICYgMjU1XV0NCiAgICAgICAgfSwNCiAgICAgICAgZW5jcnlwdEJsb2NrOiBmdW5jdGlvbihuLCBpKSB7DQogICAgICAgICAgICB0aGlzLl9kb0NyeXB0QmxvY2sobiwgaSwgdGhpcy5fa2V5U2NoZWR1bGUsIHcsIGIsIGssIGQsIHQpDQogICAgICAgIH0sDQogICAgICAgIGRlY3J5cHRCbG9jazogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgdmFyIGkgPSBuW3QgKyAxXTsNCiAgICAgICAgICAgIG5bdCArIDFdID0gblt0ICsgM107DQogICAgICAgICAgICBuW3QgKyAzXSA9IGk7DQogICAgICAgICAgICB0aGlzLl9kb0NyeXB0QmxvY2sobiwgdCwgdGhpcy5faW52S2V5U2NoZWR1bGUsIGMsIGwsIGEsIHYsIHApOw0KICAgICAgICAgICAgaSA9IG5bdCArIDFdOw0KICAgICAgICAgICAgblt0ICsgMV0gPSBuW3QgKyAzXTsNCiAgICAgICAgICAgIG5bdCArIDNdID0gaQ0KICAgICAgICB9LA0KICAgICAgICBfZG9DcnlwdEJsb2NrOiBmdW5jdGlvbihuLCB0LCBpLCByLCB1LCBmLCBlLCBvKSB7DQogICAgICAgICAgICBmb3IgKHZhciBiID0gdGhpcy5fblJvdW5kcywNCiAgICAgICAgICAgIGggPSBuW3RdIF4gaVswXSwgYyA9IG5bdCArIDFdIF4gaVsxXSwgbCA9IG5bdCArIDJdIF4gaVsyXSwgcyA9IG5bdCArIDNdIF4gaVszXSwgYSA9IDQsIHcgPSAxOyB3IDwgYjsgdysrKSB2YXIgdiA9IHJbaCA+Pj4gMjRdIF4gdVtjID4+PiAxNiAmIDI1NV0gXiBmW2wgPj4+IDggJiAyNTVdIF4gZVtzICYgMjU1XSBeIGlbYSsrXSwNCiAgICAgICAgICAgIHkgPSByW2MgPj4+IDI0XSBeIHVbbCA+Pj4gMTYgJiAyNTVdIF4gZltzID4+PiA4ICYgMjU1XSBeIGVbaCAmIDI1NV0gXiBpW2ErK10sDQogICAgICAgICAgICBwID0gcltsID4+PiAyNF0gXiB1W3MgPj4+IDE2ICYgMjU1XSBeIGZbaCA+Pj4gOCAmIDI1NV0gXiBlW2MgJiAyNTVdIF4gaVthKytdLA0KICAgICAgICAgICAgcyA9IHJbcyA+Pj4gMjRdIF4gdVtoID4+PiAxNiAmIDI1NV0gXiBmW2MgPj4+IDggJiAyNTVdIF4gZVtsICYgMjU1XSBeIGlbYSsrXSwNCiAgICAgICAgICAgIGggPSB2LA0KICAgICAgICAgICAgYyA9IHksDQogICAgICAgICAgICBsID0gcDsNCiAgICAgICAgICAgIHYgPSAob1toID4+PiAyNF0gPDwgMjQgfCBvW2MgPj4+IDE2ICYgMjU1XSA8PCAxNiB8IG9bbCA+Pj4gOCAmIDI1NV0gPDwgOCB8IG9bcyAmIDI1NV0pIF4gaVthKytdOw0KICAgICAgICAgICAgeSA9IChvW2MgPj4+IDI0XSA8PCAyNCB8IG9bbCA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgb1tzID4+PiA4ICYgMjU1XSA8PCA4IHwgb1toICYgMjU1XSkgXiBpW2ErK107DQogICAgICAgICAgICBwID0gKG9bbCA+Pj4gMjRdIDw8IDI0IHwgb1tzID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW2ggPj4+IDggJiAyNTVdIDw8IDggfCBvW2MgJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgIHMgPSAob1tzID4+PiAyNF0gPDwgMjQgfCBvW2ggPj4+IDE2ICYgMjU1XSA8PCAxNiB8IG9bYyA+Pj4gOCAmIDI1NV0gPDwgOCB8IG9bbCAmIDI1NV0pIF4gaVthKytdOw0KICAgICAgICAgICAgblt0XSA9IHY7DQogICAgICAgICAgICBuW3QgKyAxXSA9IHk7DQogICAgICAgICAgICBuW3QgKyAyXSA9IHA7DQogICAgICAgICAgICBuW3QgKyAzXSA9IHMNCiAgICAgICAgfSwNCiAgICAgICAga2V5U2l6ZTogOA0KICAgIH0pOw0KICAgIHMuQUVTID0geS5fY3JlYXRlSGVscGVyKGgpDQp9ICgpOw0KZnVuY3Rpb24gdmFsQWVzRW5jcnlwdFNldChpKSB7DQogICAgdmFyIG4sdCxyOw0KICAgIHRyeSB7DQogICAgICAgIG4gPSBhZXNEZWNyeXB0KGkpOw0KICAgICAgICBuICE9ICIiICYmICh0ID0gYWVzRW5jcnlwdChuKSwgdCAhPSBpICYmIChuID0gIiIpKQ0KICAgIH0gY2F0Y2gocikgew0KICAgICAgICBuID0gIiINCiAgICB9DQogICAgcmV0dXJuIG4gPT0gIiIgJiYgKHQgPSBhZXNFbmNyeXB0KGkpKTsNCn07DQpmdW5jdGlvbiBhZXNEZWNyeXB0KG4pIHsNCiAgICB2YXIgdCA9IENyeXB0b0pTLk1ENSgibG9naW4uMTg5LmNuIiksDQogICAgaSA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKHQpLA0KICAgIHIgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSgiMTIzNDU2NzgxMjM0NTY3OCIpOw0KICAgIHJldHVybiBDcnlwdG9KUy5BRVMuZGVjcnlwdChuLCBpLCB7DQogICAgICAgIGl2OiByDQogICAgfSkudG9TdHJpbmcoQ3J5cHRvSlMuZW5jLlV0ZjgpDQp9Ow0KZnVuY3Rpb24gYWVzRW5jcnlwdChuKSB7DQogICAgdmFyIHQgPSBDcnlwdG9KUy5NRDUoImxvZ2luLjE4OS5jbiIpLA0KICAgIGkgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSh0KSwNCiAgICByID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoIjEyMzQ1Njc4MTIzNDU2NzgiKSwNCiAgICB1ID0gQ3J5cHRvSlMuQUVTLmVuY3J5cHQobiwgaSwgew0KICAgICAgICBpdjogcg0KICAgIH0pOw0KICAgIHJldHVybiB1ICsgIiINCn07";

    @Override
    public HttpResult<Map<String, Object>> init(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_001").setFullUrl(templateUrl).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("get encrypt param:初始化失败!");
                return result.failure(ErrorCode.TASK_INIT_ERROR);
            }
            List<String> pscTokenList = XPathUtil.getXpath("//input[@id='pscToken']/@value", pageContent);
            if (!CollectionUtils.isEmpty(pscTokenList)) {
                pscToken = pscTokenList.get(0);
            }
            List<String> queryTypeList = XPathUtil.getXpath("//input[@name='queryType']/@value", pageContent);
            if (!CollectionUtils.isEmpty(queryTypeList)) {
                queryType = queryTypeList.get(0);
            }
            List<String> areaCodeList = XPathUtil.getXpath("//input[@name='areaCode']/@value", pageContent);
            if (!CollectionUtils.isEmpty(areaCodeList)) {
                areaCode = areaCodeList.get(0);
            }
            List<String> pwdTypeList = XPathUtil.getXpath("//input[@name='pwdType']/@value", pageContent);
            if (!CollectionUtils.isEmpty(pwdTypeList)) {
                pwdType = pwdTypeList.get(0);
            }
            List<String> firstInputList = XPathUtil.getXpath("//input[@name='firstInput']/@value", pageContent);
            if (!CollectionUtils.isEmpty(firstInputList)) {
                firstInput = firstInputList.get(0);
            }
            List<String> urlList = XPathUtil.getXpath("//input[@name='url']/@value", pageContent);
            if (!CollectionUtils.isEmpty(urlList)) {
                url = urlList.get(0);
            }
            return result.success();
        } catch (Exception e) {
            logger.error("登录-->初始化失败,param={}", param, e);
            return result.failure(ErrorCode.TASK_INIT_ERROR);
        }
    }

    @Override
    public HttpResult<String> refeshPicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return refeshPicCodeForLogin(param);
            case FormType.VALIDATE_USER_INFO:
                return refeshPicCodeForUserInfo(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshPicCodeForBillDetail(param);
            default:
                return new HttpResult<String>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }



    @Override
    public HttpResult<Map<String, Object>> validatePicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_USER_INFO:
                return validatePicCodeForUserInfo(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> refeshSmsCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshSmsCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }



    @Override
    public HttpResult<Object> defineProcess(OperatorParam param) {
        return null;
    }

    @Override
    public HttpResult<Map<String, Object>> submit(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return submitForLogin(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return submitForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }


    private HttpResult<String> refeshPicCodeForLogin(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://wapjl.189.cn/authImg?" + Math.random();
            String referer = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_002").setFullUrl(templateUrl).setReferer(referer).invoke();
            logger.info("登录-->图片验证码-->刷新成功,param={}", param);
            return result.success(response.getPageContentForBase64());
        } catch (Exception e) {
            logger.error("登录-->图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> submitForLogin(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            //wap端登录
            Invocable invocable = ScriptEngineUtil.createInvocableFromBase64(javaScript);
            String encryptPassword = invocable.invokeFunction("encrypt", new Object[]{pscToken, param.getPassword()}).toString();
            String templateUrl = "http://wapjl.189.cn/echn/login/login.action";
            String templateData = "queryValue=" + param.getMobile() + "&passWord=" + encryptPassword + "&randCode=" + param.getPicCode() + "&queryType=" + queryType + "&areaCode=" + areaCode + "&pwdType=" + pwdType + "&firstInput=" + firstInput + "&changeLoginFlag=&returnUrlFlag=&url=" + URLEncoder.encode(url, "UTF-8");
            String referer = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_003").setFullUrl(templateUrl).setRequestBody(templateData).setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            List<String> list = XPathUtil.getXpath("div:has(form):not(:has(div)) span:eq(0)/text()", pageContent);
            String msg = StringUtils.EMPTY;
            if (!CollectionUtils.isEmpty(list)) {
                msg = list.get(0);
            }
            if (StringUtils.isBlank(msg)) {
                list = XPathUtil.getXpath("span:has(img) + span/text()", pageContent);
                if (!CollectionUtils.isEmpty(list)) {
                    msg = list.get(0);
                }
            }
            templateUrl = "http://wapjl.189.cn/custquery/customerInfoQuery.action?servId=154";
            referer = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_004").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, String.valueOf(param.getMobile()))) {
                String customerName = PatternUtils.group(pageContent, "客户姓名：<\\/strong>\\s*([^：]+)\\s*<br", 1);
                customerName = PatternUtils.group(customerName, "(\\S*)", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "customerName", customerName);
                String idCardNo = PatternUtils.group(pageContent, "证件号码：<\\/strong>\\s*([^：]+)\\s*<br", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "idCardNo", idCardNo);
                String joinDate = PatternUtils.group(pageContent, "开通时间：<\\/strong>\\s*([^：]+)\\s*<\\/div>", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "joinDate", joinDate);
            } else {
                logger.error("wapjl189 login is error! errormessage: " + msg);
                logger.error(pageContent);
            }
            //删除cookie
            RedisUtils.del("task.cookie." + param.getTaskId());

            //web端登录
            templateUrl = "http://login.189.cn/login";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_005").setFullUrl(templateUrl).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("jl189 login request is error! errormessage: pre login failed");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }

            encryptPassword = invocable.invokeFunction("aesEncrypt", param.getPassword()).toString();
            templateUrl = "http://login.189.cn/login";
            templateData = "Account=" + param.getMobile() + "&UType=201&ProvinceID=09&AreaCode=&CityNo=&RandomFlag=0&Password=" + URLEncoder.encode(encryptPassword, "UTF-8") + "&Captcha=";
            referer = "http://login.189.cn/login";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_006").setFullUrl(templateUrl).setRequestBody(templateData).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("登录异常，请稍后重试。");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }

            templateUrl = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=00710602";
            referer = "http://www.189.cn/jl/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_007").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent) || StringUtils.containsNone(pageContent, "个人信息")) {
                logger.error("jl189 login failed! errormessage:login failed");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }

            templateUrl = "http://www.189.cn/login/index.do";
            referer = "http://www.189.cn/html/login/index.html";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_008").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isNotBlank(pageContent) && StringUtils.contains(pageContent, "errorDescription\":null")) {
                String cookieStr = TaskUtils.getCookieString(param.getTaskId());
                logger.info("mobile login success!,set cookie string: " + cookieStr);
                logger.info("登陆成功,param={}", param);
                return result.success();
            } else {
                logger.error("登陆失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登陆失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.LOGIN_ERROR);
        }
    }

    private HttpResult<String> refeshPicCodeForUserInfo(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://www.189.cn/dqmh/my189/checkMy189Session.do";
            String templateData = "fastcode=00710602";
            String referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=00710599";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_009").setFullUrl(templateUrl).setRequestBody(templateData).setReferer(referer).invoke();
            String pageContent = response.getPageContent();

            templateUrl = "http://www.189.cn/login/sso/ecs.do?method=linkTo&platNo=10030&toStUrl=http://jl.189.cn/service/bill/toDetailBillFra.action?fastcode=00710602&cityCode=jl";
            referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0010").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent) || StringUtils.containsNone(pageContent, "证件号码")) {
                logger.error("requestUrl is wrong!");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }
            templateUrl = "http://jl.189.cn/authImg";
            preUrl = response.getRedirectUrl();
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0011").setFullUrl(templateUrl).setReferer(preUrl).invoke();
            logger.info("详单-->图片验证码-->刷新成功,param={}", param);
            return result.success(response.getPageContentForBase64());
        } catch (Exception e) {
            logger.error("详单-->图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> validatePicCodeForUserInfo(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPicCode(), ErrorCode.EMPTY_PIC_CODE);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://jl.189.cn/realname/checkIdCardFra.action";
            String templateData = "ruleDetalId=109&certCode=" + param.getIdCard() + "&custName=" + param.getRealName() + "&randCode=" + param.getPicCode();
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_0012").setFullUrl(templateUrl).setRequestBody(templateData).setReferer(preUrl).invoke();
            String pageContent = response.getPageContent();
            if(StringUtils.isNotBlank(pageContent) && StringUtils.contains(pageContent,"result\":\"0")){
                logger.info("详单-->图片验证码-->校验成功,param={}", param);
                return result.success();
            }else{
                logger.error("详单-->图片验证码-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_PIC_CODE_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->图片验证码-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_PIC_CODE_ERROR);
        }
    }

    private HttpResult<String> refeshPicCodeForBillDetail(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try{
            String templateUrl = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            String referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?fastcode=00710602&cityCode=jl";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0013").setFullUrl(templateUrl).setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent) || StringUtils.containsNone(pageContent, "短信验证码")) {
                logger.error("requestUrl is wrong!");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }

            templateUrl = "http://jl.189.cn/authImg?1";
            referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0014").setFullUrl(templateUrl).setReferer(referer).invoke();
            TaskUtils.addTaskShare(param.getTaskId(), "secondPicCode", response.getPageContentForBase64());

            logger.info("详单-->第二次图片验证码-->刷新成功,param={}", param);
            return result.success();
        }catch (Exception e){
            logger.error("详单-->第二次图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }

    }

    private HttpResult<Map<String,Object>> refeshSmsCodeForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try{
            logger.info("详单-->短信验证码-->刷新成功,param={}", param);
            return result.success();
        }catch (Exception e){
            logger.error("详单-->短信验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String,Object>> submitForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = validatePicCodeForUserInfo(param);
        if (!result.getStatus()) {
            return result;
        }
        Response response = null;
        try{
            String templateUrl = "http://jl.189.cn/service/transaction/qryInacWorkOrder.action";
            String templateData = "fromPage=XDCX";
            String referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_0015").setFullUrl(templateUrl).setRequestBody(templateData).setReferer(referer).invoke();

            String secondPicCode = TaskUtils.getTaskShare(param.getTaskId(), "secondPicCode");
            templateUrl = "http://jl.189.cn/service/bill/doDetailBillFra.action";
            templateData = "sRandomCode=" + param.getSmsCode() + "&randCode=" + secondPicCode;
            referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_0015").setFullUrl(templateUrl).setRequestBody(templateData).setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if(StringUtils.isNotBlank(pageContent) && StringUtils.containsNone(pageContent,"billDetailValidate\":\"true")){
                logger.info("详单-->校验成功,param={}", param);
                return result.success();
            }else{
                logger.error("详单-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_UNEXPECTED_RESULT);
            }
        }catch (Exception e){
            logger.error("详单-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_ERROR);
        }
    }

}


