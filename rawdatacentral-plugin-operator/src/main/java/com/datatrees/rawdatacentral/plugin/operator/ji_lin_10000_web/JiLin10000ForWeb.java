package com.datatrees.rawdatacentral.plugin.operator.ji_lin_10000_web;

import javax.script.Invocable;
import java.net.URLEncoder;
import java.util.List;
import java.util.Map;

import com.datatrees.common.util.PatternUtils;
import com.datatrees.crawler.core.util.xpath.XPathUtil;
import com.datatrees.rawdatacentral.common.http.TaskHttpClient;
import com.datatrees.rawdatacentral.common.http.TaskUtils;
import com.datatrees.rawdatacentral.common.utils.CheckUtils;
import com.datatrees.rawdatacentral.common.utils.RedisUtils;
import com.datatrees.rawdatacentral.common.utils.ScriptEngineUtil;
import com.datatrees.rawdatacentral.domain.constant.FormType;
import com.datatrees.rawdatacentral.domain.enums.ErrorCode;
import com.datatrees.rawdatacentral.domain.enums.RequestType;
import com.datatrees.rawdatacentral.domain.operator.OperatorParam;
import com.datatrees.rawdatacentral.domain.result.HttpResult;
import com.datatrees.rawdatacentral.domain.vo.Response;
import com.datatrees.rawdatacentral.plugin.operator.common.LoginUtilsForChina10000Web;
import com.datatrees.rawdatacentral.service.OperatorPluginService;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.util.CollectionUtils;

/**
 * 吉林电信web端
 * 登录 wap端手机号，服务密码，图片验证码
 * 详单查询 短信验证码和两次图片验证码
 * User: yand
 * Date: 2017/10/10
 */
public class JiLin10000ForWeb implements OperatorPluginService {

    private static       Logger                     logger     = LoggerFactory.getLogger(JiLin10000ForWeb.class);
    private              LoginUtilsForChina10000Web loginUtils = new LoginUtilsForChina10000Web();
    private static final String                     javaScript
                                                               = "Ly93YXAgZW5jcnlwdApmdW5jdGlvbiBlbmNyeXB0KHN0cixrZXkpewogICAgdmFyIGNvZGUgPScnOwogICAgdmFyIGMgPSBzdHIuc3BsaXQoJycpOwogICAgdmFyIGsgPSBrZXkuc3BsaXQoJycpOwoKICAgIGZvcih2YXIgaT0wOyBpPGMubGVuZ3RoOyBpKyspewoKICAgICAgICB2YXIgaGMgPSBjW2ldLmNoYXJDb2RlQXQoKTsKICAgICAgICB2YXIga2kgPSBpOwoKICAgICAgICBpZihpID49IGsubGVuZ3RoKXsKICAgICAgICAgICAga2kgPSBpICUgay5sZW5ndGg7CiAgICAgICAgfQoKICAgICAgICB2YXIga3QgPSBrW2tpXS5jaGFyQ29kZUF0KCkgLSA5NzsKICAgICAgICBpZihoYyA+PSA5NyAmJiBoYyA8PSAxMjIpewogICAgICAgICAgICBoYyA9IDk3ICsgKCgoaGMgLTk3KSArIGt0KSAlIDI2KTsKICAgICAgICB9CiAgICAgICAgaWYoaGMgPj0gNjUgJiYgaGMgPD0gOTApewogICAgICAgICAgICBoYyA9IDY1ICsgKCgoaGMgLSA2NSkgKyBrdCkgJSAyNik7CiAgICAgICAgfQogICAgICAgIGlmKGhjID49NDggJiYgaGM8PTU3KXsKICAgICAgICAgICAgaWYoa3QgPj0gMTApewogICAgICAgICAgICAgICAga3QgPSAxMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBoYyA9IDQ4ICsgKCgoaGMgLSA0OCkgKyBrdCkgJSAxMCk7CiAgICAgICAgfQogICAgICAgIHZhciB0ZW1wID0gU3RyaW5nLmZyb21DaGFyQ29kZShoYyk7CiAgICAgICAgY29kZSArPSB0ZW1wOwoKICAgIH0KICAgIHJldHVybiBjb2RlOwp9CgoKCnZhciBDcnlwdG9KUyA9IENyeXB0b0pTIHx8CiAgICBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgdmFyIHUgPSB7fSwKICAgICAgICAgICAgZiA9IHUubGliID0ge30sCiAgICAgICAgICAgIG8gPSBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICBpID0gZi5CYXNlID0gewogICAgICAgICAgICAgICAgZXh0ZW5kOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgby5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gbmV3IG87CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG4gJiYgdC5taXhJbihuKSwKICAgICAgICAgICAgICAgICAgICB0Lmhhc093blByb3BlcnR5KCJpbml0IikgfHwgKHQuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LiRzdXBlci5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgdC5pbml0LnByb3RvdHlwZSA9IHQsCiAgICAgICAgICAgICAgICAgICAgICAgIHQuJHN1cGVyID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgdAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSB0aGlzLmV4dGVuZCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuLmluaXQuYXBwbHkobiwgYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgICAgICAgbgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgICAgICBtaXhJbjogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHQgaW4gbikgbi5oYXNPd25Qcm9wZXJ0eSh0KSAmJiAodGhpc1t0XSA9IG5bdF0pOwogICAgICAgICAgICAgICAgICAgIG4uaGFzT3duUHJvcGVydHkoInRvU3RyaW5nIikgJiYgKHRoaXMudG9TdHJpbmcgPSBuLnRvU3RyaW5nKQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbml0LnByb3RvdHlwZS5leHRlbmQodGhpcykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgciA9IGYuV29yZEFycmF5ID0gaS5leHRlbmQoewogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgaSkgewogICAgICAgICAgICAgICAgICAgIG4gPSB0aGlzLndvcmRzID0gbiB8fCBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpZ0J5dGVzID0gaSAhPSB0ID8gaTogNCAqIG4ubGVuZ3RoCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG4gfHwgbCkuc3RyaW5naWZ5KHRoaXMpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY29uY2F0OiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSB0aGlzLndvcmRzLAogICAgICAgICAgICAgICAgICAgICAgICByID0gbi53b3JkcywKICAgICAgICAgICAgICAgICAgICAgICAgdSA9IHRoaXMuc2lnQnl0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKG4gPSBuLnNpZ0J5dGVzLCB0aGlzLmNsYW1wKCksIHUgJSA0KSBmb3IgKHQgPSAwOyB0IDwgbjsgdCsrKSBpW3UgKyB0ID4+PiAyXSB8PSAoclt0ID4+PiAyXSA+Pj4gMjQgLSA4ICogKHQgJSA0KSAmIDI1NSkgPDwgMjQgLSA4ICogKCh1ICsgdCkgJSA0KTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICg2NTUzNSA8IHIubGVuZ3RoKSBmb3IgKHQgPSAwOyB0IDwgbjsgdCArPSA0KSBpW3UgKyB0ID4+PiAyXSA9IHJbdCA+Pj4gMl07CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpLnB1c2guYXBwbHkoaSwgcik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2lnQnl0ZXMgKz0gbiwKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNsYW1wOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHRoaXMud29yZHMsCiAgICAgICAgICAgICAgICAgICAgICAgIHQgPSB0aGlzLnNpZ0J5dGVzOwogICAgICAgICAgICAgICAgICAgIGlbdCA+Pj4gMl0gJj0gNDI5NDk2NzI5NSA8PCAzMiAtIDggKiAodCAlIDQpOwogICAgICAgICAgICAgICAgICAgIGkubGVuZ3RoID0gbi5jZWlsKHQgLyA0KQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IGkuY2xvbmUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbi53b3JkcyA9IHRoaXMud29yZHMuc2xpY2UoMCksCiAgICAgICAgICAgICAgICAgICAgICAgIG4KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByYW5kb206IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gW10sIHUgPSAwOyB1IDwgdDsgdSArPSA0KSBpLnB1c2goNDI5NDk2NzI5NiAqIG4ucmFuZG9tKCkgfCAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHIuaW5pdChpLCB0KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgZSA9IHUuZW5jID0ge30sCiAgICAgICAgICAgIGwgPSBlLkhleCA9IHsKICAgICAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHZhciB1ID0gbi53b3JkcywKICAgICAgICAgICAgICAgICAgICAgICAgaSwgdCwgcjsKICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSBuLnNpZ0J5dGVzLCBpID0gW10sIHQgPSAwOyB0IDwgbjsgdCsrKSByID0gdVt0ID4+PiAyXSA+Pj4gMjQgLSA4ICogKHQgJSA0KSAmIDI1NSwKICAgICAgICAgICAgICAgICAgICAgICAgaS5wdXNoKChyID4+PiA0KS50b1N0cmluZygxNikpLAogICAgICAgICAgICAgICAgICAgICAgICBpLnB1c2goKHIgJiAxNSkudG9TdHJpbmcoMTYpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaS5qb2luKCIiKQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IG4ubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHUgPSBbXSwgdCA9IDA7IHQgPCBpOyB0ICs9IDIpIHVbdCA+Pj4gM10gfD0gcGFyc2VJbnQobi5zdWJzdHIodCwgMiksIDE2KSA8PCAyNCAtIDQgKiAodCAlIDgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KHUsIGkgLyAyKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBzID0gZS5MYXRpbjEgPSB7CiAgICAgICAgICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgciA9IG4ud29yZHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGksIHQ7CiAgICAgICAgICAgICAgICAgICAgZm9yIChuID0gbi5zaWdCeXRlcywgaSA9IFtdLCB0ID0gMDsgdCA8IG47IHQrKykgaS5wdXNoKFN0cmluZy5mcm9tQ2hhckNvZGUoclt0ID4+PiAyXSA+Pj4gMjQgLSA4ICogKHQgJSA0KSAmIDI1NSkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpLmpvaW4oIiIpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gbi5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdSA9IFtdLCB0ID0gMDsgdCA8IGk7IHQrKykgdVt0ID4+PiAyXSB8PSAobi5jaGFyQ29kZUF0KHQpICYgMjU1KSA8PCAyNCAtIDggKiAodCAlIDQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KHUsIGkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGEgPSBlLlV0ZjggPSB7CiAgICAgICAgICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGVzY2FwZShzLnN0cmluZ2lmeShuKSkpCiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJNYWxmb3JtZWQgVVRGLTggZGF0YSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzLnBhcnNlKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChuKSkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGggPSBmLkJ1ZmZlcmVkQmxvY2tBbGdvcml0aG0gPSBpLmV4dGVuZCh7CiAgICAgICAgICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGF0YSA9IG5ldyByLmluaXQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbkRhdGFCeXRlcyA9IDAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfYXBwZW5kOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgInN0cmluZyIgPT0gdHlwZW9mIG4gJiYgKG4gPSBhLnBhcnNlKG4pKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXRhLmNvbmNhdChuKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9uRGF0YUJ5dGVzICs9IG4uc2lnQnl0ZXMKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfcHJvY2VzczogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmID0gdGhpcy5fZGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgcyA9IGYud29yZHMsCiAgICAgICAgICAgICAgICAgICAgICAgIHUgPSBmLnNpZ0J5dGVzLAogICAgICAgICAgICAgICAgICAgICAgICBlID0gdGhpcy5ibG9ja1NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgIG8gPSB1IC8gKDQgKiBlKSwKICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHQgPyBuLmNlaWwobykgOiBuLm1heCgobyB8IDApIC0gdGhpcy5fbWluQnVmZmVyU2l6ZSwgMCksCiAgICAgICAgICAgICAgICAgICAgICAgIGk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQgPSBvICogZSwgdSA9IG4ubWluKDQgKiB0LCB1KSwgdCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdDsgaSArPSBlKSB0aGlzLl9kb1Byb2Nlc3NCbG9jayhzLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHMuc3BsaWNlKDAsIHQpOwogICAgICAgICAgICAgICAgICAgICAgICBmLnNpZ0J5dGVzIC09IHUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQoaSwgdSkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBpLmNsb25lLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG4uX2RhdGEgPSB0aGlzLl9kYXRhLmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG4KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfbWluQnVmZmVyU2l6ZTogMAogICAgICAgICAgICB9KSwKICAgICAgICAgICAgYzsKICAgICAgICByZXR1cm4gZi5IYXNoZXIgPSBoLmV4dGVuZCh7CiAgICAgICAgICAgIGNmZzogaS5leHRlbmQoKSwKICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgdGhpcy5jZmcgPSB0aGlzLmNmZy5leHRlbmQobik7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaC5yZXNldC5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5fZG9SZXNldCgpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChuKSwKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9jZXNzKCksCiAgICAgICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICB9LAogICAgICAgICAgICBmaW5hbGl6ZTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgcmV0dXJuIG4gJiYgdGhpcy5fYXBwZW5kKG4pLAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2RvRmluYWxpemUoKQogICAgICAgICAgICB9LAogICAgICAgICAgICBibG9ja1NpemU6IDE2LAogICAgICAgICAgICBfY3JlYXRlSGVscGVyOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odCwgaSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgbi5pbml0KGkpLmZpbmFsaXplKHQpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9jcmVhdGVIbWFjSGVscGVyOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odCwgaSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgYy5ITUFDLmluaXQobiwgaSkuZmluYWxpemUodCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgICAgICBjID0gdS5hbGdvID0ge30sCiAgICAgICAgICAgIHUKICAgIH0gKE1hdGgpOyAoZnVuY3Rpb24oKSB7CiAgICB2YXIgbiA9IENyeXB0b0pTLAogICAgICAgIHQgPSBuLmxpYi5Xb3JkQXJyYXk7CiAgICBuLmVuYy5CYXNlNjQgPSB7CiAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgIHZhciBpID0gbi53b3JkcywKICAgICAgICAgICAgICAgIHUgPSBuLnNpZ0J5dGVzLAogICAgICAgICAgICAgICAgZiA9IHRoaXMuX21hcCwKICAgICAgICAgICAgICAgIHQsIGUsIHI7CiAgICAgICAgICAgIGZvciAobi5jbGFtcCgpLCBuID0gW10sIHQgPSAwOyB0IDwgdTsgdCArPSAzKSBmb3IgKGUgPSAoaVt0ID4+PiAyXSA+Pj4gMjQgLSA4ICogKHQgJSA0KSAmIDI1NSkgPDwgMTYgfCAoaVt0ICsgMSA+Pj4gMl0gPj4+IDI0IC0gOCAqICgodCArIDEpICUgNCkgJiAyNTUpIDw8IDggfCBpW3QgKyAyID4+PiAyXSA+Pj4gMjQgLSA4ICogKCh0ICsgMikgJSA0KSAmIDI1NSwgciA9IDA7IDQgPiByICYmIHQgKyAuNzUgKiByIDwgdTsgcisrKSBuLnB1c2goZi5jaGFyQXQoZSA+Pj4gNiAqICgzIC0gcikgJiA2MykpOwogICAgICAgICAgICBpZiAoaSA9IGYuY2hhckF0KDY0KSkgZm9yICg7IG4ubGVuZ3RoICUgNDspIG4ucHVzaChpKTsKICAgICAgICAgICAgcmV0dXJuIG4uam9pbigiIikKICAgICAgICB9LAogICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgIHZhciBlID0gbi5sZW5ndGgsCiAgICAgICAgICAgICAgICBmID0gdGhpcy5fbWFwLAogICAgICAgICAgICAgICAgaSA9IGYuY2hhckF0KDY0KSwKICAgICAgICAgICAgICAgIG8sCiAgICAgICAgICAgICAgICBzOwogICAgICAgICAgICBpICYmIChpID0gbi5pbmRleE9mKGkpLCAtMSAhPSBpICYmIChlID0gaSkpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gW10sIHUgPSAwLCByID0gMDsgciA8IGU7IHIrKykgciAlIDQgJiYgKG8gPSBmLmluZGV4T2Yobi5jaGFyQXQociAtIDEpKSA8PCAyICogKHIgJSA0KSwgcyA9IGYuaW5kZXhPZihuLmNoYXJBdChyKSkgPj4+IDYgLSAyICogKHIgJSA0KSwgaVt1ID4+PiAyXSB8PSAobyB8IHMpIDw8IDI0IC0gOCAqICh1ICUgNCksIHUrKyk7CiAgICAgICAgICAgIHJldHVybiB0LmNyZWF0ZShpLCB1KQogICAgICAgIH0sCiAgICAgICAgX21hcDogIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky89IgogICAgfQp9KSgpLAogICAgZnVuY3Rpb24obikgewogICAgICAgIGZ1bmN0aW9uIGkobiwgdCwgaSwgciwgdSwgZiwgZSkgewogICAgICAgICAgICByZXR1cm4gbiA9IG4gKyAodCAmIGkgfCB+dCAmIHIpICsgdSArIGUsCiAgICAgICAgICAgIChuIDw8IGYgfCBuID4+PiAzMiAtIGYpICsgdAogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByKG4sIHQsIGksIHIsIHUsIGYsIGUpIHsKICAgICAgICAgICAgcmV0dXJuIG4gPSBuICsgKHQgJiByIHwgaSAmIH5yKSArIHUgKyBlLAogICAgICAgICAgICAobiA8PCBmIHwgbiA+Pj4gMzIgLSBmKSArIHQKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdShuLCB0LCBpLCByLCB1LCBmLCBlKSB7CiAgICAgICAgICAgIHJldHVybiBuID0gbiArICh0IF4gaSBeIHIpICsgdSArIGUsCiAgICAgICAgICAgIChuIDw8IGYgfCBuID4+PiAzMiAtIGYpICsgdAogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmKG4sIHQsIGksIHIsIHUsIGYsIGUpIHsKICAgICAgICAgICAgcmV0dXJuIG4gPSBuICsgKGkgXiAodCB8IH5yKSkgKyB1ICsgZSwKICAgICAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIG8gPSBDcnlwdG9KUywKICAgICAgICAgICAgICAgICBlID0gby5saWIsCiAgICAgICAgICAgICAgICAgYyA9IGUuV29yZEFycmF5LAogICAgICAgICAgICAgICAgIHMgPSBlLkhhc2hlciwKICAgICAgICAgICAgICAgICBlID0gby5hbGdvLAogICAgICAgICAgICAgICAgIHQgPSBbXSwgaCA9IDA7IDY0ID4gaDsgaCsrKSB0W2hdID0gNDI5NDk2NzI5NiAqIG4uYWJzKG4uc2luKGggKyAxKSkgfCAwOwogICAgICAgIGUgPSBlLk1ENSA9IHMuZXh0ZW5kKHsKICAgICAgICAgICAgX2RvUmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhpcy5faGFzaCA9IG5ldyBjLmluaXQoWzE3MzI1ODQxOTMsIDQwMjMyMzM0MTcsIDI1NjIzODMxMDIsIDI3MTczMzg3OF0pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9kb1Byb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgZSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgdiwgYSwgbCA9IDA7IDE2ID4gbDsgbCsrKSB2ID0gZSArIGwsCiAgICAgICAgICAgICAgICAgICAgYSA9IG5bdl0sCiAgICAgICAgICAgICAgICAgICAgblt2XSA9IChhIDw8IDggfCBhID4+PiAyNCkgJiAxNjcxMTkzNSB8IChhIDw8IDI0IHwgYSA+Pj4gOCkgJiA0Mjc4MjU1MzYwOwogICAgICAgICAgICAgICAgdmFyIGwgPSB0aGlzLl9oYXNoLndvcmRzLAogICAgICAgICAgICAgICAgICAgIHYgPSBuW2UgKyAwXSwKICAgICAgICAgICAgICAgICAgICBhID0gbltlICsgMV0sCiAgICAgICAgICAgICAgICAgICAgeSA9IG5bZSArIDJdLAogICAgICAgICAgICAgICAgICAgIHAgPSBuW2UgKyAzXSwKICAgICAgICAgICAgICAgICAgICB3ID0gbltlICsgNF0sCiAgICAgICAgICAgICAgICAgICAgYiA9IG5bZSArIDVdLAogICAgICAgICAgICAgICAgICAgIGsgPSBuW2UgKyA2XSwKICAgICAgICAgICAgICAgICAgICBkID0gbltlICsgN10sCiAgICAgICAgICAgICAgICAgICAgZyA9IG5bZSArIDhdLAogICAgICAgICAgICAgICAgICAgIG50ID0gbltlICsgOV0sCiAgICAgICAgICAgICAgICAgICAgdHQgPSBuW2UgKyAxMF0sCiAgICAgICAgICAgICAgICAgICAgaXQgPSBuW2UgKyAxMV0sCiAgICAgICAgICAgICAgICAgICAgcnQgPSBuW2UgKyAxMl0sCiAgICAgICAgICAgICAgICAgICAgdXQgPSBuW2UgKyAxM10sCiAgICAgICAgICAgICAgICAgICAgZnQgPSBuW2UgKyAxNF0sCiAgICAgICAgICAgICAgICAgICAgZXQgPSBuW2UgKyAxNV0sCiAgICAgICAgICAgICAgICAgICAgbyA9IGxbMF0sCiAgICAgICAgICAgICAgICAgICAgcyA9IGxbMV0sCiAgICAgICAgICAgICAgICAgICAgaCA9IGxbMl0sCiAgICAgICAgICAgICAgICAgICAgYyA9IGxbM10sCiAgICAgICAgICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgdiwgNywgdFswXSksCiAgICAgICAgICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgYSwgMTIsIHRbMV0pLAogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIHksIDE3LCB0WzJdKSwKICAgICAgICAgICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBwLCAyMiwgdFszXSksCiAgICAgICAgICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgdywgNywgdFs0XSksCiAgICAgICAgICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgYiwgMTIsIHRbNV0pLAogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIGssIDE3LCB0WzZdKSwKICAgICAgICAgICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBkLCAyMiwgdFs3XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgZywgNywgdFs4XSksCiAgICAgICAgICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgbnQsIDEyLCB0WzldKSwKICAgICAgICAgICAgICAgICAgICBoID0gaShoLCBjLCBvLCBzLCB0dCwgMTcsIHRbMTBdKSwKICAgICAgICAgICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBpdCwgMjIsIHRbMTFdKSwKICAgICAgICAgICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCBydCwgNywgdFsxMl0pLAogICAgICAgICAgICAgICAgICAgIGMgPSBpKGMsIG8sIHMsIGgsIHV0LCAxMiwgdFsxM10pLAogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIGZ0LCAxNywgdFsxNF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGV0LCAyMiwgdFsxNV0pLAogICAgICAgICAgICAgICAgICAgIG8gPSByKG8sIHMsIGgsIGMsIGEsIDUsIHRbMTZdKSwKICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCBrLCA5LCB0WzE3XSksCiAgICAgICAgICAgICAgICAgICAgaCA9IHIoaCwgYywgbywgcywgaXQsIDE0LCB0WzE4XSksCiAgICAgICAgICAgICAgICAgICAgcyA9IHIocywgaCwgYywgbywgdiwgMjAsIHRbMTldKSwKICAgICAgICAgICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCBiLCA1LCB0WzIwXSksCiAgICAgICAgICAgICAgICAgICAgYyA9IHIoYywgbywgcywgaCwgdHQsIDksIHRbMjFdKSwKICAgICAgICAgICAgICAgICAgICBoID0gcihoLCBjLCBvLCBzLCBldCwgMTQsIHRbMjJdKSwKICAgICAgICAgICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCB3LCAyMCwgdFsyM10pLAogICAgICAgICAgICAgICAgICAgIG8gPSByKG8sIHMsIGgsIGMsIG50LCA1LCB0WzI0XSksCiAgICAgICAgICAgICAgICAgICAgYyA9IHIoYywgbywgcywgaCwgZnQsIDksIHRbMjVdKSwKICAgICAgICAgICAgICAgICAgICBoID0gcihoLCBjLCBvLCBzLCBwLCAxNCwgdFsyNl0pLAogICAgICAgICAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIGcsIDIwLCB0WzI3XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgdXQsIDUsIHRbMjhdKSwKICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCB5LCA5LCB0WzI5XSksCiAgICAgICAgICAgICAgICAgICAgaCA9IHIoaCwgYywgbywgcywgZCwgMTQsIHRbMzBdKSwKICAgICAgICAgICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCBydCwgMjAsIHRbMzFdKSwKICAgICAgICAgICAgICAgICAgICBvID0gdShvLCBzLCBoLCBjLCBiLCA0LCB0WzMyXSksCiAgICAgICAgICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgZywgMTEsIHRbMzNdKSwKICAgICAgICAgICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBpdCwgMTYsIHRbMzRdKSwKICAgICAgICAgICAgICAgICAgICBzID0gdShzLCBoLCBjLCBvLCBmdCwgMjMsIHRbMzVdKSwKICAgICAgICAgICAgICAgICAgICBvID0gdShvLCBzLCBoLCBjLCBhLCA0LCB0WzM2XSksCiAgICAgICAgICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgdywgMTEsIHRbMzddKSwKICAgICAgICAgICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBkLCAxNiwgdFszOF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIHR0LCAyMywgdFszOV0pLAogICAgICAgICAgICAgICAgICAgIG8gPSB1KG8sIHMsIGgsIGMsIHV0LCA0LCB0WzQwXSksCiAgICAgICAgICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgdiwgMTEsIHRbNDFdKSwKICAgICAgICAgICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBwLCAxNiwgdFs0Ml0pLAogICAgICAgICAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIGssIDIzLCB0WzQzXSksCiAgICAgICAgICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgbnQsIDQsIHRbNDRdKSwKICAgICAgICAgICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCBydCwgMTEsIHRbNDVdKSwKICAgICAgICAgICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBldCwgMTYsIHRbNDZdKSwKICAgICAgICAgICAgICAgICAgICBzID0gdShzLCBoLCBjLCBvLCB5LCAyMywgdFs0N10pLAogICAgICAgICAgICAgICAgICAgIG8gPSBmKG8sIHMsIGgsIGMsIHYsIDYsIHRbNDhdKSwKICAgICAgICAgICAgICAgICAgICBjID0gZihjLCBvLCBzLCBoLCBkLCAxMCwgdFs0OV0pLAogICAgICAgICAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIGZ0LCAxNSwgdFs1MF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIGIsIDIxLCB0WzUxXSksCiAgICAgICAgICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgcnQsIDYsIHRbNTJdKSwKICAgICAgICAgICAgICAgICAgICBjID0gZihjLCBvLCBzLCBoLCBwLCAxMCwgdFs1M10pLAogICAgICAgICAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIHR0LCAxNSwgdFs1NF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIGEsIDIxLCB0WzU1XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgZywgNiwgdFs1Nl0pLAogICAgICAgICAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGV0LCAxMCwgdFs1N10pLAogICAgICAgICAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIGssIDE1LCB0WzU4XSksCiAgICAgICAgICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgdXQsIDIxLCB0WzU5XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgdywgNiwgdFs2MF0pLAogICAgICAgICAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGl0LCAxMCwgdFs2MV0pLAogICAgICAgICAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIHksIDE1LCB0WzYyXSksCiAgICAgICAgICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgbnQsIDIxLCB0WzYzXSk7CiAgICAgICAgICAgICAgICBsWzBdID0gbFswXSArIG8gfCAwOwogICAgICAgICAgICAgICAgbFsxXSA9IGxbMV0gKyBzIHwgMDsKICAgICAgICAgICAgICAgIGxbMl0gPSBsWzJdICsgaCB8IDA7CiAgICAgICAgICAgICAgICBsWzNdID0gbFszXSArIGMgfCAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9kb0ZpbmFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciB1ID0gdGhpcy5fZGF0YSwKICAgICAgICAgICAgICAgICAgICByID0gdS53b3JkcywKICAgICAgICAgICAgICAgICAgICB0ID0gOCAqIHRoaXMuX25EYXRhQnl0ZXMsCiAgICAgICAgICAgICAgICAgICAgaSA9IDggKiB1LnNpZ0J5dGVzLAogICAgICAgICAgICAgICAgICAgIGY7CiAgICAgICAgICAgICAgICBmb3IgKHJbaSA+Pj4gNV0gfD0gMTI4IDw8IDI0IC0gaSAlIDMyLCBmID0gbi5mbG9vcih0IC8gNDI5NDk2NzI5NiksIHJbKGkgKyA2NCA+Pj4gOSA8PCA0KSArIDE1XSA9IChmIDw8IDggfCBmID4+PiAyNCkgJiAxNjcxMTkzNSB8IChmIDw8IDI0IHwgZiA+Pj4gOCkgJiA0Mjc4MjU1MzYwLCByWyhpICsgNjQgPj4+IDkgPDwgNCkgKyAxNF0gPSAodCA8PCA4IHwgdCA+Pj4gMjQpICYgMTY3MTE5MzUgfCAodCA8PCAyNCB8IHQgPj4+IDgpICYgNDI3ODI1NTM2MCwgdS5zaWdCeXRlcyA9IDQgKiAoci5sZW5ndGggKyAxKSwgdGhpcy5fcHJvY2VzcygpLCB1ID0gdGhpcy5faGFzaCwgciA9IHUud29yZHMsIHQgPSAwOyA0ID4gdDsgdCsrKSBpID0gclt0XSwKICAgICAgICAgICAgICAgICAgICByW3RdID0gKGkgPDwgOCB8IGkgPj4+IDI0KSAmIDE2NzExOTM1IHwgKGkgPDwgMjQgfCBpID4+PiA4KSAmIDQyNzgyNTUzNjA7CiAgICAgICAgICAgICAgICByZXR1cm4gdQogICAgICAgICAgICB9LAogICAgICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IHMuY2xvbmUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgIHJldHVybiBuLl9oYXNoID0gdGhpcy5faGFzaC5jbG9uZSgpLAogICAgICAgICAgICAgICAgICAgIG4KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG8uTUQ1ID0gcy5fY3JlYXRlSGVscGVyKGUpOwogICAgICAgIG8uSG1hY01ENSA9IHMuX2NyZWF0ZUhtYWNIZWxwZXIoZSkKICAgIH0gKE1hdGgpLAogICAgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHQgPSBDcnlwdG9KUywKICAgICAgICAgICAgbiA9IHQubGliLAogICAgICAgICAgICBpID0gbi5CYXNlLAogICAgICAgICAgICByID0gbi5Xb3JkQXJyYXksCiAgICAgICAgICAgIG4gPSB0LmFsZ28sCiAgICAgICAgICAgIHUgPSBuLkV2cEtERiA9IGkuZXh0ZW5kKHsKICAgICAgICAgICAgICAgIGNmZzogaS5leHRlbmQoewogICAgICAgICAgICAgICAgICAgIGtleVNpemU6IDQsCiAgICAgICAgICAgICAgICAgICAgaGFzaGVyOiBuLk1ENSwKICAgICAgICAgICAgICAgICAgICBpdGVyYXRpb25zOiAxCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNmZyA9IHRoaXMuY2ZnLmV4dGVuZChuKQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpLCBvLCBmID0gdGhpcy5jZmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdSA9IGYuaGFzaGVyLmNyZWF0ZSgpLCBlID0gci5jcmVhdGUoKSwgaCA9IGUud29yZHMsIHMgPSBmLmtleVNpemUsIGYgPSBmLml0ZXJhdGlvbnM7IGgubGVuZ3RoIDwgczspIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpICYmIHUudXBkYXRlKGkpLCBpID0gdS51cGRhdGUobikuZmluYWxpemUodCksIHUucmVzZXQoKSwgbyA9IDE7IG8gPCBmOyBvKyspIGkgPSB1LmZpbmFsaXplKGkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdS5yZXNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlLmNvbmNhdChpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5zaWdCeXRlcyA9IDQgKiBzLAogICAgICAgICAgICAgICAgICAgICAgICBlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIHQuRXZwS0RGID0gZnVuY3Rpb24obiwgdCwgaSkgewogICAgICAgICAgICByZXR1cm4gdS5jcmVhdGUoaSkuY29tcHV0ZShuLCB0KQogICAgICAgIH0KICAgIH0gKCk7CkNyeXB0b0pTLmxpYi5DaXBoZXIgfHwKZnVuY3Rpb24obikgewogICAgdmFyIGkgPSBDcnlwdG9KUywKICAgICAgICB0ID0gaS5saWIsCiAgICAgICAgZiA9IHQuQmFzZSwKICAgICAgICBlID0gdC5Xb3JkQXJyYXksCiAgICAgICAgYyA9IHQuQnVmZmVyZWRCbG9ja0FsZ29yaXRobSwKICAgICAgICBsID0gaS5lbmMuQmFzZTY0LAogICAgICAgIHkgPSBpLmFsZ28uRXZwS0RGLAogICAgICAgIG8gPSB0LkNpcGhlciA9IGMuZXh0ZW5kKHsKICAgICAgICAgICAgY2ZnOiBmLmV4dGVuZCgpLAogICAgICAgICAgICBjcmVhdGVFbmNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZSh0aGlzLl9FTkNfWEZPUk1fTU9ERSwgbiwgdCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlRGVjcnlwdG9yOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGUodGhpcy5fREVDX1hGT1JNX01PREUsIG4sIHQpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4sIHQsIGkpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2ZnID0gdGhpcy5jZmcuZXh0ZW5kKGkpOwogICAgICAgICAgICAgICAgdGhpcy5feGZvcm1Nb2RlID0gbjsKICAgICAgICAgICAgICAgIHRoaXMuX2tleSA9IHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgYy5yZXNldC5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5fZG9SZXNldCgpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHByb2Nlc3M6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9hcHBlbmQobiksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvY2VzcygpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZpbmFsaXplOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbiAmJiB0aGlzLl9hcHBlbmQobiksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZG9GaW5hbGl6ZSgpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGtleVNpemU6IDQsCiAgICAgICAgICAgIGl2U2l6ZTogNCwKICAgICAgICAgICAgX0VOQ19YRk9STV9NT0RFOiAxLAogICAgICAgICAgICBfREVDX1hGT1JNX01PREU6IDIsCiAgICAgICAgICAgIF9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgZW5jcnlwdDogZnVuY3Rpb24odCwgaSwgcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCJzdHJpbmciID09IHR5cGVvZiBpID8gdjogdSkuZW5jcnlwdChuLCB0LCBpLCByKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZGVjcnlwdDogZnVuY3Rpb24odCwgaSwgcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCJzdHJpbmciID09IHR5cGVvZiBpID8gdjogdSkuZGVjcnlwdChuLCB0LCBpLCByKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgdC5TdHJlYW1DaXBoZXIgPSBvLmV4dGVuZCh7CiAgICAgICAgX2RvRmluYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2VzcyghMCkKICAgICAgICB9LAogICAgICAgIGJsb2NrU2l6ZTogMQogICAgfSk7CiAgICB2YXIgcyA9IGkubW9kZSA9IHt9LAogICAgICAgIGEgPSBmdW5jdGlvbih0LCBpLCByKSB7CiAgICAgICAgICAgIHZhciBmID0gdGhpcy5faXYsCiAgICAgICAgICAgICAgICB1OwogICAgICAgICAgICBmb3IgKGYgPyB0aGlzLl9pdiA9IG46IGYgPSB0aGlzLl9wcmV2QmxvY2ssIHUgPSAwOyB1IDwgcjsgdSsrKSB0W2kgKyB1XSBePSBmW3VdCiAgICAgICAgfSwKICAgICAgICByID0gKHQuQmxvY2tDaXBoZXJNb2RlID0gZi5leHRlbmQoewogICAgICAgICAgICBjcmVhdGVFbmNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLkVuY3J5cHRvci5jcmVhdGUobiwgdCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY3JlYXRlRGVjcnlwdG9yOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5EZWNyeXB0b3IuY3JlYXRlKG4sIHQpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NpcGhlciA9IG47CiAgICAgICAgICAgICAgICB0aGlzLl9pdiA9IHQKICAgICAgICAgICAgfQogICAgICAgIH0pKS5leHRlbmQoKTsKICAgIHIuRW5jcnlwdG9yID0gci5leHRlbmQoewogICAgICAgIHByb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICB2YXIgaSA9IHRoaXMuX2NpcGhlciwKICAgICAgICAgICAgICAgIHIgPSBpLmJsb2NrU2l6ZTsKICAgICAgICAgICAgYS5jYWxsKHRoaXMsIG4sIHQsIHIpOwogICAgICAgICAgICBpLmVuY3J5cHRCbG9jayhuLCB0KTsKICAgICAgICAgICAgdGhpcy5fcHJldkJsb2NrID0gbi5zbGljZSh0LCB0ICsgcikKICAgICAgICB9CiAgICB9KTsKICAgIHIuRGVjcnlwdG9yID0gci5leHRlbmQoewogICAgICAgIHByb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICB2YXIgaSA9IHRoaXMuX2NpcGhlciwKICAgICAgICAgICAgICAgIHIgPSBpLmJsb2NrU2l6ZSwKICAgICAgICAgICAgICAgIHUgPSBuLnNsaWNlKHQsIHQgKyByKTsKICAgICAgICAgICAgaS5kZWNyeXB0QmxvY2sobiwgdCk7CiAgICAgICAgICAgIGEuY2FsbCh0aGlzLCBuLCB0LCByKTsKICAgICAgICAgICAgdGhpcy5fcHJldkJsb2NrID0gdQogICAgICAgIH0KICAgIH0pOwogICAgcyA9IHMuQ0JDID0gcjsKICAgIHIgPSAoaS5wYWQgPSB7fSkuUGtjczcgPSB7CiAgICAgICAgcGFkOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSA0ICogdCwKICAgICAgICAgICAgICAgICAgICAgaSA9IGkgLSBuLnNpZ0J5dGVzICUgaSwKICAgICAgICAgICAgICAgICAgICAgZiA9IGkgPDwgMjQgfCBpIDw8IDE2IHwgaSA8PCA4IHwgaSwKICAgICAgICAgICAgICAgICAgICAgciA9IFtdLCB1ID0gMDsgdSA8IGk7IHUgKz0gNCkgci5wdXNoKGYpOwogICAgICAgICAgICBpID0gZS5jcmVhdGUociwgaSk7CiAgICAgICAgICAgIG4uY29uY2F0KGkpCiAgICAgICAgfSwKICAgICAgICB1bnBhZDogZnVuY3Rpb24obikgewogICAgICAgICAgICBuLnNpZ0J5dGVzIC09IG4ud29yZHNbbi5zaWdCeXRlcyAtIDEgPj4+IDJdICYgMjU1CiAgICAgICAgfQogICAgfTsKICAgIHQuQmxvY2tDaXBoZXIgPSBvLmV4dGVuZCh7CiAgICAgICAgY2ZnOiBvLmNmZy5leHRlbmQoewogICAgICAgICAgICBtb2RlOiBzLAogICAgICAgICAgICBwYWRkaW5nOiByCiAgICAgICAgfSksCiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdDsKICAgICAgICAgICAgby5yZXNldC5jYWxsKHRoaXMpOwogICAgICAgICAgICB2YXIgbiA9IHRoaXMuY2ZnLAogICAgICAgICAgICAgICAgaSA9IG4uaXYsCiAgICAgICAgICAgICAgICBuID0gbi5tb2RlOwogICAgICAgICAgICB0aGlzLl94Zm9ybU1vZGUgPT0gdGhpcy5fRU5DX1hGT1JNX01PREUgPyB0ID0gbi5jcmVhdGVFbmNyeXB0b3I6ICh0ID0gbi5jcmVhdGVEZWNyeXB0b3IsIHRoaXMuX21pbkJ1ZmZlclNpemUgPSAxKTsKICAgICAgICAgICAgdGhpcy5fbW9kZSA9IHQuY2FsbChuLCB0aGlzLCBpICYmIGkud29yZHMpCiAgICAgICAgfSwKICAgICAgICBfZG9Qcm9jZXNzQmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgdGhpcy5fbW9kZS5wcm9jZXNzQmxvY2sobiwgdCkKICAgICAgICB9LAogICAgICAgIF9kb0ZpbmFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHQgPSB0aGlzLmNmZy5wYWRkaW5nLAogICAgICAgICAgICAgICAgbjsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3hmb3JtTW9kZSA9PSB0aGlzLl9FTkNfWEZPUk1fTU9ERSA/ICh0LnBhZCh0aGlzLl9kYXRhLCB0aGlzLmJsb2NrU2l6ZSksIG4gPSB0aGlzLl9wcm9jZXNzKCEwKSkgOiAobiA9IHRoaXMuX3Byb2Nlc3MoITApLCB0LnVucGFkKG4pKSwKICAgICAgICAgICAgICAgIG4KICAgICAgICB9LAogICAgICAgIGJsb2NrU2l6ZTogNAogICAgfSk7CiAgICB2YXIgaCA9IHQuQ2lwaGVyUGFyYW1zID0gZi5leHRlbmQoewogICAgICAgICAgICBpbml0OiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peEluKG4pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKG4gfHwgdGhpcy5mb3JtYXR0ZXIpLnN0cmluZ2lmeSh0aGlzKQogICAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgcyA9IChpLmZvcm1hdCA9IHt9KS5PcGVuU1NMID0gewogICAgICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gbi5jaXBoZXJ0ZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuIG4gPSBuLnNhbHQsCiAgICAgICAgICAgICAgICAgICAgKG4gPyBlLmNyZWF0ZShbMTM5ODg5MzY4NCwgMTcwMTA3NjgzMV0pLmNvbmNhdChuKS5jb25jYXQodCkgOiB0KS50b1N0cmluZyhsKQogICAgICAgICAgICB9LAogICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgdmFyIHQsIGk7CiAgICAgICAgICAgICAgICByZXR1cm4gbiA9IGwucGFyc2UobiksCiAgICAgICAgICAgICAgICAgICAgdCA9IG4ud29yZHMsCiAgICAgICAgICAgICAgICAxMzk4ODkzNjg0ID09IHRbMF0gJiYgMTcwMTA3NjgzMSA9PSB0WzFdICYmIChpID0gZS5jcmVhdGUodC5zbGljZSgyLCA0KSksIHQuc3BsaWNlKDAsIDQpLCBuLnNpZ0J5dGVzIC09IDE2KSwKICAgICAgICAgICAgICAgICAgICBoLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGNpcGhlcnRleHQ6IG4sCiAgICAgICAgICAgICAgICAgICAgICAgIHNhbHQ6IGkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB1ID0gdC5TZXJpYWxpemFibGVDaXBoZXIgPSBmLmV4dGVuZCh7CiAgICAgICAgICAgIGNmZzogZi5leHRlbmQoewogICAgICAgICAgICAgICAgZm9ybWF0OiBzCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBlbmNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7CiAgICAgICAgICAgICAgICByID0gdGhpcy5jZmcuZXh0ZW5kKHIpOwogICAgICAgICAgICAgICAgdmFyIHUgPSBuLmNyZWF0ZUVuY3J5cHRvcihpLCByKTsKICAgICAgICAgICAgICAgIHJldHVybiB0ID0gdS5maW5hbGl6ZSh0KSwKICAgICAgICAgICAgICAgICAgICB1ID0gdS5jZmcsCiAgICAgICAgICAgICAgICAgICAgaC5jcmVhdGUoewogICAgICAgICAgICAgICAgICAgICAgICBjaXBoZXJ0ZXh0OiB0LAogICAgICAgICAgICAgICAgICAgICAgICBrZXk6IGksCiAgICAgICAgICAgICAgICAgICAgICAgIGl2OiB1Lml2LAogICAgICAgICAgICAgICAgICAgICAgICBhbGdvcml0aG06IG4sCiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGU6IHUubW9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogdS5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBibG9ja1NpemU6IG4uYmxvY2tTaXplLAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IHIuZm9ybWF0CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVjcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHIgPSB0aGlzLmNmZy5leHRlbmQociksCiAgICAgICAgICAgICAgICAgICAgdCA9IHRoaXMuX3BhcnNlKHQsIHIuZm9ybWF0KSwKICAgICAgICAgICAgICAgICAgICBuLmNyZWF0ZURlY3J5cHRvcihpLCByKS5maW5hbGl6ZSh0LmNpcGhlcnRleHQpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9wYXJzZTogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciID09IHR5cGVvZiBuID8gdC5wYXJzZShuLCB0aGlzKSA6IG4KICAgICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgIGkgPSAoaS5rZGYgPSB7fSkuT3BlblNTTCA9IHsKICAgICAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24obiwgdCwgaSwgcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHIgfHwgKHIgPSBlLnJhbmRvbSg4KSksCiAgICAgICAgICAgICAgICAgICAgbiA9IHkuY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5U2l6ZTogdCArIGkKICAgICAgICAgICAgICAgICAgICB9KS5jb21wdXRlKG4sIHIpLAogICAgICAgICAgICAgICAgICAgIGkgPSBlLmNyZWF0ZShuLndvcmRzLnNsaWNlKHQpLCA0ICogaSksCiAgICAgICAgICAgICAgICAgICAgbi5zaWdCeXRlcyA9IDQgKiB0LAogICAgICAgICAgICAgICAgICAgIGguY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBuLAogICAgICAgICAgICAgICAgICAgICAgICBpdjogaSwKICAgICAgICAgICAgICAgICAgICAgICAgc2FsdDogcgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHYgPSB0LlBhc3N3b3JkQmFzZWRDaXBoZXIgPSB1LmV4dGVuZCh7CiAgICAgICAgICAgIGNmZzogdS5jZmcuZXh0ZW5kKHsKICAgICAgICAgICAgICAgIGtkZjogaQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgZW5jcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHIgPSB0aGlzLmNmZy5leHRlbmQociksCiAgICAgICAgICAgICAgICAgICAgaSA9IHIua2RmLmV4ZWN1dGUoaSwgbi5rZXlTaXplLCBuLml2U2l6ZSksCiAgICAgICAgICAgICAgICAgICAgci5pdiA9IGkuaXYsCiAgICAgICAgICAgICAgICAgICAgbiA9IHUuZW5jcnlwdC5jYWxsKHRoaXMsIG4sIHQsIGkua2V5LCByKSwKICAgICAgICAgICAgICAgICAgICBuLm1peEluKGkpLAogICAgICAgICAgICAgICAgICAgIG4KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVjcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHIgPSB0aGlzLmNmZy5leHRlbmQociksCiAgICAgICAgICAgICAgICAgICAgdCA9IHRoaXMuX3BhcnNlKHQsIHIuZm9ybWF0KSwKICAgICAgICAgICAgICAgICAgICBpID0gci5rZGYuZXhlY3V0ZShpLCBuLmtleVNpemUsIG4uaXZTaXplLCB0LnNhbHQpLAogICAgICAgICAgICAgICAgICAgIHIuaXYgPSBpLml2LAogICAgICAgICAgICAgICAgICAgIHUuZGVjcnlwdC5jYWxsKHRoaXMsIG4sIHQsIGkua2V5LCByKQogICAgICAgICAgICB9CiAgICAgICAgfSkKfSAoKSwKICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGksIHR0LCBzID0gQ3J5cHRvSlMsCiAgICAgICAgICAgICAgICAgeSA9IHMubGliLkJsb2NrQ2lwaGVyLAogICAgICAgICAgICAgICAgIGggPSBzLmFsZ28sCiAgICAgICAgICAgICAgICAgdCA9IFtdLCBwID0gW10sIHcgPSBbXSwgYiA9IFtdLCBrID0gW10sIGQgPSBbXSwgYyA9IFtdLCBsID0gW10sIGEgPSBbXSwgdiA9IFtdLCB1ID0gW10sIGYgPSAwOyAyNTYgPiBmOyBmKyspIHVbZl0gPSAxMjggPiBmID8gZiA8PCAxIDogZiA8PCAxIF4gMjgzOwogICAgICAgIGZvciAodmFyIHIgPSAwLAogICAgICAgICAgICAgICAgIGUgPSAwLAogICAgICAgICAgICAgICAgIGYgPSAwOyAyNTYgPiBmOyBmKyspIHsKICAgICAgICAgICAgaSA9IGUgXiBlIDw8IDEgXiBlIDw8IDIgXiBlIDw8IDMgXiBlIDw8IDQ7CiAgICAgICAgICAgIGkgPSBpID4+PiA4IF4gaSAmIDI1NSBeIDk5OwogICAgICAgICAgICB0W3JdID0gaTsKICAgICAgICAgICAgcFtpXSA9IHI7CiAgICAgICAgICAgIHZhciBvID0gdVtyXSwKICAgICAgICAgICAgICAgIGcgPSB1W29dLAogICAgICAgICAgICAgICAgbnQgPSB1W2ddLAogICAgICAgICAgICAgICAgbiA9IDI1NyAqIHVbaV0gXiAxNjg0MzAwOCAqIGk7CiAgICAgICAgICAgIHdbcl0gPSBuIDw8IDI0IHwgbiA+Pj4gODsKICAgICAgICAgICAgYltyXSA9IG4gPDwgMTYgfCBuID4+PiAxNjsKICAgICAgICAgICAga1tyXSA9IG4gPDwgOCB8IG4gPj4+IDI0OwogICAgICAgICAgICBkW3JdID0gbjsKICAgICAgICAgICAgbiA9IDE2ODQzMDA5ICogbnQgXiA2NTUzNyAqIGcgXiAyNTcgKiBvIF4gMTY4NDMwMDggKiByOwogICAgICAgICAgICBjW2ldID0gbiA8PCAyNCB8IG4gPj4+IDg7CiAgICAgICAgICAgIGxbaV0gPSBuIDw8IDE2IHwgbiA+Pj4gMTY7CiAgICAgICAgICAgIGFbaV0gPSBuIDw8IDggfCBuID4+PiAyNDsKICAgICAgICAgICAgdltpXSA9IG47CiAgICAgICAgICAgIHIgPyAociA9IG8gXiB1W3VbdVtudCBeIG9dXV0sIGUgXj0gdVt1W2VdXSkgOiByID0gZSA9IDEKICAgICAgICB9CiAgICAgICAgdHQgPSBbMCwgMSwgMiwgNCwgOCwgMTYsIDMyLCA2NCwgMTI4LCAyNywgNTRdOwogICAgICAgIGggPSBoLkFFUyA9IHkuZXh0ZW5kKHsKICAgICAgICAgICAgX2RvUmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgbiwgZiA9IHRoaXMuX2tleSwKICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBmLndvcmRzLAogICAgICAgICAgICAgICAgICAgICAgICAgciA9IGYuc2lnQnl0ZXMgLyA0LAogICAgICAgICAgICAgICAgICAgICAgICAgZiA9IDQgKiAoKHRoaXMuX25Sb3VuZHMgPSByICsgNikgKyAxKSwgdSA9IHRoaXMuX2tleVNjaGVkdWxlID0gW10sIGkgPSAwOyBpIDwgZjsgaSsrKSBpIDwgciA/IHVbaV0gPSBlW2ldIDogKG4gPSB1W2kgLSAxXSwgaSAlIHIgPyA2IDwgciAmJiA0ID09IGkgJSByICYmIChuID0gdFtuID4+PiAyNF0gPDwgMjQgfCB0W24gPj4+IDE2ICYgMjU1XSA8PCAxNiB8IHRbbiA+Pj4gOCAmIDI1NV0gPDwgOCB8IHRbbiAmIDI1NV0pIDogKG4gPSBuIDw8IDggfCBuID4+PiAyNCwgbiA9IHRbbiA+Pj4gMjRdIDw8IDI0IHwgdFtuID4+PiAxNiAmIDI1NV0gPDwgMTYgfCB0W24gPj4+IDggJiAyNTVdIDw8IDggfCB0W24gJiAyNTVdLCBuIF49IHR0W2kgLyByIHwgMF0gPDwgMjQpLCB1W2ldID0gdVtpIC0gcl0gXiBuKTsKICAgICAgICAgICAgICAgIGZvciAoZSA9IHRoaXMuX2ludktleVNjaGVkdWxlID0gW10sIHIgPSAwOyByIDwgZjsgcisrKSBpID0gZiAtIHIsCiAgICAgICAgICAgICAgICAgICAgbiA9IHIgJSA0ID8gdVtpXSA6IHVbaSAtIDRdLAogICAgICAgICAgICAgICAgICAgIGVbcl0gPSA0ID4gciB8fCA0ID49IGkgPyBuOiBjW3RbbiA+Pj4gMjRdXSBeIGxbdFtuID4+PiAxNiAmIDI1NV1dIF4gYVt0W24gPj4+IDggJiAyNTVdXSBeIHZbdFtuICYgMjU1XV0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZW5jcnlwdEJsb2NrOiBmdW5jdGlvbihuLCBpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9kb0NyeXB0QmxvY2sobiwgaSwgdGhpcy5fa2V5U2NoZWR1bGUsIHcsIGIsIGssIGQsIHQpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY3J5cHRCbG9jazogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSBuW3QgKyAxXTsKICAgICAgICAgICAgICAgIG5bdCArIDFdID0gblt0ICsgM107CiAgICAgICAgICAgICAgICBuW3QgKyAzXSA9IGk7CiAgICAgICAgICAgICAgICB0aGlzLl9kb0NyeXB0QmxvY2sobiwgdCwgdGhpcy5faW52S2V5U2NoZWR1bGUsIGMsIGwsIGEsIHYsIHApOwogICAgICAgICAgICAgICAgaSA9IG5bdCArIDFdOwogICAgICAgICAgICAgICAgblt0ICsgMV0gPSBuW3QgKyAzXTsKICAgICAgICAgICAgICAgIG5bdCArIDNdID0gaQogICAgICAgICAgICB9LAogICAgICAgICAgICBfZG9DcnlwdEJsb2NrOiBmdW5jdGlvbihuLCB0LCBpLCByLCB1LCBmLCBlLCBvKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBiID0gdGhpcy5fblJvdW5kcywKICAgICAgICAgICAgICAgICAgICAgICAgIGggPSBuW3RdIF4gaVswXSwgYyA9IG5bdCArIDFdIF4gaVsxXSwgbCA9IG5bdCArIDJdIF4gaVsyXSwgcyA9IG5bdCArIDNdIF4gaVszXSwgYSA9IDQsIHcgPSAxOyB3IDwgYjsgdysrKSB2YXIgdiA9IHJbaCA+Pj4gMjRdIF4gdVtjID4+PiAxNiAmIDI1NV0gXiBmW2wgPj4+IDggJiAyNTVdIF4gZVtzICYgMjU1XSBeIGlbYSsrXSwKICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSByW2MgPj4+IDI0XSBeIHVbbCA+Pj4gMTYgJiAyNTVdIF4gZltzID4+PiA4ICYgMjU1XSBeIGVbaCAmIDI1NV0gXiBpW2ErK10sCiAgICAgICAgICAgICAgICAgICAgICAgICBwID0gcltsID4+PiAyNF0gXiB1W3MgPj4+IDE2ICYgMjU1XSBeIGZbaCA+Pj4gOCAmIDI1NV0gXiBlW2MgJiAyNTVdIF4gaVthKytdLAogICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHJbcyA+Pj4gMjRdIF4gdVtoID4+PiAxNiAmIDI1NV0gXiBmW2MgPj4+IDggJiAyNTVdIF4gZVtsICYgMjU1XSBeIGlbYSsrXSwKICAgICAgICAgICAgICAgICAgICAgICAgIGggPSB2LAogICAgICAgICAgICAgICAgICAgICAgICAgYyA9IHksCiAgICAgICAgICAgICAgICAgICAgICAgICBsID0gcDsKICAgICAgICAgICAgICAgIHYgPSAob1toID4+PiAyNF0gPDwgMjQgfCBvW2MgPj4+IDE2ICYgMjU1XSA8PCAxNiB8IG9bbCA+Pj4gOCAmIDI1NV0gPDwgOCB8IG9bcyAmIDI1NV0pIF4gaVthKytdOwogICAgICAgICAgICAgICAgeSA9IChvW2MgPj4+IDI0XSA8PCAyNCB8IG9bbCA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgb1tzID4+PiA4ICYgMjU1XSA8PCA4IHwgb1toICYgMjU1XSkgXiBpW2ErK107CiAgICAgICAgICAgICAgICBwID0gKG9bbCA+Pj4gMjRdIDw8IDI0IHwgb1tzID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW2ggPj4+IDggJiAyNTVdIDw8IDggfCBvW2MgJiAyNTVdKSBeIGlbYSsrXTsKICAgICAgICAgICAgICAgIHMgPSAob1tzID4+PiAyNF0gPDwgMjQgfCBvW2ggPj4+IDE2ICYgMjU1XSA8PCAxNiB8IG9bYyA+Pj4gOCAmIDI1NV0gPDwgOCB8IG9bbCAmIDI1NV0pIF4gaVthKytdOwogICAgICAgICAgICAgICAgblt0XSA9IHY7CiAgICAgICAgICAgICAgICBuW3QgKyAxXSA9IHk7CiAgICAgICAgICAgICAgICBuW3QgKyAyXSA9IHA7CiAgICAgICAgICAgICAgICBuW3QgKyAzXSA9IHMKICAgICAgICAgICAgfSwKICAgICAgICAgICAga2V5U2l6ZTogOAogICAgICAgIH0pOwogICAgICAgIHMuQUVTID0geS5fY3JlYXRlSGVscGVyKGgpCiAgICB9ICgpOwpmdW5jdGlvbiB2YWxBZXNFbmNyeXB0U2V0KGkpIHsKICAgIHZhciBuLHQscjsKICAgIHRyeSB7CiAgICAgICAgbiA9IGFlc0RlY3J5cHQoaSk7CiAgICAgICAgbiAhPSAiIiAmJiAodCA9IGFlc0VuY3J5cHQobiksIHQgIT0gaSAmJiAobiA9ICIiKSkKICAgIH0gY2F0Y2gocikgewogICAgICAgIG4gPSAiIgogICAgfQogICAgcmV0dXJuIG4gPT0gIiIgJiYgKHQgPSBhZXNFbmNyeXB0KGkpKTsKfTsKZnVuY3Rpb24gYWVzRGVjcnlwdChuKSB7CiAgICB2YXIgdCA9IENyeXB0b0pTLk1ENSgibG9naW4uMTg5LmNuIiksCiAgICAgICAgaSA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKHQpLAogICAgICAgIHIgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSgiMTIzNDU2NzgxMjM0NTY3OCIpOwogICAgcmV0dXJuIENyeXB0b0pTLkFFUy5kZWNyeXB0KG4sIGksIHsKICAgICAgICBpdjogcgogICAgfSkudG9TdHJpbmcoQ3J5cHRvSlMuZW5jLlV0ZjgpCn07CmZ1bmN0aW9uIGFlc0VuY3J5cHQobikgewogICAgdmFyIHQgPSBDcnlwdG9KUy5NRDUoImxvZ2luLjE4OS5jbiIpLAogICAgICAgIGkgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSh0KSwKICAgICAgICByID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoIjEyMzQ1Njc4MTIzNDU2NzgiKSwKICAgICAgICB1ID0gQ3J5cHRvSlMuQUVTLmVuY3J5cHQobiwgaSwgewogICAgICAgICAgICBpdjogcgogICAgICAgIH0pOwogICAgcmV0dXJuIHUgKyAiIgp9Ow==";

    @Override
    public HttpResult<Map<String, Object>> init(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_001").setFullUrl(templateUrl).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("get encrypt param:初始化失败!");
                return result.failure(ErrorCode.TASK_INIT_ERROR);
            }
            String pscToken = "nqnfydcxen";
            String queryType = "4";
            String areaCode = "";
            String pwdType = "2";
            String firstInput = "y";
            String url = StringUtils.EMPTY;
            List<String> pscTokenList = XPathUtil.getXpath("//input[@id='pscToken']/@value", pageContent);
            if (!CollectionUtils.isEmpty(pscTokenList)) {
                pscToken = pscTokenList.get(0);
            }
            List<String> queryTypeList = XPathUtil.getXpath("//input[@name='queryType']/@value", pageContent);
            if (!CollectionUtils.isEmpty(queryTypeList)) {
                queryType = queryTypeList.get(0);
            }
            List<String> areaCodeList = XPathUtil.getXpath("//input[@name='areaCode']/@value", pageContent);
            if (!CollectionUtils.isEmpty(areaCodeList)) {
                areaCode = areaCodeList.get(0);
            }
            List<String> pwdTypeList = XPathUtil.getXpath("//input[@name='pwdType']/@value", pageContent);
            if (!CollectionUtils.isEmpty(pwdTypeList)) {
                pwdType = pwdTypeList.get(0);
            }
            List<String> firstInputList = XPathUtil.getXpath("//input[@name='firstInput']/@value", pageContent);
            if (!CollectionUtils.isEmpty(firstInputList)) {
                firstInput = firstInputList.get(0);
            }
            List<String> urlList = XPathUtil.getXpath("//input[@name='url']/@value", pageContent);
            if (!CollectionUtils.isEmpty(urlList)) {
                url = urlList.get(0);
            }

            TaskUtils.addTaskShare(param.getTaskId(), "pscToken", pscToken);
            TaskUtils.addTaskShare(param.getTaskId(), "queryType", queryType);
            TaskUtils.addTaskShare(param.getTaskId(), "areaCode", areaCode);
            TaskUtils.addTaskShare(param.getTaskId(), "pwdType", pwdType);
            TaskUtils.addTaskShare(param.getTaskId(), "firstInput", firstInput);
            TaskUtils.addTaskShare(param.getTaskId(), "url", url);
            return result.success();
        } catch (Exception e) {
            logger.error("登录-->初始化失败,param={}", param, e);
            return result.failure(ErrorCode.TASK_INIT_ERROR);
        }
    }

    @Override
    public HttpResult<String> refeshPicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return refeshPicCodeForLogin(param);
            case "QUERY_BASEINFO":
                return loginUtils.refeshPicCode(param);
            case FormType.VALIDATE_USER_INFO:
                return refeshPicCodeForUserInfo(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshPicCodeForBillDetail(param);
            default:
                return new HttpResult<String>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> validatePicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_USER_INFO:
                return validatePicCodeForUserInfo(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> refeshSmsCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshSmsCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Object> defineProcess(OperatorParam param) {
        return null;
    }

    @Override
    public HttpResult<Map<String, Object>> submit(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return submitForLogin(param);
            case "QUERY_BASEINFO":
                return submitForBaseinfo(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return submitForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    private HttpResult<String> refeshPicCodeForLogin(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://wapjl.189.cn/authImg?" + Math.random();
            String referer = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_002").setFullUrl(templateUrl).setReferer(referer).invoke();
            logger.info("基本信息-->图片验证码-->刷新成功,param={}", param);
            return result.success(response.getPageContentForBase64());
        } catch (Exception e) {
            logger.error("基本信息-->图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> submitForLogin(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String pscToken = TaskUtils.getTaskShare(param.getTaskId(), "pscToken");
            String queryType = TaskUtils.getTaskShare(param.getTaskId(), "queryType");
            String areaCode = TaskUtils.getTaskShare(param.getTaskId(), "areaCode");
            String pwdType = TaskUtils.getTaskShare(param.getTaskId(), "pwdType");
            String firstInput = TaskUtils.getTaskShare(param.getTaskId(), "firstInput");
            String url = TaskUtils.getTaskShare(param.getTaskId(), "url");
            //wap端登录
            Invocable invocable = ScriptEngineUtil.createInvocableFromBase64(javaScript);
            String encryptPassword = invocable.invokeFunction("encrypt", new Object[]{param.getPassword(), pscToken}).toString();
            String templateUrl = "http://wapjl.189.cn/echn/login/login.action";
            String templateData = "queryValue=" + param.getMobile() + "&passWord=" + encryptPassword + "&randCode=" + param.getPicCode() +
                    "&queryType=" + queryType + "&areaCode=" + areaCode + "&pwdType=" + pwdType + "&firstInput=" + firstInput +
                    "&changeLoginFlag=&returnUrlFlag=&url=" + URLEncoder.encode(url, "UTF-8");
            String referer = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_003").setFullUrl(templateUrl).setRequestBody(templateData)
                    .setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            List<String> list = XPathUtil.getXpath("div:has(form):not(:has(div)) span:eq(0)/text()", pageContent);
            String msg = StringUtils.EMPTY;
            if (!CollectionUtils.isEmpty(list)) {
                msg = list.get(0);
            }
            if (StringUtils.isBlank(msg)) {
                list = XPathUtil.getXpath("span:has(img) + span/text()", pageContent);
                if (!CollectionUtils.isEmpty(list)) {
                    msg = list.get(0);
                }
            }
            templateUrl = "http://wapjl.189.cn/custquery/customerInfoQuery.action?servId=154";
            referer = "http://wapjl.189.cn/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_004").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, String.valueOf(param.getMobile()))) {
                String customerName = PatternUtils.group(pageContent, "客户姓名：<\\/strong>\\s*([^：]+)\\s*<br", 1);
                customerName = PatternUtils.group(customerName, "(\\S*)", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "customerName", customerName);
                String idCardNo = PatternUtils.group(pageContent, "证件号码：<\\/strong>\\s*([^：]+)\\s*<br", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "idCardNo", idCardNo);
                String joinDate = PatternUtils.group(pageContent, "开通时间：<\\/strong>\\s*([^：]+)\\s*<\\/div>", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "joinDate", joinDate);
            } else {
                logger.error("wapjl189 login is error! errormessage: " + msg);
                logger.error("基本信息-->校验失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.VALIDATE_UNEXPECTED_RESULT);
            }
            //删除cookie
            RedisUtils.del("task.cookie." + param.getTaskId());
            loginUtils.init(param);
            logger.info("基本信息-->校验成功,param={}", param);
            return result.success();
        } catch (Exception e) {
            logger.error("基本信息-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_UNEXPECTED_RESULT);
        }
    }

    private HttpResult<Map<String, Object>> submitForBaseinfo(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            //web端登录
            result = loginUtils.submit(param);
            if (!result.getStatus()) {
                return result;
            }

            String templateUrl = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=00710602";
            String referer = "http://www.189.cn/jl/";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_007").setFullUrl(templateUrl).setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent) || !StringUtils.contains(pageContent, "个人信息")) {
                logger.error("jl189 login failed! errormessage:login failed");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }

            templateUrl = "http://www.189.cn/login/index.do";
            referer = "http://www.189.cn/html/login/index.html";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_008").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isNotBlank(pageContent) && StringUtils.contains(pageContent, "errorDescription\":null")) {
                logger.info("登陆成功,param={}", param);
                return result.success();
            } else {
                logger.error("登陆失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登陆失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.LOGIN_ERROR);
        }
    }

    private HttpResult<String> refeshPicCodeForUserInfo(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://www.189.cn/dqmh/my189/checkMy189Session.do";
            String templateData = "fastcode=00710602";
            String referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=00710599";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_009").setFullUrl(templateUrl).setRequestBody(templateData)
                    .addHeader("Accept", "application/json, text/javascript, */*; q=0.01").setReferer(referer).invoke();
            String pageContent = response.getPageContent();

            templateUrl
                    = "http://www.189.cn/login/sso/ecs.do?method=linkTo&platNo=10030&toStUrl=http://jl.189.cn/service/bill/toDetailBillFra.action?fastcode=00710602&cityCode=jl";
            referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0010").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent) || !StringUtils.contains(pageContent, "证件号码")) {
                logger.error("requestUrl is wrong!");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }
            templateUrl = "http://jl.189.cn/authImg";
            referer = response.getRedirectUrl();
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0011").setFullUrl(templateUrl).setReferer(referer).invoke();
            logger.info("个人信息-->图片验证码-->刷新成功,param={}", param);
            return result.success(response.getPageContentForBase64());
        } catch (Exception e) {
            logger.error("个人信息-->图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> validatePicCodeForUserInfo(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPicCode(), ErrorCode.EMPTY_PIC_CODE);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            String templateUrl = "http://jl.189.cn/realname/checkIdCardFra.action";
            String templateData = "ruleDetalId=109&certCode=" + param.getIdCard() + "&custName=" + param.getRealName() + "&randCode=" +
                    param.getPicCode();
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_0012").setFullUrl(templateUrl).setRequestBody(templateData)
                    .setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isNotBlank(pageContent) && StringUtils.contains(pageContent, "result\":\"0")) {
                logger.info("个人信息-->图片验证码-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("个人信息-->图片验证码-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_PIC_CODE_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("个人信息-->图片验证码-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_PIC_CODE_ERROR);
        }
    }

    private HttpResult<String> refeshPicCodeForBillDetail(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            String referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?fastcode=00710602&cityCode=jl";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0013").setFullUrl(templateUrl).setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent) || !StringUtils.contains(pageContent, "短信验证码")) {
                logger.error("requestUrl is wrong!");
                return result.failure(ErrorCode.RESPONSE_EMPTY_ERROR_CODE);
            }

            templateUrl = "http://jl.189.cn/authImg?1";
            referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.GET, "ji_lin_10000_web_0014").setFullUrl(templateUrl).setReferer(referer).invoke();
            TaskUtils.addTaskShare(param.getTaskId(), "secondPicCode", response.getPageContentForBase64());

            logger.info("详单-->第二次图片验证码-->刷新成功,param={}", param);
            return result.success();
        } catch (Exception e) {
            logger.error("详单-->第二次图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }

    }

    private HttpResult<Map<String, Object>> refeshSmsCodeForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            logger.info("详单-->短信验证码-->刷新成功,param={}", param);
            return result.success();
        } catch (Exception e) {
            logger.error("详单-->短信验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> submitForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = validatePicCodeForUserInfo(param);
        if (!result.getStatus()) {
            return result;
        }
        Response response = null;
        try {
            String templateUrl = "http://jl.189.cn/service/transaction/qryInacWorkOrder.action";
            String templateData = "fromPage=XDCX";
            String referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_0015").setFullUrl(templateUrl).setRequestBody(templateData)
                    .setReferer(referer).invoke();

            String secondPicCode = TaskUtils.getTaskShare(param.getTaskId(), "secondPicCode");
            templateUrl = "http://jl.189.cn/service/bill/doDetailBillFra.action";
            templateData = "sRandomCode=" + param.getSmsCode() + "&randCode=" + secondPicCode;
            referer = "http://jl.189.cn/service/bill/toDetailBillFra.action?cityCode=jl&fastcode=00710602";
            response = TaskHttpClient.create(param, RequestType.POST, "ji_lin_10000_web_0015").setFullUrl(templateUrl).setRequestBody(templateData)
                    .setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isNotBlank(pageContent) && !StringUtils.contains(pageContent, "billDetailValidate\":\"true")) {
                logger.info("详单-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_ERROR);
        }
    }

}


