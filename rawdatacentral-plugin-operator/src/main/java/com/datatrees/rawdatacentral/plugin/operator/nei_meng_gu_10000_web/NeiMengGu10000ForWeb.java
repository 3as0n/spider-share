package com.datatrees.rawdatacentral.plugin.operator.nei_meng_gu_10000_web;

import javax.script.Invocable;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.Map;

import com.alibaba.fastjson.JSON;
import com.datatrees.common.util.PatternUtils;
import com.datatrees.rawdatacentral.common.http.TaskHttpClient;
import com.datatrees.rawdatacentral.common.http.TaskUtils;
import com.datatrees.rawdatacentral.common.utils.CheckUtils;
import com.datatrees.rawdatacentral.common.utils.ScriptEngineUtil;
import com.datatrees.rawdatacentral.common.utils.TemplateUtils;
import com.datatrees.rawdatacentral.domain.constant.FormType;
import com.datatrees.rawdatacentral.domain.enums.ErrorCode;
import com.datatrees.rawdatacentral.domain.enums.RequestType;
import com.datatrees.rawdatacentral.domain.operator.OperatorParam;
import com.datatrees.rawdatacentral.domain.result.HttpResult;
import com.datatrees.rawdatacentral.domain.vo.Response;
import com.datatrees.rawdatacentral.service.OperatorPluginService;
import org.apache.commons.lang3.StringUtils;
import org.apache.http.entity.ContentType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Created by guimeichao on 17/9/25.
 */
public class NeiMengGu10000ForWeb implements OperatorPluginService {

    private static final Logger logger     = LoggerFactory.getLogger(NeiMengGu10000ForWeb.class);
    private static final String javaScript
                                           = "dmFyIENyeXB0b0pTID0gQ3J5cHRvSlMgfHwNCiAgICBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgIHZhciB1ID0ge30sDQogICAgICAgICAgICBmID0gdS5saWIgPSB7fSwNCiAgICAgICAgICAgIG8gPSBmdW5jdGlvbigpIHt9LA0KICAgICAgICAgICAgaSA9IGYuQmFzZSA9IHsNCiAgICAgICAgICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICAgICAgby5wcm90b3R5cGUgPSB0aGlzOw0KICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG5ldyBvOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbiAmJiB0Lm1peEluKG4pLA0KICAgICAgICAgICAgICAgICAgICB0Lmhhc093blByb3BlcnR5KCJpbml0IikgfHwgKHQuaW5pdCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdC4kc3VwZXIuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpDQogICAgICAgICAgICAgICAgICAgIH0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgdC5pbml0LnByb3RvdHlwZSA9IHQsDQogICAgICAgICAgICAgICAgICAgICAgICB0LiRzdXBlciA9IHRoaXMsDQogICAgICAgICAgICAgICAgICAgICAgICB0DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IHRoaXMuZXh0ZW5kKCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuLmluaXQuYXBwbHkobiwgYXJndW1lbnRzKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIG4NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkge30sDQogICAgICAgICAgICAgICAgbWl4SW46IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdCBpbiBuKSBuLmhhc093blByb3BlcnR5KHQpICYmICh0aGlzW3RdID0gblt0XSk7DQogICAgICAgICAgICAgICAgICAgIG4uaGFzT3duUHJvcGVydHkoInRvU3RyaW5nIikgJiYgKHRoaXMudG9TdHJpbmcgPSBuLnRvU3RyaW5nKQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbml0LnByb3RvdHlwZS5leHRlbmQodGhpcykNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgciA9IGYuV29yZEFycmF5ID0gaS5leHRlbmQoew0KICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4sIGkpIHsNCiAgICAgICAgICAgICAgICAgICAgbiA9IHRoaXMud29yZHMgPSBuIHx8IFtdOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLnNpZ0J5dGVzID0gaSAhPSB0ID8gaTogNCAqIG4ubGVuZ3RoDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gKG4gfHwgbCkuc3RyaW5naWZ5KHRoaXMpDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBjb25jYXQ6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSB0aGlzLndvcmRzLA0KICAgICAgICAgICAgICAgICAgICAgICAgciA9IG4ud29yZHMsDQogICAgICAgICAgICAgICAgICAgICAgICB1ID0gdGhpcy5zaWdCeXRlcywNCiAgICAgICAgICAgICAgICAgICAgICAgIHQ7DQogICAgICAgICAgICAgICAgICAgIGlmIChuID0gbi5zaWdCeXRlcywgdGhpcy5jbGFtcCgpLCB1ICUgNCkgZm9yICh0ID0gMDsgdCA8IG47IHQrKykgaVt1ICsgdCA+Pj4gMl0gfD0gKHJbdCA+Pj4gMl0gPj4+IDI0IC0gOCAqICh0ICUgNCkgJiAyNTUpIDw8IDI0IC0gOCAqICgodSArIHQpICUgNCk7DQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKDY1NTM1IDwgci5sZW5ndGgpIGZvciAodCA9IDA7IHQgPCBuOyB0ICs9IDQpIGlbdSArIHQgPj4+IDJdID0gclt0ID4+PiAyXTsNCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpLnB1c2guYXBwbHkoaSwgcik7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNpZ0J5dGVzICs9IG4sDQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBjbGFtcDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBpID0gdGhpcy53b3JkcywNCiAgICAgICAgICAgICAgICAgICAgICAgIHQgPSB0aGlzLnNpZ0J5dGVzOw0KICAgICAgICAgICAgICAgICAgICBpW3QgPj4+IDJdICY9IDQyOTQ5NjcyOTUgPDwgMzIgLSA4ICogKHQgJSA0KTsNCiAgICAgICAgICAgICAgICAgICAgaS5sZW5ndGggPSBuLmNlaWwodCAvIDQpDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBuID0gaS5jbG9uZS5jYWxsKHRoaXMpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbi53b3JkcyA9IHRoaXMud29yZHMuc2xpY2UoMCksDQogICAgICAgICAgICAgICAgICAgICAgICBuDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICByYW5kb206IGZ1bmN0aW9uKHQpIHsNCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IFtdLCB1ID0gMDsgdSA8IHQ7IHUgKz0gNCkgaS5wdXNoKDQyOTQ5NjcyOTYgKiBuLnJhbmRvbSgpIHwgMCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KGksIHQpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSksDQogICAgICAgICAgICBlID0gdS5lbmMgPSB7fSwNCiAgICAgICAgICAgIGwgPSBlLkhleCA9IHsNCiAgICAgICAgICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHUgPSBuLndvcmRzLA0KICAgICAgICAgICAgICAgICAgICAgICAgaSwgdCwgcjsNCiAgICAgICAgICAgICAgICAgICAgZm9yIChuID0gbi5zaWdCeXRlcywgaSA9IFtdLCB0ID0gMDsgdCA8IG47IHQrKykgciA9IHVbdCA+Pj4gMl0gPj4+IDI0IC0gOCAqICh0ICUgNCkgJiAyNTUsDQogICAgICAgICAgICAgICAgICAgICAgICBpLnB1c2goKHIgPj4+IDQpLnRvU3RyaW5nKDE2KSksDQogICAgICAgICAgICAgICAgICAgICAgICBpLnB1c2goKHIgJiAxNSkudG9TdHJpbmcoMTYpKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkuam9pbigiIikNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBuLmxlbmd0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdSA9IFtdLCB0ID0gMDsgdCA8IGk7IHQgKz0gMikgdVt0ID4+PiAzXSB8PSBwYXJzZUludChuLnN1YnN0cih0LCAyKSwgMTYpIDw8IDI0IC0gNCAqICh0ICUgOCk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KHUsIGkgLyAyKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBzID0gZS5MYXRpbjEgPSB7DQogICAgICAgICAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciByID0gbi53b3JkcywNCiAgICAgICAgICAgICAgICAgICAgICAgIGksIHQ7DQogICAgICAgICAgICAgICAgICAgIGZvciAobiA9IG4uc2lnQnl0ZXMsIGkgPSBbXSwgdCA9IDA7IHQgPCBuOyB0KyspIGkucHVzaChTdHJpbmcuZnJvbUNoYXJDb2RlKHJbdCA+Pj4gMl0gPj4+IDI0IC0gOCAqICh0ICUgNCkgJiAyNTUpKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkuam9pbigiIikNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBuLmxlbmd0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdSA9IFtdLCB0ID0gMDsgdCA8IGk7IHQrKykgdVt0ID4+PiAyXSB8PSAobi5jaGFyQ29kZUF0KHQpICYgMjU1KSA8PCAyNCAtIDggKiAodCAlIDQpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHIuaW5pdCh1LCBpKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBhID0gZS5VdGY4ID0gew0KICAgICAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChlc2NhcGUocy5zdHJpbmdpZnkobikpKQ0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKHQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJNYWxmb3JtZWQgVVRGLTggZGF0YSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcy5wYXJzZSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQobikpKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBoID0gZi5CdWZmZXJlZEJsb2NrQWxnb3JpdGhtID0gaS5leHRlbmQoew0KICAgICAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGF0YSA9IG5ldyByLmluaXQ7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuX25EYXRhQnl0ZXMgPSAwDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBfYXBwZW5kOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgICAgICJzdHJpbmciID09IHR5cGVvZiBuICYmIChuID0gYS5wYXJzZShuKSk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2RhdGEuY29uY2F0KG4pOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9uRGF0YUJ5dGVzICs9IG4uc2lnQnl0ZXMNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIF9wcm9jZXNzOiBmdW5jdGlvbih0KSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBmID0gdGhpcy5fZGF0YSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBmLndvcmRzLA0KICAgICAgICAgICAgICAgICAgICAgICAgdSA9IGYuc2lnQnl0ZXMsDQogICAgICAgICAgICAgICAgICAgICAgICBlID0gdGhpcy5ibG9ja1NpemUsDQogICAgICAgICAgICAgICAgICAgICAgICBvID0gdSAvICg0ICogZSksDQogICAgICAgICAgICAgICAgICAgICAgICBvID0gdCA/IG4uY2VpbChvKSA6IG4ubWF4KChvIHwgMCkgLSB0aGlzLl9taW5CdWZmZXJTaXplLCAwKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGk7DQogICAgICAgICAgICAgICAgICAgIGlmICh0ID0gbyAqIGUsIHUgPSBuLm1pbig0ICogdCwgdSksIHQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0OyBpICs9IGUpIHRoaXMuX2RvUHJvY2Vzc0Jsb2NrKHMsIGkpOw0KICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHMuc3BsaWNlKDAsIHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgZi5zaWdCeXRlcyAtPSB1DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQoaSwgdSkNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBpLmNsb25lLmNhbGwodGhpcyk7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBuLl9kYXRhID0gdGhpcy5fZGF0YS5jbG9uZSgpLA0KICAgICAgICAgICAgICAgICAgICAgICAgbg0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgX21pbkJ1ZmZlclNpemU6IDANCiAgICAgICAgICAgIH0pLA0KICAgICAgICAgICAgYzsNCiAgICAgICAgcmV0dXJuIGYuSGFzaGVyID0gaC5leHRlbmQoew0KICAgICAgICAgICAgY2ZnOiBpLmV4dGVuZCgpLA0KICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgIHRoaXMuY2ZnID0gdGhpcy5jZmcuZXh0ZW5kKG4pOw0KICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBoLnJlc2V0LmNhbGwodGhpcyk7DQogICAgICAgICAgICAgICAgdGhpcy5fZG9SZXNldCgpDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdXBkYXRlOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChuKSwNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvY2VzcygpLA0KICAgICAgICAgICAgICAgICAgICB0aGlzDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZmluYWxpemU6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gbiAmJiB0aGlzLl9hcHBlbmQobiksDQogICAgICAgICAgICAgICAgICAgIHRoaXMuX2RvRmluYWxpemUoKQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGJsb2NrU2l6ZTogMTYsDQogICAgICAgICAgICBfY3JlYXRlSGVscGVyOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHQsIGkpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBuLmluaXQoaSkuZmluYWxpemUodCkNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX2NyZWF0ZUhtYWNIZWxwZXI6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odCwgaSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGMuSE1BQy5pbml0KG4sIGkpLmZpbmFsaXplKHQpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9KSwNCiAgICAgICAgICAgIGMgPSB1LmFsZ28gPSB7fSwNCiAgICAgICAgICAgIHUNCiAgICB9IChNYXRoKTsgKGZ1bmN0aW9uKCkgew0KICAgIHZhciBuID0gQ3J5cHRvSlMsDQogICAgICAgIHQgPSBuLmxpYi5Xb3JkQXJyYXk7DQogICAgbi5lbmMuQmFzZTY0ID0gew0KICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHZhciBpID0gbi53b3JkcywNCiAgICAgICAgICAgICAgICB1ID0gbi5zaWdCeXRlcywNCiAgICAgICAgICAgICAgICBmID0gdGhpcy5fbWFwLA0KICAgICAgICAgICAgICAgIHQsIGUsIHI7DQogICAgICAgICAgICBmb3IgKG4uY2xhbXAoKSwgbiA9IFtdLCB0ID0gMDsgdCA8IHU7IHQgKz0gMykgZm9yIChlID0gKGlbdCA+Pj4gMl0gPj4+IDI0IC0gOCAqICh0ICUgNCkgJiAyNTUpIDw8IDE2IHwgKGlbdCArIDEgPj4+IDJdID4+PiAyNCAtIDggKiAoKHQgKyAxKSAlIDQpICYgMjU1KSA8PCA4IHwgaVt0ICsgMiA+Pj4gMl0gPj4+IDI0IC0gOCAqICgodCArIDIpICUgNCkgJiAyNTUsIHIgPSAwOyA0ID4gciAmJiB0ICsgLjc1ICogciA8IHU7IHIrKykgbi5wdXNoKGYuY2hhckF0KGUgPj4+IDYgKiAoMyAtIHIpICYgNjMpKTsNCiAgICAgICAgICAgIGlmIChpID0gZi5jaGFyQXQoNjQpKSBmb3IgKDsgbi5sZW5ndGggJSA0Oykgbi5wdXNoKGkpOw0KICAgICAgICAgICAgcmV0dXJuIG4uam9pbigiIikNCiAgICAgICAgfSwNCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHZhciBlID0gbi5sZW5ndGgsDQogICAgICAgICAgICAgICAgZiA9IHRoaXMuX21hcCwNCiAgICAgICAgICAgICAgICBpID0gZi5jaGFyQXQoNjQpLA0KICAgICAgICAgICAgICAgIG8sDQogICAgICAgICAgICAgICAgczsNCiAgICAgICAgICAgIGkgJiYgKGkgPSBuLmluZGV4T2YoaSksIC0xICE9IGkgJiYgKGUgPSBpKSk7DQogICAgICAgICAgICBmb3IgKHZhciBpID0gW10sIHUgPSAwLCByID0gMDsgciA8IGU7IHIrKykgciAlIDQgJiYgKG8gPSBmLmluZGV4T2Yobi5jaGFyQXQociAtIDEpKSA8PCAyICogKHIgJSA0KSwgcyA9IGYuaW5kZXhPZihuLmNoYXJBdChyKSkgPj4+IDYgLSAyICogKHIgJSA0KSwgaVt1ID4+PiAyXSB8PSAobyB8IHMpIDw8IDI0IC0gOCAqICh1ICUgNCksIHUrKyk7DQogICAgICAgICAgICByZXR1cm4gdC5jcmVhdGUoaSwgdSkNCiAgICAgICAgfSwNCiAgICAgICAgX21hcDogIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky89Ig0KICAgIH0NCn0pKCksDQogICAgZnVuY3Rpb24obikgew0KICAgICAgICBmdW5jdGlvbiBpKG4sIHQsIGksIHIsIHUsIGYsIGUpIHsNCiAgICAgICAgICAgIHJldHVybiBuID0gbiArICh0ICYgaSB8IH50ICYgcikgKyB1ICsgZSwNCiAgICAgICAgICAgIChuIDw8IGYgfCBuID4+PiAzMiAtIGYpICsgdA0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIHIobiwgdCwgaSwgciwgdSwgZiwgZSkgew0KICAgICAgICAgICAgcmV0dXJuIG4gPSBuICsgKHQgJiByIHwgaSAmIH5yKSArIHUgKyBlLA0KICAgICAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gdShuLCB0LCBpLCByLCB1LCBmLCBlKSB7DQogICAgICAgICAgICByZXR1cm4gbiA9IG4gKyAodCBeIGkgXiByKSArIHUgKyBlLA0KICAgICAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0DQogICAgICAgIH0NCiAgICAgICAgZnVuY3Rpb24gZihuLCB0LCBpLCByLCB1LCBmLCBlKSB7DQogICAgICAgICAgICByZXR1cm4gbiA9IG4gKyAoaSBeICh0IHwgfnIpKSArIHUgKyBlLA0KICAgICAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0DQogICAgICAgIH0NCiAgICAgICAgZm9yICh2YXIgbyA9IENyeXB0b0pTLA0KICAgICAgICAgICAgICAgICBlID0gby5saWIsDQogICAgICAgICAgICAgICAgIGMgPSBlLldvcmRBcnJheSwNCiAgICAgICAgICAgICAgICAgcyA9IGUuSGFzaGVyLA0KICAgICAgICAgICAgICAgICBlID0gby5hbGdvLA0KICAgICAgICAgICAgICAgICB0ID0gW10sIGggPSAwOyA2NCA+IGg7IGgrKykgdFtoXSA9IDQyOTQ5NjcyOTYgKiBuLmFicyhuLnNpbihoICsgMSkpIHwgMDsNCiAgICAgICAgZSA9IGUuTUQ1ID0gcy5leHRlbmQoew0KICAgICAgICAgICAgX2RvUmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX2hhc2ggPSBuZXcgYy5pbml0KFsxNzMyNTg0MTkzLCA0MDIzMjMzNDE3LCAyNTYyMzgzMTAyLCAyNzE3MzM4NzhdKQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIF9kb1Byb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgZSkgew0KICAgICAgICAgICAgICAgIGZvciAodmFyIHYsIGEsIGwgPSAwOyAxNiA+IGw7IGwrKykgdiA9IGUgKyBsLA0KICAgICAgICAgICAgICAgICAgICBhID0gblt2XSwNCiAgICAgICAgICAgICAgICAgICAgblt2XSA9IChhIDw8IDggfCBhID4+PiAyNCkgJiAxNjcxMTkzNSB8IChhIDw8IDI0IHwgYSA+Pj4gOCkgJiA0Mjc4MjU1MzYwOw0KICAgICAgICAgICAgICAgIHZhciBsID0gdGhpcy5faGFzaC53b3JkcywNCiAgICAgICAgICAgICAgICAgICAgdiA9IG5bZSArIDBdLA0KICAgICAgICAgICAgICAgICAgICBhID0gbltlICsgMV0sDQogICAgICAgICAgICAgICAgICAgIHkgPSBuW2UgKyAyXSwNCiAgICAgICAgICAgICAgICAgICAgcCA9IG5bZSArIDNdLA0KICAgICAgICAgICAgICAgICAgICB3ID0gbltlICsgNF0sDQogICAgICAgICAgICAgICAgICAgIGIgPSBuW2UgKyA1XSwNCiAgICAgICAgICAgICAgICAgICAgayA9IG5bZSArIDZdLA0KICAgICAgICAgICAgICAgICAgICBkID0gbltlICsgN10sDQogICAgICAgICAgICAgICAgICAgIGcgPSBuW2UgKyA4XSwNCiAgICAgICAgICAgICAgICAgICAgbnQgPSBuW2UgKyA5XSwNCiAgICAgICAgICAgICAgICAgICAgdHQgPSBuW2UgKyAxMF0sDQogICAgICAgICAgICAgICAgICAgIGl0ID0gbltlICsgMTFdLA0KICAgICAgICAgICAgICAgICAgICBydCA9IG5bZSArIDEyXSwNCiAgICAgICAgICAgICAgICAgICAgdXQgPSBuW2UgKyAxM10sDQogICAgICAgICAgICAgICAgICAgIGZ0ID0gbltlICsgMTRdLA0KICAgICAgICAgICAgICAgICAgICBldCA9IG5bZSArIDE1XSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IGxbMF0sDQogICAgICAgICAgICAgICAgICAgIHMgPSBsWzFdLA0KICAgICAgICAgICAgICAgICAgICBoID0gbFsyXSwNCiAgICAgICAgICAgICAgICAgICAgYyA9IGxbM10sDQogICAgICAgICAgICAgICAgICAgIG8gPSBpKG8sIHMsIGgsIGMsIHYsIDcsIHRbMF0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gaShjLCBvLCBzLCBoLCBhLCAxMiwgdFsxXSksDQogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIHksIDE3LCB0WzJdKSwNCiAgICAgICAgICAgICAgICAgICAgcyA9IGkocywgaCwgYywgbywgcCwgMjIsIHRbM10pLA0KICAgICAgICAgICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCB3LCA3LCB0WzRdKSwNCiAgICAgICAgICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgYiwgMTIsIHRbNV0pLA0KICAgICAgICAgICAgICAgICAgICBoID0gaShoLCBjLCBvLCBzLCBrLCAxNywgdFs2XSksDQogICAgICAgICAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGQsIDIyLCB0WzddKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgZywgNywgdFs4XSksDQogICAgICAgICAgICAgICAgICAgIGMgPSBpKGMsIG8sIHMsIGgsIG50LCAxMiwgdFs5XSksDQogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIHR0LCAxNywgdFsxMF0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBpdCwgMjIsIHRbMTFdKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgcnQsIDcsIHRbMTJdKSwNCiAgICAgICAgICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgdXQsIDEyLCB0WzEzXSksDQogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIGZ0LCAxNywgdFsxNF0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBldCwgMjIsIHRbMTVdKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgYSwgNSwgdFsxNl0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCBrLCA5LCB0WzE3XSksDQogICAgICAgICAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGl0LCAxNCwgdFsxOF0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCB2LCAyMCwgdFsxOV0pLA0KICAgICAgICAgICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCBiLCA1LCB0WzIwXSksDQogICAgICAgICAgICAgICAgICAgIGMgPSByKGMsIG8sIHMsIGgsIHR0LCA5LCB0WzIxXSksDQogICAgICAgICAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGV0LCAxNCwgdFsyMl0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCB3LCAyMCwgdFsyM10pLA0KICAgICAgICAgICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCBudCwgNSwgdFsyNF0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCBmdCwgOSwgdFsyNV0pLA0KICAgICAgICAgICAgICAgICAgICBoID0gcihoLCBjLCBvLCBzLCBwLCAxNCwgdFsyNl0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCBnLCAyMCwgdFsyN10pLA0KICAgICAgICAgICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCB1dCwgNSwgdFsyOF0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCB5LCA5LCB0WzI5XSksDQogICAgICAgICAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGQsIDE0LCB0WzMwXSksDQogICAgICAgICAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIHJ0LCAyMCwgdFszMV0pLA0KICAgICAgICAgICAgICAgICAgICBvID0gdShvLCBzLCBoLCBjLCBiLCA0LCB0WzMyXSksDQogICAgICAgICAgICAgICAgICAgIGMgPSB1KGMsIG8sIHMsIGgsIGcsIDExLCB0WzMzXSksDQogICAgICAgICAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGl0LCAxNiwgdFszNF0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gdShzLCBoLCBjLCBvLCBmdCwgMjMsIHRbMzVdKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgYSwgNCwgdFszNl0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCB3LCAxMSwgdFszN10pLA0KICAgICAgICAgICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBkLCAxNiwgdFszOF0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gdShzLCBoLCBjLCBvLCB0dCwgMjMsIHRbMzldKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgdXQsIDQsIHRbNDBdKSwNCiAgICAgICAgICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgdiwgMTEsIHRbNDFdKSwNCiAgICAgICAgICAgICAgICAgICAgaCA9IHUoaCwgYywgbywgcywgcCwgMTYsIHRbNDJdKSwNCiAgICAgICAgICAgICAgICAgICAgcyA9IHUocywgaCwgYywgbywgaywgMjMsIHRbNDNdKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgbnQsIDQsIHRbNDRdKSwNCiAgICAgICAgICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgcnQsIDExLCB0WzQ1XSksDQogICAgICAgICAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGV0LCAxNiwgdFs0Nl0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gdShzLCBoLCBjLCBvLCB5LCAyMywgdFs0N10pLA0KICAgICAgICAgICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCB2LCA2LCB0WzQ4XSksDQogICAgICAgICAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGQsIDEwLCB0WzQ5XSksDQogICAgICAgICAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIGZ0LCAxNSwgdFs1MF0pLA0KICAgICAgICAgICAgICAgICAgICBzID0gZihzLCBoLCBjLCBvLCBiLCAyMSwgdFs1MV0pLA0KICAgICAgICAgICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCBydCwgNiwgdFs1Ml0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gZihjLCBvLCBzLCBoLCBwLCAxMCwgdFs1M10pLA0KICAgICAgICAgICAgICAgICAgICBoID0gZihoLCBjLCBvLCBzLCB0dCwgMTUsIHRbNTRdKSwNCiAgICAgICAgICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgYSwgMjEsIHRbNTVdKSwNCiAgICAgICAgICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgZywgNiwgdFs1Nl0pLA0KICAgICAgICAgICAgICAgICAgICBjID0gZihjLCBvLCBzLCBoLCBldCwgMTAsIHRbNTddKSwNCiAgICAgICAgICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgaywgMTUsIHRbNThdKSwNCiAgICAgICAgICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgdXQsIDIxLCB0WzU5XSksDQogICAgICAgICAgICAgICAgICAgIG8gPSBmKG8sIHMsIGgsIGMsIHcsIDYsIHRbNjBdKSwNCiAgICAgICAgICAgICAgICAgICAgYyA9IGYoYywgbywgcywgaCwgaXQsIDEwLCB0WzYxXSksDQogICAgICAgICAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIHksIDE1LCB0WzYyXSksDQogICAgICAgICAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIG50LCAyMSwgdFs2M10pOw0KICAgICAgICAgICAgICAgIGxbMF0gPSBsWzBdICsgbyB8IDA7DQogICAgICAgICAgICAgICAgbFsxXSA9IGxbMV0gKyBzIHwgMDsNCiAgICAgICAgICAgICAgICBsWzJdID0gbFsyXSArIGggfCAwOw0KICAgICAgICAgICAgICAgIGxbM10gPSBsWzNdICsgYyB8IDANCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfZG9GaW5hbGl6ZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdmFyIHUgPSB0aGlzLl9kYXRhLA0KICAgICAgICAgICAgICAgICAgICByID0gdS53b3JkcywNCiAgICAgICAgICAgICAgICAgICAgdCA9IDggKiB0aGlzLl9uRGF0YUJ5dGVzLA0KICAgICAgICAgICAgICAgICAgICBpID0gOCAqIHUuc2lnQnl0ZXMsDQogICAgICAgICAgICAgICAgICAgIGY7DQogICAgICAgICAgICAgICAgZm9yIChyW2kgPj4+IDVdIHw9IDEyOCA8PCAyNCAtIGkgJSAzMiwgZiA9IG4uZmxvb3IodCAvIDQyOTQ5NjcyOTYpLCByWyhpICsgNjQgPj4+IDkgPDwgNCkgKyAxNV0gPSAoZiA8PCA4IHwgZiA+Pj4gMjQpICYgMTY3MTE5MzUgfCAoZiA8PCAyNCB8IGYgPj4+IDgpICYgNDI3ODI1NTM2MCwgclsoaSArIDY0ID4+PiA5IDw8IDQpICsgMTRdID0gKHQgPDwgOCB8IHQgPj4+IDI0KSAmIDE2NzExOTM1IHwgKHQgPDwgMjQgfCB0ID4+PiA4KSAmIDQyNzgyNTUzNjAsIHUuc2lnQnl0ZXMgPSA0ICogKHIubGVuZ3RoICsgMSksIHRoaXMuX3Byb2Nlc3MoKSwgdSA9IHRoaXMuX2hhc2gsIHIgPSB1LndvcmRzLCB0ID0gMDsgNCA+IHQ7IHQrKykgaSA9IHJbdF0sDQogICAgICAgICAgICAgICAgICAgIHJbdF0gPSAoaSA8PCA4IHwgaSA+Pj4gMjQpICYgMTY3MTE5MzUgfCAoaSA8PCAyNCB8IGkgPj4+IDgpICYgNDI3ODI1NTM2MDsNCiAgICAgICAgICAgICAgICByZXR1cm4gdQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICB2YXIgbiA9IHMuY2xvbmUuY2FsbCh0aGlzKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gbi5faGFzaCA9IHRoaXMuX2hhc2guY2xvbmUoKSwNCiAgICAgICAgICAgICAgICAgICAgbg0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgby5NRDUgPSBzLl9jcmVhdGVIZWxwZXIoZSk7DQogICAgICAgIG8uSG1hY01ENSA9IHMuX2NyZWF0ZUhtYWNIZWxwZXIoZSkNCiAgICB9IChNYXRoKSwNCiAgICBmdW5jdGlvbigpIHsNCiAgICAgICAgdmFyIHQgPSBDcnlwdG9KUywNCiAgICAgICAgICAgIG4gPSB0LmxpYiwNCiAgICAgICAgICAgIGkgPSBuLkJhc2UsDQogICAgICAgICAgICByID0gbi5Xb3JkQXJyYXksDQogICAgICAgICAgICBuID0gdC5hbGdvLA0KICAgICAgICAgICAgdSA9IG4uRXZwS0RGID0gaS5leHRlbmQoew0KICAgICAgICAgICAgICAgIGNmZzogaS5leHRlbmQoew0KICAgICAgICAgICAgICAgICAgICBrZXlTaXplOiA0LA0KICAgICAgICAgICAgICAgICAgICBoYXNoZXI6IG4uTUQ1LA0KICAgICAgICAgICAgICAgICAgICBpdGVyYXRpb25zOiAxDQogICAgICAgICAgICAgICAgfSksDQogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmNmZyA9IHRoaXMuY2ZnLmV4dGVuZChuKQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgY29tcHV0ZTogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpLCBvLCBmID0gdGhpcy5jZmcsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHUgPSBmLmhhc2hlci5jcmVhdGUoKSwgZSA9IHIuY3JlYXRlKCksIGggPSBlLndvcmRzLCBzID0gZi5rZXlTaXplLCBmID0gZi5pdGVyYXRpb25zOyBoLmxlbmd0aCA8IHM7KSB7DQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgJiYgdS51cGRhdGUoaSksIGkgPSB1LnVwZGF0ZShuKS5maW5hbGl6ZSh0KSwgdS5yZXNldCgpLCBvID0gMTsgbyA8IGY7IG8rKykgaSA9IHUuZmluYWxpemUoaSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdS5yZXNldCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgZS5jb25jYXQoaSkNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5zaWdCeXRlcyA9IDQgKiBzLA0KICAgICAgICAgICAgICAgICAgICAgICAgZQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB0LkV2cEtERiA9IGZ1bmN0aW9uKG4sIHQsIGkpIHsNCiAgICAgICAgICAgIHJldHVybiB1LmNyZWF0ZShpKS5jb21wdXRlKG4sIHQpDQogICAgICAgIH0NCiAgICB9ICgpOw0KQ3J5cHRvSlMubGliLkNpcGhlciB8fA0KZnVuY3Rpb24obikgew0KICAgIHZhciBpID0gQ3J5cHRvSlMsDQogICAgICAgIHQgPSBpLmxpYiwNCiAgICAgICAgZiA9IHQuQmFzZSwNCiAgICAgICAgZSA9IHQuV29yZEFycmF5LA0KICAgICAgICBjID0gdC5CdWZmZXJlZEJsb2NrQWxnb3JpdGhtLA0KICAgICAgICBsID0gaS5lbmMuQmFzZTY0LA0KICAgICAgICB5ID0gaS5hbGdvLkV2cEtERiwNCiAgICAgICAgbyA9IHQuQ2lwaGVyID0gYy5leHRlbmQoew0KICAgICAgICAgICAgY2ZnOiBmLmV4dGVuZCgpLA0KICAgICAgICAgICAgY3JlYXRlRW5jcnlwdG9yOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHRoaXMuX0VOQ19YRk9STV9NT0RFLCBuLCB0KQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGNyZWF0ZURlY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZSh0aGlzLl9ERUNfWEZPUk1fTU9ERSwgbiwgdCkNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBpbml0OiBmdW5jdGlvbihuLCB0LCBpKSB7DQogICAgICAgICAgICAgICAgdGhpcy5jZmcgPSB0aGlzLmNmZy5leHRlbmQoaSk7DQogICAgICAgICAgICAgICAgdGhpcy5feGZvcm1Nb2RlID0gbjsNCiAgICAgICAgICAgICAgICB0aGlzLl9rZXkgPSB0Ow0KICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBjLnJlc2V0LmNhbGwodGhpcyk7DQogICAgICAgICAgICAgICAgdGhpcy5fZG9SZXNldCgpDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgcHJvY2VzczogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9hcHBlbmQobiksDQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3MoKQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGZpbmFsaXplOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIG4gJiYgdGhpcy5fYXBwZW5kKG4pLA0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9kb0ZpbmFsaXplKCkNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBrZXlTaXplOiA0LA0KICAgICAgICAgICAgaXZTaXplOiA0LA0KICAgICAgICAgICAgX0VOQ19YRk9STV9NT0RFOiAxLA0KICAgICAgICAgICAgX0RFQ19YRk9STV9NT0RFOiAyLA0KICAgICAgICAgICAgX2NyZWF0ZUhlbHBlcjogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgICAgIGVuY3J5cHQ6IGZ1bmN0aW9uKHQsIGksIHIpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoInN0cmluZyIgPT0gdHlwZW9mIGkgPyB2OiB1KS5lbmNyeXB0KG4sIHQsIGksIHIpDQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIGRlY3J5cHQ6IGZ1bmN0aW9uKHQsIGksIHIpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoInN0cmluZyIgPT0gdHlwZW9mIGkgPyB2OiB1KS5kZWNyeXB0KG4sIHQsIGksIHIpDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIHQuU3RyZWFtQ2lwaGVyID0gby5leHRlbmQoew0KICAgICAgICBfZG9GaW5hbGl6ZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2VzcyghMCkNCiAgICAgICAgfSwNCiAgICAgICAgYmxvY2tTaXplOiAxDQogICAgfSk7DQogICAgdmFyIHMgPSBpLm1vZGUgPSB7fSwNCiAgICAgICAgYSA9IGZ1bmN0aW9uKHQsIGksIHIpIHsNCiAgICAgICAgICAgIHZhciBmID0gdGhpcy5faXYsDQogICAgICAgICAgICAgICAgdTsNCiAgICAgICAgICAgIGZvciAoZiA/IHRoaXMuX2l2ID0gbjogZiA9IHRoaXMuX3ByZXZCbG9jaywgdSA9IDA7IHUgPCByOyB1KyspIHRbaSArIHVdIF49IGZbdV0NCiAgICAgICAgfSwNCiAgICAgICAgciA9ICh0LkJsb2NrQ2lwaGVyTW9kZSA9IGYuZXh0ZW5kKHsNCiAgICAgICAgICAgIGNyZWF0ZUVuY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLkVuY3J5cHRvci5jcmVhdGUobiwgdCkNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBjcmVhdGVEZWNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5EZWNyeXB0b3IuY3JlYXRlKG4sIHQpDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgICAgIHRoaXMuX2NpcGhlciA9IG47DQogICAgICAgICAgICAgICAgdGhpcy5faXYgPSB0DQogICAgICAgICAgICB9DQogICAgICAgIH0pKS5leHRlbmQoKTsNCiAgICByLkVuY3J5cHRvciA9IHIuZXh0ZW5kKHsNCiAgICAgICAgcHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICB2YXIgaSA9IHRoaXMuX2NpcGhlciwNCiAgICAgICAgICAgICAgICByID0gaS5ibG9ja1NpemU7DQogICAgICAgICAgICBhLmNhbGwodGhpcywgbiwgdCwgcik7DQogICAgICAgICAgICBpLmVuY3J5cHRCbG9jayhuLCB0KTsNCiAgICAgICAgICAgIHRoaXMuX3ByZXZCbG9jayA9IG4uc2xpY2UodCwgdCArIHIpDQogICAgICAgIH0NCiAgICB9KTsNCiAgICByLkRlY3J5cHRvciA9IHIuZXh0ZW5kKHsNCiAgICAgICAgcHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICB2YXIgaSA9IHRoaXMuX2NpcGhlciwNCiAgICAgICAgICAgICAgICByID0gaS5ibG9ja1NpemUsDQogICAgICAgICAgICAgICAgdSA9IG4uc2xpY2UodCwgdCArIHIpOw0KICAgICAgICAgICAgaS5kZWNyeXB0QmxvY2sobiwgdCk7DQogICAgICAgICAgICBhLmNhbGwodGhpcywgbiwgdCwgcik7DQogICAgICAgICAgICB0aGlzLl9wcmV2QmxvY2sgPSB1DQogICAgICAgIH0NCiAgICB9KTsNCiAgICBzID0gcy5DQkMgPSByOw0KICAgIHIgPSAoaS5wYWQgPSB7fSkuUGtjczcgPSB7DQogICAgICAgIHBhZDogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDQgKiB0LA0KICAgICAgICAgICAgICAgICAgICAgaSA9IGkgLSBuLnNpZ0J5dGVzICUgaSwNCiAgICAgICAgICAgICAgICAgICAgIGYgPSBpIDw8IDI0IHwgaSA8PCAxNiB8IGkgPDwgOCB8IGksDQogICAgICAgICAgICAgICAgICAgICByID0gW10sIHUgPSAwOyB1IDwgaTsgdSArPSA0KSByLnB1c2goZik7DQogICAgICAgICAgICBpID0gZS5jcmVhdGUociwgaSk7DQogICAgICAgICAgICBuLmNvbmNhdChpKQ0KICAgICAgICB9LA0KICAgICAgICB1bnBhZDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgbi5zaWdCeXRlcyAtPSBuLndvcmRzW24uc2lnQnl0ZXMgLSAxID4+PiAyXSAmIDI1NQ0KICAgICAgICB9DQogICAgfTsNCiAgICB0LkJsb2NrQ2lwaGVyID0gby5leHRlbmQoew0KICAgICAgICBjZmc6IG8uY2ZnLmV4dGVuZCh7DQogICAgICAgICAgICBtb2RlOiBzLA0KICAgICAgICAgICAgcGFkZGluZzogcg0KICAgICAgICB9KSwNCiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIHQ7DQogICAgICAgICAgICBvLnJlc2V0LmNhbGwodGhpcyk7DQogICAgICAgICAgICB2YXIgbiA9IHRoaXMuY2ZnLA0KICAgICAgICAgICAgICAgIGkgPSBuLml2LA0KICAgICAgICAgICAgICAgIG4gPSBuLm1vZGU7DQogICAgICAgICAgICB0aGlzLl94Zm9ybU1vZGUgPT0gdGhpcy5fRU5DX1hGT1JNX01PREUgPyB0ID0gbi5jcmVhdGVFbmNyeXB0b3I6ICh0ID0gbi5jcmVhdGVEZWNyeXB0b3IsIHRoaXMuX21pbkJ1ZmZlclNpemUgPSAxKTsNCiAgICAgICAgICAgIHRoaXMuX21vZGUgPSB0LmNhbGwobiwgdGhpcywgaSAmJiBpLndvcmRzKQ0KICAgICAgICB9LA0KICAgICAgICBfZG9Qcm9jZXNzQmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHRoaXMuX21vZGUucHJvY2Vzc0Jsb2NrKG4sIHQpDQogICAgICAgIH0sDQogICAgICAgIF9kb0ZpbmFsaXplOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciB0ID0gdGhpcy5jZmcucGFkZGluZywNCiAgICAgICAgICAgICAgICBuOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3hmb3JtTW9kZSA9PSB0aGlzLl9FTkNfWEZPUk1fTU9ERSA/ICh0LnBhZCh0aGlzLl9kYXRhLCB0aGlzLmJsb2NrU2l6ZSksIG4gPSB0aGlzLl9wcm9jZXNzKCEwKSkgOiAobiA9IHRoaXMuX3Byb2Nlc3MoITApLCB0LnVucGFkKG4pKSwNCiAgICAgICAgICAgICAgICBuDQogICAgICAgIH0sDQogICAgICAgIGJsb2NrU2l6ZTogNA0KICAgIH0pOw0KICAgIHZhciBoID0gdC5DaXBoZXJQYXJhbXMgPSBmLmV4dGVuZCh7DQogICAgICAgICAgICBpbml0OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgdGhpcy5taXhJbihuKQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIChuIHx8IHRoaXMuZm9ybWF0dGVyKS5zdHJpbmdpZnkodGhpcykNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSksDQogICAgICAgIHMgPSAoaS5mb3JtYXQgPSB7fSkuT3BlblNTTCA9IHsNCiAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgICAgIHZhciB0ID0gbi5jaXBoZXJ0ZXh0Ow0KICAgICAgICAgICAgICAgIHJldHVybiBuID0gbi5zYWx0LA0KICAgICAgICAgICAgICAgICAgICAobiA/IGUuY3JlYXRlKFsxMzk4ODkzNjg0LCAxNzAxMDc2ODMxXSkuY29uY2F0KG4pLmNvbmNhdCh0KSA6IHQpLnRvU3RyaW5nKGwpDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgICAgICB2YXIgdCwgaTsNCiAgICAgICAgICAgICAgICByZXR1cm4gbiA9IGwucGFyc2UobiksDQogICAgICAgICAgICAgICAgICAgIHQgPSBuLndvcmRzLA0KICAgICAgICAgICAgICAgIDEzOTg4OTM2ODQgPT0gdFswXSAmJiAxNzAxMDc2ODMxID09IHRbMV0gJiYgKGkgPSBlLmNyZWF0ZSh0LnNsaWNlKDIsIDQpKSwgdC5zcGxpY2UoMCwgNCksIG4uc2lnQnl0ZXMgLT0gMTYpLA0KICAgICAgICAgICAgICAgICAgICBoLmNyZWF0ZSh7DQogICAgICAgICAgICAgICAgICAgICAgICBjaXBoZXJ0ZXh0OiBuLA0KICAgICAgICAgICAgICAgICAgICAgICAgc2FsdDogaQ0KICAgICAgICAgICAgICAgICAgICB9KQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICB1ID0gdC5TZXJpYWxpemFibGVDaXBoZXIgPSBmLmV4dGVuZCh7DQogICAgICAgICAgICBjZmc6IGYuZXh0ZW5kKHsNCiAgICAgICAgICAgICAgICBmb3JtYXQ6IHMNCiAgICAgICAgICAgIH0pLA0KICAgICAgICAgICAgZW5jcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgew0KICAgICAgICAgICAgICAgIHIgPSB0aGlzLmNmZy5leHRlbmQocik7DQogICAgICAgICAgICAgICAgdmFyIHUgPSBuLmNyZWF0ZUVuY3J5cHRvcihpLCByKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdCA9IHUuZmluYWxpemUodCksDQogICAgICAgICAgICAgICAgICAgIHUgPSB1LmNmZywNCiAgICAgICAgICAgICAgICAgICAgaC5jcmVhdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgY2lwaGVydGV4dDogdCwNCiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogaSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGl2OiB1Lml2LA0KICAgICAgICAgICAgICAgICAgICAgICAgYWxnb3JpdGhtOiBuLA0KICAgICAgICAgICAgICAgICAgICAgICAgbW9kZTogdS5tb2RlLA0KICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogdS5wYWRkaW5nLA0KICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tTaXplOiBuLmJsb2NrU2l6ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogci5mb3JtYXQNCiAgICAgICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHIgPSB0aGlzLmNmZy5leHRlbmQociksDQogICAgICAgICAgICAgICAgICAgIHQgPSB0aGlzLl9wYXJzZSh0LCByLmZvcm1hdCksDQogICAgICAgICAgICAgICAgICAgIG4uY3JlYXRlRGVjcnlwdG9yKGksIHIpLmZpbmFsaXplKHQuY2lwaGVydGV4dCkNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBfcGFyc2U6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gInN0cmluZyIgPT0gdHlwZW9mIG4gPyB0LnBhcnNlKG4sIHRoaXMpIDogbg0KICAgICAgICAgICAgfQ0KICAgICAgICB9KSwNCiAgICAgICAgaSA9IChpLmtkZiA9IHt9KS5PcGVuU1NMID0gew0KICAgICAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24obiwgdCwgaSwgcikgew0KICAgICAgICAgICAgICAgIHJldHVybiByIHx8IChyID0gZS5yYW5kb20oOCkpLA0KICAgICAgICAgICAgICAgICAgICBuID0geS5jcmVhdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAga2V5U2l6ZTogdCArIGkNCiAgICAgICAgICAgICAgICAgICAgfSkuY29tcHV0ZShuLCByKSwNCiAgICAgICAgICAgICAgICAgICAgaSA9IGUuY3JlYXRlKG4ud29yZHMuc2xpY2UodCksIDQgKiBpKSwNCiAgICAgICAgICAgICAgICAgICAgbi5zaWdCeXRlcyA9IDQgKiB0LA0KICAgICAgICAgICAgICAgICAgICBoLmNyZWF0ZSh7DQogICAgICAgICAgICAgICAgICAgICAgICBrZXk6IG4sDQogICAgICAgICAgICAgICAgICAgICAgICBpdjogaSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHNhbHQ6IHINCiAgICAgICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgdiA9IHQuUGFzc3dvcmRCYXNlZENpcGhlciA9IHUuZXh0ZW5kKHsNCiAgICAgICAgICAgIGNmZzogdS5jZmcuZXh0ZW5kKHsNCiAgICAgICAgICAgICAgICBrZGY6IGkNCiAgICAgICAgICAgIH0pLA0KICAgICAgICAgICAgZW5jcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgew0KICAgICAgICAgICAgICAgIHJldHVybiByID0gdGhpcy5jZmcuZXh0ZW5kKHIpLA0KICAgICAgICAgICAgICAgICAgICBpID0gci5rZGYuZXhlY3V0ZShpLCBuLmtleVNpemUsIG4uaXZTaXplKSwNCiAgICAgICAgICAgICAgICAgICAgci5pdiA9IGkuaXYsDQogICAgICAgICAgICAgICAgICAgIG4gPSB1LmVuY3J5cHQuY2FsbCh0aGlzLCBuLCB0LCBpLmtleSwgciksDQogICAgICAgICAgICAgICAgICAgIG4ubWl4SW4oaSksDQogICAgICAgICAgICAgICAgICAgIG4NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHIgPSB0aGlzLmNmZy5leHRlbmQociksDQogICAgICAgICAgICAgICAgICAgIHQgPSB0aGlzLl9wYXJzZSh0LCByLmZvcm1hdCksDQogICAgICAgICAgICAgICAgICAgIGkgPSByLmtkZi5leGVjdXRlKGksIG4ua2V5U2l6ZSwgbi5pdlNpemUsIHQuc2FsdCksDQogICAgICAgICAgICAgICAgICAgIHIuaXYgPSBpLml2LA0KICAgICAgICAgICAgICAgICAgICB1LmRlY3J5cHQuY2FsbCh0aGlzLCBuLCB0LCBpLmtleSwgcikNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSkNCn0gKCksDQogICAgZnVuY3Rpb24oKSB7DQogICAgICAgIGZvciAodmFyIGksIHR0LCBzID0gQ3J5cHRvSlMsDQogICAgICAgICAgICAgICAgIHkgPSBzLmxpYi5CbG9ja0NpcGhlciwNCiAgICAgICAgICAgICAgICAgaCA9IHMuYWxnbywNCiAgICAgICAgICAgICAgICAgdCA9IFtdLCBwID0gW10sIHcgPSBbXSwgYiA9IFtdLCBrID0gW10sIGQgPSBbXSwgYyA9IFtdLCBsID0gW10sIGEgPSBbXSwgdiA9IFtdLCB1ID0gW10sIGYgPSAwOyAyNTYgPiBmOyBmKyspIHVbZl0gPSAxMjggPiBmID8gZiA8PCAxIDogZiA8PCAxIF4gMjgzOw0KICAgICAgICBmb3IgKHZhciByID0gMCwNCiAgICAgICAgICAgICAgICAgZSA9IDAsDQogICAgICAgICAgICAgICAgIGYgPSAwOyAyNTYgPiBmOyBmKyspIHsNCiAgICAgICAgICAgIGkgPSBlIF4gZSA8PCAxIF4gZSA8PCAyIF4gZSA8PCAzIF4gZSA8PCA0Ow0KICAgICAgICAgICAgaSA9IGkgPj4+IDggXiBpICYgMjU1IF4gOTk7DQogICAgICAgICAgICB0W3JdID0gaTsNCiAgICAgICAgICAgIHBbaV0gPSByOw0KICAgICAgICAgICAgdmFyIG8gPSB1W3JdLA0KICAgICAgICAgICAgICAgIGcgPSB1W29dLA0KICAgICAgICAgICAgICAgIG50ID0gdVtnXSwNCiAgICAgICAgICAgICAgICBuID0gMjU3ICogdVtpXSBeIDE2ODQzMDA4ICogaTsNCiAgICAgICAgICAgIHdbcl0gPSBuIDw8IDI0IHwgbiA+Pj4gODsNCiAgICAgICAgICAgIGJbcl0gPSBuIDw8IDE2IHwgbiA+Pj4gMTY7DQogICAgICAgICAgICBrW3JdID0gbiA8PCA4IHwgbiA+Pj4gMjQ7DQogICAgICAgICAgICBkW3JdID0gbjsNCiAgICAgICAgICAgIG4gPSAxNjg0MzAwOSAqIG50IF4gNjU1MzcgKiBnIF4gMjU3ICogbyBeIDE2ODQzMDA4ICogcjsNCiAgICAgICAgICAgIGNbaV0gPSBuIDw8IDI0IHwgbiA+Pj4gODsNCiAgICAgICAgICAgIGxbaV0gPSBuIDw8IDE2IHwgbiA+Pj4gMTY7DQogICAgICAgICAgICBhW2ldID0gbiA8PCA4IHwgbiA+Pj4gMjQ7DQogICAgICAgICAgICB2W2ldID0gbjsNCiAgICAgICAgICAgIHIgPyAociA9IG8gXiB1W3VbdVtudCBeIG9dXV0sIGUgXj0gdVt1W2VdXSkgOiByID0gZSA9IDENCiAgICAgICAgfQ0KICAgICAgICB0dCA9IFswLCAxLCAyLCA0LCA4LCAxNiwgMzIsIDY0LCAxMjgsIDI3LCA1NF07DQogICAgICAgIGggPSBoLkFFUyA9IHkuZXh0ZW5kKHsNCiAgICAgICAgICAgIF9kb1Jlc2V0OiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBmb3IgKHZhciBuLCBmID0gdGhpcy5fa2V5LA0KICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBmLndvcmRzLA0KICAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBmLnNpZ0J5dGVzIC8gNCwNCiAgICAgICAgICAgICAgICAgICAgICAgICBmID0gNCAqICgodGhpcy5fblJvdW5kcyA9IHIgKyA2KSArIDEpLCB1ID0gdGhpcy5fa2V5U2NoZWR1bGUgPSBbXSwgaSA9IDA7IGkgPCBmOyBpKyspIGkgPCByID8gdVtpXSA9IGVbaV0gOiAobiA9IHVbaSAtIDFdLCBpICUgciA/IDYgPCByICYmIDQgPT0gaSAlIHIgJiYgKG4gPSB0W24gPj4+IDI0XSA8PCAyNCB8IHRbbiA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgdFtuID4+PiA4ICYgMjU1XSA8PCA4IHwgdFtuICYgMjU1XSkgOiAobiA9IG4gPDwgOCB8IG4gPj4+IDI0LCBuID0gdFtuID4+PiAyNF0gPDwgMjQgfCB0W24gPj4+IDE2ICYgMjU1XSA8PCAxNiB8IHRbbiA+Pj4gOCAmIDI1NV0gPDwgOCB8IHRbbiAmIDI1NV0sIG4gXj0gdHRbaSAvIHIgfCAwXSA8PCAyNCksIHVbaV0gPSB1W2kgLSByXSBeIG4pOw0KICAgICAgICAgICAgICAgIGZvciAoZSA9IHRoaXMuX2ludktleVNjaGVkdWxlID0gW10sIHIgPSAwOyByIDwgZjsgcisrKSBpID0gZiAtIHIsDQogICAgICAgICAgICAgICAgICAgIG4gPSByICUgNCA/IHVbaV0gOiB1W2kgLSA0XSwNCiAgICAgICAgICAgICAgICAgICAgZVtyXSA9IDQgPiByIHx8IDQgPj0gaSA/IG46IGNbdFtuID4+PiAyNF1dIF4gbFt0W24gPj4+IDE2ICYgMjU1XV0gXiBhW3RbbiA+Pj4gOCAmIDI1NV1dIF4gdlt0W24gJiAyNTVdXQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGVuY3J5cHRCbG9jazogZnVuY3Rpb24obiwgaSkgew0KICAgICAgICAgICAgICAgIHRoaXMuX2RvQ3J5cHRCbG9jayhuLCBpLCB0aGlzLl9rZXlTY2hlZHVsZSwgdywgYiwgaywgZCwgdCkNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkZWNyeXB0QmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgICAgICB2YXIgaSA9IG5bdCArIDFdOw0KICAgICAgICAgICAgICAgIG5bdCArIDFdID0gblt0ICsgM107DQogICAgICAgICAgICAgICAgblt0ICsgM10gPSBpOw0KICAgICAgICAgICAgICAgIHRoaXMuX2RvQ3J5cHRCbG9jayhuLCB0LCB0aGlzLl9pbnZLZXlTY2hlZHVsZSwgYywgbCwgYSwgdiwgcCk7DQogICAgICAgICAgICAgICAgaSA9IG5bdCArIDFdOw0KICAgICAgICAgICAgICAgIG5bdCArIDFdID0gblt0ICsgM107DQogICAgICAgICAgICAgICAgblt0ICsgM10gPSBpDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgX2RvQ3J5cHRCbG9jazogZnVuY3Rpb24obiwgdCwgaSwgciwgdSwgZiwgZSwgbykgew0KICAgICAgICAgICAgICAgIGZvciAodmFyIGIgPSB0aGlzLl9uUm91bmRzLA0KICAgICAgICAgICAgICAgICAgICAgICAgIGggPSBuW3RdIF4gaVswXSwgYyA9IG5bdCArIDFdIF4gaVsxXSwgbCA9IG5bdCArIDJdIF4gaVsyXSwgcyA9IG5bdCArIDNdIF4gaVszXSwgYSA9IDQsIHcgPSAxOyB3IDwgYjsgdysrKSB2YXIgdiA9IHJbaCA+Pj4gMjRdIF4gdVtjID4+PiAxNiAmIDI1NV0gXiBmW2wgPj4+IDggJiAyNTVdIF4gZVtzICYgMjU1XSBeIGlbYSsrXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICB5ID0gcltjID4+PiAyNF0gXiB1W2wgPj4+IDE2ICYgMjU1XSBeIGZbcyA+Pj4gOCAmIDI1NV0gXiBlW2ggJiAyNTVdIF4gaVthKytdLA0KICAgICAgICAgICAgICAgICAgICAgICAgIHAgPSByW2wgPj4+IDI0XSBeIHVbcyA+Pj4gMTYgJiAyNTVdIF4gZltoID4+PiA4ICYgMjU1XSBeIGVbYyAmIDI1NV0gXiBpW2ErK10sDQogICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHJbcyA+Pj4gMjRdIF4gdVtoID4+PiAxNiAmIDI1NV0gXiBmW2MgPj4+IDggJiAyNTVdIF4gZVtsICYgMjU1XSBeIGlbYSsrXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICBoID0gdiwNCiAgICAgICAgICAgICAgICAgICAgICAgICBjID0geSwNCiAgICAgICAgICAgICAgICAgICAgICAgICBsID0gcDsNCiAgICAgICAgICAgICAgICB2ID0gKG9baCA+Pj4gMjRdIDw8IDI0IHwgb1tjID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW2wgPj4+IDggJiAyNTVdIDw8IDggfCBvW3MgJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgICAgICB5ID0gKG9bYyA+Pj4gMjRdIDw8IDI0IHwgb1tsID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW3MgPj4+IDggJiAyNTVdIDw8IDggfCBvW2ggJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgICAgICBwID0gKG9bbCA+Pj4gMjRdIDw8IDI0IHwgb1tzID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW2ggPj4+IDggJiAyNTVdIDw8IDggfCBvW2MgJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgICAgICBzID0gKG9bcyA+Pj4gMjRdIDw8IDI0IHwgb1toID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW2MgPj4+IDggJiAyNTVdIDw8IDggfCBvW2wgJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgICAgICBuW3RdID0gdjsNCiAgICAgICAgICAgICAgICBuW3QgKyAxXSA9IHk7DQogICAgICAgICAgICAgICAgblt0ICsgMl0gPSBwOw0KICAgICAgICAgICAgICAgIG5bdCArIDNdID0gcw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGtleVNpemU6IDgNCiAgICAgICAgfSk7DQogICAgICAgIHMuQUVTID0geS5fY3JlYXRlSGVscGVyKGgpDQogICAgfSAoKTsNCmZ1bmN0aW9uIHZhbEFlc0VuY3J5cHRTZXQoaSkgew0KICAgIHZhciBuLHQscjsNCiAgICB0cnkgew0KICAgICAgICBuID0gYWVzRGVjcnlwdChpKTsNCiAgICAgICAgbiAhPSAiIiAmJiAodCA9IGFlc0VuY3J5cHQobiksIHQgIT0gaSAmJiAobiA9ICIiKSkNCiAgICB9IGNhdGNoKHIpIHsNCiAgICAgICAgbiA9ICIiDQogICAgfQ0KICAgIHJldHVybiBuID09ICIiICYmICh0ID0gYWVzRW5jcnlwdChpKSk7DQp9Ow0KZnVuY3Rpb24gYWVzRGVjcnlwdChuKSB7DQogICAgdmFyIHQgPSBDcnlwdG9KUy5NRDUoImxvZ2luLjE4OS5jbiIpLA0KICAgICAgICBpID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UodCksDQogICAgICAgIHIgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSgiMTIzNDU2NzgxMjM0NTY3OCIpOw0KICAgIHJldHVybiBDcnlwdG9KUy5BRVMuZGVjcnlwdChuLCBpLCB7DQogICAgICAgIGl2OiByDQogICAgfSkudG9TdHJpbmcoQ3J5cHRvSlMuZW5jLlV0ZjgpDQp9Ow0KZnVuY3Rpb24gYWVzRW5jcnlwdChuKSB7DQogICAgdmFyIHQgPSBDcnlwdG9KUy5NRDUoImxvZ2luLjE4OS5jbiIpLA0KICAgICAgICBpID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UodCksDQogICAgICAgIHIgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSgiMTIzNDU2NzgxMjM0NTY3OCIpLA0KICAgICAgICB1ID0gQ3J5cHRvSlMuQUVTLmVuY3J5cHQobiwgaSwgew0KICAgICAgICAgICAgaXY6IHINCiAgICAgICAgfSk7DQogICAgcmV0dXJuIHUgKyAiIg0KfTs=";

    @Override
    public HttpResult<Map<String, Object>> init(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        try {
            return result.success();
        } catch (Exception e) {
            logger.error("登录-->初始化失败,param={}", param, e);
            return result.failure(ErrorCode.TASK_INIT_ERROR);
        }
    }

    @Override
    public HttpResult<String> refeshPicCode(OperatorParam param) {
        return new HttpResult<String>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    @Override
    public HttpResult<Map<String, Object>> refeshSmsCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshSmsCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> submit(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return submitForLogin(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return submitForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> validatePicCode(OperatorParam param) {
        return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    @Override
    public HttpResult<Object> defineProcess(OperatorParam param) {
        return new HttpResult<Object>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    private HttpResult<Map<String, Object>> submitForLogin(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPassword(), ErrorCode.EMPTY_PASSWORD);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            //InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream("nei_meng_gu_10000_web/des.js");
            Invocable invocable = ScriptEngineUtil.createInvocableFromBase64(javaScript);
            String encryptPassword = invocable.invokeFunction("aesEncrypt", param.getPassword()).toString();

            String referer = "http://login.189.cn/login";
            String templateUrl = "http://login.189.cn/login";
            String templateData = "Account={}&UType=201&ProvinceID=07&AreaCode=&CityNo=&RandomFlag=0&Password={}&Captcha=";
            String data = TemplateUtils.format(templateData, param.getMobile(), URLEncoder.encode(encryptPassword, "UTF-8"));
            response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_001").setFullUrl(templateUrl).setReferer(referer)
                    .setRequestBody(data).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("登陆失败,param={},response={}", param, response);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
            String resultCode = PatternUtils.group(pageContent, "data-resultcode=\"(\\d+)\"", 1);
            if (resultCode != null) {
                if (resultCode.equals("9103") || resultCode.equals("9999")) {
                    logger.error("登陆失败,账户名与密码不匹配,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("8105")) {
                    logger.error("登陆失败,密码过于简单,请重置,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("9111")) {
                    logger.error("登陆失败,登录失败过多，帐号已被锁定,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("9100")) {
                    logger.error("登陆失败,该账户不存在,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PHONE_FAIL);
                } else if (resultCode.equals("6113")) {
                    logger.error("登陆失败,系统繁忙，稍后重试,param={},response={}", param, response);
                    return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
                } else if (StringUtils.isNotBlank(resultCode)) {
                    logger.error("登陆失败,param={},response={}", param, response);
                    return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
                }
            }

            referer = "http://www.189.cn/nm/";
            templateUrl = "http://www.189.cn/login/sso/ecs.do?method=linkTo&platNo=10008&toStUrl=http://nm.189.cn/selfservice/bill/hf";
            response = TaskHttpClient.create(param, RequestType.GET, "nei_meng_gu_10000_web_002").setFullUrl(templateUrl).setReferer(referer)
                    .invoke();
            pageContent = response.getPageContent();

            //String intLoginType = "4";
            //String areaCode = "0471";
            //String isBusinessCustType = "N";
            //String identifyType = "B";
            //String userLoginType = "4";
            //String noCheck = "N";
            //String isSSOLogin = "Y";
            //String sRand = "SSOLogin";

            String intLoginType = PatternUtils.group(pageContent, "intLoginType:\"(\\d+)\"", 1);
            String areaCode = PatternUtils.group(pageContent, "areaCode:\"(\\d+)\"", 1);
            String isBusinessCustType = PatternUtils.group(pageContent, "isBusinessCustType:\"([^\"]+)\"", 1);
            String identifyType = PatternUtils.group(pageContent, "identifyType:\"([^\"]+)\"", 1);
            String userLoginType = PatternUtils.group(pageContent, "identifyType:\"(\\d+)\"", 1);
            String noCheck = PatternUtils.group(pageContent, "noCheck:\"([^\"]+)\"", 1);
            String isSSOLogin = PatternUtils.group(pageContent, "isSSOLogin:\"([^\"]+)\"", 1);
            String sRand = PatternUtils.group(pageContent, "sRand:\"([^\"]+)\"", 1);

            referer = "http://www.189.cn/login/sso/ecs.do?method=linkTo&platNo=10008&toStUrl=http://nm.189.cn/selfservice/bill/hf";
            templateUrl = "http://nm.189.cn/selfservice/service/userLogin";
            /**
             *  {
             *      "number":"userName",
             *      "intLoginType":"intLoginType",
             *      "areaCode":"areaCode",
             *      "isBusinessCustType":"isBusinessCustType",
             *      "identifyType":"identifyType",
             *      "userLoginType":"userLoginType",
             *      "password":"",
             *      "randomPass":"",
             *      "noCheck":"noCheck",
             *      "isSSOLogin":"isSSOLogin",
             *      "sRand":"sRand"
             *  }
             */
            Map<String, Object> params = new HashMap<>();
            params.put("number", param.getMobile().toString());
            params.put("intLoginType", intLoginType);
            params.put("areaCode", areaCode);
            params.put("isBusinessCustType", isBusinessCustType);
            params.put("identifyType", identifyType);
            params.put("userLoginType", userLoginType);
            params.put("password", "");
            params.put("randomPass", "");
            params.put("noCheck", noCheck);
            params.put("isSSOLogin", isSSOLogin);
            params.put("sRand", sRand);

            data = JSON.toJSONString(params);
            response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_003").setFullUrl(templateUrl)
                    .setRequestBody(data, ContentType.APPLICATION_JSON).setReferer(referer).invoke();

            templateUrl = "http://nm.189.cn/selfservice/bill/hfQuery";
            /**
             * {
             *      "accNbr":"userName",
             *      "accNbrType":"4",
             *      "areaCode":"0476",
             *      "prodSpecId":"378",
             *      "smsCode":"",
             *      "prodSpecName":"??"
             * }
             */
            params = new HashMap<>();
            params.put("accNbr", param.getMobile().toString());
            params.put("accNbrType", "4");
            params.put("areaCode", "0476");
            params.put("prodSpecId", "378");
            params.put("smsCode", "");
            params.put("prodSpecName", "??");

            data = JSON.toJSONString(params);
            response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_004").setFullUrl(templateUrl)
                    .setRequestBody(data, ContentType.APPLICATION_JSON).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, param.getMobile().toString())) {
                areaCode = PatternUtils.group(pageContent, "areaCode\":\"(\\d+)\"", 1);
                TaskUtils.addTaskShare(param.getTaskId(), "areaCode", areaCode);
                logger.warn("登录成功,params={}", param);
                return result.success();
            } else {
                logger.warn("登录失败,param={},response={}", param, response);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登陆失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.LOGIN_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> refeshSmsCodeForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String length = "" + (64 + 6 * (param.getRealName().length()));
            String referer = "http://nm.189.cn/selfservice/bill/xd";
            String templateUrl = "http://nm.189.cn/selfservice/cust/checkNameAndIdentNbr";
            /**
             *  {
             *      "custName":"userName",
             *      "identNbr":"idCard",
             *      "IDCardType":"1"
             *  }
             */
            Map<String, Object> params = new HashMap<>();
            params.put("custName", NeiMengGu10000ForWeb.unicode(param.getRealName()));
            params.put("identNbr", param.getIdCard());
            params.put("IDCardType", "1");

            String data = JSON.toJSONString(params);
            response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_005").setFullUrl(templateUrl)
                    .setRequestBody(data, ContentType.APPLICATION_JSON).setReferer(referer).addHeader("Content-Length", length).invoke();
            String pageContent = response.getPageContent();
            if (!StringUtils.contains(pageContent, "flag\":\"1\"")) {
                logger.error("详单-->短信验证码-->刷新失败,身份校验失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
            referer = "http://nm.189.cn/selfservice/bill/wdcp";
            templateUrl = "http://nm.189.cn/selfservice/bill/xdQuerySMS";
            /**
             * {"phone":"phone"}
             */
            params = new HashMap<>();
            params.put("phone", param.getMobile().toString());

            data = JSON.toJSONString(params);
            response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_006").setFullUrl(templateUrl)
                    .setRequestBody(data, ContentType.APPLICATION_JSON).setReferer(referer).addHeader("Content-Length", "23").invoke();
            pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "flag\":\"0\"")) {
                logger.info("详单-->短信验证码-->刷新成功,param={}", param);
                return result.success();
            } else {
                /**
                 * "flag":"2"  一小时超过5次
                 */
                logger.error("详单-->短信验证码-->刷新失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->短信验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_SMS_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> submitForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String referer = "http://nm.189.cn/selfservice/bill/wdcp";
            String templateUrl = "http://nm.189.cn/selfservice/bill/xdQuerySMSCheck";
            /**
             *  {"code":"smsCode"}
             */
            Map<String, Object> params = new HashMap<>();
            params.put("code", param.getSmsCode());

            String data = JSON.toJSONString(params);
            response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_007").setFullUrl(templateUrl)
                    .setRequestBody(data, ContentType.APPLICATION_JSON).setReferer(referer).addHeader("Content-Length", "17").invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "flag\":\"1\"")) {
                referer = "http://nm.189.cn/selfservice/bill/xd";
                templateUrl = "http://nm.189.cn/selfservice/bill/xdQuerySMSCheckIf";
                response = TaskHttpClient.create(param, RequestType.POST, "nei_meng_gu_10000_web_008").setFullUrl(templateUrl)
                        .setRequestBody("{}", ContentType.APPLICATION_JSON).setReferer(referer).addHeader("Content-Length", "2").invoke();
                pageContent = response.getPageContent();
                if (StringUtils.contains(pageContent, "flag\":\"1\"")) {
                    logger.info("详单-->校验成功,param={}", param);
                    return result.success();
                } else {
                    logger.error("详单-->校验失败,还需要进行短信校验,param={},pateContent={}", param, pageContent);
                    return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
                }
            } else {
                logger.error("详单-->校验失败,param={},pateContent={}", param, pageContent);
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_ERROR);
        }
    }

    //中文转为Unicode
    public static String unicode(final String gbString) {
        char[] utfBytes = gbString.toCharArray();
        String unicodeBytes = "";
        for (int byteIndex = 0; byteIndex < utfBytes.length; byteIndex++) {
            String hexB = Integer.toHexString(utfBytes[byteIndex]);   //转换为16进制整型字符串
            if (hexB.length() <= 2) {
                hexB = "00" + hexB;
            }
            unicodeBytes = unicodeBytes + "%u" + hexB;  //注：此处 "\\u" 应当前运营商需求转为 "%u"
        }
        System.out.println("unicodeBytes is: " + unicodeBytes);
        return unicodeBytes;
    }
}
