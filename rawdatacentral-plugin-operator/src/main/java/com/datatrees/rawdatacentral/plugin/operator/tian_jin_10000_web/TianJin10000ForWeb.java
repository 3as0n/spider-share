package com.datatrees.rawdatacentral.plugin.operator.tian_jin_10000_web;

import javax.script.Invocable;
import java.math.BigDecimal;
import java.net.URLEncoder;
import java.util.Map;

import com.datatrees.common.util.PatternUtils;
import com.datatrees.rawdatacentral.common.http.TaskHttpClient;
import com.datatrees.rawdatacentral.common.utils.CheckUtils;
import com.datatrees.rawdatacentral.common.utils.ScriptEngineUtil;
import com.datatrees.rawdatacentral.common.utils.TemplateUtils;
import com.datatrees.rawdatacentral.domain.constant.FormType;
import com.datatrees.rawdatacentral.domain.enums.ErrorCode;
import com.datatrees.rawdatacentral.domain.enums.RequestType;
import com.datatrees.rawdatacentral.domain.operator.OperatorParam;
import com.datatrees.rawdatacentral.domain.result.HttpResult;
import com.datatrees.rawdatacentral.domain.vo.Response;
import com.datatrees.rawdatacentral.service.OperatorPluginService;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Created by guimeichao on 17/10/10.
 */
public class TianJin10000ForWeb implements OperatorPluginService {

    private static final Logger logger     = LoggerFactory.getLogger(TianJin10000ForWeb.class);
    private static final String javaScript
                                           = "dmFyIENyeXB0b0pTID0gQ3J5cHRvSlMgfHwKICAgIGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICB2YXIgdSA9IHt9LAogICAgICAgICAgICBmID0gdS5saWIgPSB7fSwKICAgICAgICAgICAgbyA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgIGkgPSBmLkJhc2UgPSB7CiAgICAgICAgICAgICAgICBleHRlbmQ6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICBvLnByb3RvdHlwZSA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBuZXcgbzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbiAmJiB0Lm1peEluKG4pLAogICAgICAgICAgICAgICAgICAgIHQuaGFzT3duUHJvcGVydHkoImluaXQiKSB8fCAodC5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuJHN1cGVyLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICB0LmluaXQucHJvdG90eXBlID0gdCwKICAgICAgICAgICAgICAgICAgICAgICAgdC4kc3VwZXIgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICB0CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY3JlYXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IHRoaXMuZXh0ZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG4uaW5pdC5hcHBseShuLCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICAgICAgICBuCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgICAgIG1peEluOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdCBpbiBuKSBuLmhhc093blByb3BlcnR5KHQpICYmICh0aGlzW3RdID0gblt0XSk7CiAgICAgICAgICAgICAgICAgICAgbi5oYXNPd25Qcm9wZXJ0eSgidG9TdHJpbmciKSAmJiAodGhpcy50b1N0cmluZyA9IG4udG9TdHJpbmcpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmluaXQucHJvdG90eXBlLmV4dGVuZCh0aGlzKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICByID0gZi5Xb3JkQXJyYXkgPSBpLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbihuLCBpKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IHRoaXMud29yZHMgPSBuIHx8IFtdOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2lnQnl0ZXMgPSBpICE9IHQgPyBpOiA0ICogbi5sZW5ndGgKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAobiB8fCBsKS5zdHJpbmdpZnkodGhpcykKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjb25jYXQ6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHRoaXMud29yZHMsCiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBuLndvcmRzLAogICAgICAgICAgICAgICAgICAgICAgICB1ID0gdGhpcy5zaWdCeXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgdDsKICAgICAgICAgICAgICAgICAgICBpZiAobiA9IG4uc2lnQnl0ZXMsIHRoaXMuY2xhbXAoKSwgdSAlIDQpIGZvciAodCA9IDA7IHQgPCBuOyB0KyspIGlbdSArIHQgPj4+IDJdIHw9IChyW3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1KSA8PCAyNCAtIDggKiAoKHUgKyB0KSAlIDQpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKDY1NTM1IDwgci5sZW5ndGgpIGZvciAodCA9IDA7IHQgPCBuOyB0ICs9IDQpIGlbdSArIHQgPj4+IDJdID0gclt0ID4+PiAyXTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGkucHVzaC5hcHBseShpLCByKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaWdCeXRlcyArPSBuLAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2xhbXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpID0gdGhpcy53b3JkcywKICAgICAgICAgICAgICAgICAgICAgICAgdCA9IHRoaXMuc2lnQnl0ZXM7CiAgICAgICAgICAgICAgICAgICAgaVt0ID4+PiAyXSAmPSA0Mjk0OTY3Mjk1IDw8IDMyIC0gOCAqICh0ICUgNCk7CiAgICAgICAgICAgICAgICAgICAgaS5sZW5ndGggPSBuLmNlaWwodCAvIDQpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gaS5jbG9uZS5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuLndvcmRzID0gdGhpcy53b3Jkcy5zbGljZSgwKSwKICAgICAgICAgICAgICAgICAgICAgICAgbgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJhbmRvbTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBbXSwgdSA9IDA7IHUgPCB0OyB1ICs9IDQpIGkucHVzaCg0Mjk0OTY3Mjk2ICogbi5yYW5kb20oKSB8IDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KGksIHQpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBlID0gdS5lbmMgPSB7fSwKICAgICAgICAgICAgbCA9IGUuSGV4ID0gewogICAgICAgICAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHUgPSBuLndvcmRzLAogICAgICAgICAgICAgICAgICAgICAgICBpLCB0LCByOwogICAgICAgICAgICAgICAgICAgIGZvciAobiA9IG4uc2lnQnl0ZXMsIGkgPSBbXSwgdCA9IDA7IHQgPCBuOyB0KyspIHIgPSB1W3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1LAogICAgICAgICAgICAgICAgICAgICAgICBpLnB1c2goKHIgPj4+IDQpLnRvU3RyaW5nKDE2KSksCiAgICAgICAgICAgICAgICAgICAgICAgIGkucHVzaCgociAmIDE1KS50b1N0cmluZygxNikpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpLmpvaW4oIiIpCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gbi5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdSA9IFtdLCB0ID0gMDsgdCA8IGk7IHQgKz0gMikgdVt0ID4+PiAzXSB8PSBwYXJzZUludChuLnN1YnN0cih0LCAyKSwgMTYpIDw8IDI0IC0gNCAqICh0ICUgOCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQodSwgaSAvIDIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHMgPSBlLkxhdGluMSA9IHsKICAgICAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHZhciByID0gbi53b3JkcywKICAgICAgICAgICAgICAgICAgICAgICAgaSwgdDsKICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSBuLnNpZ0J5dGVzLCBpID0gW10sIHQgPSAwOyB0IDwgbjsgdCsrKSBpLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZShyW3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1KSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkuam9pbigiIikKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBuLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1ID0gW10sIHQgPSAwOyB0IDwgaTsgdCsrKSB1W3QgPj4+IDJdIHw9IChuLmNoYXJDb2RlQXQodCkgJiAyNTUpIDw8IDI0IC0gOCAqICh0ICUgNCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQodSwgaSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgYSA9IGUuVXRmOCA9IHsKICAgICAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoZXNjYXBlKHMuc3RyaW5naWZ5KG4pKSkKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIk1hbGZvcm1lZCBVVEYtOCBkYXRhIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHMucGFyc2UodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KG4pKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaCA9IGYuQnVmZmVyZWRCbG9ja0FsZ29yaXRobSA9IGkuZXh0ZW5kKHsKICAgICAgICAgICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kYXRhID0gbmV3IHIuaW5pdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9uRGF0YUJ5dGVzID0gMAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9hcHBlbmQ6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgICAic3RyaW5nIiA9PSB0eXBlb2YgbiAmJiAobiA9IGEucGFyc2UobikpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2RhdGEuY29uY2F0KG4pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX25EYXRhQnl0ZXMgKz0gbi5zaWdCeXRlcwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9wcm9jZXNzOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGYgPSB0aGlzLl9kYXRhLAogICAgICAgICAgICAgICAgICAgICAgICBzID0gZi53b3JkcywKICAgICAgICAgICAgICAgICAgICAgICAgdSA9IGYuc2lnQnl0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGUgPSB0aGlzLmJsb2NrU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHUgLyAoNCAqIGUpLAogICAgICAgICAgICAgICAgICAgICAgICBvID0gdCA/IG4uY2VpbChvKSA6IG4ubWF4KChvIHwgMCkgLSB0aGlzLl9taW5CdWZmZXJTaXplLCAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgaTsKICAgICAgICAgICAgICAgICAgICBpZiAodCA9IG8gKiBlLCB1ID0gbi5taW4oNCAqIHQsIHUpLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0OyBpICs9IGUpIHRoaXMuX2RvUHJvY2Vzc0Jsb2NrKHMsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICBpID0gcy5zcGxpY2UoMCwgdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGYuc2lnQnl0ZXMgLT0gdQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHIuaW5pdChpLCB1KQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IGkuY2xvbmUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbi5fZGF0YSA9IHRoaXMuX2RhdGEuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9taW5CdWZmZXJTaXplOiAwCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBjOwogICAgICAgIHJldHVybiBmLkhhc2hlciA9IGguZXh0ZW5kKHsKICAgICAgICAgICAgY2ZnOiBpLmV4dGVuZCgpLAogICAgICAgICAgICBpbml0OiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNmZyA9IHRoaXMuY2ZnLmV4dGVuZChuKTsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKQogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBoLnJlc2V0LmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLl9kb1Jlc2V0KCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXBkYXRlOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fYXBwZW5kKG4pLAogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3MoKSwKICAgICAgICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZpbmFsaXplOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbiAmJiB0aGlzLl9hcHBlbmQobiksCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZG9GaW5hbGl6ZSgpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJsb2NrU2l6ZTogMTYsCiAgICAgICAgICAgIF9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBuLmluaXQoaSkuZmluYWxpemUodCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2NyZWF0ZUhtYWNIZWxwZXI6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0LCBpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjLkhNQUMuaW5pdChuLCBpKS5maW5hbGl6ZSh0KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgICAgIGMgPSB1LmFsZ28gPSB7fSwKICAgICAgICAgICAgdQogICAgfSAoTWF0aCk7IChmdW5jdGlvbigpIHsKICAgIHZhciBuID0gQ3J5cHRvSlMsCiAgICAgICAgdCA9IG4ubGliLldvcmRBcnJheTsKICAgIG4uZW5jLkJhc2U2NCA9IHsKICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgdmFyIGkgPSBuLndvcmRzLAogICAgICAgICAgICAgICAgdSA9IG4uc2lnQnl0ZXMsCiAgICAgICAgICAgICAgICBmID0gdGhpcy5fbWFwLAogICAgICAgICAgICAgICAgdCwgZSwgcjsKICAgICAgICAgICAgZm9yIChuLmNsYW1wKCksIG4gPSBbXSwgdCA9IDA7IHQgPCB1OyB0ICs9IDMpIGZvciAoZSA9IChpW3QgPj4+IDJdID4+PiAyNCAtIDggKiAodCAlIDQpICYgMjU1KSA8PCAxNiB8IChpW3QgKyAxID4+PiAyXSA+Pj4gMjQgLSA4ICogKCh0ICsgMSkgJSA0KSAmIDI1NSkgPDwgOCB8IGlbdCArIDIgPj4+IDJdID4+PiAyNCAtIDggKiAoKHQgKyAyKSAlIDQpICYgMjU1LCByID0gMDsgNCA+IHIgJiYgdCArIC43NSAqIHIgPCB1OyByKyspIG4ucHVzaChmLmNoYXJBdChlID4+PiA2ICogKDMgLSByKSAmIDYzKSk7CiAgICAgICAgICAgIGlmIChpID0gZi5jaGFyQXQoNjQpKSBmb3IgKDsgbi5sZW5ndGggJSA0Oykgbi5wdXNoKGkpOwogICAgICAgICAgICByZXR1cm4gbi5qb2luKCIiKQogICAgICAgIH0sCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgdmFyIGUgPSBuLmxlbmd0aCwKICAgICAgICAgICAgICAgIGYgPSB0aGlzLl9tYXAsCiAgICAgICAgICAgICAgICBpID0gZi5jaGFyQXQoNjQpLAogICAgICAgICAgICAgICAgbywKICAgICAgICAgICAgICAgIHM7CiAgICAgICAgICAgIGkgJiYgKGkgPSBuLmluZGV4T2YoaSksIC0xICE9IGkgJiYgKGUgPSBpKSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBbXSwgdSA9IDAsIHIgPSAwOyByIDwgZTsgcisrKSByICUgNCAmJiAobyA9IGYuaW5kZXhPZihuLmNoYXJBdChyIC0gMSkpIDw8IDIgKiAociAlIDQpLCBzID0gZi5pbmRleE9mKG4uY2hhckF0KHIpKSA+Pj4gNiAtIDIgKiAociAlIDQpLCBpW3UgPj4+IDJdIHw9IChvIHwgcykgPDwgMjQgLSA4ICogKHUgJSA0KSwgdSsrKTsKICAgICAgICAgICAgcmV0dXJuIHQuY3JlYXRlKGksIHUpCiAgICAgICAgfSwKICAgICAgICBfbWFwOiAiQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLz0iCiAgICB9Cn0pKCksCiAgICBmdW5jdGlvbihuKSB7CiAgICAgICAgZnVuY3Rpb24gaShuLCB0LCBpLCByLCB1LCBmLCBlKSB7CiAgICAgICAgICAgIHJldHVybiBuID0gbiArICh0ICYgaSB8IH50ICYgcikgKyB1ICsgZSwKICAgICAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHIobiwgdCwgaSwgciwgdSwgZiwgZSkgewogICAgICAgICAgICByZXR1cm4gbiA9IG4gKyAodCAmIHIgfCBpICYgfnIpICsgdSArIGUsCiAgICAgICAgICAgIChuIDw8IGYgfCBuID4+PiAzMiAtIGYpICsgdAogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1KG4sIHQsIGksIHIsIHUsIGYsIGUpIHsKICAgICAgICAgICAgcmV0dXJuIG4gPSBuICsgKHQgXiBpIF4gcikgKyB1ICsgZSwKICAgICAgICAgICAgKG4gPDwgZiB8IG4gPj4+IDMyIC0gZikgKyB0CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGYobiwgdCwgaSwgciwgdSwgZiwgZSkgewogICAgICAgICAgICByZXR1cm4gbiA9IG4gKyAoaSBeICh0IHwgfnIpKSArIHUgKyBlLAogICAgICAgICAgICAobiA8PCBmIHwgbiA+Pj4gMzIgLSBmKSArIHQKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgbyA9IENyeXB0b0pTLAogICAgICAgICAgICAgICAgIGUgPSBvLmxpYiwKICAgICAgICAgICAgICAgICBjID0gZS5Xb3JkQXJyYXksCiAgICAgICAgICAgICAgICAgcyA9IGUuSGFzaGVyLAogICAgICAgICAgICAgICAgIGUgPSBvLmFsZ28sCiAgICAgICAgICAgICAgICAgdCA9IFtdLCBoID0gMDsgNjQgPiBoOyBoKyspIHRbaF0gPSA0Mjk0OTY3Mjk2ICogbi5hYnMobi5zaW4oaCArIDEpKSB8IDA7CiAgICAgICAgZSA9IGUuTUQ1ID0gcy5leHRlbmQoewogICAgICAgICAgICBfZG9SZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9oYXNoID0gbmV3IGMuaW5pdChbMTczMjU4NDE5MywgNDAyMzIzMzQxNywgMjU2MjM4MzEwMiwgMjcxNzMzODc4XSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2RvUHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCBlKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB2LCBhLCBsID0gMDsgMTYgPiBsOyBsKyspIHYgPSBlICsgbCwKICAgICAgICAgICAgICAgICAgICBhID0gblt2XSwKICAgICAgICAgICAgICAgICAgICBuW3ZdID0gKGEgPDwgOCB8IGEgPj4+IDI0KSAmIDE2NzExOTM1IHwgKGEgPDwgMjQgfCBhID4+PiA4KSAmIDQyNzgyNTUzNjA7CiAgICAgICAgICAgICAgICB2YXIgbCA9IHRoaXMuX2hhc2gud29yZHMsCiAgICAgICAgICAgICAgICAgICAgdiA9IG5bZSArIDBdLAogICAgICAgICAgICAgICAgICAgIGEgPSBuW2UgKyAxXSwKICAgICAgICAgICAgICAgICAgICB5ID0gbltlICsgMl0sCiAgICAgICAgICAgICAgICAgICAgcCA9IG5bZSArIDNdLAogICAgICAgICAgICAgICAgICAgIHcgPSBuW2UgKyA0XSwKICAgICAgICAgICAgICAgICAgICBiID0gbltlICsgNV0sCiAgICAgICAgICAgICAgICAgICAgayA9IG5bZSArIDZdLAogICAgICAgICAgICAgICAgICAgIGQgPSBuW2UgKyA3XSwKICAgICAgICAgICAgICAgICAgICBnID0gbltlICsgOF0sCiAgICAgICAgICAgICAgICAgICAgbnQgPSBuW2UgKyA5XSwKICAgICAgICAgICAgICAgICAgICB0dCA9IG5bZSArIDEwXSwKICAgICAgICAgICAgICAgICAgICBpdCA9IG5bZSArIDExXSwKICAgICAgICAgICAgICAgICAgICBydCA9IG5bZSArIDEyXSwKICAgICAgICAgICAgICAgICAgICB1dCA9IG5bZSArIDEzXSwKICAgICAgICAgICAgICAgICAgICBmdCA9IG5bZSArIDE0XSwKICAgICAgICAgICAgICAgICAgICBldCA9IG5bZSArIDE1XSwKICAgICAgICAgICAgICAgICAgICBvID0gbFswXSwKICAgICAgICAgICAgICAgICAgICBzID0gbFsxXSwKICAgICAgICAgICAgICAgICAgICBoID0gbFsyXSwKICAgICAgICAgICAgICAgICAgICBjID0gbFszXSwKICAgICAgICAgICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCB2LCA3LCB0WzBdKSwKICAgICAgICAgICAgICAgICAgICBjID0gaShjLCBvLCBzLCBoLCBhLCAxMiwgdFsxXSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGkoaCwgYywgbywgcywgeSwgMTcsIHRbMl0pLAogICAgICAgICAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIHAsIDIyLCB0WzNdKSwKICAgICAgICAgICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCB3LCA3LCB0WzRdKSwKICAgICAgICAgICAgICAgICAgICBjID0gaShjLCBvLCBzLCBoLCBiLCAxMiwgdFs1XSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGkoaCwgYywgbywgcywgaywgMTcsIHRbNl0pLAogICAgICAgICAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGQsIDIyLCB0WzddKSwKICAgICAgICAgICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCBnLCA3LCB0WzhdKSwKICAgICAgICAgICAgICAgICAgICBjID0gaShjLCBvLCBzLCBoLCBudCwgMTIsIHRbOV0pLAogICAgICAgICAgICAgICAgICAgIGggPSBpKGgsIGMsIG8sIHMsIHR0LCAxNywgdFsxMF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGl0LCAyMiwgdFsxMV0pLAogICAgICAgICAgICAgICAgICAgIG8gPSBpKG8sIHMsIGgsIGMsIHJ0LCA3LCB0WzEyXSksCiAgICAgICAgICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgdXQsIDEyLCB0WzEzXSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGkoaCwgYywgbywgcywgZnQsIDE3LCB0WzE0XSksCiAgICAgICAgICAgICAgICAgICAgcyA9IGkocywgaCwgYywgbywgZXQsIDIyLCB0WzE1XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgYSwgNSwgdFsxNl0pLAogICAgICAgICAgICAgICAgICAgIGMgPSByKGMsIG8sIHMsIGgsIGssIDksIHRbMTddKSwKICAgICAgICAgICAgICAgICAgICBoID0gcihoLCBjLCBvLCBzLCBpdCwgMTQsIHRbMThdKSwKICAgICAgICAgICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCB2LCAyMCwgdFsxOV0pLAogICAgICAgICAgICAgICAgICAgIG8gPSByKG8sIHMsIGgsIGMsIGIsIDUsIHRbMjBdKSwKICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCB0dCwgOSwgdFsyMV0pLAogICAgICAgICAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGV0LCAxNCwgdFsyMl0pLAogICAgICAgICAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIHcsIDIwLCB0WzIzXSksCiAgICAgICAgICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgbnQsIDUsIHRbMjRdKSwKICAgICAgICAgICAgICAgICAgICBjID0gcihjLCBvLCBzLCBoLCBmdCwgOSwgdFsyNV0pLAogICAgICAgICAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIHAsIDE0LCB0WzI2XSksCiAgICAgICAgICAgICAgICAgICAgcyA9IHIocywgaCwgYywgbywgZywgMjAsIHRbMjddKSwKICAgICAgICAgICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCB1dCwgNSwgdFsyOF0pLAogICAgICAgICAgICAgICAgICAgIGMgPSByKGMsIG8sIHMsIGgsIHksIDksIHRbMjldKSwKICAgICAgICAgICAgICAgICAgICBoID0gcihoLCBjLCBvLCBzLCBkLCAxNCwgdFszMF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIHJ0LCAyMCwgdFszMV0pLAogICAgICAgICAgICAgICAgICAgIG8gPSB1KG8sIHMsIGgsIGMsIGIsIDQsIHRbMzJdKSwKICAgICAgICAgICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCBnLCAxMSwgdFszM10pLAogICAgICAgICAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGl0LCAxNiwgdFszNF0pLAogICAgICAgICAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIGZ0LCAyMywgdFszNV0pLAogICAgICAgICAgICAgICAgICAgIG8gPSB1KG8sIHMsIGgsIGMsIGEsIDQsIHRbMzZdKSwKICAgICAgICAgICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCB3LCAxMSwgdFszN10pLAogICAgICAgICAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGQsIDE2LCB0WzM4XSksCiAgICAgICAgICAgICAgICAgICAgcyA9IHUocywgaCwgYywgbywgdHQsIDIzLCB0WzM5XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgdXQsIDQsIHRbNDBdKSwKICAgICAgICAgICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCB2LCAxMSwgdFs0MV0pLAogICAgICAgICAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIHAsIDE2LCB0WzQyXSksCiAgICAgICAgICAgICAgICAgICAgcyA9IHUocywgaCwgYywgbywgaywgMjMsIHRbNDNdKSwKICAgICAgICAgICAgICAgICAgICBvID0gdShvLCBzLCBoLCBjLCBudCwgNCwgdFs0NF0pLAogICAgICAgICAgICAgICAgICAgIGMgPSB1KGMsIG8sIHMsIGgsIHJ0LCAxMSwgdFs0NV0pLAogICAgICAgICAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGV0LCAxNiwgdFs0Nl0pLAogICAgICAgICAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIHksIDIzLCB0WzQ3XSksCiAgICAgICAgICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgdiwgNiwgdFs0OF0pLAogICAgICAgICAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGQsIDEwLCB0WzQ5XSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgZnQsIDE1LCB0WzUwXSksCiAgICAgICAgICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgYiwgMjEsIHRbNTFdKSwKICAgICAgICAgICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCBydCwgNiwgdFs1Ml0pLAogICAgICAgICAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIHAsIDEwLCB0WzUzXSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgdHQsIDE1LCB0WzU0XSksCiAgICAgICAgICAgICAgICAgICAgcyA9IGYocywgaCwgYywgbywgYSwgMjEsIHRbNTVdKSwKICAgICAgICAgICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCBnLCA2LCB0WzU2XSksCiAgICAgICAgICAgICAgICAgICAgYyA9IGYoYywgbywgcywgaCwgZXQsIDEwLCB0WzU3XSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgaywgMTUsIHRbNThdKSwKICAgICAgICAgICAgICAgICAgICBzID0gZihzLCBoLCBjLCBvLCB1dCwgMjEsIHRbNTldKSwKICAgICAgICAgICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCB3LCA2LCB0WzYwXSksCiAgICAgICAgICAgICAgICAgICAgYyA9IGYoYywgbywgcywgaCwgaXQsIDEwLCB0WzYxXSksCiAgICAgICAgICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgeSwgMTUsIHRbNjJdKSwKICAgICAgICAgICAgICAgICAgICBzID0gZihzLCBoLCBjLCBvLCBudCwgMjEsIHRbNjNdKTsKICAgICAgICAgICAgICAgIGxbMF0gPSBsWzBdICsgbyB8IDA7CiAgICAgICAgICAgICAgICBsWzFdID0gbFsxXSArIHMgfCAwOwogICAgICAgICAgICAgICAgbFsyXSA9IGxbMl0gKyBoIHwgMDsKICAgICAgICAgICAgICAgIGxbM10gPSBsWzNdICsgYyB8IDAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2RvRmluYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIHUgPSB0aGlzLl9kYXRhLAogICAgICAgICAgICAgICAgICAgIHIgPSB1LndvcmRzLAogICAgICAgICAgICAgICAgICAgIHQgPSA4ICogdGhpcy5fbkRhdGFCeXRlcywKICAgICAgICAgICAgICAgICAgICBpID0gOCAqIHUuc2lnQnl0ZXMsCiAgICAgICAgICAgICAgICAgICAgZjsKICAgICAgICAgICAgICAgIGZvciAocltpID4+PiA1XSB8PSAxMjggPDwgMjQgLSBpICUgMzIsIGYgPSBuLmZsb29yKHQgLyA0Mjk0OTY3Mjk2KSwgclsoaSArIDY0ID4+PiA5IDw8IDQpICsgMTVdID0gKGYgPDwgOCB8IGYgPj4+IDI0KSAmIDE2NzExOTM1IHwgKGYgPDwgMjQgfCBmID4+PiA4KSAmIDQyNzgyNTUzNjAsIHJbKGkgKyA2NCA+Pj4gOSA8PCA0KSArIDE0XSA9ICh0IDw8IDggfCB0ID4+PiAyNCkgJiAxNjcxMTkzNSB8ICh0IDw8IDI0IHwgdCA+Pj4gOCkgJiA0Mjc4MjU1MzYwLCB1LnNpZ0J5dGVzID0gNCAqIChyLmxlbmd0aCArIDEpLCB0aGlzLl9wcm9jZXNzKCksIHUgPSB0aGlzLl9oYXNoLCByID0gdS53b3JkcywgdCA9IDA7IDQgPiB0OyB0KyspIGkgPSByW3RdLAogICAgICAgICAgICAgICAgICAgIHJbdF0gPSAoaSA8PCA4IHwgaSA+Pj4gMjQpICYgMTY3MTE5MzUgfCAoaSA8PCAyNCB8IGkgPj4+IDgpICYgNDI3ODI1NTM2MDsKICAgICAgICAgICAgICAgIHJldHVybiB1CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBuID0gcy5jbG9uZS5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIG4uX2hhc2ggPSB0aGlzLl9oYXNoLmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgbgogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgby5NRDUgPSBzLl9jcmVhdGVIZWxwZXIoZSk7CiAgICAgICAgby5IbWFjTUQ1ID0gcy5fY3JlYXRlSG1hY0hlbHBlcihlKQogICAgfSAoTWF0aCksCiAgICBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdCA9IENyeXB0b0pTLAogICAgICAgICAgICBuID0gdC5saWIsCiAgICAgICAgICAgIGkgPSBuLkJhc2UsCiAgICAgICAgICAgIHIgPSBuLldvcmRBcnJheSwKICAgICAgICAgICAgbiA9IHQuYWxnbywKICAgICAgICAgICAgdSA9IG4uRXZwS0RGID0gaS5leHRlbmQoewogICAgICAgICAgICAgICAgY2ZnOiBpLmV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAga2V5U2l6ZTogNCwKICAgICAgICAgICAgICAgICAgICBoYXNoZXI6IG4uTUQ1LAogICAgICAgICAgICAgICAgICAgIGl0ZXJhdGlvbnM6IDEKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2ZnID0gdGhpcy5jZmcuZXh0ZW5kKG4pCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY29tcHV0ZTogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGksIG8sIGYgPSB0aGlzLmNmZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1ID0gZi5oYXNoZXIuY3JlYXRlKCksIGUgPSByLmNyZWF0ZSgpLCBoID0gZS53b3JkcywgcyA9IGYua2V5U2l6ZSwgZiA9IGYuaXRlcmF0aW9uczsgaC5sZW5ndGggPCBzOykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgJiYgdS51cGRhdGUoaSksIGkgPSB1LnVwZGF0ZShuKS5maW5hbGl6ZSh0KSwgdS5yZXNldCgpLCBvID0gMTsgbyA8IGY7IG8rKykgaSA9IHUuZmluYWxpemUoaSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1LnJlc2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGUuY29uY2F0KGkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlLnNpZ0J5dGVzID0gNCAqIHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgdC5FdnBLREYgPSBmdW5jdGlvbihuLCB0LCBpKSB7CiAgICAgICAgICAgIHJldHVybiB1LmNyZWF0ZShpKS5jb21wdXRlKG4sIHQpCiAgICAgICAgfQogICAgfSAoKTsKQ3J5cHRvSlMubGliLkNpcGhlciB8fApmdW5jdGlvbihuKSB7CiAgICB2YXIgaSA9IENyeXB0b0pTLAogICAgICAgIHQgPSBpLmxpYiwKICAgICAgICBmID0gdC5CYXNlLAogICAgICAgIGUgPSB0LldvcmRBcnJheSwKICAgICAgICBjID0gdC5CdWZmZXJlZEJsb2NrQWxnb3JpdGhtLAogICAgICAgIGwgPSBpLmVuYy5CYXNlNjQsCiAgICAgICAgeSA9IGkuYWxnby5FdnBLREYsCiAgICAgICAgbyA9IHQuQ2lwaGVyID0gYy5leHRlbmQoewogICAgICAgICAgICBjZmc6IGYuZXh0ZW5kKCksCiAgICAgICAgICAgIGNyZWF0ZUVuY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHRoaXMuX0VOQ19YRk9STV9NT0RFLCBuLCB0KQogICAgICAgICAgICB9LAogICAgICAgICAgICBjcmVhdGVEZWNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZSh0aGlzLl9ERUNfWEZPUk1fTU9ERSwgbiwgdCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgdCwgaSkgewogICAgICAgICAgICAgICAgdGhpcy5jZmcgPSB0aGlzLmNmZy5leHRlbmQoaSk7CiAgICAgICAgICAgICAgICB0aGlzLl94Zm9ybU1vZGUgPSBuOwogICAgICAgICAgICAgICAgdGhpcy5fa2V5ID0gdDsKICAgICAgICAgICAgICAgIHRoaXMucmVzZXQoKQogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjLnJlc2V0LmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLl9kb1Jlc2V0KCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJvY2VzczogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChuKSwKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9jZXNzKCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmluYWxpemU6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBuICYmIHRoaXMuX2FwcGVuZChuKSwKICAgICAgICAgICAgICAgICAgICB0aGlzLl9kb0ZpbmFsaXplKCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAga2V5U2l6ZTogNCwKICAgICAgICAgICAgaXZTaXplOiA0LAogICAgICAgICAgICBfRU5DX1hGT1JNX01PREU6IDEsCiAgICAgICAgICAgIF9ERUNfWEZPUk1fTU9ERTogMiwKICAgICAgICAgICAgX2NyZWF0ZUhlbHBlcjogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICBlbmNyeXB0OiBmdW5jdGlvbih0LCBpLCByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoInN0cmluZyIgPT0gdHlwZW9mIGkgPyB2OiB1KS5lbmNyeXB0KG4sIHQsIGksIHIpCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbih0LCBpLCByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoInN0cmluZyIgPT0gdHlwZW9mIGkgPyB2OiB1KS5kZWNyeXB0KG4sIHQsIGksIHIpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB0LlN0cmVhbUNpcGhlciA9IG8uZXh0ZW5kKHsKICAgICAgICBfZG9GaW5hbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzKCEwKQogICAgICAgIH0sCiAgICAgICAgYmxvY2tTaXplOiAxCiAgICB9KTsKICAgIHZhciBzID0gaS5tb2RlID0ge30sCiAgICAgICAgYSA9IGZ1bmN0aW9uKHQsIGksIHIpIHsKICAgICAgICAgICAgdmFyIGYgPSB0aGlzLl9pdiwKICAgICAgICAgICAgICAgIHU7CiAgICAgICAgICAgIGZvciAoZiA/IHRoaXMuX2l2ID0gbjogZiA9IHRoaXMuX3ByZXZCbG9jaywgdSA9IDA7IHUgPCByOyB1KyspIHRbaSArIHVdIF49IGZbdV0KICAgICAgICB9LAogICAgICAgIHIgPSAodC5CbG9ja0NpcGhlck1vZGUgPSBmLmV4dGVuZCh7CiAgICAgICAgICAgIGNyZWF0ZUVuY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuRW5jcnlwdG9yLmNyZWF0ZShuLCB0KQogICAgICAgICAgICB9LAogICAgICAgICAgICBjcmVhdGVEZWNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLkRlY3J5cHRvci5jcmVhdGUobiwgdCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICAgICAgdGhpcy5fY2lwaGVyID0gbjsKICAgICAgICAgICAgICAgIHRoaXMuX2l2ID0gdAogICAgICAgICAgICB9CiAgICAgICAgfSkpLmV4dGVuZCgpOwogICAgci5FbmNyeXB0b3IgPSByLmV4dGVuZCh7CiAgICAgICAgcHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgIHZhciBpID0gdGhpcy5fY2lwaGVyLAogICAgICAgICAgICAgICAgciA9IGkuYmxvY2tTaXplOwogICAgICAgICAgICBhLmNhbGwodGhpcywgbiwgdCwgcik7CiAgICAgICAgICAgIGkuZW5jcnlwdEJsb2NrKG4sIHQpOwogICAgICAgICAgICB0aGlzLl9wcmV2QmxvY2sgPSBuLnNsaWNlKHQsIHQgKyByKQogICAgICAgIH0KICAgIH0pOwogICAgci5EZWNyeXB0b3IgPSByLmV4dGVuZCh7CiAgICAgICAgcHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgIHZhciBpID0gdGhpcy5fY2lwaGVyLAogICAgICAgICAgICAgICAgciA9IGkuYmxvY2tTaXplLAogICAgICAgICAgICAgICAgdSA9IG4uc2xpY2UodCwgdCArIHIpOwogICAgICAgICAgICBpLmRlY3J5cHRCbG9jayhuLCB0KTsKICAgICAgICAgICAgYS5jYWxsKHRoaXMsIG4sIHQsIHIpOwogICAgICAgICAgICB0aGlzLl9wcmV2QmxvY2sgPSB1CiAgICAgICAgfQogICAgfSk7CiAgICBzID0gcy5DQkMgPSByOwogICAgciA9IChpLnBhZCA9IHt9KS5Qa2NzNyA9IHsKICAgICAgICBwYWQ6IGZ1bmN0aW9uKG4sIHQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDQgKiB0LAogICAgICAgICAgICAgICAgICAgICBpID0gaSAtIG4uc2lnQnl0ZXMgJSBpLAogICAgICAgICAgICAgICAgICAgICBmID0gaSA8PCAyNCB8IGkgPDwgMTYgfCBpIDw8IDggfCBpLAogICAgICAgICAgICAgICAgICAgICByID0gW10sIHUgPSAwOyB1IDwgaTsgdSArPSA0KSByLnB1c2goZik7CiAgICAgICAgICAgIGkgPSBlLmNyZWF0ZShyLCBpKTsKICAgICAgICAgICAgbi5jb25jYXQoaSkKICAgICAgICB9LAogICAgICAgIHVucGFkOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgIG4uc2lnQnl0ZXMgLT0gbi53b3Jkc1tuLnNpZ0J5dGVzIC0gMSA+Pj4gMl0gJiAyNTUKICAgICAgICB9CiAgICB9OwogICAgdC5CbG9ja0NpcGhlciA9IG8uZXh0ZW5kKHsKICAgICAgICBjZmc6IG8uY2ZnLmV4dGVuZCh7CiAgICAgICAgICAgIG1vZGU6IHMsCiAgICAgICAgICAgIHBhZGRpbmc6IHIKICAgICAgICB9KSwKICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0OwogICAgICAgICAgICBvLnJlc2V0LmNhbGwodGhpcyk7CiAgICAgICAgICAgIHZhciBuID0gdGhpcy5jZmcsCiAgICAgICAgICAgICAgICBpID0gbi5pdiwKICAgICAgICAgICAgICAgIG4gPSBuLm1vZGU7CiAgICAgICAgICAgIHRoaXMuX3hmb3JtTW9kZSA9PSB0aGlzLl9FTkNfWEZPUk1fTU9ERSA/IHQgPSBuLmNyZWF0ZUVuY3J5cHRvcjogKHQgPSBuLmNyZWF0ZURlY3J5cHRvciwgdGhpcy5fbWluQnVmZmVyU2l6ZSA9IDEpOwogICAgICAgICAgICB0aGlzLl9tb2RlID0gdC5jYWxsKG4sIHRoaXMsIGkgJiYgaS53b3JkcykKICAgICAgICB9LAogICAgICAgIF9kb1Byb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgdCkgewogICAgICAgICAgICB0aGlzLl9tb2RlLnByb2Nlc3NCbG9jayhuLCB0KQogICAgICAgIH0sCiAgICAgICAgX2RvRmluYWxpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdCA9IHRoaXMuY2ZnLnBhZGRpbmcsCiAgICAgICAgICAgICAgICBuOwogICAgICAgICAgICByZXR1cm4gdGhpcy5feGZvcm1Nb2RlID09IHRoaXMuX0VOQ19YRk9STV9NT0RFID8gKHQucGFkKHRoaXMuX2RhdGEsIHRoaXMuYmxvY2tTaXplKSwgbiA9IHRoaXMuX3Byb2Nlc3MoITApKSA6IChuID0gdGhpcy5fcHJvY2VzcyghMCksIHQudW5wYWQobikpLAogICAgICAgICAgICAgICAgbgogICAgICAgIH0sCiAgICAgICAgYmxvY2tTaXplOiA0CiAgICB9KTsKICAgIHZhciBoID0gdC5DaXBoZXJQYXJhbXMgPSBmLmV4dGVuZCh7CiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHRoaXMubWl4SW4obikKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiAobiB8fCB0aGlzLmZvcm1hdHRlcikuc3RyaW5naWZ5KHRoaXMpCiAgICAgICAgICAgIH0KICAgICAgICB9KSwKICAgICAgICBzID0gKGkuZm9ybWF0ID0ge30pLk9wZW5TU0wgPSB7CiAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgewogICAgICAgICAgICAgICAgdmFyIHQgPSBuLmNpcGhlcnRleHQ7CiAgICAgICAgICAgICAgICByZXR1cm4gbiA9IG4uc2FsdCwKICAgICAgICAgICAgICAgICAgICAobiA/IGUuY3JlYXRlKFsxMzk4ODkzNjg0LCAxNzAxMDc2ODMxXSkuY29uY2F0KG4pLmNvbmNhdCh0KSA6IHQpLnRvU3RyaW5nKGwpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBhcnNlOiBmdW5jdGlvbihuKSB7CiAgICAgICAgICAgICAgICB2YXIgdCwgaTsKICAgICAgICAgICAgICAgIHJldHVybiBuID0gbC5wYXJzZShuKSwKICAgICAgICAgICAgICAgICAgICB0ID0gbi53b3JkcywKICAgICAgICAgICAgICAgIDEzOTg4OTM2ODQgPT0gdFswXSAmJiAxNzAxMDc2ODMxID09IHRbMV0gJiYgKGkgPSBlLmNyZWF0ZSh0LnNsaWNlKDIsIDQpKSwgdC5zcGxpY2UoMCwgNCksIG4uc2lnQnl0ZXMgLT0gMTYpLAogICAgICAgICAgICAgICAgICAgIGguY3JlYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgY2lwaGVydGV4dDogbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2FsdDogaQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHUgPSB0LlNlcmlhbGl6YWJsZUNpcGhlciA9IGYuZXh0ZW5kKHsKICAgICAgICAgICAgY2ZnOiBmLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBmb3JtYXQ6IHMKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGVuY3J5cHQ6IGZ1bmN0aW9uKG4sIHQsIGksIHIpIHsKICAgICAgICAgICAgICAgIHIgPSB0aGlzLmNmZy5leHRlbmQocik7CiAgICAgICAgICAgICAgICB2YXIgdSA9IG4uY3JlYXRlRW5jcnlwdG9yKGksIHIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHQgPSB1LmZpbmFsaXplKHQpLAogICAgICAgICAgICAgICAgICAgIHUgPSB1LmNmZywKICAgICAgICAgICAgICAgICAgICBoLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGNpcGhlcnRleHQ6IHQsCiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogaSwKICAgICAgICAgICAgICAgICAgICAgICAgaXY6IHUuaXYsCiAgICAgICAgICAgICAgICAgICAgICAgIGFsZ29yaXRobTogbiwKICAgICAgICAgICAgICAgICAgICAgICAgbW9kZTogdS5tb2RlLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiB1LnBhZGRpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrU2l6ZTogbi5ibG9ja1NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlcjogci5mb3JtYXQKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gciA9IHRoaXMuY2ZnLmV4dGVuZChyKSwKICAgICAgICAgICAgICAgICAgICB0ID0gdGhpcy5fcGFyc2UodCwgci5mb3JtYXQpLAogICAgICAgICAgICAgICAgICAgIG4uY3JlYXRlRGVjcnlwdG9yKGksIHIpLmZpbmFsaXplKHQuY2lwaGVydGV4dCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3BhcnNlOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gInN0cmluZyIgPT0gdHlwZW9mIG4gPyB0LnBhcnNlKG4sIHRoaXMpIDogbgogICAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgaSA9IChpLmtkZiA9IHt9KS5PcGVuU1NMID0gewogICAgICAgICAgICBleGVjdXRlOiBmdW5jdGlvbihuLCB0LCBpLCByKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gciB8fCAociA9IGUucmFuZG9tKDgpKSwKICAgICAgICAgICAgICAgICAgICBuID0geS5jcmVhdGUoewogICAgICAgICAgICAgICAgICAgICAgICBrZXlTaXplOiB0ICsgaQogICAgICAgICAgICAgICAgICAgIH0pLmNvbXB1dGUobiwgciksCiAgICAgICAgICAgICAgICAgICAgaSA9IGUuY3JlYXRlKG4ud29yZHMuc2xpY2UodCksIDQgKiBpKSwKICAgICAgICAgICAgICAgICAgICBuLnNpZ0J5dGVzID0gNCAqIHQsCiAgICAgICAgICAgICAgICAgICAgaC5jcmVhdGUoewogICAgICAgICAgICAgICAgICAgICAgICBrZXk6IG4sCiAgICAgICAgICAgICAgICAgICAgICAgIGl2OiBpLAogICAgICAgICAgICAgICAgICAgICAgICBzYWx0OiByCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdiA9IHQuUGFzc3dvcmRCYXNlZENpcGhlciA9IHUuZXh0ZW5kKHsKICAgICAgICAgICAgY2ZnOiB1LmNmZy5leHRlbmQoewogICAgICAgICAgICAgICAga2RmOiBpCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBlbmNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gciA9IHRoaXMuY2ZnLmV4dGVuZChyKSwKICAgICAgICAgICAgICAgICAgICBpID0gci5rZGYuZXhlY3V0ZShpLCBuLmtleVNpemUsIG4uaXZTaXplKSwKICAgICAgICAgICAgICAgICAgICByLml2ID0gaS5pdiwKICAgICAgICAgICAgICAgICAgICBuID0gdS5lbmNyeXB0LmNhbGwodGhpcywgbiwgdCwgaS5rZXksIHIpLAogICAgICAgICAgICAgICAgICAgIG4ubWl4SW4oaSksCiAgICAgICAgICAgICAgICAgICAgbgogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gciA9IHRoaXMuY2ZnLmV4dGVuZChyKSwKICAgICAgICAgICAgICAgICAgICB0ID0gdGhpcy5fcGFyc2UodCwgci5mb3JtYXQpLAogICAgICAgICAgICAgICAgICAgIGkgPSByLmtkZi5leGVjdXRlKGksIG4ua2V5U2l6ZSwgbi5pdlNpemUsIHQuc2FsdCksCiAgICAgICAgICAgICAgICAgICAgci5pdiA9IGkuaXYsCiAgICAgICAgICAgICAgICAgICAgdS5kZWNyeXB0LmNhbGwodGhpcywgbiwgdCwgaS5rZXksIHIpCiAgICAgICAgICAgIH0KICAgICAgICB9KQp9ICgpLAogICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSwgdHQsIHMgPSBDcnlwdG9KUywKICAgICAgICAgICAgICAgICB5ID0gcy5saWIuQmxvY2tDaXBoZXIsCiAgICAgICAgICAgICAgICAgaCA9IHMuYWxnbywKICAgICAgICAgICAgICAgICB0ID0gW10sIHAgPSBbXSwgdyA9IFtdLCBiID0gW10sIGsgPSBbXSwgZCA9IFtdLCBjID0gW10sIGwgPSBbXSwgYSA9IFtdLCB2ID0gW10sIHUgPSBbXSwgZiA9IDA7IDI1NiA+IGY7IGYrKykgdVtmXSA9IDEyOCA+IGYgPyBmIDw8IDEgOiBmIDw8IDEgXiAyODM7CiAgICAgICAgZm9yICh2YXIgciA9IDAsCiAgICAgICAgICAgICAgICAgZSA9IDAsCiAgICAgICAgICAgICAgICAgZiA9IDA7IDI1NiA+IGY7IGYrKykgewogICAgICAgICAgICBpID0gZSBeIGUgPDwgMSBeIGUgPDwgMiBeIGUgPDwgMyBeIGUgPDwgNDsKICAgICAgICAgICAgaSA9IGkgPj4+IDggXiBpICYgMjU1IF4gOTk7CiAgICAgICAgICAgIHRbcl0gPSBpOwogICAgICAgICAgICBwW2ldID0gcjsKICAgICAgICAgICAgdmFyIG8gPSB1W3JdLAogICAgICAgICAgICAgICAgZyA9IHVbb10sCiAgICAgICAgICAgICAgICBudCA9IHVbZ10sCiAgICAgICAgICAgICAgICBuID0gMjU3ICogdVtpXSBeIDE2ODQzMDA4ICogaTsKICAgICAgICAgICAgd1tyXSA9IG4gPDwgMjQgfCBuID4+PiA4OwogICAgICAgICAgICBiW3JdID0gbiA8PCAxNiB8IG4gPj4+IDE2OwogICAgICAgICAgICBrW3JdID0gbiA8PCA4IHwgbiA+Pj4gMjQ7CiAgICAgICAgICAgIGRbcl0gPSBuOwogICAgICAgICAgICBuID0gMTY4NDMwMDkgKiBudCBeIDY1NTM3ICogZyBeIDI1NyAqIG8gXiAxNjg0MzAwOCAqIHI7CiAgICAgICAgICAgIGNbaV0gPSBuIDw8IDI0IHwgbiA+Pj4gODsKICAgICAgICAgICAgbFtpXSA9IG4gPDwgMTYgfCBuID4+PiAxNjsKICAgICAgICAgICAgYVtpXSA9IG4gPDwgOCB8IG4gPj4+IDI0OwogICAgICAgICAgICB2W2ldID0gbjsKICAgICAgICAgICAgciA/IChyID0gbyBeIHVbdVt1W250IF4gb11dXSwgZSBePSB1W3VbZV1dKSA6IHIgPSBlID0gMQogICAgICAgIH0KICAgICAgICB0dCA9IFswLCAxLCAyLCA0LCA4LCAxNiwgMzIsIDY0LCAxMjgsIDI3LCA1NF07CiAgICAgICAgaCA9IGguQUVTID0geS5leHRlbmQoewogICAgICAgICAgICBfZG9SZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBuLCBmID0gdGhpcy5fa2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGYud29yZHMsCiAgICAgICAgICAgICAgICAgICAgICAgICByID0gZi5zaWdCeXRlcyAvIDQsCiAgICAgICAgICAgICAgICAgICAgICAgICBmID0gNCAqICgodGhpcy5fblJvdW5kcyA9IHIgKyA2KSArIDEpLCB1ID0gdGhpcy5fa2V5U2NoZWR1bGUgPSBbXSwgaSA9IDA7IGkgPCBmOyBpKyspIGkgPCByID8gdVtpXSA9IGVbaV0gOiAobiA9IHVbaSAtIDFdLCBpICUgciA/IDYgPCByICYmIDQgPT0gaSAlIHIgJiYgKG4gPSB0W24gPj4+IDI0XSA8PCAyNCB8IHRbbiA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgdFtuID4+PiA4ICYgMjU1XSA8PCA4IHwgdFtuICYgMjU1XSkgOiAobiA9IG4gPDwgOCB8IG4gPj4+IDI0LCBuID0gdFtuID4+PiAyNF0gPDwgMjQgfCB0W24gPj4+IDE2ICYgMjU1XSA8PCAxNiB8IHRbbiA+Pj4gOCAmIDI1NV0gPDwgOCB8IHRbbiAmIDI1NV0sIG4gXj0gdHRbaSAvIHIgfCAwXSA8PCAyNCksIHVbaV0gPSB1W2kgLSByXSBeIG4pOwogICAgICAgICAgICAgICAgZm9yIChlID0gdGhpcy5faW52S2V5U2NoZWR1bGUgPSBbXSwgciA9IDA7IHIgPCBmOyByKyspIGkgPSBmIC0gciwKICAgICAgICAgICAgICAgICAgICBuID0gciAlIDQgPyB1W2ldIDogdVtpIC0gNF0sCiAgICAgICAgICAgICAgICAgICAgZVtyXSA9IDQgPiByIHx8IDQgPj0gaSA/IG46IGNbdFtuID4+PiAyNF1dIF4gbFt0W24gPj4+IDE2ICYgMjU1XV0gXiBhW3RbbiA+Pj4gOCAmIDI1NV1dIF4gdlt0W24gJiAyNTVdXQogICAgICAgICAgICB9LAogICAgICAgICAgICBlbmNyeXB0QmxvY2s6IGZ1bmN0aW9uKG4sIGkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RvQ3J5cHRCbG9jayhuLCBpLCB0aGlzLl9rZXlTY2hlZHVsZSwgdywgYiwgaywgZCwgdCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVjcnlwdEJsb2NrOiBmdW5jdGlvbihuLCB0KSB7CiAgICAgICAgICAgICAgICB2YXIgaSA9IG5bdCArIDFdOwogICAgICAgICAgICAgICAgblt0ICsgMV0gPSBuW3QgKyAzXTsKICAgICAgICAgICAgICAgIG5bdCArIDNdID0gaTsKICAgICAgICAgICAgICAgIHRoaXMuX2RvQ3J5cHRCbG9jayhuLCB0LCB0aGlzLl9pbnZLZXlTY2hlZHVsZSwgYywgbCwgYSwgdiwgcCk7CiAgICAgICAgICAgICAgICBpID0gblt0ICsgMV07CiAgICAgICAgICAgICAgICBuW3QgKyAxXSA9IG5bdCArIDNdOwogICAgICAgICAgICAgICAgblt0ICsgM10gPSBpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9kb0NyeXB0QmxvY2s6IGZ1bmN0aW9uKG4sIHQsIGksIHIsIHUsIGYsIGUsIG8pIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGIgPSB0aGlzLl9uUm91bmRzLAogICAgICAgICAgICAgICAgICAgICAgICAgaCA9IG5bdF0gXiBpWzBdLCBjID0gblt0ICsgMV0gXiBpWzFdLCBsID0gblt0ICsgMl0gXiBpWzJdLCBzID0gblt0ICsgM10gXiBpWzNdLCBhID0gNCwgdyA9IDE7IHcgPCBiOyB3KyspIHZhciB2ID0gcltoID4+PiAyNF0gXiB1W2MgPj4+IDE2ICYgMjU1XSBeIGZbbCA+Pj4gOCAmIDI1NV0gXiBlW3MgJiAyNTVdIF4gaVthKytdLAogICAgICAgICAgICAgICAgICAgICAgICAgeSA9IHJbYyA+Pj4gMjRdIF4gdVtsID4+PiAxNiAmIDI1NV0gXiBmW3MgPj4+IDggJiAyNTVdIF4gZVtoICYgMjU1XSBeIGlbYSsrXSwKICAgICAgICAgICAgICAgICAgICAgICAgIHAgPSByW2wgPj4+IDI0XSBeIHVbcyA+Pj4gMTYgJiAyNTVdIF4gZltoID4+PiA4ICYgMjU1XSBeIGVbYyAmIDI1NV0gXiBpW2ErK10sCiAgICAgICAgICAgICAgICAgICAgICAgICBzID0gcltzID4+PiAyNF0gXiB1W2ggPj4+IDE2ICYgMjU1XSBeIGZbYyA+Pj4gOCAmIDI1NV0gXiBlW2wgJiAyNTVdIF4gaVthKytdLAogICAgICAgICAgICAgICAgICAgICAgICAgaCA9IHYsCiAgICAgICAgICAgICAgICAgICAgICAgICBjID0geSwKICAgICAgICAgICAgICAgICAgICAgICAgIGwgPSBwOwogICAgICAgICAgICAgICAgdiA9IChvW2ggPj4+IDI0XSA8PCAyNCB8IG9bYyA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgb1tsID4+PiA4ICYgMjU1XSA8PCA4IHwgb1tzICYgMjU1XSkgXiBpW2ErK107CiAgICAgICAgICAgICAgICB5ID0gKG9bYyA+Pj4gMjRdIDw8IDI0IHwgb1tsID4+PiAxNiAmIDI1NV0gPDwgMTYgfCBvW3MgPj4+IDggJiAyNTVdIDw8IDggfCBvW2ggJiAyNTVdKSBeIGlbYSsrXTsKICAgICAgICAgICAgICAgIHAgPSAob1tsID4+PiAyNF0gPDwgMjQgfCBvW3MgPj4+IDE2ICYgMjU1XSA8PCAxNiB8IG9baCA+Pj4gOCAmIDI1NV0gPDwgOCB8IG9bYyAmIDI1NV0pIF4gaVthKytdOwogICAgICAgICAgICAgICAgcyA9IChvW3MgPj4+IDI0XSA8PCAyNCB8IG9baCA+Pj4gMTYgJiAyNTVdIDw8IDE2IHwgb1tjID4+PiA4ICYgMjU1XSA8PCA4IHwgb1tsICYgMjU1XSkgXiBpW2ErK107CiAgICAgICAgICAgICAgICBuW3RdID0gdjsKICAgICAgICAgICAgICAgIG5bdCArIDFdID0geTsKICAgICAgICAgICAgICAgIG5bdCArIDJdID0gcDsKICAgICAgICAgICAgICAgIG5bdCArIDNdID0gcwogICAgICAgICAgICB9LAogICAgICAgICAgICBrZXlTaXplOiA4CiAgICAgICAgfSk7CiAgICAgICAgcy5BRVMgPSB5Ll9jcmVhdGVIZWxwZXIoaCkKICAgIH0gKCk7CmZ1bmN0aW9uIHZhbEFlc0VuY3J5cHRTZXQoaSkgewogICAgdmFyIG4sdCxyOwogICAgdHJ5IHsKICAgICAgICBuID0gYWVzRGVjcnlwdChpKTsKICAgICAgICBuICE9ICIiICYmICh0ID0gYWVzRW5jcnlwdChuKSwgdCAhPSBpICYmIChuID0gIiIpKQogICAgfSBjYXRjaChyKSB7CiAgICAgICAgbiA9ICIiCiAgICB9CiAgICByZXR1cm4gbiA9PSAiIiAmJiAodCA9IGFlc0VuY3J5cHQoaSkpOwp9OwpmdW5jdGlvbiBhZXNEZWNyeXB0KG4pIHsKICAgIHZhciB0ID0gQ3J5cHRvSlMuTUQ1KCJsb2dpbi4xODkuY24iKSwKICAgICAgICBpID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UodCksCiAgICAgICAgciA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKCIxMjM0NTY3ODEyMzQ1Njc4Iik7CiAgICByZXR1cm4gQ3J5cHRvSlMuQUVTLmRlY3J5cHQobiwgaSwgewogICAgICAgIGl2OiByCiAgICB9KS50b1N0cmluZyhDcnlwdG9KUy5lbmMuVXRmOCkKfTsKZnVuY3Rpb24gYWVzRW5jcnlwdChuKSB7CiAgICB2YXIgdCA9IENyeXB0b0pTLk1ENSgibG9naW4uMTg5LmNuIiksCiAgICAgICAgaSA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKHQpLAogICAgICAgIHIgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSgiMTIzNDU2NzgxMjM0NTY3OCIpLAogICAgICAgIHUgPSBDcnlwdG9KUy5BRVMuZW5jcnlwdChuLCBpLCB7CiAgICAgICAgICAgIGl2OiByCiAgICAgICAgfSk7CiAgICByZXR1cm4gdSArICIiCn07";

    @Override
    public HttpResult<Map<String, Object>> init(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        try {
            return result.success();
        } catch (Exception e) {
            logger.error("登录-->初始化失败,param={}", param, e);
            return result.failure(ErrorCode.TASK_INIT_ERROR);
        }
    }

    @Override
    public HttpResult<String> refeshPicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshPicCodeForBillDetail(param);
            default:
                return new HttpResult<String>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> refeshSmsCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshSmsCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> submit(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return submitForLogin(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return submitForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> validatePicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return validatePicCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Object> defineProcess(OperatorParam param) {
        return new HttpResult<Object>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    private HttpResult<Map<String, Object>> submitForLogin(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPassword(), ErrorCode.EMPTY_PASSWORD);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            Invocable invocable = ScriptEngineUtil.createInvocableFromBase64(javaScript);
            String encryptPassword = invocable.invokeFunction("aesEncrypt", param.getPassword()).toString();

            String referer = "http://login.189.cn/login";
            String templateUrl = "http://login.189.cn/login";
            String templateData = "Account={}&UType=201&ProvinceID=03&AreaCode=&CityNo=&RandomFlag=0&Password={}&Captcha=";
            String data = TemplateUtils.format(templateData, param.getMobile(), URLEncoder.encode(encryptPassword, "UTF-8"));
            response = TaskHttpClient.create(param, RequestType.POST, "tian_jin_10000_web_001").setFullUrl(templateUrl).setReferer(referer)
                    .setRequestBody(data).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("登陆失败,param={},response={}", param, response);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
            String resultCode = PatternUtils.group(pageContent, "data-resultcode=\"(\\d+)\"", 1);
            if (resultCode != null) {
                if (resultCode.equals("9103") || resultCode.equals("9999")) {
                    logger.error("登陆失败,账户名与密码不匹配,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("8105")) {
                    logger.error("登陆失败,密码过于简单,请重置,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("9111")) {
                    logger.error("登陆失败,登录失败过多，帐号已被锁定,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("9100")) {
                    logger.error("登陆失败,该账户不存在,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PHONE_FAIL);
                } else if (resultCode.equals("6113")) {
                    logger.error("登陆失败,系统繁忙，稍后重试,param={},response={}", param, response);
                    return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
                } else if (StringUtils.isNotBlank(resultCode)) {
                    logger.error("登陆失败,param={},response={}", param, response);
                    return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
                }
            }

            referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=02251357";
            templateUrl
                    = "http://www.189.cn/login/sso/ecs.do?method=linkTo&platNo=10002&toStUrl=http://tj.189.cn/tj/service/bill/feeQueryIndex.action?tab=3&fastcode=02251357";
            response = TaskHttpClient.create(param, RequestType.GET, "tian_jin_10000_web_002").setFullUrl(templateUrl).setReferer(referer).invoke();

            templateUrl = "http://www.189.cn/tj/";
            response = TaskHttpClient.create(param, RequestType.GET, "tian_jin_10000_web_003").setFullUrl(templateUrl).invoke();

            referer = "http://tj.189.cn/tj/service/bill/feeQueryIndex.action?tab=3&amp;fastcode=02251357";
            templateUrl = "http://tj.189.cn/tj/service/bill/feeQueryIndex.action?tab=tab3&time=";
            response = TaskHttpClient.create(param, RequestType.POST, "tian_jin_10000_web_004").setFullUrl(templateUrl, System.currentTimeMillis())
                    .setReferer(referer).invoke();

            templateUrl = "http://tj.189.cn/tj/service/bill/balanceQuery.action?requestFlag=asynchronism&shijian=";
            response = TaskHttpClient.create(param, RequestType.POST, "tian_jin_10000_web_005").setFullUrl(templateUrl).invoke();
            pageContent = response.getPageContent();
            if (StringUtils.isNotBlank(pageContent)) {
                logger.info("登陆成功,param={}", param);
                return result.success();
            } else {
                logger.error("登陆失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登陆失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.LOGIN_ERROR);
        }
    }

    private HttpResult<String> refeshPicCodeForBillDetail(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        Response response = null;
        try {
            BigDecimal db = new BigDecimal(Math.random() * (1 - 0) + 0);
            String referer = "http://tj.189.cn/tj/service/bill/detailBillQuery.action";
            String templateUrl = "http://tj.189.cn/tj/authImg?{}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET, "tian_jin_10000_web_006")
                    .setFullUrl(templateUrl, db.setScale(16, BigDecimal.ROUND_HALF_UP)).setReferer(referer).invoke();
            logger.info("详单-->图片验证码-->刷新成功,param={}", param);
            return result.success(response.getPageContentForBase64());
        } catch (Exception e) {
            logger.error("详单-->图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> validatePicCodeForBillDetail(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPicCode(), ErrorCode.EMPTY_PIC_CODE);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String referer = "http://tj.189.cn/tj/service/bill/detailBillQuery.action";
            String templateUrl = "http://tj.189.cn/tj/checkrand/checkRand.action?randValue={}";
            response = TaskHttpClient.create(param, RequestType.POST, "tian_jin_10000_web_007").setFullUrl(templateUrl, param.getPicCode())
                    .setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "\"ret\":0")) {
                logger.info("详单-->图片验证码-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->图片验证码-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_PIC_CODE_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->图片验证码-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> refeshSmsCodeForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String referer = "http://tj.189.cn/tj/service/bill/detailBillQuery.action";
            String templateUrl = "http://tj.189.cn/tj/service/bill/sendRandomSmscode.action?randomMode=2&funcType=detail&checkCode={}";
            //String templateData = "<buffalo-call><method>SendVCodeByNbr</method><string>{}</string></buffalo-call>";
            //String data = TemplateUtils.format(templateData, param.getMobile());
            response = TaskHttpClient.create(param, RequestType.POST, "tian_jin_10000_web_008").setFullUrl(templateUrl, param.getPicCode())
                    .setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "\"requestFlag\":\"success\"")) {
                logger.info("详单-->短信验证码-->刷新成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->短信验证码-->刷新失败,param={},pateContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->短信验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_SMS_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> submitForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String referer = "http://tj.189.cn/tj/service/bill/detailBillQuery.action";
            String templateUrl = "http://tj.189.cn/tj/service/bill/validateRandomcode.action?sRandomCode={}&randomMode=1&funcType=detail";
            response = TaskHttpClient.create(param, RequestType.POST, "tian_jin_10000_web_009").setFullUrl(templateUrl, param.getSmsCode())
                    .setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "\"requestFlag\":\"success\"")) {
                logger.info("详单-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_ERROR);
        }
    }
}
