package com.datatrees.rawdatacentral.plugin.operator.he_nan_10000_web;

import com.datatrees.common.util.PatternUtils;
import com.datatrees.rawdatacentral.common.http.TaskHttpClient;
import com.datatrees.rawdatacentral.common.http.TaskUtils;
import com.datatrees.rawdatacentral.common.utils.CheckUtils;
import com.datatrees.rawdatacentral.common.utils.ScriptEngineUtil;
import com.datatrees.rawdatacentral.common.utils.TemplateUtils;
import com.datatrees.rawdatacentral.domain.constant.FormType;
import com.datatrees.rawdatacentral.domain.enums.ErrorCode;
import com.datatrees.rawdatacentral.domain.enums.RequestType;
import com.datatrees.rawdatacentral.domain.operator.OperatorParam;
import com.datatrees.rawdatacentral.domain.result.HttpResult;
import com.datatrees.rawdatacentral.domain.vo.Response;
import com.datatrees.rawdatacentral.service.OperatorPluginService;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.script.Invocable;
import java.net.URLEncoder;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Map;

/**
 *
 * User: yand
 * Date: 2017/9/21
 */
public class HeNan10000ForWeb implements OperatorPluginService {
    private static final Logger logger = LoggerFactory.getLogger(HeNan10000ForWeb.class);
    private static final String javaScript = "dmFyIENyeXB0b0pTID0gQ3J5cHRvSlMgfHwNCmZ1bmN0aW9uKG4sIHQpIHsNCiAgICB2YXIgdSA9IHt9LA0KICAgIGYgPSB1LmxpYiA9IHt9LA0KICAgIG8gPSBmdW5jdGlvbigpIHt9LA0KICAgIGkgPSBmLkJhc2UgPSB7DQogICAgICAgIGV4dGVuZDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgby5wcm90b3R5cGUgPSB0aGlzOw0KICAgICAgICAgICAgdmFyIHQgPSBuZXcgbzsNCiAgICAgICAgICAgIHJldHVybiBuICYmIHQubWl4SW4obiksDQogICAgICAgICAgICB0Lmhhc093blByb3BlcnR5KCJpbml0IikgfHwgKHQuaW5pdCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHQuJHN1cGVyLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKQ0KICAgICAgICAgICAgfSksDQogICAgICAgICAgICB0LmluaXQucHJvdG90eXBlID0gdCwNCiAgICAgICAgICAgIHQuJHN1cGVyID0gdGhpcywNCiAgICAgICAgICAgIHQNCiAgICAgICAgfSwNCiAgICAgICAgY3JlYXRlOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBuID0gdGhpcy5leHRlbmQoKTsNCiAgICAgICAgICAgIHJldHVybiBuLmluaXQuYXBwbHkobiwgYXJndW1lbnRzKSwNCiAgICAgICAgICAgIG4NCiAgICAgICAgfSwNCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7fSwNCiAgICAgICAgbWl4SW46IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIGZvciAodmFyIHQgaW4gbikgbi5oYXNPd25Qcm9wZXJ0eSh0KSAmJiAodGhpc1t0XSA9IG5bdF0pOw0KICAgICAgICAgICAgbi5oYXNPd25Qcm9wZXJ0eSgidG9TdHJpbmciKSAmJiAodGhpcy50b1N0cmluZyA9IG4udG9TdHJpbmcpDQogICAgICAgIH0sDQogICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmluaXQucHJvdG90eXBlLmV4dGVuZCh0aGlzKQ0KICAgICAgICB9DQogICAgfSwNCiAgICByID0gZi5Xb3JkQXJyYXkgPSBpLmV4dGVuZCh7DQogICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4sIGkpIHsNCiAgICAgICAgICAgIG4gPSB0aGlzLndvcmRzID0gbiB8fCBbXTsNCiAgICAgICAgICAgIHRoaXMuc2lnQnl0ZXMgPSBpICE9IHQgPyBpOiA0ICogbi5sZW5ndGgNCiAgICAgICAgfSwNCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHJldHVybiAobiB8fCBsKS5zdHJpbmdpZnkodGhpcykNCiAgICAgICAgfSwNCiAgICAgICAgY29uY2F0OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB2YXIgaSA9IHRoaXMud29yZHMsDQogICAgICAgICAgICByID0gbi53b3JkcywNCiAgICAgICAgICAgIHUgPSB0aGlzLnNpZ0J5dGVzLA0KICAgICAgICAgICAgdDsNCiAgICAgICAgICAgIGlmIChuID0gbi5zaWdCeXRlcywgdGhpcy5jbGFtcCgpLCB1ICUgNCkgZm9yICh0ID0gMDsgdCAmbHQ7IG47IHQrKykgaVt1ICsgdCAmZ3Q7Jmd0OyZndDsgMl0gfD0gKHJbdCAmZ3Q7Jmd0OyZndDsgMl0gJmd0OyZndDsmZ3Q7IDI0IC0gOCAqICh0ICUgNCkgJiAyNTUpICZsdDsmbHQ7IDI0IC0gOCAqICgodSArIHQpICUgNCk7DQogICAgICAgICAgICBlbHNlIGlmICg2NTUzNSAmbHQ7IHIubGVuZ3RoKSBmb3IgKHQgPSAwOyB0ICZsdDsgbjsgdCArPSA0KSBpW3UgKyB0ICZndDsmZ3Q7Jmd0OyAyXSA9IHJbdCAmZ3Q7Jmd0OyZndDsgMl07DQogICAgICAgICAgICBlbHNlIGkucHVzaC5hcHBseShpLCByKTsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLnNpZ0J5dGVzICs9IG4sDQogICAgICAgICAgICB0aGlzDQogICAgICAgIH0sDQogICAgICAgIGNsYW1wOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBpID0gdGhpcy53b3JkcywNCiAgICAgICAgICAgIHQgPSB0aGlzLnNpZ0J5dGVzOw0KICAgICAgICAgICAgaVt0ICZndDsmZ3Q7Jmd0OyAyXSAmPSA0Mjk0OTY3Mjk1ICZsdDsmbHQ7IDMyIC0gOCAqICh0ICUgNCk7DQogICAgICAgICAgICBpLmxlbmd0aCA9IG4uY2VpbCh0IC8gNCkNCiAgICAgICAgfSwNCiAgICAgICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIG4gPSBpLmNsb25lLmNhbGwodGhpcyk7DQogICAgICAgICAgICByZXR1cm4gbi53b3JkcyA9IHRoaXMud29yZHMuc2xpY2UoMCksDQogICAgICAgICAgICBuDQogICAgICAgIH0sDQogICAgICAgIHJhbmRvbTogZnVuY3Rpb24odCkgew0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IFtdLCB1ID0gMDsgdSAmbHQ7IHQ7IHUgKz0gNCkgaS5wdXNoKDQyOTQ5NjcyOTYgKiBuLnJhbmRvbSgpIHwgMCk7DQogICAgICAgICAgICByZXR1cm4gbmV3IHIuaW5pdChpLCB0KQ0KICAgICAgICB9DQogICAgfSksDQogICAgZSA9IHUuZW5jID0ge30sDQogICAgbCA9IGUuSGV4ID0gew0KICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHZhciB1ID0gbi53b3JkcywNCiAgICAgICAgICAgIGksIHQsIHI7DQogICAgICAgICAgICBmb3IgKG4gPSBuLnNpZ0J5dGVzLCBpID0gW10sIHQgPSAwOyB0ICZsdDsgbjsgdCsrKSByID0gdVt0ICZndDsmZ3Q7Jmd0OyAyXSAmZ3Q7Jmd0OyZndDsgMjQgLSA4ICogKHQgJSA0KSAmIDI1NSwNCiAgICAgICAgICAgIGkucHVzaCgociAmZ3Q7Jmd0OyZndDsgNCkudG9TdHJpbmcoMTYpKSwNCiAgICAgICAgICAgIGkucHVzaCgociAmIDE1KS50b1N0cmluZygxNikpOw0KICAgICAgICAgICAgcmV0dXJuIGkuam9pbigiIikNCiAgICAgICAgfSwNCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIGZvciAodmFyIGkgPSBuLmxlbmd0aCwNCiAgICAgICAgICAgIHUgPSBbXSwgdCA9IDA7IHQgJmx0OyBpOyB0ICs9IDIpIHVbdCAmZ3Q7Jmd0OyZndDsgM10gfD0gcGFyc2VJbnQobi5zdWJzdHIodCwgMiksIDE2KSAmbHQ7Jmx0OyAyNCAtIDQgKiAodCAlIDgpOw0KICAgICAgICAgICAgcmV0dXJuIG5ldyByLmluaXQodSwgaSAvIDIpDQogICAgICAgIH0NCiAgICB9LA0KICAgIHMgPSBlLkxhdGluMSA9IHsNCiAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB2YXIgciA9IG4ud29yZHMsDQogICAgICAgICAgICBpLCB0Ow0KICAgICAgICAgICAgZm9yIChuID0gbi5zaWdCeXRlcywgaSA9IFtdLCB0ID0gMDsgdCAmbHQ7IG47IHQrKykgaS5wdXNoKFN0cmluZy5mcm9tQ2hhckNvZGUoclt0ICZndDsmZ3Q7Jmd0OyAyXSAmZ3Q7Jmd0OyZndDsgMjQgLSA4ICogKHQgJSA0KSAmIDI1NSkpOw0KICAgICAgICAgICAgcmV0dXJuIGkuam9pbigiIikNCiAgICAgICAgfSwNCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIGZvciAodmFyIGkgPSBuLmxlbmd0aCwNCiAgICAgICAgICAgIHUgPSBbXSwgdCA9IDA7IHQgJmx0OyBpOyB0KyspIHVbdCAmZ3Q7Jmd0OyZndDsgMl0gfD0gKG4uY2hhckNvZGVBdCh0KSAmIDI1NSkgJmx0OyZsdDsgMjQgLSA4ICogKHQgJSA0KTsNCiAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KHUsIGkpDQogICAgICAgIH0NCiAgICB9LA0KICAgIGEgPSBlLlV0ZjggPSB7DQogICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGVzY2FwZShzLnN0cmluZ2lmeShuKSkpDQogICAgICAgICAgICB9IGNhdGNoKHQpIHsNCiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiTWFsZm9ybWVkIFVURi04IGRhdGEiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHJldHVybiBzLnBhcnNlKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChuKSkpDQogICAgICAgIH0NCiAgICB9LA0KICAgIGggPSBmLkJ1ZmZlcmVkQmxvY2tBbGdvcml0aG0gPSBpLmV4dGVuZCh7DQogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHRoaXMuX2RhdGEgPSBuZXcgci5pbml0Ow0KICAgICAgICAgICAgdGhpcy5fbkRhdGFCeXRlcyA9IDANCiAgICAgICAgfSwNCiAgICAgICAgX2FwcGVuZDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgInN0cmluZyIgPT0gdHlwZW9mIG4gJiYgKG4gPSBhLnBhcnNlKG4pKTsNCiAgICAgICAgICAgIHRoaXMuX2RhdGEuY29uY2F0KG4pOw0KICAgICAgICAgICAgdGhpcy5fbkRhdGFCeXRlcyArPSBuLnNpZ0J5dGVzDQogICAgICAgIH0sDQogICAgICAgIF9wcm9jZXNzOiBmdW5jdGlvbih0KSB7DQogICAgICAgICAgICB2YXIgZiA9IHRoaXMuX2RhdGEsDQogICAgICAgICAgICBzID0gZi53b3JkcywNCiAgICAgICAgICAgIHUgPSBmLnNpZ0J5dGVzLA0KICAgICAgICAgICAgZSA9IHRoaXMuYmxvY2tTaXplLA0KICAgICAgICAgICAgbyA9IHUgLyAoNCAqIGUpLA0KICAgICAgICAgICAgbyA9IHQgPyBuLmNlaWwobykgOiBuLm1heCgobyB8IDApIC0gdGhpcy5fbWluQnVmZmVyU2l6ZSwgMCksDQogICAgICAgICAgICBpOw0KICAgICAgICAgICAgaWYgKHQgPSBvICogZSwgdSA9IG4ubWluKDQgKiB0LCB1KSwgdCkgew0KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgJmx0OyB0OyBpICs9IGUpIHRoaXMuX2RvUHJvY2Vzc0Jsb2NrKHMsIGkpOw0KICAgICAgICAgICAgICAgIGkgPSBzLnNwbGljZSgwLCB0KTsNCiAgICAgICAgICAgICAgICBmLnNpZ0J5dGVzIC09IHUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiBuZXcgci5pbml0KGksIHUpDQogICAgICAgIH0sDQogICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBuID0gaS5jbG9uZS5jYWxsKHRoaXMpOw0KICAgICAgICAgICAgcmV0dXJuIG4uX2RhdGEgPSB0aGlzLl9kYXRhLmNsb25lKCksDQogICAgICAgICAgICBuDQogICAgICAgIH0sDQogICAgICAgIF9taW5CdWZmZXJTaXplOiAwDQogICAgfSksDQogICAgYzsNCiAgICByZXR1cm4gZi5IYXNoZXIgPSBoLmV4dGVuZCh7DQogICAgICAgIGNmZzogaS5leHRlbmQoKSwNCiAgICAgICAgaW5pdDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdGhpcy5jZmcgPSB0aGlzLmNmZy5leHRlbmQobik7DQogICAgICAgICAgICB0aGlzLnJlc2V0KCkNCiAgICAgICAgfSwNCiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgaC5yZXNldC5jYWxsKHRoaXMpOw0KICAgICAgICAgICAgdGhpcy5fZG9SZXNldCgpDQogICAgICAgIH0sDQogICAgICAgIHVwZGF0ZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChuKSwNCiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3MoKSwNCiAgICAgICAgICAgIHRoaXMNCiAgICAgICAgfSwNCiAgICAgICAgZmluYWxpemU6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHJldHVybiBuICYmIHRoaXMuX2FwcGVuZChuKSwNCiAgICAgICAgICAgIHRoaXMuX2RvRmluYWxpemUoKQ0KICAgICAgICB9LA0KICAgICAgICBibG9ja1NpemU6IDE2LA0KICAgICAgICBfY3JlYXRlSGVscGVyOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odCwgaSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBuZXcgbi5pbml0KGkpLmZpbmFsaXplKHQpDQogICAgICAgICAgICB9DQogICAgICAgIH0sDQogICAgICAgIF9jcmVhdGVIbWFjSGVscGVyOiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odCwgaSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBuZXcgYy5ITUFDLmluaXQobiwgaSkuZmluYWxpemUodCkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0pLA0KICAgIGMgPSB1LmFsZ28gPSB7fSwNCiAgICB1DQp9IChNYXRoKTsgKGZ1bmN0aW9uKCkgew0KICAgIHZhciBuID0gQ3J5cHRvSlMsDQogICAgdCA9IG4ubGliLldvcmRBcnJheTsNCiAgICBuLmVuYy5CYXNlNjQgPSB7DQogICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdmFyIGkgPSBuLndvcmRzLA0KICAgICAgICAgICAgdSA9IG4uc2lnQnl0ZXMsDQogICAgICAgICAgICBmID0gdGhpcy5fbWFwLA0KICAgICAgICAgICAgdCwgZSwgcjsNCiAgICAgICAgICAgIGZvciAobi5jbGFtcCgpLCBuID0gW10sIHQgPSAwOyB0ICZsdDsgdTsgdCArPSAzKSBmb3IgKGUgPSAoaVt0ICZndDsmZ3Q7Jmd0OyAyXSAmZ3Q7Jmd0OyZndDsgMjQgLSA4ICogKHQgJSA0KSAmIDI1NSkgJmx0OyZsdDsgMTYgfCAoaVt0ICsgMSAmZ3Q7Jmd0OyZndDsgMl0gJmd0OyZndDsmZ3Q7IDI0IC0gOCAqICgodCArIDEpICUgNCkgJiAyNTUpICZsdDsmbHQ7IDggfCBpW3QgKyAyICZndDsmZ3Q7Jmd0OyAyXSAmZ3Q7Jmd0OyZndDsgMjQgLSA4ICogKCh0ICsgMikgJSA0KSAmIDI1NSwgciA9IDA7IDQgJmd0OyByICYmIHQgKyAuNzUgKiByICZsdDsgdTsgcisrKSBuLnB1c2goZi5jaGFyQXQoZSAmZ3Q7Jmd0OyZndDsgNiAqICgzIC0gcikgJiA2MykpOw0KICAgICAgICAgICAgaWYgKGkgPSBmLmNoYXJBdCg2NCkpIGZvciAoOyBuLmxlbmd0aCAlIDQ7KSBuLnB1c2goaSk7DQogICAgICAgICAgICByZXR1cm4gbi5qb2luKCIiKQ0KICAgICAgICB9LA0KICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdmFyIGUgPSBuLmxlbmd0aCwNCiAgICAgICAgICAgIGYgPSB0aGlzLl9tYXAsDQogICAgICAgICAgICBpID0gZi5jaGFyQXQoNjQpLA0KICAgICAgICAgICAgbywNCiAgICAgICAgICAgIHM7DQogICAgICAgICAgICBpICYmIChpID0gbi5pbmRleE9mKGkpLCAtMSAhPSBpICYmIChlID0gaSkpOw0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IFtdLCB1ID0gMCwgciA9IDA7IHIgJmx0OyBlOyByKyspIHIgJSA0ICYmIChvID0gZi5pbmRleE9mKG4uY2hhckF0KHIgLSAxKSkgJmx0OyZsdDsgMiAqIChyICUgNCksIHMgPSBmLmluZGV4T2Yobi5jaGFyQXQocikpICZndDsmZ3Q7Jmd0OyA2IC0gMiAqIChyICUgNCksIGlbdSAmZ3Q7Jmd0OyZndDsgMl0gfD0gKG8gfCBzKSAmbHQ7Jmx0OyAyNCAtIDggKiAodSAlIDQpLCB1KyspOw0KICAgICAgICAgICAgcmV0dXJuIHQuY3JlYXRlKGksIHUpDQogICAgICAgIH0sDQogICAgICAgIF9tYXA6ICJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvPSINCiAgICB9DQp9KSgpLA0KZnVuY3Rpb24obikgew0KICAgIGZ1bmN0aW9uIGkobiwgdCwgaSwgciwgdSwgZiwgZSkgew0KICAgICAgICByZXR1cm4gbiA9IG4gKyAodCAmIGkgfCB+dCAmIHIpICsgdSArIGUsDQogICAgICAgIChuICZsdDsmbHQ7IGYgfCBuICZndDsmZ3Q7Jmd0OyAzMiAtIGYpICsgdA0KICAgIH0NCiAgICBmdW5jdGlvbiByKG4sIHQsIGksIHIsIHUsIGYsIGUpIHsNCiAgICAgICAgcmV0dXJuIG4gPSBuICsgKHQgJiByIHwgaSAmIH5yKSArIHUgKyBlLA0KICAgICAgICAobiAmbHQ7Jmx0OyBmIHwgbiAmZ3Q7Jmd0OyZndDsgMzIgLSBmKSArIHQNCiAgICB9DQogICAgZnVuY3Rpb24gdShuLCB0LCBpLCByLCB1LCBmLCBlKSB7DQogICAgICAgIHJldHVybiBuID0gbiArICh0IF4gaSBeIHIpICsgdSArIGUsDQogICAgICAgIChuICZsdDsmbHQ7IGYgfCBuICZndDsmZ3Q7Jmd0OyAzMiAtIGYpICsgdA0KICAgIH0NCiAgICBmdW5jdGlvbiBmKG4sIHQsIGksIHIsIHUsIGYsIGUpIHsNCiAgICAgICAgcmV0dXJuIG4gPSBuICsgKGkgXiAodCB8IH5yKSkgKyB1ICsgZSwNCiAgICAgICAgKG4gJmx0OyZsdDsgZiB8IG4gJmd0OyZndDsmZ3Q7IDMyIC0gZikgKyB0DQogICAgfQ0KICAgIGZvciAodmFyIG8gPSBDcnlwdG9KUywNCiAgICBlID0gby5saWIsDQogICAgYyA9IGUuV29yZEFycmF5LA0KICAgIHMgPSBlLkhhc2hlciwNCiAgICBlID0gby5hbGdvLA0KICAgIHQgPSBbXSwgaCA9IDA7IDY0ICZndDsgaDsgaCsrKSB0W2hdID0gNDI5NDk2NzI5NiAqIG4uYWJzKG4uc2luKGggKyAxKSkgfCAwOw0KICAgIGUgPSBlLk1ENSA9IHMuZXh0ZW5kKHsNCiAgICAgICAgX2RvUmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdGhpcy5faGFzaCA9IG5ldyBjLmluaXQoWzE3MzI1ODQxOTMsIDQwMjMyMzM0MTcsIDI1NjIzODMxMDIsIDI3MTczMzg3OF0pDQogICAgICAgIH0sDQogICAgICAgIF9kb1Byb2Nlc3NCbG9jazogZnVuY3Rpb24obiwgZSkgew0KICAgICAgICAgICAgZm9yICh2YXIgdiwgYSwgbCA9IDA7IDE2ICZndDsgbDsgbCsrKSB2ID0gZSArIGwsDQogICAgICAgICAgICBhID0gblt2XSwNCiAgICAgICAgICAgIG5bdl0gPSAoYSAmbHQ7Jmx0OyA4IHwgYSAmZ3Q7Jmd0OyZndDsgMjQpICYgMTY3MTE5MzUgfCAoYSAmbHQ7Jmx0OyAyNCB8IGEgJmd0OyZndDsmZ3Q7IDgpICYgNDI3ODI1NTM2MDsNCiAgICAgICAgICAgIHZhciBsID0gdGhpcy5faGFzaC53b3JkcywNCiAgICAgICAgICAgIHYgPSBuW2UgKyAwXSwNCiAgICAgICAgICAgIGEgPSBuW2UgKyAxXSwNCiAgICAgICAgICAgIHkgPSBuW2UgKyAyXSwNCiAgICAgICAgICAgIHAgPSBuW2UgKyAzXSwNCiAgICAgICAgICAgIHcgPSBuW2UgKyA0XSwNCiAgICAgICAgICAgIGIgPSBuW2UgKyA1XSwNCiAgICAgICAgICAgIGsgPSBuW2UgKyA2XSwNCiAgICAgICAgICAgIGQgPSBuW2UgKyA3XSwNCiAgICAgICAgICAgIGcgPSBuW2UgKyA4XSwNCiAgICAgICAgICAgIG50ID0gbltlICsgOV0sDQogICAgICAgICAgICB0dCA9IG5bZSArIDEwXSwNCiAgICAgICAgICAgIGl0ID0gbltlICsgMTFdLA0KICAgICAgICAgICAgcnQgPSBuW2UgKyAxMl0sDQogICAgICAgICAgICB1dCA9IG5bZSArIDEzXSwNCiAgICAgICAgICAgIGZ0ID0gbltlICsgMTRdLA0KICAgICAgICAgICAgZXQgPSBuW2UgKyAxNV0sDQogICAgICAgICAgICBvID0gbFswXSwNCiAgICAgICAgICAgIHMgPSBsWzFdLA0KICAgICAgICAgICAgaCA9IGxbMl0sDQogICAgICAgICAgICBjID0gbFszXSwNCiAgICAgICAgICAgIG8gPSBpKG8sIHMsIGgsIGMsIHYsIDcsIHRbMF0pLA0KICAgICAgICAgICAgYyA9IGkoYywgbywgcywgaCwgYSwgMTIsIHRbMV0pLA0KICAgICAgICAgICAgaCA9IGkoaCwgYywgbywgcywgeSwgMTcsIHRbMl0pLA0KICAgICAgICAgICAgcyA9IGkocywgaCwgYywgbywgcCwgMjIsIHRbM10pLA0KICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgdywgNywgdFs0XSksDQogICAgICAgICAgICBjID0gaShjLCBvLCBzLCBoLCBiLCAxMiwgdFs1XSksDQogICAgICAgICAgICBoID0gaShoLCBjLCBvLCBzLCBrLCAxNywgdFs2XSksDQogICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBkLCAyMiwgdFs3XSksDQogICAgICAgICAgICBvID0gaShvLCBzLCBoLCBjLCBnLCA3LCB0WzhdKSwNCiAgICAgICAgICAgIGMgPSBpKGMsIG8sIHMsIGgsIG50LCAxMiwgdFs5XSksDQogICAgICAgICAgICBoID0gaShoLCBjLCBvLCBzLCB0dCwgMTcsIHRbMTBdKSwNCiAgICAgICAgICAgIHMgPSBpKHMsIGgsIGMsIG8sIGl0LCAyMiwgdFsxMV0pLA0KICAgICAgICAgICAgbyA9IGkobywgcywgaCwgYywgcnQsIDcsIHRbMTJdKSwNCiAgICAgICAgICAgIGMgPSBpKGMsIG8sIHMsIGgsIHV0LCAxMiwgdFsxM10pLA0KICAgICAgICAgICAgaCA9IGkoaCwgYywgbywgcywgZnQsIDE3LCB0WzE0XSksDQogICAgICAgICAgICBzID0gaShzLCBoLCBjLCBvLCBldCwgMjIsIHRbMTVdKSwNCiAgICAgICAgICAgIG8gPSByKG8sIHMsIGgsIGMsIGEsIDUsIHRbMTZdKSwNCiAgICAgICAgICAgIGMgPSByKGMsIG8sIHMsIGgsIGssIDksIHRbMTddKSwNCiAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGl0LCAxNCwgdFsxOF0pLA0KICAgICAgICAgICAgcyA9IHIocywgaCwgYywgbywgdiwgMjAsIHRbMTldKSwNCiAgICAgICAgICAgIG8gPSByKG8sIHMsIGgsIGMsIGIsIDUsIHRbMjBdKSwNCiAgICAgICAgICAgIGMgPSByKGMsIG8sIHMsIGgsIHR0LCA5LCB0WzIxXSksDQogICAgICAgICAgICBoID0gcihoLCBjLCBvLCBzLCBldCwgMTQsIHRbMjJdKSwNCiAgICAgICAgICAgIHMgPSByKHMsIGgsIGMsIG8sIHcsIDIwLCB0WzIzXSksDQogICAgICAgICAgICBvID0gcihvLCBzLCBoLCBjLCBudCwgNSwgdFsyNF0pLA0KICAgICAgICAgICAgYyA9IHIoYywgbywgcywgaCwgZnQsIDksIHRbMjVdKSwNCiAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIHAsIDE0LCB0WzI2XSksDQogICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCBnLCAyMCwgdFsyN10pLA0KICAgICAgICAgICAgbyA9IHIobywgcywgaCwgYywgdXQsIDUsIHRbMjhdKSwNCiAgICAgICAgICAgIGMgPSByKGMsIG8sIHMsIGgsIHksIDksIHRbMjldKSwNCiAgICAgICAgICAgIGggPSByKGgsIGMsIG8sIHMsIGQsIDE0LCB0WzMwXSksDQogICAgICAgICAgICBzID0gcihzLCBoLCBjLCBvLCBydCwgMjAsIHRbMzFdKSwNCiAgICAgICAgICAgIG8gPSB1KG8sIHMsIGgsIGMsIGIsIDQsIHRbMzJdKSwNCiAgICAgICAgICAgIGMgPSB1KGMsIG8sIHMsIGgsIGcsIDExLCB0WzMzXSksDQogICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBpdCwgMTYsIHRbMzRdKSwNCiAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIGZ0LCAyMywgdFszNV0pLA0KICAgICAgICAgICAgbyA9IHUobywgcywgaCwgYywgYSwgNCwgdFszNl0pLA0KICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgdywgMTEsIHRbMzddKSwNCiAgICAgICAgICAgIGggPSB1KGgsIGMsIG8sIHMsIGQsIDE2LCB0WzM4XSksDQogICAgICAgICAgICBzID0gdShzLCBoLCBjLCBvLCB0dCwgMjMsIHRbMzldKSwNCiAgICAgICAgICAgIG8gPSB1KG8sIHMsIGgsIGMsIHV0LCA0LCB0WzQwXSksDQogICAgICAgICAgICBjID0gdShjLCBvLCBzLCBoLCB2LCAxMSwgdFs0MV0pLA0KICAgICAgICAgICAgaCA9IHUoaCwgYywgbywgcywgcCwgMTYsIHRbNDJdKSwNCiAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIGssIDIzLCB0WzQzXSksDQogICAgICAgICAgICBvID0gdShvLCBzLCBoLCBjLCBudCwgNCwgdFs0NF0pLA0KICAgICAgICAgICAgYyA9IHUoYywgbywgcywgaCwgcnQsIDExLCB0WzQ1XSksDQogICAgICAgICAgICBoID0gdShoLCBjLCBvLCBzLCBldCwgMTYsIHRbNDZdKSwNCiAgICAgICAgICAgIHMgPSB1KHMsIGgsIGMsIG8sIHksIDIzLCB0WzQ3XSksDQogICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCB2LCA2LCB0WzQ4XSksDQogICAgICAgICAgICBjID0gZihjLCBvLCBzLCBoLCBkLCAxMCwgdFs0OV0pLA0KICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgZnQsIDE1LCB0WzUwXSksDQogICAgICAgICAgICBzID0gZihzLCBoLCBjLCBvLCBiLCAyMSwgdFs1MV0pLA0KICAgICAgICAgICAgbyA9IGYobywgcywgaCwgYywgcnQsIDYsIHRbNTJdKSwNCiAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIHAsIDEwLCB0WzUzXSksDQogICAgICAgICAgICBoID0gZihoLCBjLCBvLCBzLCB0dCwgMTUsIHRbNTRdKSwNCiAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIGEsIDIxLCB0WzU1XSksDQogICAgICAgICAgICBvID0gZihvLCBzLCBoLCBjLCBnLCA2LCB0WzU2XSksDQogICAgICAgICAgICBjID0gZihjLCBvLCBzLCBoLCBldCwgMTAsIHRbNTddKSwNCiAgICAgICAgICAgIGggPSBmKGgsIGMsIG8sIHMsIGssIDE1LCB0WzU4XSksDQogICAgICAgICAgICBzID0gZihzLCBoLCBjLCBvLCB1dCwgMjEsIHRbNTldKSwNCiAgICAgICAgICAgIG8gPSBmKG8sIHMsIGgsIGMsIHcsIDYsIHRbNjBdKSwNCiAgICAgICAgICAgIGMgPSBmKGMsIG8sIHMsIGgsIGl0LCAxMCwgdFs2MV0pLA0KICAgICAgICAgICAgaCA9IGYoaCwgYywgbywgcywgeSwgMTUsIHRbNjJdKSwNCiAgICAgICAgICAgIHMgPSBmKHMsIGgsIGMsIG8sIG50LCAyMSwgdFs2M10pOw0KICAgICAgICAgICAgbFswXSA9IGxbMF0gKyBvIHwgMDsNCiAgICAgICAgICAgIGxbMV0gPSBsWzFdICsgcyB8IDA7DQogICAgICAgICAgICBsWzJdID0gbFsyXSArIGggfCAwOw0KICAgICAgICAgICAgbFszXSA9IGxbM10gKyBjIHwgMA0KICAgICAgICB9LA0KICAgICAgICBfZG9GaW5hbGl6ZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB2YXIgdSA9IHRoaXMuX2RhdGEsDQogICAgICAgICAgICByID0gdS53b3JkcywNCiAgICAgICAgICAgIHQgPSA4ICogdGhpcy5fbkRhdGFCeXRlcywNCiAgICAgICAgICAgIGkgPSA4ICogdS5zaWdCeXRlcywNCiAgICAgICAgICAgIGY7DQogICAgICAgICAgICBmb3IgKHJbaSAmZ3Q7Jmd0OyZndDsgNV0gfD0gMTI4ICZsdDsmbHQ7IDI0IC0gaSAlIDMyLCBmID0gbi5mbG9vcih0IC8gNDI5NDk2NzI5NiksIHJbKGkgKyA2NCAmZ3Q7Jmd0OyZndDsgOSAmbHQ7Jmx0OyA0KSArIDE1XSA9IChmICZsdDsmbHQ7IDggfCBmICZndDsmZ3Q7Jmd0OyAyNCkgJiAxNjcxMTkzNSB8IChmICZsdDsmbHQ7IDI0IHwgZiAmZ3Q7Jmd0OyZndDsgOCkgJiA0Mjc4MjU1MzYwLCByWyhpICsgNjQgJmd0OyZndDsmZ3Q7IDkgJmx0OyZsdDsgNCkgKyAxNF0gPSAodCAmbHQ7Jmx0OyA4IHwgdCAmZ3Q7Jmd0OyZndDsgMjQpICYgMTY3MTE5MzUgfCAodCAmbHQ7Jmx0OyAyNCB8IHQgJmd0OyZndDsmZ3Q7IDgpICYgNDI3ODI1NTM2MCwgdS5zaWdCeXRlcyA9IDQgKiAoci5sZW5ndGggKyAxKSwgdGhpcy5fcHJvY2VzcygpLCB1ID0gdGhpcy5faGFzaCwgciA9IHUud29yZHMsIHQgPSAwOyA0ICZndDsgdDsgdCsrKSBpID0gclt0XSwNCiAgICAgICAgICAgIHJbdF0gPSAoaSAmbHQ7Jmx0OyA4IHwgaSAmZ3Q7Jmd0OyZndDsgMjQpICYgMTY3MTE5MzUgfCAoaSAmbHQ7Jmx0OyAyNCB8IGkgJmd0OyZndDsmZ3Q7IDgpICYgNDI3ODI1NTM2MDsNCiAgICAgICAgICAgIHJldHVybiB1DQogICAgICAgIH0sDQogICAgICAgIGNsb25lOiBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBuID0gcy5jbG9uZS5jYWxsKHRoaXMpOw0KICAgICAgICAgICAgcmV0dXJuIG4uX2hhc2ggPSB0aGlzLl9oYXNoLmNsb25lKCksDQogICAgICAgICAgICBuDQogICAgICAgIH0NCiAgICB9KTsNCiAgICBvLk1ENSA9IHMuX2NyZWF0ZUhlbHBlcihlKTsNCiAgICBvLkhtYWNNRDUgPSBzLl9jcmVhdGVIbWFjSGVscGVyKGUpDQp9IChNYXRoKSwNCmZ1bmN0aW9uKCkgew0KICAgIHZhciB0ID0gQ3J5cHRvSlMsDQogICAgbiA9IHQubGliLA0KICAgIGkgPSBuLkJhc2UsDQogICAgciA9IG4uV29yZEFycmF5LA0KICAgIG4gPSB0LmFsZ28sDQogICAgdSA9IG4uRXZwS0RGID0gaS5leHRlbmQoew0KICAgICAgICBjZmc6IGkuZXh0ZW5kKHsNCiAgICAgICAgICAgIGtleVNpemU6IDQsDQogICAgICAgICAgICBoYXNoZXI6IG4uTUQ1LA0KICAgICAgICAgICAgaXRlcmF0aW9uczogMQ0KICAgICAgICB9KSwNCiAgICAgICAgaW5pdDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdGhpcy5jZmcgPSB0aGlzLmNmZy5leHRlbmQobikNCiAgICAgICAgfSwNCiAgICAgICAgY29tcHV0ZTogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgZm9yICh2YXIgaSwgbywgZiA9IHRoaXMuY2ZnLA0KICAgICAgICAgICAgdSA9IGYuaGFzaGVyLmNyZWF0ZSgpLCBlID0gci5jcmVhdGUoKSwgaCA9IGUud29yZHMsIHMgPSBmLmtleVNpemUsIGYgPSBmLml0ZXJhdGlvbnM7IGgubGVuZ3RoICZsdDsgczspIHsNCiAgICAgICAgICAgICAgICBmb3IgKGkgJiYgdS51cGRhdGUoaSksIGkgPSB1LnVwZGF0ZShuKS5maW5hbGl6ZSh0KSwgdS5yZXNldCgpLCBvID0gMTsgbyAmbHQ7IGY7IG8rKykgaSA9IHUuZmluYWxpemUoaSksDQogICAgICAgICAgICAgICAgdS5yZXNldCgpOw0KICAgICAgICAgICAgICAgIGUuY29uY2F0KGkpDQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gZS5zaWdCeXRlcyA9IDQgKiBzLA0KICAgICAgICAgICAgZQ0KICAgICAgICB9DQogICAgfSk7DQogICAgdC5FdnBLREYgPSBmdW5jdGlvbihuLCB0LCBpKSB7DQogICAgICAgIHJldHVybiB1LmNyZWF0ZShpKS5jb21wdXRlKG4sIHQpDQogICAgfQ0KfSAoKTsNCkNyeXB0b0pTLmxpYi5DaXBoZXIgfHwNCmZ1bmN0aW9uKG4pIHsNCiAgICB2YXIgaSA9IENyeXB0b0pTLA0KICAgIHQgPSBpLmxpYiwNCiAgICBmID0gdC5CYXNlLA0KICAgIGUgPSB0LldvcmRBcnJheSwNCiAgICBjID0gdC5CdWZmZXJlZEJsb2NrQWxnb3JpdGhtLA0KICAgIGwgPSBpLmVuYy5CYXNlNjQsDQogICAgeSA9IGkuYWxnby5FdnBLREYsDQogICAgbyA9IHQuQ2lwaGVyID0gYy5leHRlbmQoew0KICAgICAgICBjZmc6IGYuZXh0ZW5kKCksDQogICAgICAgIGNyZWF0ZUVuY3J5cHRvcjogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHRoaXMuX0VOQ19YRk9STV9NT0RFLCBuLCB0KQ0KICAgICAgICB9LA0KICAgICAgICBjcmVhdGVEZWNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZSh0aGlzLl9ERUNfWEZPUk1fTU9ERSwgbiwgdCkNCiAgICAgICAgfSwNCiAgICAgICAgaW5pdDogZnVuY3Rpb24obiwgdCwgaSkgew0KICAgICAgICAgICAgdGhpcy5jZmcgPSB0aGlzLmNmZy5leHRlbmQoaSk7DQogICAgICAgICAgICB0aGlzLl94Zm9ybU1vZGUgPSBuOw0KICAgICAgICAgICAgdGhpcy5fa2V5ID0gdDsNCiAgICAgICAgICAgIHRoaXMucmVzZXQoKQ0KICAgICAgICB9LA0KICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBjLnJlc2V0LmNhbGwodGhpcyk7DQogICAgICAgICAgICB0aGlzLl9kb1Jlc2V0KCkNCiAgICAgICAgfSwNCiAgICAgICAgcHJvY2VzczogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGVuZChuKSwNCiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3MoKQ0KICAgICAgICB9LA0KICAgICAgICBmaW5hbGl6ZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIG4gJiYgdGhpcy5fYXBwZW5kKG4pLA0KICAgICAgICAgICAgdGhpcy5fZG9GaW5hbGl6ZSgpDQogICAgICAgIH0sDQogICAgICAgIGtleVNpemU6IDQsDQogICAgICAgIGl2U2l6ZTogNCwNCiAgICAgICAgX0VOQ19YRk9STV9NT0RFOiAxLA0KICAgICAgICBfREVDX1hGT1JNX01PREU6IDIsDQogICAgICAgIF9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgZW5jcnlwdDogZnVuY3Rpb24odCwgaSwgcikgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCJzdHJpbmciID09IHR5cGVvZiBpID8gdjogdSkuZW5jcnlwdChuLCB0LCBpLCByKQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZGVjcnlwdDogZnVuY3Rpb24odCwgaSwgcikgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCJzdHJpbmciID09IHR5cGVvZiBpID8gdjogdSkuZGVjcnlwdChuLCB0LCBpLCByKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0pOw0KICAgIHQuU3RyZWFtQ2lwaGVyID0gby5leHRlbmQoew0KICAgICAgICBfZG9GaW5hbGl6ZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2VzcyghMCkNCiAgICAgICAgfSwNCiAgICAgICAgYmxvY2tTaXplOiAxDQogICAgfSk7DQogICAgdmFyIHMgPSBpLm1vZGUgPSB7fSwNCiAgICBhID0gZnVuY3Rpb24odCwgaSwgcikgew0KICAgICAgICB2YXIgZiA9IHRoaXMuX2l2LA0KICAgICAgICB1Ow0KICAgICAgICBmb3IgKGYgPyB0aGlzLl9pdiA9IG46IGYgPSB0aGlzLl9wcmV2QmxvY2ssIHUgPSAwOyB1ICZsdDsgcjsgdSsrKSB0W2kgKyB1XSBePSBmW3VdDQogICAgfSwNCiAgICByID0gKHQuQmxvY2tDaXBoZXJNb2RlID0gZi5leHRlbmQoew0KICAgICAgICBjcmVhdGVFbmNyeXB0b3I6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLkVuY3J5cHRvci5jcmVhdGUobiwgdCkNCiAgICAgICAgfSwNCiAgICAgICAgY3JlYXRlRGVjcnlwdG9yOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5EZWNyeXB0b3IuY3JlYXRlKG4sIHQpDQogICAgICAgIH0sDQogICAgICAgIGluaXQ6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHRoaXMuX2NpcGhlciA9IG47DQogICAgICAgICAgICB0aGlzLl9pdiA9IHQNCiAgICAgICAgfQ0KICAgIH0pKS5leHRlbmQoKTsNCiAgICByLkVuY3J5cHRvciA9IHIuZXh0ZW5kKHsNCiAgICAgICAgcHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICB2YXIgaSA9IHRoaXMuX2NpcGhlciwNCiAgICAgICAgICAgIHIgPSBpLmJsb2NrU2l6ZTsNCiAgICAgICAgICAgIGEuY2FsbCh0aGlzLCBuLCB0LCByKTsNCiAgICAgICAgICAgIGkuZW5jcnlwdEJsb2NrKG4sIHQpOw0KICAgICAgICAgICAgdGhpcy5fcHJldkJsb2NrID0gbi5zbGljZSh0LCB0ICsgcikNCiAgICAgICAgfQ0KICAgIH0pOw0KICAgIHIuRGVjcnlwdG9yID0gci5leHRlbmQoew0KICAgICAgICBwcm9jZXNzQmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHZhciBpID0gdGhpcy5fY2lwaGVyLA0KICAgICAgICAgICAgciA9IGkuYmxvY2tTaXplLA0KICAgICAgICAgICAgdSA9IG4uc2xpY2UodCwgdCArIHIpOw0KICAgICAgICAgICAgaS5kZWNyeXB0QmxvY2sobiwgdCk7DQogICAgICAgICAgICBhLmNhbGwodGhpcywgbiwgdCwgcik7DQogICAgICAgICAgICB0aGlzLl9wcmV2QmxvY2sgPSB1DQogICAgICAgIH0NCiAgICB9KTsNCiAgICBzID0gcy5DQkMgPSByOw0KICAgIHIgPSAoaS5wYWQgPSB7fSkuUGtjczcgPSB7DQogICAgICAgIHBhZDogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDQgKiB0LA0KICAgICAgICAgICAgaSA9IGkgLSBuLnNpZ0J5dGVzICUgaSwNCiAgICAgICAgICAgIGYgPSBpICZsdDsmbHQ7IDI0IHwgaSAmbHQ7Jmx0OyAxNiB8IGkgJmx0OyZsdDsgOCB8IGksDQogICAgICAgICAgICByID0gW10sIHUgPSAwOyB1ICZsdDsgaTsgdSArPSA0KSByLnB1c2goZik7DQogICAgICAgICAgICBpID0gZS5jcmVhdGUociwgaSk7DQogICAgICAgICAgICBuLmNvbmNhdChpKQ0KICAgICAgICB9LA0KICAgICAgICB1bnBhZDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgbi5zaWdCeXRlcyAtPSBuLndvcmRzW24uc2lnQnl0ZXMgLSAxICZndDsmZ3Q7Jmd0OyAyXSAmIDI1NQ0KICAgICAgICB9DQogICAgfTsNCiAgICB0LkJsb2NrQ2lwaGVyID0gby5leHRlbmQoew0KICAgICAgICBjZmc6IG8uY2ZnLmV4dGVuZCh7DQogICAgICAgICAgICBtb2RlOiBzLA0KICAgICAgICAgICAgcGFkZGluZzogcg0KICAgICAgICB9KSwNCiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIHQ7DQogICAgICAgICAgICBvLnJlc2V0LmNhbGwodGhpcyk7DQogICAgICAgICAgICB2YXIgbiA9IHRoaXMuY2ZnLA0KICAgICAgICAgICAgaSA9IG4uaXYsDQogICAgICAgICAgICBuID0gbi5tb2RlOw0KICAgICAgICAgICAgdGhpcy5feGZvcm1Nb2RlID09IHRoaXMuX0VOQ19YRk9STV9NT0RFID8gdCA9IG4uY3JlYXRlRW5jcnlwdG9yOiAodCA9IG4uY3JlYXRlRGVjcnlwdG9yLCB0aGlzLl9taW5CdWZmZXJTaXplID0gMSk7DQogICAgICAgICAgICB0aGlzLl9tb2RlID0gdC5jYWxsKG4sIHRoaXMsIGkgJiYgaS53b3JkcykNCiAgICAgICAgfSwNCiAgICAgICAgX2RvUHJvY2Vzc0Jsb2NrOiBmdW5jdGlvbihuLCB0KSB7DQogICAgICAgICAgICB0aGlzLl9tb2RlLnByb2Nlc3NCbG9jayhuLCB0KQ0KICAgICAgICB9LA0KICAgICAgICBfZG9GaW5hbGl6ZTogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB2YXIgdCA9IHRoaXMuY2ZnLnBhZGRpbmcsDQogICAgICAgICAgICBuOw0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3hmb3JtTW9kZSA9PSB0aGlzLl9FTkNfWEZPUk1fTU9ERSA/ICh0LnBhZCh0aGlzLl9kYXRhLCB0aGlzLmJsb2NrU2l6ZSksIG4gPSB0aGlzLl9wcm9jZXNzKCEwKSkgOiAobiA9IHRoaXMuX3Byb2Nlc3MoITApLCB0LnVucGFkKG4pKSwNCiAgICAgICAgICAgIG4NCiAgICAgICAgfSwNCiAgICAgICAgYmxvY2tTaXplOiA0DQogICAgfSk7DQogICAgdmFyIGggPSB0LkNpcGhlclBhcmFtcyA9IGYuZXh0ZW5kKHsNCiAgICAgICAgaW5pdDogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdGhpcy5taXhJbihuKQ0KICAgICAgICB9LA0KICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgcmV0dXJuIChuIHx8IHRoaXMuZm9ybWF0dGVyKS5zdHJpbmdpZnkodGhpcykNCiAgICAgICAgfQ0KICAgIH0pLA0KICAgIHMgPSAoaS5mb3JtYXQgPSB7fSkuT3BlblNTTCA9IHsNCiAgICAgICAgc3RyaW5naWZ5OiBmdW5jdGlvbihuKSB7DQogICAgICAgICAgICB2YXIgdCA9IG4uY2lwaGVydGV4dDsNCiAgICAgICAgICAgIHJldHVybiBuID0gbi5zYWx0LA0KICAgICAgICAgICAgKG4gPyBlLmNyZWF0ZShbMTM5ODg5MzY4NCwgMTcwMTA3NjgzMV0pLmNvbmNhdChuKS5jb25jYXQodCkgOiB0KS50b1N0cmluZyhsKQ0KICAgICAgICB9LA0KICAgICAgICBwYXJzZTogZnVuY3Rpb24obikgew0KICAgICAgICAgICAgdmFyIHQsIGk7DQogICAgICAgICAgICByZXR1cm4gbiA9IGwucGFyc2UobiksDQogICAgICAgICAgICB0ID0gbi53b3JkcywNCiAgICAgICAgICAgIDEzOTg4OTM2ODQgPT0gdFswXSAmJiAxNzAxMDc2ODMxID09IHRbMV0gJiYgKGkgPSBlLmNyZWF0ZSh0LnNsaWNlKDIsIDQpKSwgdC5zcGxpY2UoMCwgNCksIG4uc2lnQnl0ZXMgLT0gMTYpLA0KICAgICAgICAgICAgaC5jcmVhdGUoew0KICAgICAgICAgICAgICAgIGNpcGhlcnRleHQ6IG4sDQogICAgICAgICAgICAgICAgc2FsdDogaQ0KICAgICAgICAgICAgfSkNCiAgICAgICAgfQ0KICAgIH0sDQogICAgdSA9IHQuU2VyaWFsaXphYmxlQ2lwaGVyID0gZi5leHRlbmQoew0KICAgICAgICBjZmc6IGYuZXh0ZW5kKHsNCiAgICAgICAgICAgIGZvcm1hdDogcw0KICAgICAgICB9KSwNCiAgICAgICAgZW5jcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgew0KICAgICAgICAgICAgciA9IHRoaXMuY2ZnLmV4dGVuZChyKTsNCiAgICAgICAgICAgIHZhciB1ID0gbi5jcmVhdGVFbmNyeXB0b3IoaSwgcik7DQogICAgICAgICAgICByZXR1cm4gdCA9IHUuZmluYWxpemUodCksDQogICAgICAgICAgICB1ID0gdS5jZmcsDQogICAgICAgICAgICBoLmNyZWF0ZSh7DQogICAgICAgICAgICAgICAgY2lwaGVydGV4dDogdCwNCiAgICAgICAgICAgICAgICBrZXk6IGksDQogICAgICAgICAgICAgICAgaXY6IHUuaXYsDQogICAgICAgICAgICAgICAgYWxnb3JpdGhtOiBuLA0KICAgICAgICAgICAgICAgIG1vZGU6IHUubW9kZSwNCiAgICAgICAgICAgICAgICBwYWRkaW5nOiB1LnBhZGRpbmcsDQogICAgICAgICAgICAgICAgYmxvY2tTaXplOiBuLmJsb2NrU2l6ZSwNCiAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IHIuZm9ybWF0DQogICAgICAgICAgICB9KQ0KICAgICAgICB9LA0KICAgICAgICBkZWNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICByZXR1cm4gciA9IHRoaXMuY2ZnLmV4dGVuZChyKSwNCiAgICAgICAgICAgIHQgPSB0aGlzLl9wYXJzZSh0LCByLmZvcm1hdCksDQogICAgICAgICAgICBuLmNyZWF0ZURlY3J5cHRvcihpLCByKS5maW5hbGl6ZSh0LmNpcGhlcnRleHQpDQogICAgICAgIH0sDQogICAgICAgIF9wYXJzZTogZnVuY3Rpb24obiwgdCkgew0KICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciID09IHR5cGVvZiBuID8gdC5wYXJzZShuLCB0aGlzKSA6IG4NCiAgICAgICAgfQ0KICAgIH0pLA0KICAgIGkgPSAoaS5rZGYgPSB7fSkuT3BlblNTTCA9IHsNCiAgICAgICAgZXhlY3V0ZTogZnVuY3Rpb24obiwgdCwgaSwgcikgew0KICAgICAgICAgICAgcmV0dXJuIHIgfHwgKHIgPSBlLnJhbmRvbSg4KSksDQogICAgICAgICAgICBuID0geS5jcmVhdGUoew0KICAgICAgICAgICAgICAgIGtleVNpemU6IHQgKyBpDQogICAgICAgICAgICB9KS5jb21wdXRlKG4sIHIpLA0KICAgICAgICAgICAgaSA9IGUuY3JlYXRlKG4ud29yZHMuc2xpY2UodCksIDQgKiBpKSwNCiAgICAgICAgICAgIG4uc2lnQnl0ZXMgPSA0ICogdCwNCiAgICAgICAgICAgIGguY3JlYXRlKHsNCiAgICAgICAgICAgICAgICBrZXk6IG4sDQogICAgICAgICAgICAgICAgaXY6IGksDQogICAgICAgICAgICAgICAgc2FsdDogcg0KICAgICAgICAgICAgfSkNCiAgICAgICAgfQ0KICAgIH0sDQogICAgdiA9IHQuUGFzc3dvcmRCYXNlZENpcGhlciA9IHUuZXh0ZW5kKHsNCiAgICAgICAgY2ZnOiB1LmNmZy5leHRlbmQoew0KICAgICAgICAgICAga2RmOiBpDQogICAgICAgIH0pLA0KICAgICAgICBlbmNyeXB0OiBmdW5jdGlvbihuLCB0LCBpLCByKSB7DQogICAgICAgICAgICByZXR1cm4gciA9IHRoaXMuY2ZnLmV4dGVuZChyKSwNCiAgICAgICAgICAgIGkgPSByLmtkZi5leGVjdXRlKGksIG4ua2V5U2l6ZSwgbi5pdlNpemUpLA0KICAgICAgICAgICAgci5pdiA9IGkuaXYsDQogICAgICAgICAgICBuID0gdS5lbmNyeXB0LmNhbGwodGhpcywgbiwgdCwgaS5rZXksIHIpLA0KICAgICAgICAgICAgbi5taXhJbihpKSwNCiAgICAgICAgICAgIG4NCiAgICAgICAgfSwNCiAgICAgICAgZGVjcnlwdDogZnVuY3Rpb24obiwgdCwgaSwgcikgew0KICAgICAgICAgICAgcmV0dXJuIHIgPSB0aGlzLmNmZy5leHRlbmQociksDQogICAgICAgICAgICB0ID0gdGhpcy5fcGFyc2UodCwgci5mb3JtYXQpLA0KICAgICAgICAgICAgaSA9IHIua2RmLmV4ZWN1dGUoaSwgbi5rZXlTaXplLCBuLml2U2l6ZSwgdC5zYWx0KSwNCiAgICAgICAgICAgIHIuaXYgPSBpLml2LA0KICAgICAgICAgICAgdS5kZWNyeXB0LmNhbGwodGhpcywgbiwgdCwgaS5rZXksIHIpDQogICAgICAgIH0NCiAgICB9KQ0KfSAoKSwNCmZ1bmN0aW9uKCkgew0KICAgIGZvciAodmFyIGksIHR0LCBzID0gQ3J5cHRvSlMsDQogICAgeSA9IHMubGliLkJsb2NrQ2lwaGVyLA0KICAgIGggPSBzLmFsZ28sDQogICAgdCA9IFtdLCBwID0gW10sIHcgPSBbXSwgYiA9IFtdLCBrID0gW10sIGQgPSBbXSwgYyA9IFtdLCBsID0gW10sIGEgPSBbXSwgdiA9IFtdLCB1ID0gW10sIGYgPSAwOyAyNTYgJmd0OyBmOyBmKyspIHVbZl0gPSAxMjggJmd0OyBmID8gZiAmbHQ7Jmx0OyAxIDogZiAmbHQ7Jmx0OyAxIF4gMjgzOw0KICAgIGZvciAodmFyIHIgPSAwLA0KICAgIGUgPSAwLA0KICAgIGYgPSAwOyAyNTYgJmd0OyBmOyBmKyspIHsNCiAgICAgICAgaSA9IGUgXiBlICZsdDsmbHQ7IDEgXiBlICZsdDsmbHQ7IDIgXiBlICZsdDsmbHQ7IDMgXiBlICZsdDsmbHQ7IDQ7DQogICAgICAgIGkgPSBpICZndDsmZ3Q7Jmd0OyA4IF4gaSAmIDI1NSBeIDk5Ow0KICAgICAgICB0W3JdID0gaTsNCiAgICAgICAgcFtpXSA9IHI7DQogICAgICAgIHZhciBvID0gdVtyXSwNCiAgICAgICAgZyA9IHVbb10sDQogICAgICAgIG50ID0gdVtnXSwNCiAgICAgICAgbiA9IDI1NyAqIHVbaV0gXiAxNjg0MzAwOCAqIGk7DQogICAgICAgIHdbcl0gPSBuICZsdDsmbHQ7IDI0IHwgbiAmZ3Q7Jmd0OyZndDsgODsNCiAgICAgICAgYltyXSA9IG4gJmx0OyZsdDsgMTYgfCBuICZndDsmZ3Q7Jmd0OyAxNjsNCiAgICAgICAga1tyXSA9IG4gJmx0OyZsdDsgOCB8IG4gJmd0OyZndDsmZ3Q7IDI0Ow0KICAgICAgICBkW3JdID0gbjsNCiAgICAgICAgbiA9IDE2ODQzMDA5ICogbnQgXiA2NTUzNyAqIGcgXiAyNTcgKiBvIF4gMTY4NDMwMDggKiByOw0KICAgICAgICBjW2ldID0gbiAmbHQ7Jmx0OyAyNCB8IG4gJmd0OyZndDsmZ3Q7IDg7DQogICAgICAgIGxbaV0gPSBuICZsdDsmbHQ7IDE2IHwgbiAmZ3Q7Jmd0OyZndDsgMTY7DQogICAgICAgIGFbaV0gPSBuICZsdDsmbHQ7IDggfCBuICZndDsmZ3Q7Jmd0OyAyNDsNCiAgICAgICAgdltpXSA9IG47DQogICAgICAgIHIgPyAociA9IG8gXiB1W3VbdVtudCBeIG9dXV0sIGUgXj0gdVt1W2VdXSkgOiByID0gZSA9IDENCiAgICB9DQogICAgdHQgPSBbMCwgMSwgMiwgNCwgOCwgMTYsIDMyLCA2NCwgMTI4LCAyNywgNTRdOw0KICAgIGggPSBoLkFFUyA9IHkuZXh0ZW5kKHsNCiAgICAgICAgX2RvUmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgZm9yICh2YXIgbiwgZiA9IHRoaXMuX2tleSwNCiAgICAgICAgICAgIGUgPSBmLndvcmRzLA0KICAgICAgICAgICAgciA9IGYuc2lnQnl0ZXMgLyA0LA0KICAgICAgICAgICAgZiA9IDQgKiAoKHRoaXMuX25Sb3VuZHMgPSByICsgNikgKyAxKSwgdSA9IHRoaXMuX2tleVNjaGVkdWxlID0gW10sIGkgPSAwOyBpICZsdDsgZjsgaSsrKSBpICZsdDsgciA/IHVbaV0gPSBlW2ldIDogKG4gPSB1W2kgLSAxXSwgaSAlIHIgPyA2ICZsdDsgciAmJiA0ID09IGkgJSByICYmIChuID0gdFtuICZndDsmZ3Q7Jmd0OyAyNF0gJmx0OyZsdDsgMjQgfCB0W24gJmd0OyZndDsmZ3Q7IDE2ICYgMjU1XSAmbHQ7Jmx0OyAxNiB8IHRbbiAmZ3Q7Jmd0OyZndDsgOCAmIDI1NV0gJmx0OyZsdDsgOCB8IHRbbiAmIDI1NV0pIDogKG4gPSBuICZsdDsmbHQ7IDggfCBuICZndDsmZ3Q7Jmd0OyAyNCwgbiA9IHRbbiAmZ3Q7Jmd0OyZndDsgMjRdICZsdDsmbHQ7IDI0IHwgdFtuICZndDsmZ3Q7Jmd0OyAxNiAmIDI1NV0gJmx0OyZsdDsgMTYgfCB0W24gJmd0OyZndDsmZ3Q7IDggJiAyNTVdICZsdDsmbHQ7IDggfCB0W24gJiAyNTVdLCBuIF49IHR0W2kgLyByIHwgMF0gJmx0OyZsdDsgMjQpLCB1W2ldID0gdVtpIC0gcl0gXiBuKTsNCiAgICAgICAgICAgIGZvciAoZSA9IHRoaXMuX2ludktleVNjaGVkdWxlID0gW10sIHIgPSAwOyByICZsdDsgZjsgcisrKSBpID0gZiAtIHIsDQogICAgICAgICAgICBuID0gciAlIDQgPyB1W2ldIDogdVtpIC0gNF0sDQogICAgICAgICAgICBlW3JdID0gNCAmZ3Q7IHIgfHwgNCAmZ3Q7PSBpID8gbjogY1t0W24gJmd0OyZndDsmZ3Q7IDI0XV0gXiBsW3RbbiAmZ3Q7Jmd0OyZndDsgMTYgJiAyNTVdXSBeIGFbdFtuICZndDsmZ3Q7Jmd0OyA4ICYgMjU1XV0gXiB2W3RbbiAmIDI1NV1dDQogICAgICAgIH0sDQogICAgICAgIGVuY3J5cHRCbG9jazogZnVuY3Rpb24obiwgaSkgew0KICAgICAgICAgICAgdGhpcy5fZG9DcnlwdEJsb2NrKG4sIGksIHRoaXMuX2tleVNjaGVkdWxlLCB3LCBiLCBrLCBkLCB0KQ0KICAgICAgICB9LA0KICAgICAgICBkZWNyeXB0QmxvY2s6IGZ1bmN0aW9uKG4sIHQpIHsNCiAgICAgICAgICAgIHZhciBpID0gblt0ICsgMV07DQogICAgICAgICAgICBuW3QgKyAxXSA9IG5bdCArIDNdOw0KICAgICAgICAgICAgblt0ICsgM10gPSBpOw0KICAgICAgICAgICAgdGhpcy5fZG9DcnlwdEJsb2NrKG4sIHQsIHRoaXMuX2ludktleVNjaGVkdWxlLCBjLCBsLCBhLCB2LCBwKTsNCiAgICAgICAgICAgIGkgPSBuW3QgKyAxXTsNCiAgICAgICAgICAgIG5bdCArIDFdID0gblt0ICsgM107DQogICAgICAgICAgICBuW3QgKyAzXSA9IGkNCiAgICAgICAgfSwNCiAgICAgICAgX2RvQ3J5cHRCbG9jazogZnVuY3Rpb24obiwgdCwgaSwgciwgdSwgZiwgZSwgbykgew0KICAgICAgICAgICAgZm9yICh2YXIgYiA9IHRoaXMuX25Sb3VuZHMsDQogICAgICAgICAgICBoID0gblt0XSBeIGlbMF0sIGMgPSBuW3QgKyAxXSBeIGlbMV0sIGwgPSBuW3QgKyAyXSBeIGlbMl0sIHMgPSBuW3QgKyAzXSBeIGlbM10sIGEgPSA0LCB3ID0gMTsgdyAmbHQ7IGI7IHcrKykgdmFyIHYgPSByW2ggJmd0OyZndDsmZ3Q7IDI0XSBeIHVbYyAmZ3Q7Jmd0OyZndDsgMTYgJiAyNTVdIF4gZltsICZndDsmZ3Q7Jmd0OyA4ICYgMjU1XSBeIGVbcyAmIDI1NV0gXiBpW2ErK10sDQogICAgICAgICAgICB5ID0gcltjICZndDsmZ3Q7Jmd0OyAyNF0gXiB1W2wgJmd0OyZndDsmZ3Q7IDE2ICYgMjU1XSBeIGZbcyAmZ3Q7Jmd0OyZndDsgOCAmIDI1NV0gXiBlW2ggJiAyNTVdIF4gaVthKytdLA0KICAgICAgICAgICAgcCA9IHJbbCAmZ3Q7Jmd0OyZndDsgMjRdIF4gdVtzICZndDsmZ3Q7Jmd0OyAxNiAmIDI1NV0gXiBmW2ggJmd0OyZndDsmZ3Q7IDggJiAyNTVdIF4gZVtjICYgMjU1XSBeIGlbYSsrXSwNCiAgICAgICAgICAgIHMgPSByW3MgJmd0OyZndDsmZ3Q7IDI0XSBeIHVbaCAmZ3Q7Jmd0OyZndDsgMTYgJiAyNTVdIF4gZltjICZndDsmZ3Q7Jmd0OyA4ICYgMjU1XSBeIGVbbCAmIDI1NV0gXiBpW2ErK10sDQogICAgICAgICAgICBoID0gdiwNCiAgICAgICAgICAgIGMgPSB5LA0KICAgICAgICAgICAgbCA9IHA7DQogICAgICAgICAgICB2ID0gKG9baCAmZ3Q7Jmd0OyZndDsgMjRdICZsdDsmbHQ7IDI0IHwgb1tjICZndDsmZ3Q7Jmd0OyAxNiAmIDI1NV0gJmx0OyZsdDsgMTYgfCBvW2wgJmd0OyZndDsmZ3Q7IDggJiAyNTVdICZsdDsmbHQ7IDggfCBvW3MgJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgIHkgPSAob1tjICZndDsmZ3Q7Jmd0OyAyNF0gJmx0OyZsdDsgMjQgfCBvW2wgJmd0OyZndDsmZ3Q7IDE2ICYgMjU1XSAmbHQ7Jmx0OyAxNiB8IG9bcyAmZ3Q7Jmd0OyZndDsgOCAmIDI1NV0gJmx0OyZsdDsgOCB8IG9baCAmIDI1NV0pIF4gaVthKytdOw0KICAgICAgICAgICAgcCA9IChvW2wgJmd0OyZndDsmZ3Q7IDI0XSAmbHQ7Jmx0OyAyNCB8IG9bcyAmZ3Q7Jmd0OyZndDsgMTYgJiAyNTVdICZsdDsmbHQ7IDE2IHwgb1toICZndDsmZ3Q7Jmd0OyA4ICYgMjU1XSAmbHQ7Jmx0OyA4IHwgb1tjICYgMjU1XSkgXiBpW2ErK107DQogICAgICAgICAgICBzID0gKG9bcyAmZ3Q7Jmd0OyZndDsgMjRdICZsdDsmbHQ7IDI0IHwgb1toICZndDsmZ3Q7Jmd0OyAxNiAmIDI1NV0gJmx0OyZsdDsgMTYgfCBvW2MgJmd0OyZndDsmZ3Q7IDggJiAyNTVdICZsdDsmbHQ7IDggfCBvW2wgJiAyNTVdKSBeIGlbYSsrXTsNCiAgICAgICAgICAgIG5bdF0gPSB2Ow0KICAgICAgICAgICAgblt0ICsgMV0gPSB5Ow0KICAgICAgICAgICAgblt0ICsgMl0gPSBwOw0KICAgICAgICAgICAgblt0ICsgM10gPSBzDQogICAgICAgIH0sDQogICAgICAgIGtleVNpemU6IDgNCiAgICB9KTsNCiAgICBzLkFFUyA9IHkuX2NyZWF0ZUhlbHBlcihoKQ0KfSAoKTsNCmZ1bmN0aW9uIHZhbEFlc0VuY3J5cHRTZXQoaSkgew0KICAgIHZhciBuLHQscjsNCiAgICB0cnkgew0KICAgICAgICBuID0gYWVzRGVjcnlwdChpKTsNCiAgICAgICAgbiAhPSAiIiAmJiAodCA9IGFlc0VuY3J5cHQobiksIHQgIT0gaSAmJiAobiA9ICIiKSkNCiAgICB9IGNhdGNoKHIpIHsNCiAgICAgICAgbiA9ICIiDQogICAgfQ0KICAgIHJldHVybiBuID09ICIiICYmICh0ID0gYWVzRW5jcnlwdChpKSk7DQp9Ow0KZnVuY3Rpb24gYWVzRGVjcnlwdChuKSB7DQogICAgdmFyIHQgPSBDcnlwdG9KUy5NRDUoImxvZ2luLjE4OS5jbiIpLA0KICAgIGkgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSh0KSwNCiAgICByID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoIjEyMzQ1Njc4MTIzNDU2NzgiKTsNCiAgICByZXR1cm4gQ3J5cHRvSlMuQUVTLmRlY3J5cHQobiwgaSwgew0KICAgICAgICBpdjogcg0KICAgIH0pLnRvU3RyaW5nKENyeXB0b0pTLmVuYy5VdGY4KQ0KfTsNCmZ1bmN0aW9uIGFlc0VuY3J5cHQobikgew0KICAgIHZhciB0ID0gQ3J5cHRvSlMuTUQ1KCJsb2dpbi4xODkuY24iKSwNCiAgICBpID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UodCksDQogICAgciA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKCIxMjM0NTY3ODEyMzQ1Njc4IiksDQogICAgdSA9IENyeXB0b0pTLkFFUy5lbmNyeXB0KG4sIGksIHsNCiAgICAgICAgaXY6IHINCiAgICB9KTsNCiAgICByZXR1cm4gdSArICIiDQp9Ow==";

    @Override
    public HttpResult<Map<String, Object>> init(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        try {
            return result.success();
        } catch (Exception e) {
            logger.error("登录-->初始化失败,param={}", param, e);
            return result.failure(ErrorCode.TASK_INIT_ERROR);
        }
    }

    @Override
    public HttpResult<Object> defineProcess(OperatorParam param) {
        return new HttpResult<Object>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    @Override
    public HttpResult<String> refeshPicCode(OperatorParam param) {
        return new HttpResult<String>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    @Override
    public HttpResult<Map<String, Object>> refeshSmsCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshSmsCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }


    @Override
    public HttpResult<Map<String, Object>> validatePicCode(OperatorParam param) {
        return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    @Override
    public HttpResult<Map<String, Object>> submit(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return submitForLogin(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return submitForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }


    private HttpResult<Map<String, Object>> submitForLogin(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPassword(), ErrorCode.EMPTY_PASSWORD);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;

        try {
            Invocable invocable = ScriptEngineUtil.createInvocableFromBase64(javaScript);
            String encryptPassword = invocable.invokeFunction("aesEncrypt", param.getPassword()).toString();

            String referer = "http://login.189.cn/login";
            String templateUrl = "http://login.189.cn/login";
            String templateData = "Account={}&UType=201&ProvinceID=17&AreaCode=&CityNo=&RandomFlag=0&Password={}&Captcha=";
            String data = TemplateUtils.format(templateData, param.getMobile(), URLEncoder.encode(encryptPassword, "UTF-8"));
            response = TaskHttpClient.create(param, RequestType.POST, "he_nan_10000_web_001").setFullUrl(templateUrl).setReferer(referer)
                    .setRequestBody(data).invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.isBlank(pageContent)) {
                logger.error("登陆失败,param={},response={}", param, response);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
            String resultCode = PatternUtils.group(pageContent, "data-resultcode=\"(\\d+)\"", 1);
            if (resultCode != null) {
                if (resultCode.equals("9103") || resultCode.equals("9999")) {
                    logger.error("登陆失败,账户名与密码不匹配,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("8105")) {
                    logger.error("登陆失败,密码过于简单,请重置,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("9111")) {
                    logger.error("登陆失败,登录失败过多，帐号已被锁定,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                } else if (resultCode.equals("9100")) {
                    logger.error("登陆失败,该账户不存在,param={},response={}", param, response);
                    return result.failure(ErrorCode.VALIDATE_PHONE_FAIL);
                } else if (resultCode.equals("6113")) {
                    logger.error("登陆失败,系统繁忙，稍后重试,param={},response={}", param, response);
                    return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
                } else if (StringUtils.isNotBlank(resultCode)) {
                    logger.error("登陆失败,param={},response={}", param, response);
                    return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
                }
            }

            templateUrl = "http://www.189.cn/ha/";
            response = TaskHttpClient.create(param, RequestType.GET, "he_nan_10000_web_002").setFullUrl(templateUrl).invoke();

            referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=20000354";
            templateUrl = "http://www.189.cn/login/sso/ecs.do?method=linkTo&platNo=10017&toStUrl=http://ha.189.cn/service/iframe/feeQuery_iframe.jsp?SERV_NO=FSE-2-1&fastcode=20000354&cityCode=ha";
            response = TaskHttpClient.create(param, RequestType.GET, "he_nan_10000_web_003").setFullUrl(templateUrl).setReferer(referer).invoke();

            referer = "http://ha.189.cn/service/iframe/feeQuery_iframe.jsp?SERV_NO=FSE-2-1&fastcode=20000354&cityCode=ha";
            templateUrl = "http://ha.189.cn/service/iframe/bill/iframe_ye.jsp\"ACC_NBR=" + param.getMobile() + "&PROD_TYPE=713058010165&ACCTNBR97=";
            response = TaskHttpClient.create(param, RequestType.GET, "he_nan_10000_web_004").setFullUrl(templateUrl).setReferer(referer).invoke();
            pageContent = response.getPageContent();

            if (StringUtils.contains(pageContent, String.valueOf(param.getMobile())) && StringUtils.contains(pageContent, "可用余额")) {
                logger.info("登陆成功,param={}", param);
                return result.success();
            } else {
                logger.error("登陆失败,param={},pageContent={}", param, pageContent);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登陆失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.LOGIN_ERROR);
        }

    }


    private HttpResult<Map<String, Object>> refeshSmsCodeForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        SimpleDateFormat sf = new SimpleDateFormat("yyyy-MM-dd");
        Calendar c = Calendar.getInstance();
        c.add(Calendar.MONTH, 0);
        try {
            String referer = "http://www.189.cn/dqmh/my189/initMy189home.do?fastcode=20000354";
            String templateUrl = "http://ha.189.cn/service/iframe/feeQuery_iframe.jsp?SERV_NO=FSE-2-2&fastcode=20000356&cityCode=ha";
            response = TaskHttpClient.create(param, RequestType.GET, "he_nan_10000_web_005").setFullUrl(templateUrl).setReferer(referer)
                    .invoke();
            String pageContent = response.getPageContent();
            String PRODTYPE = PatternUtils.group(pageContent, "doQuery\\('(\\d+)','(\\d+)',''\\)", 2);
            TaskUtils.addTaskShare(param.getTaskId(), "PRODTYPE", PRODTYPE);

            referer = "http://ha.189.cn/service/iframe/feeQuery_iframe.jsp?SERV_NO=FSE-2-2&fastcode=20000356&cityCode=ha";
            templateUrl = "http://ha.189.cn/service/iframe/bill/iframe_inxxall.jsp\"ACC_NBR=" + param.getMobile() + "&PROD_TYPE="
                    + PRODTYPE + "&BEGIN_DATE=&END_DATE=&SERV_NO=&ValueType=1&REFRESH_FLAG=1&FIND_TYPE=1&radioQryType=on&QRY_FLAG=1&ACCT_DATE="
                    + sf.format(c.getTime()) + "&ACCT_DATE_1=" + sf.format(c.getTime());
            response = TaskHttpClient.create(param, RequestType.GET, "he_nan_10000_web_006").setFullUrl(templateUrl).setReferer(referer)
                    .invoke();
            if (StringUtils.isBlank(response.getPageContent())) {
                logger.error("详单-->短信验证码-->刷新失败,param={},pateContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
            String RAND_TYPE = PatternUtils.group(pageContent, "name=\"RAND_TYPE\" value=\"(\\d+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "RAND_TYPE", RAND_TYPE);
            String BureauCode = PatternUtils.group(pageContent, "name=\"BureauCode\" value=\"(\\d+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "BureauCode", BureauCode);
            String REFRESH_FLAG = PatternUtils.group(pageContent, "name=\"REFRESH_FLAG\" value=\"(\\d+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "REFRESH_FLAG", REFRESH_FLAG);
            String ACCT_DATE = PatternUtils.group(pageContent, "name=\"ACCT_DATE\" value=\"(\\d+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "ACCT_DATE", ACCT_DATE);
            String QRY_FLAG = PatternUtils.group(pageContent, "name=\"QRY_FLAG\" value=\"(\\d+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "QRY_FLAG", QRY_FLAG);
            String ValueType = PatternUtils.group(pageContent, "name=\"ValueType\" value=\"(\\d+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "ValueType", ValueType);
            String OPER_TYPE = PatternUtils.group(pageContent, "name=\"OPER_TYPE\" value=\"(\\w+)\"", 1);
            TaskUtils.addTaskShare(param.getTaskId(), "OPER_TYPE", OPER_TYPE);
            if (StringUtils.isBlank(PRODTYPE) || StringUtils.isBlank(RAND_TYPE) || StringUtils.isBlank(BureauCode)) {
                logger.error("详单-->短信验证码-->刷新失败,param={},pateContent={}", param, "param_PRODTYPE is null or param_RAND_TYPE is null or param_BureauCode is null");
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
            referer = "http://ha.189.cn/service/iframe/feeQuery_iframe.jsp?SERV_NO=FSE-2-2&fastcode=20000356&cityCode=ha";
            templateUrl = "http://ha.189.cn/service/bill/getRand.jsp?PRODTYPE=" + PRODTYPE + "&RAND_TYPE=" + RAND_TYPE
                    + "&BureauCode=" + BureauCode + "&ACC_NBR=" + param.getMobile() + "&PROD_TYPE=" + PRODTYPE + "&PROD_PWD=&REFRESH_FLAG="
                    + REFRESH_FLAG + "&BEGIN_DATE=&END_DATE=&ACCT_DATE=" + ACCT_DATE + "&FIND_TYPE=1&SERV_NO=&QRY_FLAG=" + QRY_FLAG
                    + "&ValueType=" + ValueType + "&MOBILE_NAME=" + param.getMobile() + "&OPER_TYPE=" + OPER_TYPE + "&PASSWORD=";
            response = TaskHttpClient.create(param, RequestType.POST, "he_nan_10000_web_007").setFullUrl(templateUrl).setReferer(referer)
                    .invoke();
            pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "<flag>0</flag>")) {
                logger.info("详单-->短信验证码-->刷新成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->短信验证码-->刷新失败,param={},pateContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->短信验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_SMS_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> submitForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String PRODTYPE = TaskUtils.getTaskShare(param.getTaskId(), "PRODTYPE");
            String RAND_TYPE = TaskUtils.getTaskShare(param.getTaskId(), "RAND_TYPE");
            String BureauCode = TaskUtils.getTaskShare(param.getTaskId(), "BureauCode");
            String REFRESH_FLAG = TaskUtils.getTaskShare(param.getTaskId(), "REFRESH_FLAG");
            String ACCT_DATE = TaskUtils.getTaskShare(param.getTaskId(), "ACCT_DATE");
            String QRY_FLAG = TaskUtils.getTaskShare(param.getTaskId(), "QRY_FLAG");
            String ValueType = TaskUtils.getTaskShare(param.getTaskId(), "ValueType");
            String OPER_TYPE = TaskUtils.getTaskShare(param.getTaskId(), "OPER_TYPE");

            String referer = "http://ha.189.cn/service/iframe/feeQuery_iframe.jsp?SERV_NO=FSE-2-2&fastcode=20000356&cityCode=ha";
            String templateUrl = "http://ha.189.cn/service/iframe/bill/iframe_inxxall.jsp\"PRODTYPE=" + PRODTYPE + "&RAND_TYPE=" + RAND_TYPE
                    + "&BureauCode=" + BureauCode + "&ACC_NBR=" + param.getMobile() + "&PROD_TYPE=" + PRODTYPE + "&PROD_PWD=&REFRESH_FLAG="
                    + REFRESH_FLAG + "&BEGIN_DATE=&END_DATE=&ACCT_DATE=" + ACCT_DATE + "&FIND_TYPE=1&SERV_NO=&QRY_FLAG=" + QRY_FLAG
                    + "&ValueType=" + ValueType + "&MOBILE_NAME=" + param.getMobile() + "&OPER_TYPE=" + OPER_TYPE + "&PASSWORD=" + param.getSmsCode();
            response = TaskHttpClient.create(param, RequestType.GET, "he_nan_10000_web_008").setFullUrl(templateUrl).setReferer(referer)
                    .invoke();
            if (StringUtils.contains(response.getPageContent(), "开始时间")) {
                logger.info("详单-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_UNEXPECTED_RESULT);
            }

        } catch (Exception e) {
            logger.error("详单-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_ERROR);
        }

    }
}
