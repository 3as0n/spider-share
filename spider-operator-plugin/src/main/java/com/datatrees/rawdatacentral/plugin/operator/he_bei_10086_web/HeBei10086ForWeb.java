package com.datatrees.rawdatacentral.plugin.operator.he_bei_10086_web;

import javax.script.Invocable;
import java.io.InputStream;
import java.math.BigDecimal;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.util.List;
import java.util.Map;

import com.datatrees.common.util.PatternUtils;
import com.datatrees.crawler.core.util.xpath.XPathUtil;
import com.datatrees.rawdatacentral.common.http.TaskHttpClient;
import com.datatrees.rawdatacentral.common.http.TaskUtils;
import com.datatrees.rawdatacentral.common.utils.CheckUtils;
import com.datatrees.rawdatacentral.common.utils.ScriptEngineUtil;
import com.datatrees.rawdatacentral.common.utils.TemplateUtils;
import com.datatrees.spider.share.domain.RequestType;
import com.datatrees.rawdatacentral.domain.vo.Response;
import com.datatrees.spider.operator.domain.model.OperatorParam;
import com.datatrees.spider.operator.service.OperatorPluginService;
import com.datatrees.spider.share.domain.ErrorCode;
import com.datatrees.spider.share.domain.FormType;
import com.datatrees.spider.share.domain.HttpResult;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.util.CollectionUtils;

/**
 * Created by guimeichao on 17/9/11.
 */
public class HeBei10086ForWeb implements OperatorPluginService {

    private static final Logger logger     = LoggerFactory.getLogger(HeBei10086ForWeb.class);

    private static final String javaScript
                                           = "ZnVuY3Rpb24gZW5TdHJpbmcoZGF0YSl7CnZhciBrZXkxID0gIllIWFdXTEtKWVhHUyI7CnZhciBrZXkyID0gIlpGQ0hIWVhGTDEwQyI7CnZhciBrZXkzID0gIkRFUyI7CiB2YXIgZW5jaGV4ID0gc3RyRW5jKGRhdGEsa2V5MSxrZXkyLGtleTMpOwogcmV0dXJuIGVuY2hleDsKfQovKioKUlNB5YqgL+ino+WvhgoqKi8KZnVuY3Rpb24gRW5jcnlTdHJpbmcoZW5TdHJpbmcpCiAgICB7CiAgICAgICAgaWYod2luZG93LkFjdGl2ZVhPYmplY3QpIC8vIElF5rWP6KeI5ZmoCiAgICAgICAgewogICAgICAgICAgICB4bWxIdHRwUmVxdWVzdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgLy8g6ZmkSUXku6XlpJbnmoTlhbbku5bmtY/op4jlmagKICAgICAgICB7CiAgICAgICAgICAgIHhtbEh0dHBSZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgfQogICAgICAgIGlmKG51bGwgIT0geG1sSHR0cFJlcXVlc3QpCiAgICAgICAgewogICAgICAgICAgIAogICAgICAgICAgICB4bWxIdHRwUmVxdWVzdC5vcGVuKCJQT1NUIiwgImh0dHA6Ly8xMjcuMC4wLjE6ODA4MS9zc282cXRuL0VuY3J5cHRTZXJ2bGV0IiwgZmFsc2UpOwogICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIOW9k+WPkeeUn+eKtuaAgeWPmOWMluaXtuWwseiwg+eUqOi/meS4quWbnuiwg+WHveaVsAogICAgICAgICAgICAvL3htbEh0dHBSZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGFqYXhDYWxsQmFjazsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIOS9v+eUqHBvc3Tmj5DkuqTml7blv4XpobvliqDkuIrkuIvpnaLov5nooYzku6PnoIEKICAgICAgICAgICAgeG1sSHR0cFJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC1UeXBlIiwiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIik7ICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIOWQkeacjeWKoeWZqOWPkeWHuuS4gOS4quivt+axggogICAgICAgICAgICB4bWxIdHRwUmVxdWVzdC5zZW5kKCJlblN0cmluZz0iK2VuU3RyaW5nKTsKICAgICAgICAgICAgcmV0dXJuIHhtbEh0dHBSZXF1ZXN0LnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgICAKICAgICAgICB9CiAgICB9CmZ1bmN0aW9uIGFqYXhDYWxsQmFjaygpCnsKICAgICAgICBpZih4bWxIdHRwUmVxdWVzdC5yZWFkeVN0YXRlID09IDQpCiAgICAgICAgewogICAgICAgICAgICBpZih4bWxIdHRwUmVxdWVzdC5zdGF0dXMgPT0gMjAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHhtbEh0dHBSZXF1ZXN0LnJlc3BvbnNlVGV4dDsgIAogICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgfQp9CgovKioKKiBERVPliqDlr4Yv6Kej5a+GCiogQENvcHlyaWdodCBDb3B5cmlnaHQgKGMpIDIwMDkKKiBAYXV0aG9yIGxpbnNpCiovCgovKgoqIGVuY3J5cHQgdGhlIHN0cmluZyB0byBzdHJpbmcgbWFkZSB1cCBvZiBoZXgKKiByZXR1cm4gdGhlIGVuY3J5cHRlZCBzdHJpbmcKKi8KZnVuY3Rpb24gc3RyRW5jKGRhdGEsZmlyc3RLZXksc2Vjb25kS2V5LHRoaXJkS2V5KXsKCiB2YXIgbGVuZyA9IGRhdGEubGVuZ3RoOwogdmFyIGVuY0RhdGEgPSAiIjsKIHZhciBmaXJzdEtleUJ0LHNlY29uZEtleUJ0LHRoaXJkS2V5QnQsZmlyc3RMZW5ndGgsc2Vjb25kTGVuZ3RoLHRoaXJkTGVuZ3RoOwogaWYoZmlyc3RLZXkgIT0gbnVsbCAmJiBmaXJzdEtleSAhPSAiIil7ICAgIAogICBmaXJzdEtleUJ0ID0gZ2V0S2V5Qnl0ZXMoZmlyc3RLZXkpOwogICBmaXJzdExlbmd0aCA9IGZpcnN0S2V5QnQubGVuZ3RoOwogfQogaWYoc2Vjb25kS2V5ICE9IG51bGwgJiYgc2Vjb25kS2V5ICE9ICIiKXsKICAgc2Vjb25kS2V5QnQgPSBnZXRLZXlCeXRlcyhzZWNvbmRLZXkpOwogICBzZWNvbmRMZW5ndGggPSBzZWNvbmRLZXlCdC5sZW5ndGg7CiB9CiBpZih0aGlyZEtleSAhPSBudWxsICYmIHRoaXJkS2V5ICE9ICIiKXsKICAgdGhpcmRLZXlCdCA9IGdldEtleUJ5dGVzKHRoaXJkS2V5KTsKICAgdGhpcmRMZW5ndGggPSB0aGlyZEtleUJ0Lmxlbmd0aDsKIH0gIAogCiBpZihsZW5nID4gMCl7CiAgIGlmKGxlbmcgPCA0KXsKICAgICB2YXIgYnQgPSBzdHJUb0J0KGRhdGEpOyAgICAgIAogICAgIHZhciBlbmNCeXRlIDsKICAgICBpZihmaXJzdEtleSAhPSBudWxsICYmIGZpcnN0S2V5ICE9IiIgJiYgc2Vjb25kS2V5ICE9IG51bGwgJiYgc2Vjb25kS2V5ICE9ICIiICYmIHRoaXJkS2V5ICE9IG51bGwgJiYgdGhpcmRLZXkgIT0gIiIpewogICAgICAgdmFyIHRlbXBCdDsKICAgICAgIHZhciB4LHksejsKICAgICAgIHRlbXBCdCA9IGJ0OyAgICAgICAgCiAgICAgICBmb3IoeCA9IDA7eCA8IGZpcnN0TGVuZ3RoIDt4ICsrKXsKICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCxmaXJzdEtleUJ0W3hdKTsKICAgICAgIH0KICAgICAgIGZvcih5ID0gMDt5IDwgc2Vjb25kTGVuZ3RoIDt5ICsrKXsKICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCxzZWNvbmRLZXlCdFt5XSk7CiAgICAgICB9CiAgICAgICBmb3IoeiA9IDA7eiA8IHRoaXJkTGVuZ3RoIDt6ICsrKXsKICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCx0aGlyZEtleUJ0W3pdKTsKICAgICAgIH0gICAgICAgIAogICAgICAgZW5jQnl0ZSA9IHRlbXBCdDsgICAgICAgIAogICAgIH1lbHNlewogICAgICAgaWYoZmlyc3RLZXkgIT0gbnVsbCAmJiBmaXJzdEtleSAhPSIiICYmIHNlY29uZEtleSAhPSBudWxsICYmIHNlY29uZEtleSAhPSAiIil7CiAgICAgICAgIHZhciB0ZW1wQnQ7CiAgICAgICAgIHZhciB4LHk7CiAgICAgICAgIHRlbXBCdCA9IGJ0OwogICAgICAgICBmb3IoeCA9IDA7eCA8IGZpcnN0TGVuZ3RoIDt4ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LGZpcnN0S2V5QnRbeF0pOwogICAgICAgICB9CiAgICAgICAgIGZvcih5ID0gMDt5IDwgc2Vjb25kTGVuZ3RoIDt5ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LHNlY29uZEtleUJ0W3ldKTsKICAgICAgICAgfQogICAgICAgICBlbmNCeXRlID0gdGVtcEJ0OwogICAgICAgfWVsc2V7CiAgICAgICAgIGlmKGZpcnN0S2V5ICE9IG51bGwgJiYgZmlyc3RLZXkgIT0iIil7ICAgICAgICAgICAgCiAgICAgICAgICAgdmFyIHRlbXBCdDsKICAgICAgICAgICB2YXIgeCA9IDA7CiAgICAgICAgICAgdGVtcEJ0ID0gYnQ7ICAgICAgICAgICAgCiAgICAgICAgICAgZm9yKHggPSAwO3ggPCBmaXJzdExlbmd0aCA7eCArKyl7CiAgICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LGZpcnN0S2V5QnRbeF0pOwogICAgICAgICAgIH0KICAgICAgICAgICBlbmNCeXRlID0gdGVtcEJ0OwogICAgICAgICB9CiAgICAgICB9ICAgICAgICAKICAgICB9CiAgICAgZW5jRGF0YSA9IGJ0NjRUb0hleChlbmNCeXRlKTsKICAgfWVsc2V7CiAgICAgdmFyIGl0ZXJhdG9yID0gcGFyc2VJbnQobGVuZy80KTsKICAgICB2YXIgcmVtYWluZGVyID0gbGVuZyU0OwogICAgIHZhciBpPTA7ICAgICAgCiAgICAgZm9yKGkgPSAwO2kgPCBpdGVyYXRvcjtpKyspewogICAgICAgdmFyIHRlbXBEYXRhID0gZGF0YS5zdWJzdHJpbmcoaSo0KzAsaSo0KzQpOwogICAgICAgdmFyIHRlbXBCeXRlID0gc3RyVG9CdCh0ZW1wRGF0YSk7CiAgICAgICB2YXIgZW5jQnl0ZSA7CiAgICAgICBpZihmaXJzdEtleSAhPSBudWxsICYmIGZpcnN0S2V5ICE9IiIgJiYgc2Vjb25kS2V5ICE9IG51bGwgJiYgc2Vjb25kS2V5ICE9ICIiICYmIHRoaXJkS2V5ICE9IG51bGwgJiYgdGhpcmRLZXkgIT0gIiIpewogICAgICAgICB2YXIgdGVtcEJ0OwogICAgICAgICB2YXIgeCx5LHo7CiAgICAgICAgIHRlbXBCdCA9IHRlbXBCeXRlOwogICAgICAgICBmb3IoeCA9IDA7eCA8IGZpcnN0TGVuZ3RoIDt4ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LGZpcnN0S2V5QnRbeF0pOwogICAgICAgICB9CiAgICAgICAgIGZvcih5ID0gMDt5IDwgc2Vjb25kTGVuZ3RoIDt5ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LHNlY29uZEtleUJ0W3ldKTsKICAgICAgICAgfQogICAgICAgICBmb3IoeiA9IDA7eiA8IHRoaXJkTGVuZ3RoIDt6ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LHRoaXJkS2V5QnRbel0pOwogICAgICAgICB9CiAgICAgICAgIGVuY0J5dGUgPSB0ZW1wQnQ7CiAgICAgICB9ZWxzZXsKICAgICAgICAgaWYoZmlyc3RLZXkgIT0gbnVsbCAmJiBmaXJzdEtleSAhPSIiICYmIHNlY29uZEtleSAhPSBudWxsICYmIHNlY29uZEtleSAhPSAiIil7CiAgICAgICAgICAgdmFyIHRlbXBCdDsKICAgICAgICAgICB2YXIgeCx5OwogICAgICAgICAgIHRlbXBCdCA9IHRlbXBCeXRlOwogICAgICAgICAgIGZvcih4ID0gMDt4IDwgZmlyc3RMZW5ndGggO3ggKyspewogICAgICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCxmaXJzdEtleUJ0W3hdKTsKICAgICAgICAgICB9CiAgICAgICAgICAgZm9yKHkgPSAwO3kgPCBzZWNvbmRMZW5ndGggO3kgKyspewogICAgICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCxzZWNvbmRLZXlCdFt5XSk7CiAgICAgICAgICAgfQogICAgICAgICAgIGVuY0J5dGUgPSB0ZW1wQnQ7CiAgICAgICAgIH1lbHNlewogICAgICAgICAgIGlmKGZpcnN0S2V5ICE9IG51bGwgJiYgZmlyc3RLZXkgIT0iIil7ICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgdmFyIHRlbXBCdDsKICAgICAgICAgICAgIHZhciB4OwogICAgICAgICAgICAgdGVtcEJ0ID0gdGVtcEJ5dGU7CiAgICAgICAgICAgICBmb3IoeCA9IDA7eCA8IGZpcnN0TGVuZ3RoIDt4ICsrKXsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgIHRlbXBCdCA9IGVuYyh0ZW1wQnQsZmlyc3RLZXlCdFt4XSk7CiAgICAgICAgICAgICB9CiAgICAgICAgICAgICBlbmNCeXRlID0gdGVtcEJ0OyAgICAgICAgICAgICAgCiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9CiAgICAgICBlbmNEYXRhICs9IGJ0NjRUb0hleChlbmNCeXRlKTsKICAgICB9ICAgICAgCiAgICAgaWYocmVtYWluZGVyID4gMCl7CiAgICAgICB2YXIgcmVtYWluZGVyRGF0YSA9IGRhdGEuc3Vic3RyaW5nKGl0ZXJhdG9yKjQrMCxsZW5nKTsKICAgICAgIHZhciB0ZW1wQnl0ZSA9IHN0clRvQnQocmVtYWluZGVyRGF0YSk7CiAgICAgICB2YXIgZW5jQnl0ZSA7CiAgICAgICBpZihmaXJzdEtleSAhPSBudWxsICYmIGZpcnN0S2V5ICE9IiIgJiYgc2Vjb25kS2V5ICE9IG51bGwgJiYgc2Vjb25kS2V5ICE9ICIiICYmIHRoaXJkS2V5ICE9IG51bGwgJiYgdGhpcmRLZXkgIT0gIiIpewogICAgICAgICB2YXIgdGVtcEJ0OwogICAgICAgICB2YXIgeCx5LHo7CiAgICAgICAgIHRlbXBCdCA9IHRlbXBCeXRlOwogICAgICAgICBmb3IoeCA9IDA7eCA8IGZpcnN0TGVuZ3RoIDt4ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LGZpcnN0S2V5QnRbeF0pOwogICAgICAgICB9CiAgICAgICAgIGZvcih5ID0gMDt5IDwgc2Vjb25kTGVuZ3RoIDt5ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LHNlY29uZEtleUJ0W3ldKTsKICAgICAgICAgfQogICAgICAgICBmb3IoeiA9IDA7eiA8IHRoaXJkTGVuZ3RoIDt6ICsrKXsKICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LHRoaXJkS2V5QnRbel0pOwogICAgICAgICB9CiAgICAgICAgIGVuY0J5dGUgPSB0ZW1wQnQ7CiAgICAgICB9ZWxzZXsKICAgICAgICAgaWYoZmlyc3RLZXkgIT0gbnVsbCAmJiBmaXJzdEtleSAhPSIiICYmIHNlY29uZEtleSAhPSBudWxsICYmIHNlY29uZEtleSAhPSAiIil7CiAgICAgICAgICAgdmFyIHRlbXBCdDsKICAgICAgICAgICB2YXIgeCx5OwogICAgICAgICAgIHRlbXBCdCA9IHRlbXBCeXRlOwogICAgICAgICAgIGZvcih4ID0gMDt4IDwgZmlyc3RMZW5ndGggO3ggKyspewogICAgICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCxmaXJzdEtleUJ0W3hdKTsKICAgICAgICAgICB9CiAgICAgICAgICAgZm9yKHkgPSAwO3kgPCBzZWNvbmRMZW5ndGggO3kgKyspewogICAgICAgICAgICAgdGVtcEJ0ID0gZW5jKHRlbXBCdCxzZWNvbmRLZXlCdFt5XSk7CiAgICAgICAgICAgfQogICAgICAgICAgIGVuY0J5dGUgPSB0ZW1wQnQ7CiAgICAgICAgIH1lbHNlewogICAgICAgICAgIGlmKGZpcnN0S2V5ICE9IG51bGwgJiYgZmlyc3RLZXkgIT0iIil7ICAgICAgICAgICAgCiAgICAgICAgICAgICB2YXIgdGVtcEJ0OwogICAgICAgICAgICAgdmFyIHg7CiAgICAgICAgICAgICB0ZW1wQnQgPSB0ZW1wQnl0ZTsKICAgICAgICAgICAgIGZvcih4ID0gMDt4IDwgZmlyc3RMZW5ndGggO3ggKyspewogICAgICAgICAgICAgICB0ZW1wQnQgPSBlbmModGVtcEJ0LGZpcnN0S2V5QnRbeF0pOwogICAgICAgICAgICAgfQogICAgICAgICAgICAgZW5jQnl0ZSA9IHRlbXBCdDsKICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICAgIGVuY0RhdGEgKz0gYnQ2NFRvSGV4KGVuY0J5dGUpOwogICAgIH0gICAgICAgICAgICAgICAgCiAgIH0KIH0KIHJldHVybiBlbmNEYXRhOwp9CgovKgoqIGNoYW5nIHRoZSBzdHJpbmcgaW50byB0aGUgYml0IGFycmF5CiogCiogcmV0dXJuIGJpdCBhcnJheShpdCdzIGxlbmd0aCAlIDY0ID0gMCkKKi8KZnVuY3Rpb24gZ2V0S2V5Qnl0ZXMoa2V5KXsKIHZhciBrZXlCeXRlcyA9IG5ldyBBcnJheSgpOwogdmFyIGxlbmcgPSBrZXkubGVuZ3RoOwogdmFyIGl0ZXJhdG9yID0gcGFyc2VJbnQobGVuZy80KTsKIHZhciByZW1haW5kZXIgPSBsZW5nJTQ7CiB2YXIgaSA9IDA7CiBmb3IoaSA9IDA7aSA8IGl0ZXJhdG9yOyBpICsrKXsKICAga2V5Qnl0ZXNbaV0gPSBzdHJUb0J0KGtleS5zdWJzdHJpbmcoaSo0KzAsaSo0KzQpKTsKIH0KIGlmKHJlbWFpbmRlciA+IDApewogICBrZXlCeXRlc1tpXSA9IHN0clRvQnQoa2V5LnN1YnN0cmluZyhpKjQrMCxsZW5nKSk7CiB9ICAgIAogcmV0dXJuIGtleUJ5dGVzOwp9CgovKgoqIGNoYW5nIHRoZSBzdHJpbmcoaXQncyBsZW5ndGggPD0gNCkgaW50byB0aGUgYml0IGFycmF5CiogCiogcmV0dXJuIGJpdCBhcnJheShpdCdzIGxlbmd0aCA9IDY0KQoqLwpmdW5jdGlvbiBzdHJUb0J0KHN0cil7ICAKIHZhciBsZW5nID0gc3RyLmxlbmd0aDsKIHZhciBidCA9IG5ldyBBcnJheSg2NCk7CiBpZihsZW5nIDwgNCl7CiAgIHZhciBpPTAsaj0wLHA9MCxxPTA7CiAgIGZvcihpID0gMDtpPGxlbmc7aSsrKXsKICAgICB2YXIgayA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgIGZvcihqPTA7ajwxNjtqKyspeyAgICAgIAogICAgICAgdmFyIHBvdz0xLG09MDsKICAgICAgIGZvcihtPTE1O20+ajttLS0pewogICAgICAgICBwb3cgKj0gMjsKICAgICAgIH0gICAgICAgIAogICAgICAgYnRbMTYqaStqXT1wYXJzZUludChrL3BvdyklMjsKICAgICB9CiAgIH0KICAgZm9yKHAgPSBsZW5nO3A8NDtwKyspewogICAgIHZhciBrID0gMDsKICAgICBmb3IocT0wO3E8MTY7cSsrKXsgICAgICAKICAgICAgIHZhciBwb3c9MSxtPTA7CiAgICAgICBmb3IobT0xNTttPnE7bS0tKXsKICAgICAgICAgcG93ICo9IDI7CiAgICAgICB9ICAgICAgICAKICAgICAgIGJ0WzE2KnArcV09cGFyc2VJbnQoay9wb3cpJTI7CiAgICAgfQogICB9ICAKIH1lbHNlewogICBmb3IoaSA9IDA7aTw0O2krKyl7CiAgICAgdmFyIGsgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICBmb3Ioaj0wO2o8MTY7aisrKXsgICAgICAKICAgICAgIHZhciBwb3c9MTsKICAgICAgIGZvcihtPTE1O20+ajttLS0pewogICAgICAgICBwb3cgKj0gMjsKICAgICAgIH0gICAgICAgIAogICAgICAgYnRbMTYqaStqXT1wYXJzZUludChrL3BvdyklMjsKICAgICB9CiAgIH0gIAogfQogcmV0dXJuIGJ0Owp9CgovKgoqIGNoYW5nIHRoZSBiaXQoaXQncyBsZW5ndGggPSA0KSBpbnRvIHRoZSBoZXgKKiAKKiByZXR1cm4gaGV4CiovCmZ1bmN0aW9uIGJ0NFRvSGV4KGJpbmFyeSkgewogdmFyIGhleDsKIHN3aXRjaCAoYmluYXJ5KSB7CiAgIGNhc2UgIjAwMDAiIDogaGV4ID0gIjAiOyBicmVhazsKICAgY2FzZSAiMDAwMSIgOiBoZXggPSAiMSI7IGJyZWFrOwogICBjYXNlICIwMDEwIiA6IGhleCA9ICIyIjsgYnJlYWs7CiAgIGNhc2UgIjAwMTEiIDogaGV4ID0gIjMiOyBicmVhazsKICAgY2FzZSAiMDEwMCIgOiBoZXggPSAiNCI7IGJyZWFrOwogICBjYXNlICIwMTAxIiA6IGhleCA9ICI1IjsgYnJlYWs7CiAgIGNhc2UgIjAxMTAiIDogaGV4ID0gIjYiOyBicmVhazsKICAgY2FzZSAiMDExMSIgOiBoZXggPSAiNyI7IGJyZWFrOwogICBjYXNlICIxMDAwIiA6IGhleCA9ICI4IjsgYnJlYWs7CiAgIGNhc2UgIjEwMDEiIDogaGV4ID0gIjkiOyBicmVhazsKICAgY2FzZSAiMTAxMCIgOiBoZXggPSAiQSI7IGJyZWFrOwogICBjYXNlICIxMDExIiA6IGhleCA9ICJCIjsgYnJlYWs7CiAgIGNhc2UgIjExMDAiIDogaGV4ID0gIkMiOyBicmVhazsKICAgY2FzZSAiMTEwMSIgOiBoZXggPSAiRCI7IGJyZWFrOwogICBjYXNlICIxMTEwIiA6IGhleCA9ICJFIjsgYnJlYWs7CiAgIGNhc2UgIjExMTEiIDogaGV4ID0gIkYiOyBicmVhazsKIH0KIHJldHVybiBoZXg7Cn0KCi8qCiogY2hhbmcgdGhlIGhleCBpbnRvIHRoZSBiaXQoaXQncyBsZW5ndGggPSA0KQoqIAoqIHJldHVybiB0aGUgYml0KGl0J3MgbGVuZ3RoID0gNCkKKi8KZnVuY3Rpb24gaGV4VG9CdDQoaGV4KSB7CiB2YXIgYmluYXJ5Owogc3dpdGNoIChoZXgpIHsKICAgY2FzZSAiMCIgOiBiaW5hcnkgPSAiMDAwMCI7IGJyZWFrOwogICBjYXNlICIxIiA6IGJpbmFyeSA9ICIwMDAxIjsgYnJlYWs7CiAgIGNhc2UgIjIiIDogYmluYXJ5ID0gIjAwMTAiOyBicmVhazsKICAgY2FzZSAiMyIgOiBiaW5hcnkgPSAiMDAxMSI7IGJyZWFrOwogICBjYXNlICI0IiA6IGJpbmFyeSA9ICIwMTAwIjsgYnJlYWs7CiAgIGNhc2UgIjUiIDogYmluYXJ5ID0gIjAxMDEiOyBicmVhazsKICAgY2FzZSAiNiIgOiBiaW5hcnkgPSAiMDExMCI7IGJyZWFrOwogICBjYXNlICI3IiA6IGJpbmFyeSA9ICIwMTExIjsgYnJlYWs7CiAgIGNhc2UgIjgiIDogYmluYXJ5ID0gIjEwMDAiOyBicmVhazsKICAgY2FzZSAiOSIgOiBiaW5hcnkgPSAiMTAwMSI7IGJyZWFrOwogICBjYXNlICJBIiA6IGJpbmFyeSA9ICIxMDEwIjsgYnJlYWs7CiAgIGNhc2UgIkIiIDogYmluYXJ5ID0gIjEwMTEiOyBicmVhazsKICAgY2FzZSAiQyIgOiBiaW5hcnkgPSAiMTEwMCI7IGJyZWFrOwogICBjYXNlICJEIiA6IGJpbmFyeSA9ICIxMTAxIjsgYnJlYWs7CiAgIGNhc2UgIkUiIDogYmluYXJ5ID0gIjExMTAiOyBicmVhazsKICAgY2FzZSAiRiIgOiBiaW5hcnkgPSAiMTExMSI7IGJyZWFrOwogfQogcmV0dXJuIGJpbmFyeTsKfQoKLyoKKiBjaGFuZyB0aGUgYml0KGl0J3MgbGVuZ3RoID0gNjQpIGludG8gdGhlIHN0cmluZwoqIAoqIHJldHVybiBzdHJpbmcKKi8KZnVuY3Rpb24gYnl0ZVRvU3RyaW5nKGJ5dGVEYXRhKXsKIHZhciBzdHI9IiI7CiBmb3IoaSA9IDA7aTw0O2krKyl7CiAgIHZhciBjb3VudD0wOwogICBmb3Ioaj0wO2o8MTY7aisrKXsgICAgICAgIAogICAgIHZhciBwb3c9MTsKICAgICBmb3IobT0xNTttPmo7bS0tKXsKICAgICAgIHBvdyo9MjsKICAgICB9ICAgICAgICAgICAgICAKICAgICBjb3VudCs9Ynl0ZURhdGFbMTYqaStqXSpwb3c7CiAgIH0gICAgICAgIAogICBpZihjb3VudCAhPSAwKXsKICAgICBzdHIrPVN0cmluZy5mcm9tQ2hhckNvZGUoY291bnQpOwogICB9CiB9CiByZXR1cm4gc3RyOwp9CgpmdW5jdGlvbiBidDY0VG9IZXgoYnl0ZURhdGEpewogdmFyIGhleCA9ICIiOwogZm9yKGkgPSAwO2k8MTY7aSsrKXsKICAgdmFyIGJ0ID0gIiI7CiAgIGZvcihqPTA7ajw0O2orKyl7ICAgIAogICAgIGJ0ICs9IGJ5dGVEYXRhW2kqNCtqXTsKICAgfSAgICAKICAgaGV4Kz1idDRUb0hleChidCk7CiB9CiByZXR1cm4gaGV4Owp9CgpmdW5jdGlvbiBoZXhUb0J0NjQoaGV4KXsKIHZhciBiaW5hcnkgPSAiIjsKIGZvcihpID0gMDtpPDE2O2krKyl7CiAgIGJpbmFyeSs9aGV4VG9CdDQoaGV4LnN1YnN0cmluZyhpLGkrMSkpOwogfQogcmV0dXJuIGJpbmFyeTsKfQoKLyoKKiB0aGUgNjQgYml0IGRlcyBjb3JlIGFyaXRobWV0aWMKKi8KCmZ1bmN0aW9uIGVuYyhkYXRhQnl0ZSxrZXlCeXRlKXsgIAogdmFyIGtleXMgPSBnZW5lcmF0ZUtleXMoa2V5Qnl0ZSk7ICAgIAogdmFyIGlwQnl0ZSAgID0gaW5pdFBlcm11dGUoZGF0YUJ5dGUpOyAgCiB2YXIgaXBMZWZ0ICAgPSBuZXcgQXJyYXkoMzIpOwogdmFyIGlwUmlnaHQgID0gbmV3IEFycmF5KDMyKTsKIHZhciB0ZW1wTGVmdCA9IG5ldyBBcnJheSgzMik7CiB2YXIgaSA9IDAsaiA9IDAsayA9IDAsbSA9IDAsIG4gPSAwOwogZm9yKGsgPSAwO2sgPCAzMjtrICsrKXsKICAgaXBMZWZ0W2tdID0gaXBCeXRlW2tdOwogICBpcFJpZ2h0W2tdID0gaXBCeXRlWzMyK2tdOwogfSAgICAKIGZvcihpID0gMDtpIDwgMTY7aSArKyl7CiAgIGZvcihqID0gMDtqIDwgMzI7aiArKyl7CiAgICAgdGVtcExlZnRbal0gPSBpcExlZnRbal07CiAgICAgaXBMZWZ0W2pdID0gaXBSaWdodFtqXTsgICAgICAKICAgfSAgCiAgIHZhciBrZXkgPSBuZXcgQXJyYXkoNDgpOwogICBmb3IobSA9IDA7bSA8IDQ4O20gKyspewogICAgIGtleVttXSA9IGtleXNbaV1bbV07CiAgIH0KICAgdmFyICB0ZW1wUmlnaHQgPSB4b3IocFBlcm11dGUoc0JveFBlcm11dGUoeG9yKGV4cGFuZFBlcm11dGUoaXBSaWdodCksa2V5KSkpLCB0ZW1wTGVmdCk7ICAgICAgCiAgIGZvcihuID0gMDtuIDwgMzI7biArKyl7CiAgICAgaXBSaWdodFtuXSA9IHRlbXBSaWdodFtuXTsKICAgfSAgCiAgIAogfSAgCiAKIAogdmFyIGZpbmFsRGF0YSA9bmV3IEFycmF5KDY0KTsKIGZvcihpID0gMDtpIDwgMzI7aSArKyl7CiAgIGZpbmFsRGF0YVtpXSA9IGlwUmlnaHRbaV07CiAgIGZpbmFsRGF0YVszMitpXSA9IGlwTGVmdFtpXTsKIH0KIHJldHVybiBmaW5hbGx5UGVybXV0ZShmaW5hbERhdGEpOyAgCn0KCmZ1bmN0aW9uIGRlYyhkYXRhQnl0ZSxrZXlCeXRlKXsgIAogdmFyIGtleXMgPSBnZW5lcmF0ZUtleXMoa2V5Qnl0ZSk7ICAgIAogdmFyIGlwQnl0ZSAgID0gaW5pdFBlcm11dGUoZGF0YUJ5dGUpOyAgCiB2YXIgaXBMZWZ0ICAgPSBuZXcgQXJyYXkoMzIpOwogdmFyIGlwUmlnaHQgID0gbmV3IEFycmF5KDMyKTsKIHZhciB0ZW1wTGVmdCA9IG5ldyBBcnJheSgzMik7CiB2YXIgaSA9IDAsaiA9IDAsayA9IDAsbSA9IDAsIG4gPSAwOwogZm9yKGsgPSAwO2sgPCAzMjtrICsrKXsKICAgaXBMZWZ0W2tdID0gaXBCeXRlW2tdOwogICBpcFJpZ2h0W2tdID0gaXBCeXRlWzMyK2tdOwogfSAgCiBmb3IoaSA9IDE1O2kgPj0gMDtpIC0tKXsKICAgZm9yKGogPSAwO2ogPCAzMjtqICsrKXsKICAgICB0ZW1wTGVmdFtqXSA9IGlwTGVmdFtqXTsKICAgICBpcExlZnRbal0gPSBpcFJpZ2h0W2pdOyAgICAgIAogICB9ICAKICAgdmFyIGtleSA9IG5ldyBBcnJheSg0OCk7CiAgIGZvcihtID0gMDttIDwgNDg7bSArKyl7CiAgICAga2V5W21dID0ga2V5c1tpXVttXTsKICAgfQogICAKICAgdmFyICB0ZW1wUmlnaHQgPSB4b3IocFBlcm11dGUoc0JveFBlcm11dGUoeG9yKGV4cGFuZFBlcm11dGUoaXBSaWdodCksa2V5KSkpLCB0ZW1wTGVmdCk7ICAgICAgCiAgIGZvcihuID0gMDtuIDwgMzI7biArKyl7CiAgICAgaXBSaWdodFtuXSA9IHRlbXBSaWdodFtuXTsKICAgfSAgCiB9ICAKIAogCiB2YXIgZmluYWxEYXRhID1uZXcgQXJyYXkoNjQpOwogZm9yKGkgPSAwO2kgPCAzMjtpICsrKXsKICAgZmluYWxEYXRhW2ldID0gaXBSaWdodFtpXTsKICAgZmluYWxEYXRhWzMyK2ldID0gaXBMZWZ0W2ldOwogfQogcmV0dXJuIGZpbmFsbHlQZXJtdXRlKGZpbmFsRGF0YSk7ICAKfQoKZnVuY3Rpb24gaW5pdFBlcm11dGUob3JpZ2luYWxEYXRhKXsKIHZhciBpcEJ5dGUgPSBuZXcgQXJyYXkoNjQpOwogZm9yIChpID0gMCwgbSA9IDEsIG4gPSAwOyBpIDwgNDsgaSsrLCBtICs9IDIsIG4gKz0gMikgewogICBmb3IgKGogPSA3LCBrID0gMDsgaiA+PSAwOyBqLS0sIGsrKykgewogICAgIGlwQnl0ZVtpICogOCArIGtdID0gb3JpZ2luYWxEYXRhW2ogKiA4ICsgbV07CiAgICAgaXBCeXRlW2kgKiA4ICsgayArIDMyXSA9IG9yaWdpbmFsRGF0YVtqICogOCArIG5dOwogICB9CiB9ICAgIAogcmV0dXJuIGlwQnl0ZTsKfQoKZnVuY3Rpb24gZXhwYW5kUGVybXV0ZShyaWdodERhdGEpeyAgCiB2YXIgZXBCeXRlID0gbmV3IEFycmF5KDQ4KTsKIGZvciAoaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgaWYgKGkgPT0gMCkgewogICAgIGVwQnl0ZVtpICogNiArIDBdID0gcmlnaHREYXRhWzMxXTsKICAgfSBlbHNlIHsKICAgICBlcEJ5dGVbaSAqIDYgKyAwXSA9IHJpZ2h0RGF0YVtpICogNCAtIDFdOwogICB9CiAgIGVwQnl0ZVtpICogNiArIDFdID0gcmlnaHREYXRhW2kgKiA0ICsgMF07CiAgIGVwQnl0ZVtpICogNiArIDJdID0gcmlnaHREYXRhW2kgKiA0ICsgMV07CiAgIGVwQnl0ZVtpICogNiArIDNdID0gcmlnaHREYXRhW2kgKiA0ICsgMl07CiAgIGVwQnl0ZVtpICogNiArIDRdID0gcmlnaHREYXRhW2kgKiA0ICsgM107CiAgIGlmIChpID09IDcpIHsKICAgICBlcEJ5dGVbaSAqIDYgKyA1XSA9IHJpZ2h0RGF0YVswXTsKICAgfSBlbHNlIHsKICAgICBlcEJ5dGVbaSAqIDYgKyA1XSA9IHJpZ2h0RGF0YVtpICogNCArIDRdOwogICB9CiB9ICAgICAgCiByZXR1cm4gZXBCeXRlOwp9CgpmdW5jdGlvbiB4b3IoYnl0ZU9uZSxieXRlVHdvKXsgIAogdmFyIHhvckJ5dGUgPSBuZXcgQXJyYXkoYnl0ZU9uZS5sZW5ndGgpOwogZm9yKGkgPSAwO2kgPCBieXRlT25lLmxlbmd0aDsgaSArKyl7ICAgICAgCiAgIHhvckJ5dGVbaV0gPSBieXRlT25lW2ldIF4gYnl0ZVR3b1tpXTsKIH0gIAogcmV0dXJuIHhvckJ5dGU7Cn0KCmZ1bmN0aW9uIHNCb3hQZXJtdXRlKGV4cGFuZEJ5dGUpewogCiAgIHZhciBzQm94Qnl0ZSA9IG5ldyBBcnJheSgzMik7CiAgIHZhciBiaW5hcnkgPSAiIjsKICAgdmFyIHMxID0gWwogICAgICAgWzE0LCA0LCAxMywgMSwgMiwgMTUsIDExLCA4LCAzLCAxMCwgNiwgMTIsIDUsIDksIDAsIDddLAogICAgICAgWzAsIDE1LCA3LCA0LCAxNCwgMiwgMTMsIDEsIDEwLCA2LCAxMiwgMTEsIDksIDUsIDMsIDhdLAogICAgICAgWzQsIDEsIDE0LCA4LCAxMywgNiwgMiwgMTEsIDE1LCAxMiwgOSwgNywgMywgMTAsIDUsIDBdLAogICAgICAgWzE1LCAxMiwgOCwgMiwgNCwgOSwgMSwgNywgNSwgMTEsIDMsIDE0LCAxMCwgMCwgNiwgMTMgXV07CgogICAgICAgLyogVGFibGUgLSBzMiAqLwogICB2YXIgczIgPSBbCiAgICAgICBbMTUsIDEsIDgsIDE0LCA2LCAxMSwgMywgNCwgOSwgNywgMiwgMTMsIDEyLCAwLCA1LCAxMF0sCiAgICAgICBbMywgMTMsIDQsIDcsIDE1LCAyLCA4LCAxNCwgMTIsIDAsIDEsIDEwLCA2LCA5LCAxMSwgNV0sCiAgICAgICBbMCwgMTQsIDcsIDExLCAxMCwgNCwgMTMsIDEsIDUsIDgsIDEyLCA2LCA5LCAzLCAyLCAxNV0sCiAgICAgICBbMTMsIDgsIDEwLCAxLCAzLCAxNSwgNCwgMiwgMTEsIDYsIDcsIDEyLCAwLCA1LCAxNCwgOSBdXTsKCiAgICAgICAvKiBUYWJsZSAtIHMzICovCiAgIHZhciBzMz0gWwogICAgICAgWzEwLCAwLCA5LCAxNCwgNiwgMywgMTUsIDUsIDEsIDEzLCAxMiwgNywgMTEsIDQsIDIsIDhdLAogICAgICAgWzEzLCA3LCAwLCA5LCAzLCA0LCA2LCAxMCwgMiwgOCwgNSwgMTQsIDEyLCAxMSwgMTUsIDFdLAogICAgICAgWzEzLCA2LCA0LCA5LCA4LCAxNSwgMywgMCwgMTEsIDEsIDIsIDEyLCA1LCAxMCwgMTQsIDddLAogICAgICAgWzEsIDEwLCAxMywgMCwgNiwgOSwgOCwgNywgNCwgMTUsIDE0LCAzLCAxMSwgNSwgMiwgMTIgXV07CiAgICAgICAvKiBUYWJsZSAtIHM0ICovCiAgIHZhciBzNCA9IFsKICAgICAgIFs3LCAxMywgMTQsIDMsIDAsIDYsIDksIDEwLCAxLCAyLCA4LCA1LCAxMSwgMTIsIDQsIDE1XSwKICAgICAgIFsxMywgOCwgMTEsIDUsIDYsIDE1LCAwLCAzLCA0LCA3LCAyLCAxMiwgMSwgMTAsIDE0LCA5XSwKICAgICAgIFsxMCwgNiwgOSwgMCwgMTIsIDExLCA3LCAxMywgMTUsIDEsIDMsIDE0LCA1LCAyLCA4LCA0XSwKICAgICAgIFszLCAxNSwgMCwgNiwgMTAsIDEsIDEzLCA4LCA5LCA0LCA1LCAxMSwgMTIsIDcsIDIsIDE0IF1dOwoKICAgICAgIC8qIFRhYmxlIC0gczUgKi8KICAgdmFyIHM1ID0gWwogICAgICAgWzIsIDEyLCA0LCAxLCA3LCAxMCwgMTEsIDYsIDgsIDUsIDMsIDE1LCAxMywgMCwgMTQsIDldLAogICAgICAgWzE0LCAxMSwgMiwgMTIsIDQsIDcsIDEzLCAxLCA1LCAwLCAxNSwgMTAsIDMsIDksIDgsIDZdLAogICAgICAgWzQsIDIsIDEsIDExLCAxMCwgMTMsIDcsIDgsIDE1LCA5LCAxMiwgNSwgNiwgMywgMCwgMTRdLAogICAgICAgWzExLCA4LCAxMiwgNywgMSwgMTQsIDIsIDEzLCA2LCAxNSwgMCwgOSwgMTAsIDQsIDUsIDMgXV07CgogICAgICAgLyogVGFibGUgLSBzNiAqLwogICB2YXIgczYgPSBbCiAgICAgICBbMTIsIDEsIDEwLCAxNSwgOSwgMiwgNiwgOCwgMCwgMTMsIDMsIDQsIDE0LCA3LCA1LCAxMV0sCiAgICAgICBbMTAsIDE1LCA0LCAyLCA3LCAxMiwgOSwgNSwgNiwgMSwgMTMsIDE0LCAwLCAxMSwgMywgOF0sCiAgICAgICBbOSwgMTQsIDE1LCA1LCAyLCA4LCAxMiwgMywgNywgMCwgNCwgMTAsIDEsIDEzLCAxMSwgNl0sCiAgICAgICBbNCwgMywgMiwgMTIsIDksIDUsIDE1LCAxMCwgMTEsIDE0LCAxLCA3LCA2LCAwLCA4LCAxMyBdXTsKCiAgICAgICAvKiBUYWJsZSAtIHM3ICovCiAgIHZhciBzNyA9IFsKICAgICAgIFs0LCAxMSwgMiwgMTQsIDE1LCAwLCA4LCAxMywgMywgMTIsIDksIDcsIDUsIDEwLCA2LCAxXSwKICAgICAgIFsxMywgMCwgMTEsIDcsIDQsIDksIDEsIDEwLCAxNCwgMywgNSwgMTIsIDIsIDE1LCA4LCA2XSwKICAgICAgIFsxLCA0LCAxMSwgMTMsIDEyLCAzLCA3LCAxNCwgMTAsIDE1LCA2LCA4LCAwLCA1LCA5LCAyXSwKICAgICAgIFs2LCAxMSwgMTMsIDgsIDEsIDQsIDEwLCA3LCA5LCA1LCAwLCAxNSwgMTQsIDIsIDMsIDEyXV07CgogICAgICAgLyogVGFibGUgLSBzOCAqLwogICB2YXIgczggPSBbCiAgICAgICBbMTMsIDIsIDgsIDQsIDYsIDE1LCAxMSwgMSwgMTAsIDksIDMsIDE0LCA1LCAwLCAxMiwgN10sCiAgICAgICBbMSwgMTUsIDEzLCA4LCAxMCwgMywgNywgNCwgMTIsIDUsIDYsIDExLCAwLCAxNCwgOSwgMl0sCiAgICAgICBbNywgMTEsIDQsIDEsIDksIDEyLCAxNCwgMiwgMCwgNiwgMTAsIDEzLCAxNSwgMywgNSwgOF0sCiAgICAgICBbMiwgMSwgMTQsIDcsIDQsIDEwLCA4LCAxMywgMTUsIDEyLCA5LCAwLCAzLCA1LCA2LCAxMV1dOwogICAKICAgZm9yKG09MDttPDg7bSsrKXsKICAgdmFyIGk9MCxqPTA7CiAgIGkgPSBleHBhbmRCeXRlW20qNiswXSoyK2V4cGFuZEJ5dGVbbSo2KzVdOwogICBqID0gZXhwYW5kQnl0ZVttICogNiArIDFdICogMiAqIDIgKiAyIAogICAgICsgZXhwYW5kQnl0ZVttICogNiArIDJdICogMiogMiAKICAgICArIGV4cGFuZEJ5dGVbbSAqIDYgKyAzXSAqIDIgCiAgICAgKyBleHBhbmRCeXRlW20gKiA2ICsgNF07CiAgIHN3aXRjaCAobSkgewogICAgIGNhc2UgMCA6CiAgICAgICBiaW5hcnkgPSBnZXRCb3hCaW5hcnkoczFbaV1bal0pOwogICAgICAgYnJlYWs7CiAgICAgY2FzZSAxIDoKICAgICAgIGJpbmFyeSA9IGdldEJveEJpbmFyeShzMltpXVtqXSk7CiAgICAgICBicmVhazsKICAgICBjYXNlIDIgOgogICAgICAgYmluYXJ5ID0gZ2V0Qm94QmluYXJ5KHMzW2ldW2pdKTsKICAgICAgIGJyZWFrOwogICAgIGNhc2UgMyA6CiAgICAgICBiaW5hcnkgPSBnZXRCb3hCaW5hcnkoczRbaV1bal0pOwogICAgICAgYnJlYWs7CiAgICAgY2FzZSA0IDoKICAgICAgIGJpbmFyeSA9IGdldEJveEJpbmFyeShzNVtpXVtqXSk7CiAgICAgICBicmVhazsKICAgICBjYXNlIDUgOgogICAgICAgYmluYXJ5ID0gZ2V0Qm94QmluYXJ5KHM2W2ldW2pdKTsKICAgICAgIGJyZWFrOwogICAgIGNhc2UgNiA6CiAgICAgICBiaW5hcnkgPSBnZXRCb3hCaW5hcnkoczdbaV1bal0pOwogICAgICAgYnJlYWs7CiAgICAgY2FzZSA3IDoKICAgICAgIGJpbmFyeSA9IGdldEJveEJpbmFyeShzOFtpXVtqXSk7CiAgICAgICBicmVhazsKICAgfSAgICAgIAogICBzQm94Qnl0ZVttKjQrMF0gPSBwYXJzZUludChiaW5hcnkuc3Vic3RyaW5nKDAsMSkpOwogICBzQm94Qnl0ZVttKjQrMV0gPSBwYXJzZUludChiaW5hcnkuc3Vic3RyaW5nKDEsMikpOwogICBzQm94Qnl0ZVttKjQrMl0gPSBwYXJzZUludChiaW5hcnkuc3Vic3RyaW5nKDIsMykpOwogICBzQm94Qnl0ZVttKjQrM10gPSBwYXJzZUludChiaW5hcnkuc3Vic3RyaW5nKDMsNCkpOwogfQogcmV0dXJuIHNCb3hCeXRlOwp9CgpmdW5jdGlvbiBwUGVybXV0ZShzQm94Qnl0ZSl7CiB2YXIgcEJveFBlcm11dGUgPSBuZXcgQXJyYXkoMzIpOwogcEJveFBlcm11dGVbIDBdID0gc0JveEJ5dGVbMTVdOyAKIHBCb3hQZXJtdXRlWyAxXSA9IHNCb3hCeXRlWyA2XTsgCiBwQm94UGVybXV0ZVsgMl0gPSBzQm94Qnl0ZVsxOV07IAogcEJveFBlcm11dGVbIDNdID0gc0JveEJ5dGVbMjBdOyAKIHBCb3hQZXJtdXRlWyA0XSA9IHNCb3hCeXRlWzI4XTsgCiBwQm94UGVybXV0ZVsgNV0gPSBzQm94Qnl0ZVsxMV07IAogcEJveFBlcm11dGVbIDZdID0gc0JveEJ5dGVbMjddOyAKIHBCb3hQZXJtdXRlWyA3XSA9IHNCb3hCeXRlWzE2XTsgCiBwQm94UGVybXV0ZVsgOF0gPSBzQm94Qnl0ZVsgMF07IAogcEJveFBlcm11dGVbIDldID0gc0JveEJ5dGVbMTRdOyAKIHBCb3hQZXJtdXRlWzEwXSA9IHNCb3hCeXRlWzIyXTsgCiBwQm94UGVybXV0ZVsxMV0gPSBzQm94Qnl0ZVsyNV07IAogcEJveFBlcm11dGVbMTJdID0gc0JveEJ5dGVbIDRdOyAKIHBCb3hQZXJtdXRlWzEzXSA9IHNCb3hCeXRlWzE3XTsgCiBwQm94UGVybXV0ZVsxNF0gPSBzQm94Qnl0ZVszMF07IAogcEJveFBlcm11dGVbMTVdID0gc0JveEJ5dGVbIDldOyAKIHBCb3hQZXJtdXRlWzE2XSA9IHNCb3hCeXRlWyAxXTsgCiBwQm94UGVybXV0ZVsxN10gPSBzQm94Qnl0ZVsgN107IAogcEJveFBlcm11dGVbMThdID0gc0JveEJ5dGVbMjNdOyAKIHBCb3hQZXJtdXRlWzE5XSA9IHNCb3hCeXRlWzEzXTsgCiBwQm94UGVybXV0ZVsyMF0gPSBzQm94Qnl0ZVszMV07IAogcEJveFBlcm11dGVbMjFdID0gc0JveEJ5dGVbMjZdOyAKIHBCb3hQZXJtdXRlWzIyXSA9IHNCb3hCeXRlWyAyXTsgCiBwQm94UGVybXV0ZVsyM10gPSBzQm94Qnl0ZVsgOF07IAogcEJveFBlcm11dGVbMjRdID0gc0JveEJ5dGVbMThdOyAKIHBCb3hQZXJtdXRlWzI1XSA9IHNCb3hCeXRlWzEyXTsgCiBwQm94UGVybXV0ZVsyNl0gPSBzQm94Qnl0ZVsyOV07IAogcEJveFBlcm11dGVbMjddID0gc0JveEJ5dGVbIDVdOyAKIHBCb3hQZXJtdXRlWzI4XSA9IHNCb3hCeXRlWzIxXTsgCiBwQm94UGVybXV0ZVsyOV0gPSBzQm94Qnl0ZVsxMF07IAogcEJveFBlcm11dGVbMzBdID0gc0JveEJ5dGVbIDNdOyAKIHBCb3hQZXJtdXRlWzMxXSA9IHNCb3hCeXRlWzI0XTsgICAgCiByZXR1cm4gcEJveFBlcm11dGU7Cn0KCmZ1bmN0aW9uIGZpbmFsbHlQZXJtdXRlKGVuZEJ5dGUpeyAgICAKIHZhciBmcEJ5dGUgPSBuZXcgQXJyYXkoNjQpOyAgCiBmcEJ5dGVbIDBdID0gZW5kQnl0ZVszOV07IAogZnBCeXRlWyAxXSA9IGVuZEJ5dGVbIDddOyAKIGZwQnl0ZVsgMl0gPSBlbmRCeXRlWzQ3XTsgCiBmcEJ5dGVbIDNdID0gZW5kQnl0ZVsxNV07IAogZnBCeXRlWyA0XSA9IGVuZEJ5dGVbNTVdOyAKIGZwQnl0ZVsgNV0gPSBlbmRCeXRlWzIzXTsgCiBmcEJ5dGVbIDZdID0gZW5kQnl0ZVs2M107IAogZnBCeXRlWyA3XSA9IGVuZEJ5dGVbMzFdOyAKIGZwQnl0ZVsgOF0gPSBlbmRCeXRlWzM4XTsgCiBmcEJ5dGVbIDldID0gZW5kQnl0ZVsgNl07IAogZnBCeXRlWzEwXSA9IGVuZEJ5dGVbNDZdOyAKIGZwQnl0ZVsxMV0gPSBlbmRCeXRlWzE0XTsgCiBmcEJ5dGVbMTJdID0gZW5kQnl0ZVs1NF07IAogZnBCeXRlWzEzXSA9IGVuZEJ5dGVbMjJdOyAKIGZwQnl0ZVsxNF0gPSBlbmRCeXRlWzYyXTsgCiBmcEJ5dGVbMTVdID0gZW5kQnl0ZVszMF07IAogZnBCeXRlWzE2XSA9IGVuZEJ5dGVbMzddOyAKIGZwQnl0ZVsxN10gPSBlbmRCeXRlWyA1XTsgCiBmcEJ5dGVbMThdID0gZW5kQnl0ZVs0NV07IAogZnBCeXRlWzE5XSA9IGVuZEJ5dGVbMTNdOyAKIGZwQnl0ZVsyMF0gPSBlbmRCeXRlWzUzXTsgCiBmcEJ5dGVbMjFdID0gZW5kQnl0ZVsyMV07IAogZnBCeXRlWzIyXSA9IGVuZEJ5dGVbNjFdOyAKIGZwQnl0ZVsyM10gPSBlbmRCeXRlWzI5XTsgCiBmcEJ5dGVbMjRdID0gZW5kQnl0ZVszNl07IAogZnBCeXRlWzI1XSA9IGVuZEJ5dGVbIDRdOyAKIGZwQnl0ZVsyNl0gPSBlbmRCeXRlWzQ0XTsgCiBmcEJ5dGVbMjddID0gZW5kQnl0ZVsxMl07IAogZnBCeXRlWzI4XSA9IGVuZEJ5dGVbNTJdOyAKIGZwQnl0ZVsyOV0gPSBlbmRCeXRlWzIwXTsgCiBmcEJ5dGVbMzBdID0gZW5kQnl0ZVs2MF07IAogZnBCeXRlWzMxXSA9IGVuZEJ5dGVbMjhdOyAKIGZwQnl0ZVszMl0gPSBlbmRCeXRlWzM1XTsgCiBmcEJ5dGVbMzNdID0gZW5kQnl0ZVsgM107IAogZnBCeXRlWzM0XSA9IGVuZEJ5dGVbNDNdOyAKIGZwQnl0ZVszNV0gPSBlbmRCeXRlWzExXTsgCiBmcEJ5dGVbMzZdID0gZW5kQnl0ZVs1MV07IAogZnBCeXRlWzM3XSA9IGVuZEJ5dGVbMTldOyAKIGZwQnl0ZVszOF0gPSBlbmRCeXRlWzU5XTsgCiBmcEJ5dGVbMzldID0gZW5kQnl0ZVsyN107IAogZnBCeXRlWzQwXSA9IGVuZEJ5dGVbMzRdOyAKIGZwQnl0ZVs0MV0gPSBlbmRCeXRlWyAyXTsgCiBmcEJ5dGVbNDJdID0gZW5kQnl0ZVs0Ml07IAogZnBCeXRlWzQzXSA9IGVuZEJ5dGVbMTBdOyAKIGZwQnl0ZVs0NF0gPSBlbmRCeXRlWzUwXTsgCiBmcEJ5dGVbNDVdID0gZW5kQnl0ZVsxOF07IAogZnBCeXRlWzQ2XSA9IGVuZEJ5dGVbNThdOyAKIGZwQnl0ZVs0N10gPSBlbmRCeXRlWzI2XTsgCiBmcEJ5dGVbNDhdID0gZW5kQnl0ZVszM107IAogZnBCeXRlWzQ5XSA9IGVuZEJ5dGVbIDFdOyAKIGZwQnl0ZVs1MF0gPSBlbmRCeXRlWzQxXTsgCiBmcEJ5dGVbNTFdID0gZW5kQnl0ZVsgOV07IAogZnBCeXRlWzUyXSA9IGVuZEJ5dGVbNDldOyAKIGZwQnl0ZVs1M10gPSBlbmRCeXRlWzE3XTsgCiBmcEJ5dGVbNTRdID0gZW5kQnl0ZVs1N107IAogZnBCeXRlWzU1XSA9IGVuZEJ5dGVbMjVdOyAKIGZwQnl0ZVs1Nl0gPSBlbmRCeXRlWzMyXTsgCiBmcEJ5dGVbNTddID0gZW5kQnl0ZVsgMF07IAogZnBCeXRlWzU4XSA9IGVuZEJ5dGVbNDBdOyAKIGZwQnl0ZVs1OV0gPSBlbmRCeXRlWyA4XTsgCiBmcEJ5dGVbNjBdID0gZW5kQnl0ZVs0OF07IAogZnBCeXRlWzYxXSA9IGVuZEJ5dGVbMTZdOyAKIGZwQnl0ZVs2Ml0gPSBlbmRCeXRlWzU2XTsgCiBmcEJ5dGVbNjNdID0gZW5kQnl0ZVsyNF07CiByZXR1cm4gZnBCeXRlOwp9CgpmdW5jdGlvbiBnZXRCb3hCaW5hcnkoaSkgewogdmFyIGJpbmFyeSA9ICIiOwogc3dpdGNoIChpKSB7CiAgIGNhc2UgMCA6YmluYXJ5ID0gIjAwMDAiO2JyZWFrOwogICBjYXNlIDEgOmJpbmFyeSA9ICIwMDAxIjticmVhazsKICAgY2FzZSAyIDpiaW5hcnkgPSAiMDAxMCI7YnJlYWs7CiAgIGNhc2UgMyA6YmluYXJ5ID0gIjAwMTEiO2JyZWFrOwogICBjYXNlIDQgOmJpbmFyeSA9ICIwMTAwIjticmVhazsKICAgY2FzZSA1IDpiaW5hcnkgPSAiMDEwMSI7YnJlYWs7CiAgIGNhc2UgNiA6YmluYXJ5ID0gIjAxMTAiO2JyZWFrOwogICBjYXNlIDcgOmJpbmFyeSA9ICIwMTExIjticmVhazsKICAgY2FzZSA4IDpiaW5hcnkgPSAiMTAwMCI7YnJlYWs7CiAgIGNhc2UgOSA6YmluYXJ5ID0gIjEwMDEiO2JyZWFrOwogICBjYXNlIDEwIDpiaW5hcnkgPSAiMTAxMCI7YnJlYWs7CiAgIGNhc2UgMTEgOmJpbmFyeSA9ICIxMDExIjticmVhazsKICAgY2FzZSAxMiA6YmluYXJ5ID0gIjExMDAiO2JyZWFrOwogICBjYXNlIDEzIDpiaW5hcnkgPSAiMTEwMSI7YnJlYWs7CiAgIGNhc2UgMTQgOmJpbmFyeSA9ICIxMTEwIjticmVhazsKICAgY2FzZSAxNSA6YmluYXJ5ID0gIjExMTEiO2JyZWFrOwogfQogcmV0dXJuIGJpbmFyeTsKfQovKgoqIGdlbmVyYXRlIDE2IGtleXMgZm9yIHhvcgoqCiovCmZ1bmN0aW9uIGdlbmVyYXRlS2V5cyhrZXlCeXRlKXsgICAgCiB2YXIga2V5ICAgPSBuZXcgQXJyYXkoNTYpOwogdmFyIGtleXMgPSBuZXcgQXJyYXkoKTsgIAogCiBrZXlzWyAwXSA9IG5ldyBBcnJheSgpOwoga2V5c1sgMV0gPSBuZXcgQXJyYXkoKTsKIGtleXNbIDJdID0gbmV3IEFycmF5KCk7CiBrZXlzWyAzXSA9IG5ldyBBcnJheSgpOwoga2V5c1sgNF0gPSBuZXcgQXJyYXkoKTsKIGtleXNbIDVdID0gbmV3IEFycmF5KCk7CiBrZXlzWyA2XSA9IG5ldyBBcnJheSgpOwoga2V5c1sgN10gPSBuZXcgQXJyYXkoKTsKIGtleXNbIDhdID0gbmV3IEFycmF5KCk7CiBrZXlzWyA5XSA9IG5ldyBBcnJheSgpOwoga2V5c1sxMF0gPSBuZXcgQXJyYXkoKTsKIGtleXNbMTFdID0gbmV3IEFycmF5KCk7CiBrZXlzWzEyXSA9IG5ldyBBcnJheSgpOwoga2V5c1sxM10gPSBuZXcgQXJyYXkoKTsKIGtleXNbMTRdID0gbmV3IEFycmF5KCk7CiBrZXlzWzE1XSA9IG5ldyBBcnJheSgpOyAgCiB2YXIgbG9vcCA9IFsxLDEsMiwyLDIsMiwyLDIsMSwyLDIsMiwyLDIsMiwxXTsKCiBmb3IoaT0wO2k8NztpKyspewogICBmb3Ioaj0wLGs9NztqPDg7aisrLGstLSl7CiAgICAga2V5W2kqOCtqXT1rZXlCeXRlWzgqaytpXTsKICAgfQogfSAgICAKIAogdmFyIGkgPSAwOwogZm9yKGkgPSAwO2kgPCAxNjtpICsrKXsKICAgdmFyIHRlbXBMZWZ0PTA7CiAgIHZhciB0ZW1wUmlnaHQ9MDsKICAgZm9yKGogPSAwOyBqIDwgbG9vcFtpXTtqICsrKXsgICAgICAgICAgCiAgICAgdGVtcExlZnQgPSBrZXlbMF07CiAgICAgdGVtcFJpZ2h0ID0ga2V5WzI4XTsKICAgICBmb3IoayA9IDA7ayA8IDI3IDtrICsrKXsKICAgICAgIGtleVtrXSA9IGtleVtrKzFdOwogICAgICAga2V5WzI4K2tdID0ga2V5WzI5K2tdOwogICAgIH0gIAogICAgIGtleVsyN109dGVtcExlZnQ7CiAgICAga2V5WzU1XT10ZW1wUmlnaHQ7CiAgIH0KICAgdmFyIHRlbXBLZXkgPSBuZXcgQXJyYXkoNDgpOwogICB0ZW1wS2V5WyAwXSA9IGtleVsxM107CiAgIHRlbXBLZXlbIDFdID0ga2V5WzE2XTsKICAgdGVtcEtleVsgMl0gPSBrZXlbMTBdOwogICB0ZW1wS2V5WyAzXSA9IGtleVsyM107CiAgIHRlbXBLZXlbIDRdID0ga2V5WyAwXTsKICAgdGVtcEtleVsgNV0gPSBrZXlbIDRdOwogICB0ZW1wS2V5WyA2XSA9IGtleVsgMl07CiAgIHRlbXBLZXlbIDddID0ga2V5WzI3XTsKICAgdGVtcEtleVsgOF0gPSBrZXlbMTRdOwogICB0ZW1wS2V5WyA5XSA9IGtleVsgNV07CiAgIHRlbXBLZXlbMTBdID0ga2V5WzIwXTsKICAgdGVtcEtleVsxMV0gPSBrZXlbIDldOwogICB0ZW1wS2V5WzEyXSA9IGtleVsyMl07CiAgIHRlbXBLZXlbMTNdID0ga2V5WzE4XTsKICAgdGVtcEtleVsxNF0gPSBrZXlbMTFdOwogICB0ZW1wS2V5WzE1XSA9IGtleVsgM107CiAgIHRlbXBLZXlbMTZdID0ga2V5WzI1XTsKICAgdGVtcEtleVsxN10gPSBrZXlbIDddOwogICB0ZW1wS2V5WzE4XSA9IGtleVsxNV07CiAgIHRlbXBLZXlbMTldID0ga2V5WyA2XTsKICAgdGVtcEtleVsyMF0gPSBrZXlbMjZdOwogICB0ZW1wS2V5WzIxXSA9IGtleVsxOV07CiAgIHRlbXBLZXlbMjJdID0ga2V5WzEyXTsKICAgdGVtcEtleVsyM10gPSBrZXlbIDFdOwogICB0ZW1wS2V5WzI0XSA9IGtleVs0MF07CiAgIHRlbXBLZXlbMjVdID0ga2V5WzUxXTsKICAgdGVtcEtleVsyNl0gPSBrZXlbMzBdOwogICB0ZW1wS2V5WzI3XSA9IGtleVszNl07CiAgIHRlbXBLZXlbMjhdID0ga2V5WzQ2XTsKICAgdGVtcEtleVsyOV0gPSBrZXlbNTRdOwogICB0ZW1wS2V5WzMwXSA9IGtleVsyOV07CiAgIHRlbXBLZXlbMzFdID0ga2V5WzM5XTsKICAgdGVtcEtleVszMl0gPSBrZXlbNTBdOwogICB0ZW1wS2V5WzMzXSA9IGtleVs0NF07CiAgIHRlbXBLZXlbMzRdID0ga2V5WzMyXTsKICAgdGVtcEtleVszNV0gPSBrZXlbNDddOwogICB0ZW1wS2V5WzM2XSA9IGtleVs0M107CiAgIHRlbXBLZXlbMzddID0ga2V5WzQ4XTsKICAgdGVtcEtleVszOF0gPSBrZXlbMzhdOwogICB0ZW1wS2V5WzM5XSA9IGtleVs1NV07CiAgIHRlbXBLZXlbNDBdID0ga2V5WzMzXTsKICAgdGVtcEtleVs0MV0gPSBrZXlbNTJdOwogICB0ZW1wS2V5WzQyXSA9IGtleVs0NV07CiAgIHRlbXBLZXlbNDNdID0ga2V5WzQxXTsKICAgdGVtcEtleVs0NF0gPSBrZXlbNDldOwogICB0ZW1wS2V5WzQ1XSA9IGtleVszNV07CiAgIHRlbXBLZXlbNDZdID0ga2V5WzI4XTsKICAgdGVtcEtleVs0N10gPSBrZXlbMzFdOwogICBzd2l0Y2goaSl7CiAgICAgY2FzZSAwOiBmb3IobT0wO20gPCA0OCA7bSsrKXsga2V5c1sgMF1bbV0gPSB0ZW1wS2V5W21dOyB9IGJyZWFrOwogICAgIGNhc2UgMTogZm9yKG09MDttIDwgNDggO20rKyl7IGtleXNbIDFdW21dID0gdGVtcEtleVttXTsgfSBicmVhazsKICAgICBjYXNlIDI6IGZvcihtPTA7bSA8IDQ4IDttKyspeyBrZXlzWyAyXVttXSA9IHRlbXBLZXlbbV07IH0gYnJlYWs7CiAgICAgY2FzZSAzOiBmb3IobT0wO20gPCA0OCA7bSsrKXsga2V5c1sgM11bbV0gPSB0ZW1wS2V5W21dOyB9IGJyZWFrOwogICAgIGNhc2UgNDogZm9yKG09MDttIDwgNDggO20rKyl7IGtleXNbIDRdW21dID0gdGVtcEtleVttXTsgfSBicmVhazsKICAgICBjYXNlIDU6IGZvcihtPTA7bSA8IDQ4IDttKyspeyBrZXlzWyA1XVttXSA9IHRlbXBLZXlbbV07IH0gYnJlYWs7CiAgICAgY2FzZSA2OiBmb3IobT0wO20gPCA0OCA7bSsrKXsga2V5c1sgNl1bbV0gPSB0ZW1wS2V5W21dOyB9IGJyZWFrOwogICAgIGNhc2UgNzogZm9yKG09MDttIDwgNDggO20rKyl7IGtleXNbIDddW21dID0gdGVtcEtleVttXTsgfSBicmVhazsKICAgICBjYXNlIDg6IGZvcihtPTA7bSA8IDQ4IDttKyspeyBrZXlzWyA4XVttXSA9IHRlbXBLZXlbbV07IH0gYnJlYWs7CiAgICAgY2FzZSA5OiBmb3IobT0wO20gPCA0OCA7bSsrKXsga2V5c1sgOV1bbV0gPSB0ZW1wS2V5W21dOyB9IGJyZWFrOwogICAgIGNhc2UgMTA6IGZvcihtPTA7bSA8IDQ4IDttKyspeyBrZXlzWzEwXVttXSA9IHRlbXBLZXlbbV07IH0gYnJlYWs7CiAgICAgY2FzZSAxMTogZm9yKG09MDttIDwgNDggO20rKyl7IGtleXNbMTFdW21dID0gdGVtcEtleVttXTsgfSBicmVhazsKICAgICBjYXNlIDEyOiBmb3IobT0wO20gPCA0OCA7bSsrKXsga2V5c1sxMl1bbV0gPSB0ZW1wS2V5W21dOyB9IGJyZWFrOwogICAgIGNhc2UgMTM6IGZvcihtPTA7bSA8IDQ4IDttKyspeyBrZXlzWzEzXVttXSA9IHRlbXBLZXlbbV07IH0gYnJlYWs7CiAgICAgY2FzZSAxNDogZm9yKG09MDttIDwgNDggO20rKyl7IGtleXNbMTRdW21dID0gdGVtcEtleVttXTsgfSBicmVhazsKICAgICBjYXNlIDE1OiBmb3IobT0wO20gPCA0OCA7bSsrKXsga2V5c1sxNV1bbV0gPSB0ZW1wS2V5W21dOyB9IGJyZWFrOwogICB9CiB9CiByZXR1cm4ga2V5czsgIAp9";

    @Override
    public HttpResult<Map<String, Object>> init(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String referer = "http://www.10086.cn/he/index_311_311.html";
            String templateUrl = "https://he.ac.10086.cn/login";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET).setFullUrl(templateUrl).setReferer(referer)
                    .invoke();
            String pageContent = response.getPageContent();

            String displayPics = PatternUtils.group(pageContent, "name=\"displayPics\" value=\"([^\"]+)\"", 1);
            String displayPic = PatternUtils.group(pageContent, "name=\"displayPic\" value=\"([^\"]+)\"", 1);
            String loginType = PatternUtils.group(pageContent, "name=\"type\" value=\"([^\"]+)\"", 1);
            String formerLoginType = PatternUtils.group(pageContent, "name=\"formertype\" value=\"([^\"]+)\"", 1);
            String backurl = PatternUtils.group(pageContent, "name=\"backurl\" value=\"([^\"]+)\"", 1);
            String warnurl = PatternUtils.group(pageContent, "name=\"warnurl\" value=\"([^\"]+)\"", 1);
            String spid = PatternUtils.group(pageContent, "name=\"spid\" value=\"([^\"]+)\"", 1);
            String relayState = PatternUtils.group(pageContent, "name=\"RelayState\" value=\"([^\"]+)\"", 1);

            TaskUtils.addTaskShare(param.getTaskId(), "displayPics", displayPics);
            TaskUtils.addTaskShare(param.getTaskId(), "displayPic", displayPic);
            TaskUtils.addTaskShare(param.getTaskId(), "loginType", loginType);
            TaskUtils.addTaskShare(param.getTaskId(), "formerLoginType", formerLoginType);
            TaskUtils.addTaskShare(param.getTaskId(), "backurl", backurl);
            TaskUtils.addTaskShare(param.getTaskId(), "warnurl", warnurl);
            TaskUtils.addTaskShare(param.getTaskId(), "spid", spid);
            TaskUtils.addTaskShare(param.getTaskId(), "relayState", relayState);

            return result.success();
        } catch (Exception e) {
            logger.error("登录-->初始化失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.TASK_INIT_ERROR);
        }
    }

    @Override
    public HttpResult<String> refeshPicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return refeshPicCodeForLogin(param);
            default:
                return new HttpResult<String>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> refeshSmsCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.VALIDATE_BILL_DETAIL:
                return refeshSmsCodeForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> submit(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return submitForLogin(param);
            case FormType.VALIDATE_BILL_DETAIL:
                return submitForBillDetail(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Map<String, Object>> validatePicCode(OperatorParam param) {
        switch (param.getFormType()) {
            case FormType.LOGIN:
                return validatePicCodeForLogin(param);
            default:
                return new HttpResult<Map<String, Object>>().failure(ErrorCode.NOT_SUPORT_METHOD);
        }
    }

    @Override
    public HttpResult<Object> defineProcess(OperatorParam param) {
        return new HttpResult<Object>().failure(ErrorCode.NOT_SUPORT_METHOD);
    }

    private HttpResult<String> refeshPicCodeForLogin(OperatorParam param) {
        HttpResult<String> result = new HttpResult<>();
        BigDecimal db = new BigDecimal(Math.random() * (1 - 0) + 0);
        Response response = null;
        try {
            String templateUrl = "https://he.ac.10086.cn/common/image.jsp?l={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET)
                    .setFullUrl(templateUrl, db.setScale(16, BigDecimal.ROUND_HALF_UP)).invoke();
            logger.info("登录-->图片验证码-->刷新成功,param={}", param);
            return result.success(response.getPageContentForBase64());
        } catch (Exception e) {
            logger.error("登录-->图片验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_PIC_CODE_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> validatePicCodeForLogin(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPicCode(), ErrorCode.EMPTY_PIC_CODE);
        BigDecimal db = new BigDecimal(Math.random() * (1 - 0) + 0);
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        Response response = null;
        try {
            String templateUrl = "https://he.ac.10086.cn/validImageCode?r_{}&imageCode={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET)
                    .setFullUrl(templateUrl, db.setScale(16, BigDecimal.ROUND_HALF_UP), param.getPicCode())
                    .addHeader("X-Requested-With", "XMLHttpRequest").invoke();
            String pageContent = response.getPageContent();
            if (StringUtils.contains(pageContent, "1")) {
                logger.info("登录-->图片验证码-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("登录-->图片验证码-->校验失败,param={},pageContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.VALIDATE_PIC_CODE_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登录-->图片验证码-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_PIC_CODE_ERROR);
        }
    }

    public HttpResult<Map<String, Object>> submitForLogin(OperatorParam param) {
        CheckUtils.checkNotBlank(param.getPassword(), ErrorCode.EMPTY_PASSWORD);
        CheckUtils.checkNotBlank(param.getPicCode(), ErrorCode.EMPTY_SMS_CODE);
        CheckUtils.checkNotBlank(param.getPicCode(), ErrorCode.EMPTY_PIC_CODE);
        HttpResult<Map<String, Object>> result = validatePicCode(param);
        if (!result.getStatus()) {
            return result;
        }
        Response response = null;
        try {
            String displayPics = TaskUtils.getTaskShare(param.getTaskId(), "displayPics");
            String displayPic = TaskUtils.getTaskShare(param.getTaskId(), "displayPic");
            String loginType = TaskUtils.getTaskShare(param.getTaskId(), "loginType");
            String formerLoginType = TaskUtils.getTaskShare(param.getTaskId(), "formerLoginType");
            String backurl = TaskUtils.getTaskShare(param.getTaskId(), "backurl");
            String warnurl = TaskUtils.getTaskShare(param.getTaskId(), "warnurl");
            String spid = TaskUtils.getTaskShare(param.getTaskId(), "spid");
            String relayState = TaskUtils.getTaskShare(param.getTaskId(), "relayState");

            InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream("he_bei_10086_web/des.js");
            Invocable invocable = ScriptEngineUtil.createInvocableFromBase64(javaScript);
            String encodePassword = invocable.invokeFunction("enString", param.getPassword().toString()).toString();

            String templateUrl = "https://he.ac.10086.cn/Login?displayPics={}&displayPic={}&type={}&formertype={}" +
                    "&backurl={}&warnurl={}&spid={}&RelayState={}&mobileNum={}&userIdTemp={}&servicePassword={}" +
                    "&emailPwd=&smsValidCode=&login_pwd_type=&email=输入Email邮箱地址&validCode={}&emailPwd=请输入密码&servicePassword=请输入6" +
                    "位数字的服务密码&smsValidCode=";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, displayPics, displayPic, loginType, formerLoginType, backurl, warnurl, spid, relayState,
                            param.getMobile(), param.getMobile(), encodePassword, param.getPicCode()).invoke();
            String pageContent = response.getPageContent();
            if (pageContent.contains("服务密码错误")) {
                if (pageContent.contains("账号已被锁定，请明天再试")) {
                    logger.warn("登录失败-->密码错误次数超过限制，账号已被锁定，请明天再试,param={}", param);
                    return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
                }
                logger.warn("登录失败-->账户名与密码不匹配,param={}", param);
                return result.failure(ErrorCode.VALIDATE_PASSWORD_FAIL);
            }
            if (pageContent.contains("图片验证码已失效")) {
                logger.warn("登录失败-->图片验证码已失效,param={}", param);
                return result.failure(ErrorCode.VALIDATE_PIC_CODE_FAIL);
            }

            List<String> relayStateList = XPathUtil.getXpath("//input[@name='RelayState']/@value", pageContent);
            if (!CollectionUtils.isEmpty(relayStateList)) {
                relayState = relayStateList.get(0);
            }
            String samLart = StringUtils.EMPTY;
            List<String> samLartList = XPathUtil.getXpath("//input[@name='SAMLart']/@value", pageContent);
            if (!CollectionUtils.isEmpty(samLartList)) {
                samLart = samLartList.get(0);
            }
            List<String> displayPicList = XPathUtil.getXpath("//input[@name='displayPic']/@value", pageContent);
            if (!CollectionUtils.isEmpty(displayPicList)) {
                displayPic = displayPicList.get(0);
            }
            List<String> displayPicsList = XPathUtil.getXpath("//input[@name='displayPics']/@value", pageContent);
            if (!CollectionUtils.isEmpty(displayPicsList)) {
                displayPics = displayPicsList.get(0);
            }
            String isEncodePassword = StringUtils.EMPTY;
            List<String> isEncodePasswordList = XPathUtil.getXpath("//input[@name='isEncodePassword']/@value", pageContent);
            if (!CollectionUtils.isEmpty(isEncodePasswordList)) {
                isEncodePassword = isEncodePasswordList.get(0);
            }

            templateUrl
                    = "https://he.ac.10086.cn//hblogin/backPage.jsp?SAMLart={}&isEncodePassword={}&displayPic={}&RelayState={}&isEncodeMobile=1&displayPics={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, samLart, isEncodePassword, displayPic, relayState, displayPics).invoke();
            if (StringUtils.isBlank(response.getContentType())) {
                logger.error("登陆失败,param={},response={}", param, response);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }

            relayStateList = XPathUtil.getXpath("//input[@name='RelayState']/@value", pageContent);
            if (!CollectionUtils.isEmpty(relayStateList)) {
                relayState = relayStateList.get(0);
            }
            samLartList = XPathUtil.getXpath("//input[@name='SAMLart']/@value", pageContent);
            if (!CollectionUtils.isEmpty(samLartList)) {
                samLart = samLartList.get(0);
            }

            /**
             * 此处post请求的body参数不能放进地址，
             * 否则会导致重定向url拥有不该有的参数
             */
            templateUrl = "http://www.he.10086.cn/my";
            String templateData = "SAMLart={}&RelayState={}";
            String data = TemplateUtils.format(templateData, URLEncoder.encode(samLart, "UTF-8"), URLEncoder.encode(relayState, "UTF-8"));
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST).setFullUrl(templateUrl).setRequestBody(data)
                    .invoke();

            //String redirectUrl = "http://www.he.10086.cn/my/account/";
            //response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST).setFullUrl(redirectUrl).invoke();
            pageContent = response.getPageContent();

            relayStateList = XPathUtil.getXpath("//input[@name='RelayState']/@value", pageContent);
            if (!CollectionUtils.isEmpty(relayStateList)) {
                relayState = relayStateList.get(0);
            }
            samLartList = XPathUtil.getXpath("//input[@name='SAMLRequest']/@value", pageContent);
            if (!CollectionUtils.isEmpty(samLartList)) {
                samLart = samLartList.get(0);
            }

            String referer = "http://www.he.10086.cn/my/";
            templateUrl = "http://he.ac.10086.cn/POST?SAMLRequest={}&RelayState={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, URLEncoder.encode(samLart, "UTF-8"), URLEncoder.encode(relayState, "UTF-8")).setReferer(referer)
                    .invoke();
            pageContent = response.getPageContent();

            relayStateList = XPathUtil.getXpath("//input[@name='RelayState']/@value", pageContent);
            if (!CollectionUtils.isEmpty(relayStateList)) {
                relayState = relayStateList.get(0);
            }
            samLartList = XPathUtil.getXpath("//input[@name='SAMLart']/@value", pageContent);
            if (!CollectionUtils.isEmpty(samLartList)) {
                samLart = samLartList.get(0);
            }
            displayPicList = XPathUtil.getXpath("//input[@name='displayPic']/@value", pageContent);
            if (!CollectionUtils.isEmpty(displayPicList)) {
                displayPic = displayPicList.get(0);
            }
            displayPicsList = XPathUtil.getXpath("//input[@name='displayPics']/@value", pageContent);
            if (!CollectionUtils.isEmpty(displayPicsList)) {
                displayPics = displayPicsList.get(0);
            }
            isEncodePasswordList = XPathUtil.getXpath("//input[@name='isEncodePassword']/@value", pageContent);
            if (CollectionUtils.isEmpty(isEncodePasswordList)) {
                isEncodePassword = isEncodePasswordList.get(0);
            }

            templateUrl = "http://www.he.10086.cn/my/?SAMLart={}&isEncodePassword={}&displayPic={}&RelayState={}&displayPics={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, samLart, isEncodePassword, displayPic, relayState, displayPics).invoke();

            templateUrl = "http://www.he.10086.cn/my/account/";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET).setFullUrl(templateUrl).invoke();
            pageContent = response.getPageContent();
            if (pageContent.contains(param.getMobile().toString())) {
                logger.info("登陆成功,param={}", param);
                return result.success();
            } else {
                logger.error("登陆失败,param={},response={}", param, response);
                return result.failure(ErrorCode.LOGIN_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("登陆失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.LOGIN_ERROR);
        }
    }

    private HttpResult<Map<String, Object>> refeshSmsCodeForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        BigDecimal db = new BigDecimal(Math.random() * (1 - 0) + 0);
        Response response = null;
        try {
            String templateUrl = "http://www.he.10086.cn/service/fee/qryDetailBill.action?menuid=qryDetailBill&pageId={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET)
                    .setFullUrl(templateUrl, db.setScale(17, BigDecimal.ROUND_HALF_UP)).invoke();
            String pageContent = response.getPageContent();

            String relayState = StringUtils.EMPTY;
            List<String> relayStateList = XPathUtil.getXpath("//input[@name='RelayState']/@value", pageContent);
            if (!CollectionUtils.isEmpty(relayStateList)) {
                relayState = relayStateList.get(0);
            }
            String samLart = StringUtils.EMPTY;
            List<String> samLartList = XPathUtil.getXpath("//input[@name='SAMLRequest']/@value", pageContent);
            if (!CollectionUtils.isEmpty(samLartList)) {
                samLart = samLartList.get(0);
            }
            samLart = samLart.replace(" ", URLDecoder.decode("%0D%0A", "UTF-8"));

            templateUrl = "http://he.ac.10086.cn/POST";
            String templateData = "SAMLRequest={}&RelayState={}";
            String data = TemplateUtils.format(templateData, samLart, relayState);
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST).setFullUrl(templateUrl).setRequestBody(data)
                    .invoke();
            pageContent = response.getPageContent();

            relayStateList = XPathUtil.getXpath("//input[@name='RelayState']/@value", pageContent);
            if (!CollectionUtils.isEmpty(relayStateList)) {
                relayState = relayStateList.get(0);
            }
            samLartList = XPathUtil.getXpath("//input[@name='SAMLart']/@value", pageContent);
            if (!CollectionUtils.isEmpty(samLartList)) {
                samLart = samLartList.get(0);
            }
            String displayPic = StringUtils.EMPTY;
            List<String> displayPicList = XPathUtil.getXpath("//input[@name='displayPic']/@value", pageContent);
            if (!CollectionUtils.isEmpty(displayPicList)) {
                displayPic = displayPicList.get(0);
            }
            String displayPics = StringUtils.EMPTY;
            List<String> displayPicsList = XPathUtil.getXpath("//input[@name='displayPics']/@value", pageContent);
            if (!CollectionUtils.isEmpty(displayPicsList)) {
                displayPics = displayPicsList.get(0);
            }
            String isEncodePassword = StringUtils.EMPTY;
            List<String> isEncodePasswordList = XPathUtil.getXpath("//input[@name='isEncodePassword']/@value", pageContent);
            if (!CollectionUtils.isEmpty(isEncodePasswordList)) {
                isEncodePassword = isEncodePasswordList.get(0);
            }

            templateUrl = "http://www.he.10086.cn/service/login!initLogin" +
                    ".action?SAMLart={}&isEncodePassword={}&displayPic={}&RelayState={}&displayPics={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, samLart, isEncodePassword, displayPic, relayState, displayPics).invoke();

            templateUrl = "http://www.he.10086.cn/service/fee/qryDetailBill.action";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.GET).setFullUrl(templateUrl).invoke();

            templateUrl = "http://www.he.10086.cn/service/fee/fee/qryDetailBill!sendRandomCode.action?r={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, db.setScale(16, BigDecimal.ROUND_HALF_UP)).invoke();
            pageContent = response.getPageContent();
            if (pageContent.contains("result\":\"success\"")) {
                logger.info("详单-->短信验证码-->刷新成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->短信验证码-->刷新失败,param={},pateContent={}", param, response.getPageContent());
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->短信验证码-->刷新失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.REFESH_SMS_ERROR);
        }
    }

    public HttpResult<Map<String, Object>> submitForBillDetail(OperatorParam param) {
        HttpResult<Map<String, Object>> result = new HttpResult<>();
        BigDecimal db = new BigDecimal(Math.random() * (1 - 0) + 0);
        Response response = null;
        try {
            String referer = "http://www.he.10086.cn/service/fee/qryDetailBill.action";
            String templateUrl = "http://www.he.10086.cn/service/fee/qryDetailBill!checkSmsCode.action?r={}&smsrandom={}";
            response = TaskHttpClient.create(param.getTaskId(), param.getWebsiteName(), RequestType.POST)
                    .setFullUrl(templateUrl, db.setScale(16, BigDecimal.ROUND_HALF_UP), param.getSmsCode()).setReferer(referer, param.getMobile())
                    .addHeader("X-Requested-With", "XMLHttpRequest").setReferer(referer).invoke();
            String pageContent = response.getPageContent();
            if (pageContent.contains("\"desc\":\"\"")) {
                logger.info("详单-->校验成功,param={}", param);
                return result.success();
            } else {
                logger.error("详单-->校验失败,param={},pateContent={}", param, pageContent);
                return result.failure(ErrorCode.REFESH_SMS_UNEXPECTED_RESULT);
            }
        } catch (Exception e) {
            logger.error("详单-->校验失败,param={},response={}", param, response, e);
            return result.failure(ErrorCode.VALIDATE_ERROR);
        }
    }
}
